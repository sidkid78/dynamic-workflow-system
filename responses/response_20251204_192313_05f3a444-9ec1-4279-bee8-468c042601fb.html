<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Agent Response - orchestrator&lowbar;workers</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="agent-response---orchestrator_workers">Agent Response - orchestrator_workers</h1>
<p><strong>Session ID</strong>: 05f3a444-9ec1-4279-bee8-468c042601fb
<strong>Processing Time</strong>: 364.27 seconds</p>
<h2 id="final-response">Final Response</h2>
<p>Of course. Here is a comprehensive technical architecture plan for the HOMEase | AI platform, re-architected to use Next.js App Router and Supabase, replacing the original Google Cloud and Firebase stack.</p>
<h3 id="executive-summary"><strong>Executive Summary</strong></h3>
<p>This document outlines a comprehensive technical architecture for the HOMEase | AI platform, pivoting from the originally planned Google Cloud/Firebase stack to a modern, integrated solution centered on <strong>Next.js 15 (App Router)</strong> for the frontend and <strong>Supabase</strong> for all backend services. This strategic shift consolidates the technology stack, enhances developer experience, and leverages the power of PostgreSQL to build a secure, scalable, and real-time lead generation platform.</p>
<p>The architecture is built on Vercel for hosting, providing seamless deployment and performance optimization for the Next.js application. Supabase serves as a complete backend-as-a-service (BaaS), offering a relational PostgreSQL database, authentication, object storage, serverless Edge Functions, and real-time capabilities. This plan details the system's foundation, core user journeys, payment integration, administrative oversight, and a full DevOps pipeline, ensuring a robust and efficient path to market.</p>
<hr>
<h3 id="1-core-technology-stack"><strong>1. Core Technology Stack</strong></h3>
<p>The platform is built on a modern, serverless architecture designed for scalability and performance.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Component</th>
<th style="text-align:left">Technology</th>
<th style="text-align:left">Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>Frontend &amp; Web Server</strong></td>
<td style="text-align:left"><strong>Next.js 15 (App Router) on Vercel</strong></td>
<td style="text-align:left">Provides a powerful React framework with Server Components, Server Actions, and an optimized build process. Vercel offers best-in-class hosting, performance, and CI/CD integration.</td>
</tr>
<tr>
<td style="text-align:left"><strong>Database</strong></td>
<td style="text-align:left"><strong>Supabase (PostgreSQL)</strong></td>
<td style="text-align:left">A robust, relational SQL database offering data integrity, powerful querying with extensions like PostGIS for geospatial data, and fine-grained security via Row Level Security (RLS).</td>
</tr>
<tr>
<td style="text-align:left"><strong>Authentication</strong></td>
<td style="text-align:left"><strong>Supabase Auth</strong></td>
<td style="text-align:left">Manages user identity, social logins, and secure session handling via JWTs. Integrates seamlessly with the database and Next.js middleware for route protection.</td>
</tr>
<tr>
<td style="text-align:left"><strong>Serverless Functions</strong></td>
<td style="text-align:left"><strong>Supabase Edge Functions (Deno)</strong></td>
<td style="text-align:left">Replaces Google Cloud Functions for running backend logic, orchestrating AI services, and handling webhooks. Deployed at the edge for low latency.</td>
</tr>
<tr>
<td style="text-align:left"><strong>File Storage</strong></td>
<td style="text-align:left"><strong>Supabase Storage</strong></td>
<td style="text-align:left">Securely stores user-uploaded images from AR assessments, contractor licenses, and other documents, with access control managed by database policies.</td>
</tr>
<tr>
<td style="text-align:left"><strong>Real-time Engine</strong></td>
<td style="text-align:left"><strong>Supabase Realtime</strong></td>
<td style="text-align:left">Powers live updates for the messaging system, online presence indicators, and notifications for asynchronous jobs like AI analysis and contractor matching.</td>
</tr>
<tr>
<td style="text-align:left"><strong>AI Analysis</strong></td>
<td style="text-align:left"><strong>Google Gemini &amp; <a href="http://Fal.ai">Fal.ai</a></strong></td>
<td style="text-align:left">As per the original specification, these external APIs will be called from Supabase Edge Functions to perform hazard analysis and generate &quot;after&quot; visualizations.</td>
</tr>
<tr>
<td style="text-align:left"><strong>Payments</strong></td>
<td style="text-align:left"><strong>Stripe (Connect &amp; Checkout)</strong></td>
<td style="text-align:left">Manages contractor onboarding, verification, payouts (Connect), and secure homeowner payments (Checkout) in a multi-party transaction model.</td>
</tr>
<tr>
<td style="text-align:left"><strong>DevOps &amp; CI/CD</strong></td>
<td style="text-align:left"><strong>GitHub &amp; Vercel with GitHub Actions</strong></td>
<td style="text-align:left">Provides a complete, automated workflow from code commit to production deployment, including automated testing, preview deployments, and environment management.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="2-platform-foundation-data-model--authentication"><strong>2. Platform Foundation: Data Model &amp; Authentication</strong></h3>
<p>The foundation of the platform is a secure, relational database and a robust authentication system that enforces strict access control based on user roles.</p>
<h4 id="21-supabase-database-schema"><strong>2.1. Supabase Database Schema</strong></h4>
<p>The data model is built on a normalized PostgreSQL schema, ensuring data integrity and consistency.</p>
<ul>
<li><strong><code>profiles</code></strong>: Extends the built-in <code>auth.users</code> table, storing public data like <code>full_name</code>, <code>avatar_url</code>, and the critical <code>role</code> (<code>homeowner</code>, <code>contractor</code>, or <code>admin</code>). A database trigger automatically creates a profile for each new user.</li>
<li><strong><code>contractor_details</code></strong>: A one-to-one extension of <code>profiles</code> for contractors, containing fields for <code>company_name</code>, <code>is_caps_certified</code>, <code>verification_status</code>, and their <code>stripe_connect_id</code>. It also includes a <code>GEOMETRY</code> column for their service area, powered by the PostGIS extension.</li>
<li><strong><code>projects</code></strong>: The central table representing a homeowner's lead. It links to the <code>homeowner_id</code>, stores the project <code>status</code> (e.g., <code>draft</code>, <code>open_for_bids</code>, <code>completed</code>), and contains address/location data.</li>
<li><strong><code>ar_assessments</code></strong>: Stores the output of the AI analysis, including the <code>accessibility_score</code>, <code>identified_hazards</code> (JSONB), <code>recommendations</code> (JSONB), and <code>fal_ai_visualization_urls</code>.</li>
<li><strong><code>project_matches</code></strong>: A join table linking <code>projects</code> to matched <code>contractors</code>, tracking the status of their interaction (e.g., <code>matched</code>, <code>proposal_sent</code>).</li>
<li><strong><code>messages</code></strong>: Stores all real-time chat messages, linked to a specific project match.</li>
<li><strong><code>payments</code></strong>: Records every transaction processed through Stripe, linking the <code>project_id</code>, <code>payer_id</code>, <code>payee_id</code>, and <code>stripe_charge_id</code>.</li>
</ul>
<h4 id="22-authentication-and-authorization"><strong>2.2. Authentication and Authorization</strong></h4>
<p>Authentication is handled by Supabase Auth, integrated into Next.js using the <code>@supabase/ssr</code> library.</p>
<ol>
<li><strong>Session Management:</strong> A Next.js middleware file securely manages the user's session by refreshing the auth cookie on every request, making user data available to both Server and Client Components.</li>
<li><strong>Route Protection:</strong> The middleware also acts as a gatekeeper, redirecting unauthenticated users away from protected routes like <code>/dashboard</code> and <code>/admin</code>.</li>
<li><strong>Row Level Security (RLS):</strong> This is the cornerstone of the platform's security. RLS policies are PostgreSQL rules that filter data at the database level, ensuring users can only access data they are permitted to see.
<ul>
<li><strong>Example Policy 1:</strong> A user can only select or update their own row in the <code>profiles</code> table.<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> POLICY &quot;Users can manage their own profile.&quot;
<span class="hljs-keyword">ON</span> public.profiles <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">USING</span> ( auth.uid() <span class="hljs-operator">=</span> id );
</code></pre>
</li>
<li><strong>Example Policy 2:</strong> A homeowner can only view projects they have created.<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> POLICY &quot;Homeowners can view their own projects.&quot;
<span class="hljs-keyword">ON</span> public.projects <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> ( auth.uid() <span class="hljs-operator">=</span> homeowner_id );
</code></pre>
</li>
<li><strong>Example Policy 3:</strong> A contractor can only view projects they have been explicitly matched with.<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> POLICY &quot;Contractors can view matched projects.&quot;
<span class="hljs-keyword">ON</span> public.projects <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (
  <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> project_matches
    <span class="hljs-keyword">WHERE</span> project_matches.project_id <span class="hljs-operator">=</span> projects.id
    <span class="hljs-keyword">AND</span> project_matches.contractor_id <span class="hljs-operator">=</span> auth.uid()
  )
);
</code></pre>
</li>
</ul>
</li>
</ol>
<hr>
<h3 id="3-core-journey-ar-assessment-to-contractor-match"><strong>3. Core Journey: AR Assessment to Contractor Match</strong></h3>
<p>This two-stage, asynchronous workflow forms the innovative core of the HOMEase platform.</p>
<h4 id="stage-1-ar-assessment-and-ai-analysis"><strong>Stage 1: AR Assessment and AI Analysis</strong></h4>
<p>This stage is designed to be non-blocking, providing a responsive user experience while computationally intensive AI tasks run in the background.</p>
<ol>
<li><strong>Capture (Frontend):</strong> The homeowner uses a WebXR-based component (built with <code>@react-three/xr</code>) in the Next.js app to capture images of their home. These images are uploaded directly and securely to a private bucket in <strong>Supabase Storage</strong>.</li>
<li><strong>Initiate (Edge Function):</strong> The app invokes a Supabase Edge Function (<code>process-ar-assessment</code>), passing the storage paths of the uploaded images. This function immediately creates a placeholder record in the <code>ar_assessments</code> table with a <code>processing</code> status and returns a <code>202 Accepted</code> response to the user.</li>
<li><strong>Orchestrate (Background Function):</strong> The initiator function then triggers a second, long-running Edge Function (<code>generate-ai-analysis</code>) without awaiting its completion. This worker function:
<ul>
<li>Generates secure, signed URLs for the stored images.</li>
<li>Calls the <strong>Google Gemini API</strong> with the images and a specialized prompt to perform hazard analysis.</li>
<li>Calls the <strong><a href="http://Fal.ai">Fal.ai</a> API</strong> with the results to generate &quot;after&quot; visualizations.</li>
</ul>
</li>
<li><strong>Persist &amp; Notify:</strong> The worker function updates the <code>ar_assessments</code> record with the AI results and changes its status to <code>completed</code>. The homeowner's app, subscribed to database changes via <strong>Supabase Realtime</strong>, is instantly notified and displays the full report.</li>
</ol>
<h4 id="stage-2-lead-submission-and-contractor-matching"><strong>Stage 2: Lead Submission and Contractor Matching</strong></h4>
<p>Once the assessment is complete, the homeowner can submit it as a lead, triggering the asynchronous matching process.</p>
<ol>
<li><strong>Submit (Frontend):</strong> The homeowner reviews the report, adds budget and urgency details, and clicks &quot;Find Contractors.&quot; This action updates the corresponding <code>projects</code> table record, setting its <code>status</code> to <code>open_for_bids</code>.</li>
<li><strong>Trigger (Database):</strong> A <strong>PostgreSQL Trigger</strong> on the <code>projects</code> table detects this specific status change. It securely invokes a Supabase Edge Function (<code>match-contractors</code>) via a database webhook, passing the project data as the payload. This trigger-based approach is more robust and conditional than a simple webhook.</li>
<li><strong>Match (Edge Function):</strong> The <code>match-contractors</code> function executes the matching logic:
<ul>
<li>It queries the <code>contractor_details</code> table using a <strong>PostGIS geospatial function</strong> (<code>ST_Contains</code>) to find contractors whose service area polygon contains the project's location point.</li>
<li>It further filters these contractors by skills (derived from the AR recommendations) and CAPS certification.</li>
<li>This complex query is encapsulated in a PostgreSQL Function (RPC) for performance and maintainability.</li>
</ul>
</li>
<li><strong>Persist &amp; Notify:</strong> For each qualified contractor found, the function inserts a record into the <code>project_matches</code> table. The homeowner's dashboard, subscribed via <strong>Supabase Realtime</strong>, automatically populates with contractor profiles as they are matched.</li>
</ol>
<hr>
<h3 id="4-user-interfaces-dashboards--communication"><strong>4. User Interfaces: Dashboards &amp; Communication</strong></h3>
<p>The platform provides role-specific dashboards for homeowners and contractors, built as protected routes within the Next.js application.</p>
<h4 id="41-homeowner-dashboard-dashboardhomeowner"><strong>4.1. Homeowner Dashboard (<code>/dashboard/homeowner</code>)</strong></h4>
<ul>
<li><strong>Project Hub:</strong> View a list of all projects and their current status on a visual timeline.</li>
<li><strong>Contractor Matching:</strong> See a real-time list of matched contractors as they are found by the backend process.</li>
<li><strong>Proposal Management:</strong> Review, accept, or decline proposals submitted by contractors.</li>
<li><strong>Secure Payments:</strong> Initiate payments via Stripe Checkout after accepting a proposal.</li>
<li><strong>Real-time Chat:</strong> Communicate directly with the selected contractor.</li>
</ul>
<h4 id="42-contractor-dashboard-dashboardcontractor"><strong>4.2. Contractor Dashboard (<code>/dashboard/contractor</code>)</strong></h4>
<ul>
<li><strong>Profile Management:</strong> Manage company details, upload licenses/insurance, and define a service area by drawing a polygon on an interactive map.</li>
<li><strong>Lead Feed:</strong> View and manage incoming, pre-qualified leads.</li>
<li><strong>Dynamic Scope Builder:</strong> An interactive tool that uses the AR assessment data as a starting point. Contractors can convert AI recommendations into line items, add custom items, and set prices to auto-generate a detailed proposal.</li>
<li><strong>Payment Tracking:</strong> View payment history and manage payouts.</li>
</ul>
<h4 id="43-real-time-messaging-system"><strong>4.3. Real-time Messaging System</strong></h4>
<p>The chat feature is powered entirely by Supabase Realtime, operating on a secure, project-specific channel.</p>
<ul>
<li><strong>Message Syncing:</strong> New messages inserted into the <code>messages</code> table are broadcast to participants in real-time using <strong>Postgres Changes</strong>.</li>
<li><strong>Online Status:</strong> <strong>Supabase Presence</strong> tracks which users are currently active in the chat, allowing for &quot;Online&quot; indicators.</li>
<li><strong>Typing Indicators:</strong> Ephemeral &quot;is typing...&quot; notifications are sent using <strong>Supabase Broadcast</strong>, which avoids writing unnecessary data to the database.</li>
</ul>
<hr>
<h3 id="5-monetization--administration"><strong>5. Monetization &amp; Administration</strong></h3>
<p>The platform's financial operations and internal oversight are handled by Stripe integration and a secure admin dashboard.</p>
<h4 id="51-stripe-payment-integration"><strong>5.1. Stripe Payment Integration</strong></h4>
<ul>
<li><strong>Contractor Onboarding:</strong> Contractors are onboarded using <strong>Stripe Connect Express</strong>. A Server Action in Next.js creates a Stripe account link, redirecting the user to Stripe's secure flow. A webhook confirms when their account is verified and ready for payouts.</li>
<li><strong>Homeowner Payments:</strong> After a proposal is accepted, the homeowner pays using <strong>Stripe Checkout</strong>. The platform fee is automatically calculated and transferred to the HOMEase platform account during the transaction using Stripe's <code>application_fee_amount</code> parameter.</li>
<li><strong>Webhook Handling:</strong> A single, secure Supabase Edge Function (<code>stripe-webhooks</code>) acts as the endpoint for all Stripe events. It verifies the Stripe signature on every request and updates the <code>payments</code> and <code>projects</code> tables accordingly, ensuring a reliable record of all financial activity.</li>
</ul>
<h4 id="52-administrative-dashboard-admin"><strong>5.2. Administrative Dashboard (<code>/admin</code>)</strong></h4>
<p>This is a role-protected area of the app, accessible only to users with the <code>admin</code> role.</p>
<ul>
<li><strong>Security:</strong> Access is controlled by the Next.js middleware, which checks the user's role from the <code>profiles</code> table.</li>
<li><strong>Analytics:</strong> A main dashboard displays key platform metrics like user growth, lead volume, and revenue.</li>
<li><strong>Contractor Approval:</strong> An interface for reviewing pending contractor applications, viewing their uploaded documents, and approving or rejecting them.</li>
<li><strong>User Management:</strong> A tool for viewing and managing all user accounts on the platform. All administrative actions are executed via secure Next.js Server Actions.</li>
</ul>
<hr>
<h3 id="6-deployment--devops-on-vercel"><strong>6. Deployment &amp; DevOps on Vercel</strong></h3>
<p>A full CI/CD pipeline ensures code quality and automates deployments, enabling rapid and reliable iteration.</p>
<ol>
<li><strong>Hosting on Vercel:</strong> The Next.js application is deployed to Vercel, which provides a global Edge Network, automatic scaling, and seamless integration with GitHub.</li>
<li><strong>Environment Strategy:</strong>
<ul>
<li><strong>Production:</strong> The live application, connected to the production Supabase project and deployed from the <code>main</code> branch.</li>
<li><strong>Preview (Staging):</strong> For every pull request, Vercel creates a unique preview deployment connected to a separate staging Supabase project. This allows for thorough testing and review before merging.</li>
<li><strong>Local:</strong> Developers run the app locally, also connected to the staging Supabase project.</li>
</ul>
</li>
<li><strong>CI/CD Pipeline with GitHub Actions:</strong>
<ul>
<li><strong>Trigger:</strong> The pipeline runs automatically on every pull request to the <code>main</code> branch.</li>
<li><strong>Quality Gates:</strong> A GitHub Actions workflow runs a series of checks:
<ul>
<li><strong>Linting:</strong> Enforces code style consistency with ESLint.</li>
<li><strong>Testing:</strong> Runs automated unit and integration tests (e.g., with Vitest or Jest).</li>
<li><strong>Type Checking:</strong> The <code>next build</code> command performs a full TypeScript check.</li>
</ul>
</li>
<li><strong>Branch Protection:</strong> A GitHub branch protection rule is configured on <code>main</code> to prevent merging until all CI checks have passed.</li>
<li><strong>Deployment:</strong> Once a pull request is approved and merged, Vercel automatically builds and deploys the new version to production, using the production environment variables configured in the Vercel dashboard.</li>
</ul>
</li>
</ol>
<h2 id="intermediate-steps">Intermediate Steps</h2>
<h3 id="task-coordinator">Task Coordinator</h3>
<p>Task Understanding:
The user wants a comprehensive technical architecture plan to build the HOMEase | AI platform. The key constraint is to replace the original Google Cloud and Firebase stack with a new stack centered on Next.js (using the App Router) and Supabase. The plan must cover all aspects of the platform described in the briefing document, including user roles, the AR assessment with AI analysis, lead generation, contractor matching, payments, and real-time communication.</p>
<p>Execution Strategy:
The technical architecture plan will be executed in a phased, feature-driven approach. Phase 1 focuses on establishing the core infrastructure using Next.js and Supabase, including authentication, database schema, and a CI/CD pipeline. Phase 2 develops the core user journey, from the AR assessment and AI analysis to lead generation and contractor matching. Phase 3 builds the user-facing dashboards and communication tools. Phase 4 layers in monetization with Stripe and provides administrative oversight. This strategy prioritizes building the foundational components first, followed by the core value-generating features, ensuring a solid and scalable architecture. The technology stack is consolidated around Vercel for the frontend and Supabase for all backend services (database, authentication, serverless functions, storage), replacing the original GCP and Firebase stack.</p>
<p>Subtasks:</p>
<ol>
<li>Platform Foundation &amp; Authentication with Next.js and Supabase (Priority: 1, Expertise: Frontend Development (Next.js), Backend Development (Supabase Auth))
Description: Set up the Next.js 15 application using the App Router. Integrate Supabase for authentication, replacing Firebase Auth. This includes configuring user roles (homeowner, contractor, admin) and implementing Row Level Security (RLS) policies in Supabase to ensure data access is restricted based on user roles. Create sign-up, sign-in, and user profile management pages.
Dependencies: None</li>
<li>Supabase Database Schema Design and Implementation (Priority: 2, Expertise: Database Architecture, Backend Development (Supabase, PostgreSQL))
Description: Design and implement the complete database schema in Supabase Postgres, replacing Firebase Firestore. This includes creating tables for users, profiles, projects (leads), AR assessments, contractor details (including CAPS certification), real-time messages, and payment records. Define all table relationships, constraints, and data types. Implement comprehensive RLS policies for all tables to enforce data security.
Dependencies: foundation_auth</li>
<li>AR Assessment Flow and AI Service Integration (Priority: 3, Expertise: Frontend Development (WebXR), Backend Development (Supabase Edge Functions), AI API Integration)
Description: Develop the AR assessment flow using a WebXR-based approach for broad accessibility. Create a Supabase Edge Function to securely receive image data from the frontend. This function will orchestrate calls to the Google Gemini API for hazard analysis and the <a href="http://Fal.ai">Fal.ai</a> API for generating 'after' visualizations. The results, including the accessibility score, recommendations, and visualization URLs, will be saved to the 'assessments' table in the database.
Dependencies: db_schema</li>
<li>Asynchronous Lead Generation and Contractor Matching (Priority: 4, Expertise: Backend Development (Supabase Edge Functions, PostgreSQL))
Description: Implement the process for a homeowner to submit their completed AR assessment as a formal lead. This involves creating a new project record in the database. Use a Supabase database webhook to trigger a serverless Edge Function asynchronously. This function will execute the contractor matching logic, querying the contractor profiles based on geographic location, skills, and availability, and then associating the matched contractors with the new project.
Dependencies: ar_ai_integration</li>
<li>Homeowner and Contractor Dashboards Development (Priority: 5, Expertise: Frontend Development (Next.js), UI/UX Design)
Description: Build the user-facing dashboards. For homeowners, this includes viewing project status, communicating with contractors, and managing payments. For contractors, this includes managing their profile, viewing and responding to leads, and using a 'Dynamic Scope Builder' to generate proposals based on the AR assessment data.
Dependencies: lead_matching</li>
<li>Real-time Messaging System (Priority: 6, Expertise: Frontend Development (Next.js), Backend Development (Supabase Realtime))
Description: Implement a real-time messaging system between homeowners and contractors using Supabase's Realtime Broadcast and Presence features. This will allow for instant communication within the platform. All messages will be stored in the database with RLS policies ensuring only the participants can view them.
Dependencies: user_dashboards</li>
<li>Payment Integration and Administrative Dashboard (Priority: 7, Expertise: Backend Development (Stripe Integration, Supabase Edge Functions), Frontend Development)
Description: Integrate Stripe Connect for contractor onboarding, verification, and payouts. Use Stripe Checkout for homeowners to make secure payments for projects. Develop Supabase Edge Functions to handle Stripe webhooks for events like successful payments or transfers, ensuring the database is updated accordingly. Build a separate admin dashboard for platform administrators to manage the contractor approval process, oversee user accounts, and view key platform analytics.
Dependencies: user_dashboards</li>
<li>Deployment, Hosting, and DevOps Pipeline on Vercel (Priority: 8, Expertise: DevOps, CI/CD (GitHub Actions), Vercel Platform)
Description: Establish a full CI/CD pipeline using GitHub Actions for automated testing and deployment. Configure deployments to Vercel, the recommended hosting platform for Next.js. Set up distinct environments for development, staging, and production, managing Supabase project URLs and API keys securely as environment variables in Vercel.
Dependencies: foundation_auth</li>
</ol>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;execution_strategy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;The technical architecture plan will be executed in a phased, feature-driven approach. Phase 1 focuses on establishing the core infrastructure using Next.js and Supabase, including authentication, database schema, and a CI/CD pipeline. Phase 2 develops the core user journey, from the AR assessment and AI analysis to lead generation and contractor matching. Phase 3 builds the user-facing dashboards and communication tools. Phase 4 layers in monetization with Stripe and provides administrative oversight. This strategy prioritizes building the foundational components first, followed by the core value-generating features, ensuring a solid and scalable architecture. The technology stack is consolidated around Vercel for the frontend and Supabase for all backend services (database, authentication, serverless functions, storage), replacing the original GCP and Firebase stack.&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;subtasks&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Set up the Next.js 15 application using the App Router. Integrate Supabase for authentication, replacing Firebase Auth. This includes configuring user roles (homeowner, contractor, admin) and implementing Row Level Security (RLS) policies in Supabase to ensure data access is restricted based on user roles. Create sign-up, sign-in, and user profile management pages.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Frontend Development (Next.js), Backend Development (Supabase Auth)&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Platform Foundation &amp; Authentication with Next.js and Supabase&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;foundation_auth&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;db_schema&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Database Architecture, Backend Development (Supabase, PostgreSQL)&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Supabase Database Schema Design and Implementation&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;foundation_auth&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design and implement the complete database schema in Supabase Postgres, replacing Firebase Firestore. This includes creating tables for users, profiles, projects (leads), AR assessments, contractor details (including CAPS certification), real-time messages, and payment records. Define all table relationships, constraints, and data types. Implement comprehensive RLS policies for all tables to enforce data security.&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Develop the AR assessment flow using a WebXR-based approach for broad accessibility. Create a Supabase Edge Function to securely receive image data from the frontend. This function will orchestrate calls to the Google Gemini API for hazard analysis and the Fal.ai API for generating &#x27;after&#x27; visualizations. The results, including the accessibility score, recommendations, and visualization URLs, will be saved to the &#x27;assessments&#x27; table in the database.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ar_ai_integration&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Frontend Development (WebXR), Backend Development (Supabase Edge Functions), AI API Integration&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;db_schema&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AR Assessment Flow and AI Service Integration&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Implement the process for a homeowner to submit their completed AR assessment as a formal lead. This involves creating a new project record in the database. Use a Supabase database webhook to trigger a serverless Edge Function asynchronously. This function will execute the contractor matching logic, querying the contractor profiles based on geographic location, skills, and availability, and then associating the matched contractors with the new project.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Backend Development (Supabase Edge Functions, PostgreSQL)&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;ar_ai_integration&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Asynchronous Lead Generation and Contractor Matching&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lead_matching&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Build the user-facing dashboards. For homeowners, this includes viewing project status, communicating with contractors, and managing payments. For contractors, this includes managing their profile, viewing and responding to leads, and using a &#x27;Dynamic Scope Builder&#x27; to generate proposals based on the AR assessment data.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Frontend Development (Next.js), UI/UX Design&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Homeowner and Contractor Dashboards Development&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;lead_matching&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user_dashboards&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;user_dashboards&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Real-time Messaging System&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Implement a real-time messaging system between homeowners and contractors using Supabase&#x27;s Realtime Broadcast and Presence features. This will allow for instant communication within the platform. All messages will be stored in the database with RLS policies ensuring only the participants can view them.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Frontend Development (Next.js), Backend Development (Supabase Realtime)&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;realtime_messaging&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;payments_admin&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Backend Development (Stripe Integration, Supabase Edge Functions), Frontend Development&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Payment Integration and Administrative Dashboard&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Integrate Stripe Connect for contractor onboarding, verification, and payouts. Use Stripe Checkout for homeowners to make secure payments for projects. Develop Supabase Edge Functions to handle Stripe webhooks for events like successful payments or transfers, ensuring the database is updated accordingly. Build a separate admin dashboard for platform administrators to manage the contractor approval process, oversee user accounts, and view key platform analytics.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;user_dashboards&quot;</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DevOps, CI/CD (GitHub Actions), Vercel Platform&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Establish a full CI/CD pipeline using GitHub Actions for automated testing and deployment. Configure deployments to Vercel, the recommended hosting platform for Next.js. Set up distinct environments for development, staging, and production, managing Supabase project URLs and API keys securely as environment variables in Vercel.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;foundation_auth&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;deployment_devops&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Deployment, Hosting, and DevOps Pipeline on Vercel&quot;</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;task_understanding&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;The user wants a comprehensive technical architecture plan to build the HOMEase | AI platform. The key constraint is to replace the original Google Cloud and Firebase stack with a new stack centered on Next.js (using the App Router) and Supabase. The plan must cover all aspects of the platform described in the briefing document, including user roles, the AR assessment with AI analysis, lead generation, contractor matching, payments, and real-time communication.&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="frontend-development-nextjs-backend-development-supabase-auth-specialist">Frontend Development (Next.js), Backend Development (Supabase Auth) Specialist</h3>
<h3 id="comprehensive-technical-architecture-plan-homease--ai"><strong>Comprehensive Technical Architecture Plan: HOMEase | AI</strong></h3>
<h3 id="subtask-platform-foundation--authentication-with-nextjs-and-supabase"><strong>Subtask: Platform Foundation &amp; Authentication with Next.js and Supabase</strong></h3>
<p>This document details the setup of the foundational web application for HOMEase | AI using Next.js 15 (App Router) and the complete integration of Supabase for authentication and user management. This replaces the originally planned Firebase/GCP stack, establishing a secure, scalable, and role-based access control system from the outset.</p>
<hr>
<h4 id="1-project-setup--supabase-integration"><strong>1. Project Setup &amp; Supabase Integration</strong></h4>
<p>This section covers the initial setup of the Next.js application and its connection to a new Supabase project.</p>
<h5 id="11-initializing-the-nextjs-15-application"><strong>1.1. Initializing the Next.js 15 Application</strong></h5>
<p>We will start by creating a new Next.js project configured with TypeScript and Tailwind CSS for styling, which are industry standards for modern web development.</p>
<p><strong>Command:</strong></p>
<pre><code class="language-bash">npx create-next-app@latest homease-app
</code></pre>
<p><strong>Configuration during setup:</strong></p>
<ul>
<li><strong>TypeScript:</strong> Yes</li>
<li><strong>ESLint:</strong> Yes</li>
<li><strong>Tailwind CSS:</strong> Yes</li>
<li><strong><code>src/</code> directory:</strong> Yes</li>
<li><strong>App Router:</strong> Yes (Default)</li>
<li><strong>Import alias:</strong> <code>@/*</code></li>
</ul>
<p>This command scaffolds a new project in the <code>homease-app</code> directory with the recommended App Router structure.</p>
<h5 id="12-setting-up-the-supabase-project"><strong>1.2. Setting up the Supabase Project</strong></h5>
<ol>
<li><strong>Create Project:</strong> Navigate to <a href="https://database.new">database.new</a> and create a new project for HOMEase. Select a strong password for the database and store it securely.</li>
<li><strong>Retrieve API Keys:</strong> In the Supabase dashboard, go to <strong>Project Settings &gt; API</strong>. You will need two values:
<ul>
<li><strong>Project URL</strong> (e.g., <code>https://&lt;your-project-ref&gt;.supabase.co</code>)</li>
<li><strong><code>anon</code> (public) Key</strong></li>
</ul>
</li>
</ol>
<h5 id="13-configuring-supabase-in-nextjs"><strong>1.3. Configuring Supabase in Next.js</strong></h5>
<p>We will use the <code>@supabase/ssr</code> library, which is specifically designed for server-side rendering environments like the Next.js App Router. It securely manages authentication state via cookies.</p>
<p><strong>1. Install Supabase Libraries:</strong></p>
<pre><code class="language-bash">npm install @supabase/supabase-js @supabase/ssr
</code></pre>
<p><strong>2. Environment Variables:</strong>
Create a file named <code>.env.local</code> in the root of your project to store the Supabase credentials securely. Never commit this file to version control.</p>
<p><code>.env.local</code></p>
<pre><code>NEXT_PUBLIC_SUPABASE_URL=https://&lt;your-project-ref&gt;.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=&lt;your-anon-key&gt;
</code></pre>
<p><em>Note: The <code>NEXT_PUBLIC_</code> prefix makes these variables available in the browser, which is necessary for the Supabase client.</em></p>
<p><strong>3. Create the Supabase Client:</strong>
To avoid repeating client creation logic, we'll create a utility module that provides Supabase client instances for different contexts (Client Components, Server Components, Server Actions, and Route Handlers).</p>
<p><code>src/lib/supabase/client.ts</code> (For Client Components)</p>
<pre><code class="language-typescript"><span class="hljs-keyword">import</span> { createBrowserClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@supabase/ssr&#x27;</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createClient</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createBrowserClient</span>(
    process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_SUPABASE_URL</span>!,
    process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_SUPABASE_ANON_KEY</span>!
  )
}
</code></pre>
<p><code>src/lib/supabase/server.ts</code> (For Server Components, Actions, Route Handlers)</p>
<pre><code class="language-typescript"><span class="hljs-keyword">import</span> { createServerClient, <span class="hljs-keyword">type</span> <span class="hljs-title class_">CookieOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@supabase/ssr&#x27;</span>
<span class="hljs-keyword">import</span> { cookies } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/headers&#x27;</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createClient</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> cookieStore = <span class="hljs-title function_">cookies</span>()

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createServerClient</span>(
    process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_SUPABASE_URL</span>!,
    process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_SUPABASE_ANON_KEY</span>!,
    {
      <span class="hljs-attr">cookies</span>: {
        <span class="hljs-title function_">get</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
          <span class="hljs-keyword">return</span> cookieStore.<span class="hljs-title function_">get</span>(name)?.<span class="hljs-property">value</span>
        },
        <span class="hljs-title function_">set</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">string</span>, options: CookieOptions</span>) {
          <span class="hljs-keyword">try</span> {
            cookieStore.<span class="hljs-title function_">set</span>({ name, value, ...options })
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-comment">// The `set` method was called from a Server Component.</span>
            <span class="hljs-comment">// This can be ignored if you have middleware refreshing</span>
            <span class="hljs-comment">// user sessions.</span>
          }
        },
        <span class="hljs-title function_">remove</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, options: CookieOptions</span>) {
          <span class="hljs-keyword">try</span> {
            cookieStore.<span class="hljs-title function_">delete</span>({ name, ...options })
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-comment">// The `delete` method was called from a Server Component.</span>
            <span class="hljs-comment">// This can be ignored if you have middleware refreshing</span>
            <span class="hljs-comment">// user sessions.</span>
          }
        },
      },
    }
  )
}
</code></pre>
<hr>
<h4 id="2-core-authentication-flow"><strong>2. Core Authentication Flow</strong></h4>
<p>This section covers the implementation of user sign-up, sign-in, session management, and route protection.</p>
<h5 id="21-implementing-sign-up-and-sign-in"><strong>2.1. Implementing Sign-Up and Sign-In</strong></h5>
<p>For rapid development and a polished user experience, we'll use Supabase's pre-built UI components.</p>
<p><strong>1. Install Auth UI Helpers:</strong></p>
<pre><code class="language-bash">npm install @supabase/auth-ui-react @supabase/auth-ui-shared
</code></pre>
<p><strong>2. Create the Authentication Page:</strong>
This page will serve as the entry point for both new and returning users.</p>
<p><code>src/app/login/page.tsx</code></p>
<pre><code class="language-tsx"><span class="hljs-string">&#x27;use client&#x27;</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Auth</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@supabase/auth-ui-react&#x27;</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemeSupa</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@supabase/auth-ui-shared&#x27;</span>
<span class="hljs-keyword">import</span> { createClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/supabase/client&#x27;</span>
<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/navigation&#x27;</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">LoginPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> supabase = <span class="hljs-title function_">createClient</span>()
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>()

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: { subscription } } = supabase.<span class="hljs-property">auth</span>.<span class="hljs-title function_">onAuthStateChange</span>(<span class="hljs-function">(<span class="hljs-params">event, session</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (session) {
        <span class="hljs-comment">// User is logged in, redirect to dashboard</span>
        router.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;/dashboard&#x27;</span>)
      }
    })

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> subscription.<span class="hljs-title function_">unsubscribe</span>()
  }, [supabase, router])

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex justify-center items-center min-h-screen&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;w-full max-w-md p-8&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-2xl font-bold mb-4&quot;</span>&gt;</span>Welcome to HOMEase<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Auth</span>
          <span class="hljs-attr">supabaseClient</span>=<span class="hljs-string">{supabase}</span>
          <span class="hljs-attr">appearance</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">theme:</span> <span class="hljs-attr">ThemeSupa</span> }}
          <span class="hljs-attr">providers</span>=<span class="hljs-string">{[</span>&#x27;<span class="hljs-attr">google</span>&#x27;]} // <span class="hljs-attr">Example:</span> <span class="hljs-attr">Add</span> <span class="hljs-attr">social</span> <span class="hljs-attr">providers</span>
          <span class="hljs-attr">redirectTo</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">process.env.NEXT_PUBLIC_BASE_URL</span>}/<span class="hljs-attr">auth</span>/<span class="hljs-attr">callback</span>`}
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><em>Note: You'll need to create an <code>auth/callback</code> route handler as per Supabase documentation to handle OAuth redirects.</em></p>
<h5 id="22-session-management-with-middleware"><strong>2.2. Session Management with Middleware</strong></h5>
<p>Middleware is crucial for maintaining the user's session by refreshing the auth cookie on every request. It also serves as the gatekeeper for protected routes.</p>
<p><code>src/middleware.ts</code></p>
<pre><code class="language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextResponse</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">NextRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/server&#x27;</span>
<span class="hljs-keyword">import</span> { createServerClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@supabase/ssr&#x27;</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params">request: NextRequest</span>) {
  <span class="hljs-keyword">let</span> response = <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>({
    <span class="hljs-attr">request</span>: {
      <span class="hljs-attr">headers</span>: request.<span class="hljs-property">headers</span>,
    },
  })

  <span class="hljs-keyword">const</span> supabase = <span class="hljs-title function_">createServerClient</span>(
    process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_SUPABASE_URL</span>!,
    process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_SUPABASE_ANON_KEY</span>!,
    {
      <span class="hljs-attr">cookies</span>: {
        <span class="hljs-title function_">get</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
          <span class="hljs-keyword">return</span> request.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">get</span>(name)?.<span class="hljs-property">value</span>
        },
        <span class="hljs-title function_">set</span>(<span class="hljs-params">name, value, options</span>) {
          request.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">set</span>({ name, value, ...options })
          response = <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>({
            <span class="hljs-attr">request</span>: {
              <span class="hljs-attr">headers</span>: request.<span class="hljs-property">headers</span>,
            },
          })
          response.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">set</span>({ name, value, ...options })
        },
        <span class="hljs-title function_">remove</span>(<span class="hljs-params">name, options</span>) {
          request.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">delete</span>({ name, ...options })
          response = <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>({
            <span class="hljs-attr">request</span>: {
              <span class="hljs-attr">headers</span>: request.<span class="hljs-property">headers</span>,
            },
          })
          response.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">delete</span>({ name, ...options })
        },
      },
    }
  )

  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: { user } } = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">auth</span>.<span class="hljs-title function_">getUser</span>()

  <span class="hljs-comment">// Protect routes</span>
  <span class="hljs-keyword">if</span> (!user &amp;&amp; request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;/dashboard&#x27;</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, request.<span class="hljs-property">url</span>))
  }

  <span class="hljs-keyword">return</span> response
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">matcher</span>: [
    <span class="hljs-comment">/*
     * Match all request paths except for the ones starting with:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * Feel free to modify this pattern to include more paths.
     */</span>
    <span class="hljs-string">&#x27;/((?!_next/static|_next/image|favicon.ico).*)&#x27;</span>,
  ],
}
</code></pre>
<hr>
<h4 id="3-user-roles--row-level-security-rls"><strong>3. User Roles &amp; Row Level Security (RLS)</strong></h4>
<p>This is the most critical part of the security architecture, replacing Firebase Custom Claims and Firestore Rules with Supabase's powerful PostgreSQL-based RLS.</p>
<h5 id="31-database-schema-for-user-profiles-and-roles"><strong>3.1. Database Schema for User Profiles and Roles</strong></h5>
<p>We will create a <code>profiles</code> table that is linked one-to-one with Supabase's built-in <code>auth.users</code> table. This table will store public user information and their role.</p>
<p><strong>1. Create Role Enum Type:</strong>
In the Supabase SQL Editor (<code>database.new</code> -&gt; SQL Editor), run this query to define the possible user roles.</p>
<pre><code class="language-sql"><span class="hljs-comment">-- Create a custom type for user roles</span>
<span class="hljs-keyword">CREATE</span> TYPE user_role <span class="hljs-keyword">AS</span> ENUM (<span class="hljs-string">&#x27;homeowner&#x27;</span>, <span class="hljs-string">&#x27;contractor&#x27;</span>, <span class="hljs-string">&#x27;admin&#x27;</span>);
</code></pre>
<p><strong>2. Create <code>profiles</code> Table:</strong></p>
<pre><code class="language-sql"><span class="hljs-comment">-- Create the profiles table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.profiles (
  id UUID <span class="hljs-keyword">PRIMARY</span> KEY <span class="hljs-keyword">REFERENCES</span> auth.users(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  updated_at TIMESTAMPTZ,
  full_name TEXT,
  avatar_url TEXT,
  role user_role <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;homeowner&#x27;</span>
);

<span class="hljs-comment">-- Set up Row Level Security (RLS)</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> public.profiles ENABLE <span class="hljs-type">ROW</span> LEVEL SECURITY;
</code></pre>
<h5 id="32-automating-profile-and-role-creation-with-a-database-trigger"><strong>3.2. Automating Profile and Role Creation with a Database Trigger</strong></h5>
<p>To ensure every new user gets a profile entry and a default role, we'll create a PostgreSQL function and trigger it automatically whenever a new user signs up.</p>
<p><strong>SQL to run in Supabase SQL Editor:</strong></p>
<pre><code class="language-sql"><span class="hljs-comment">-- This trigger automatically creates a profile entry for new users.</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> public.handle_new_user()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> public.profiles (id, full_name, avatar_url, role)
  <span class="hljs-keyword">VALUES</span> (
    new.id,
    new.raw_user_meta_data<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">&#x27;full_name&#x27;</span>,
    new.raw_user_meta_data<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">&#x27;avatar_url&#x27;</span>,
    <span class="hljs-string">&#x27;homeowner&#x27;</span> <span class="hljs-comment">-- Assign &#x27;homeowner&#x27; as the default role</span>
  );
  <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">new</span>;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql SECURITY DEFINER;

<span class="hljs-comment">-- Trigger the function after a new user is created</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> on_auth_user_created
  AFTER <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> auth.users
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-type">ROW</span> <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> public.handle_new_user();
</code></pre>
<p>This server-side logic is more secure and reliable than assigning roles on the client. Admins can later change a user's role directly in the <code>profiles</code> table.</p>
<h5 id="33-implementing-row-level-security-rls-policies"><strong>3.3. Implementing Row Level Security (RLS) Policies</strong></h5>
<p>RLS policies are PostgreSQL rules that restrict which rows users can access or modify. They are the cornerstone of our data security.</p>
<p><strong>Policy 1: Users can only view and update their own profile.</strong></p>
<pre><code class="language-sql"><span class="hljs-comment">-- Users can view their own profile</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Users can view their own profile.&quot;
  <span class="hljs-keyword">ON</span> public.profiles <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">USING</span> ( auth.uid() <span class="hljs-operator">=</span> id );

<span class="hljs-comment">-- Users can update their own profile</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Users can update own profile.&quot;
  <span class="hljs-keyword">ON</span> public.profiles <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>
  <span class="hljs-keyword">USING</span> ( auth.uid() <span class="hljs-operator">=</span> id );
</code></pre>
<p><strong>Policy 2 (Example for a future <code>leads</code> table): Homeowners can only see leads they created.</strong>
Assume a <code>leads</code> table exists with a <code>homeowner_id</code> column of type <code>UUID</code>.</p>
<pre><code class="language-sql"><span class="hljs-comment">-- Enable RLS on the leads table</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> public.leads ENABLE <span class="hljs-type">ROW</span> LEVEL SECURITY;

<span class="hljs-comment">-- Policy for homeowners to access their leads</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Homeowners can view their own leads.&quot;
  <span class="hljs-keyword">ON</span> public.leads <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">USING</span> ( auth.uid() <span class="hljs-operator">=</span> homeowner_id );
</code></pre>
<p><strong>Policy 3 (Example): Contractors can only see leads they are matched with.</strong>
Assume a <code>lead_matches</code> table exists linking <code>lead_id</code> and <code>contractor_id</code>.</p>
<pre><code class="language-sql"><span class="hljs-comment">-- Policy for contractors to view matched leads</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Contractors can view matched leads.&quot;
  <span class="hljs-keyword">ON</span> public.leads <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">USING</span> (
    <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> lead_matches
      <span class="hljs-keyword">WHERE</span> lead_matches.lead_id <span class="hljs-operator">=</span> leads.id
      <span class="hljs-keyword">AND</span> lead_matches.contractor_id <span class="hljs-operator">=</span> auth.uid()
    )
  );
</code></pre>
<p><strong>Policy 4: Admins have full access.</strong>
We can create a policy that checks the user's role from the <code>profiles</code> table.</p>
<pre><code class="language-sql"><span class="hljs-comment">-- Function to get the current user&#x27;s role</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> get_my_role()
<span class="hljs-keyword">RETURNS</span> user_role <span class="hljs-keyword">AS</span> $$
  <span class="hljs-keyword">SELECT</span> role <span class="hljs-keyword">FROM</span> public.profiles <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> auth.uid()
$$ <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">sql</span> STABLE;

<span class="hljs-comment">-- Admin full access policy on profiles table</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Admins have full access to profiles.&quot;
  <span class="hljs-keyword">ON</span> public.profiles <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-keyword">USING</span> ( get_my_role() <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;admin&#x27;</span> );
</code></pre>
<p><em>Note: This admin policy must be combined with the user-specific policies. RLS policies are permissive, meaning if any <code>SELECT</code> policy returns true, access is granted.</em></p>
<hr>
<h4 id="4-user-profile-management"><strong>4. User Profile Management</strong></h4>
<p>Finally, we'll create a page where authenticated users can manage their profile information.</p>
<h5 id="41-building-the-profile-page-ui"><strong>4.1. Building the Profile Page UI</strong></h5>
<p>We'll use a Server Component to fetch initial data and a Client Component form to handle user input and interaction.</p>
<p><code>src/app/dashboard/account/page.tsx</code></p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> { createClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/lib/supabase/server&quot;</span>;
<span class="hljs-keyword">import</span> { redirect } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next/navigation&quot;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AccountForm</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./account-form&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AccountPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> supabase = <span class="hljs-title function_">createClient</span>();

  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: { user } } = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">auth</span>.<span class="hljs-title function_">getUser</span>();

  <span class="hljs-keyword">if</span> (!user) {
    <span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/login&quot;</span>);
  }

  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: profile, error } = <span class="hljs-keyword">await</span> supabase
    .<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;profiles&#x27;</span>)
    .<span class="hljs-title function_">select</span>(<span class="hljs-string">&#x27;full_name, avatar_url&#x27;</span>)
    .<span class="hljs-title function_">eq</span>(<span class="hljs-string">&#x27;id&#x27;</span>, user.<span class="hljs-property">id</span>)
    .<span class="hljs-title function_">single</span>();

  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Error fetching profile:&#x27;</span>, error);
    <span class="hljs-comment">// Handle error appropriately</span>
  }

  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AccountForm</span> <span class="hljs-attr">user</span>=<span class="hljs-string">{user}</span> <span class="hljs-attr">profile</span>=<span class="hljs-string">{profile}</span> /&gt;</span></span>;
}
</code></pre>
<h5 id="42-securely-fetching-and-updating-profile-data-with-server-actions"><strong>4.2. Securely Fetching and Updating Profile Data with Server Actions</strong></h5>
<p>The <code>AccountForm</code> will be a Client Component that uses a Server Action to securely update the user's data on the backend. This prevents exposing API endpoints.</p>
<p><code>src/app/dashboard/account/account-form.tsx</code></p>
<pre><code class="language-tsx"><span class="hljs-string">&#x27;use client&#x27;</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@supabase/supabase-js&#x27;</span>
<span class="hljs-keyword">import</span> { updateProfile } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./actions&#x27;</span>
<span class="hljs-keyword">import</span> { useFormState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-dom&#x27;</span>

type <span class="hljs-title class_">Profile</span> = { <span class="hljs-attr">full_name</span>: string | <span class="hljs-literal">null</span>; <span class="hljs-attr">avatar_url</span>: string | <span class="hljs-literal">null</span>; } | <span class="hljs-literal">null</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AccountForm</span>(<span class="hljs-params">{ user, profile }: { user: User, profile: Profile }</span>) {
  <span class="hljs-keyword">const</span> initialState = { <span class="hljs-attr">message</span>: <span class="hljs-literal">null</span> };
  <span class="hljs-keyword">const</span> [state, formAction] = <span class="hljs-title function_">useFormState</span>(updateProfile, initialState);

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">{formAction}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-semibold&quot;</span>&gt;</span>Account Details<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Email: {user.email}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-4&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">&quot;fullName&quot;</span>&gt;</span>Full Name<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
          <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;fullName&quot;</span>
          <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;fullName&quot;</span>
          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span>
          <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">{profile?.full_name</span> || &#x27;&#x27;}
          <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;w-full p-2 border rounded&quot;</span>
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* Add other fields like avatar_url */}
      
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-4 px-4 py-2 bg-blue-600 text-white rounded&quot;</span>&gt;</span>
        Update Profile
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {state?.message &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-red-500 mt-2&quot;</span>&gt;</span>{state.message}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  )
}
</code></pre>
<p><code>src/app/dashboard/account/actions.ts</code></p>
<pre><code class="language-ts"><span class="hljs-string">&#x27;use server&#x27;</span>
<span class="hljs-keyword">import</span> { createClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/lib/supabase/server&quot;</span>;
<span class="hljs-keyword">import</span> { revalidatePath } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next/cache&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateProfile</span>(<span class="hljs-params">prevState: <span class="hljs-built_in">any</span>, formData: FormData</span>) {
  <span class="hljs-keyword">const</span> supabase = <span class="hljs-title function_">createClient</span>();
  
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: { user } } = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">auth</span>.<span class="hljs-title function_">getUser</span>();
  <span class="hljs-keyword">if</span> (!user) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Authentication required.&#x27;</span> };
  }

  <span class="hljs-keyword">const</span> fullName = formData.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;fullName&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;

  <span class="hljs-keyword">const</span> { error } = <span class="hljs-keyword">await</span> supabase.<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;profiles&#x27;</span>).<span class="hljs-title function_">update</span>({
    <span class="hljs-attr">full_name</span>: fullName,
    <span class="hljs-attr">updated_at</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
  }).<span class="hljs-title function_">eq</span>(<span class="hljs-string">&#x27;id&#x27;</span>, user.<span class="hljs-property">id</span>);

  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Update profile error:&#x27;</span>, error);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Failed to update profile.&#x27;</span> };
  }

  <span class="hljs-title function_">revalidatePath</span>(<span class="hljs-string">&#x27;/dashboard/account&#x27;</span>); <span class="hljs-comment">// Re-renders the page with new data</span>
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Profile updated successfully!&#x27;</span> };
}
</code></pre>
<p>This completes the foundational setup. We now have a secure, role-aware application base ready for the next phases of development, including the AR assessment, lead management, and contractor matching features.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;foundation_auth&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Platform Foundation &amp; Authentication with Next.js and Supabase&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Frontend Development (Next.js), Backend Development (Supabase Auth)&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="database-architecture-backend-development-supabase-postgresql-specialist">Database Architecture, Backend Development (Supabase, PostgreSQL) Specialist</h3>
<h3 id="comprehensive-technical-architecture-plan-homease--ai-1"><strong>Comprehensive Technical Architecture Plan: HOMEase | AI</strong></h3>
<h3 id="subtask-supabase-database-schema-design-and-implementation"><strong>Subtask: Supabase Database Schema Design and Implementation</strong></h3>
<p>This document provides the complete database schema and security policy implementation for the HOMEase platform using Supabase's PostgreSQL database. This schema replaces the original Firebase Firestore model, leveraging the power of relational data, structured types, and PostgreSQL's robust Row Level Security (RLS) to ensure data integrity and security.</p>
<hr>
<h4 id="1-schema-design-philosophy"><strong>1. Schema Design Philosophy</strong></h4>
<p>The schema is designed around a relational model to enforce data consistency and integrity, which is a significant advantage over a NoSQL structure for this application's needs.</p>
<ul>
<li><strong>Normalization:</strong> Data is normalized to reduce redundancy. For example, contractor-specific details are in a separate table, linked to the main user profile.</li>
<li><strong>UUIDs as Primary Keys:</strong> We use <code>uuid</code> for all primary keys (<code>id</code> columns), generated by <code>gen_random_uuid()</code>. This prevents enumeration attacks and simplifies integration with various services.</li>
<li><strong>Foreign Key Constraints:</strong> Relationships are strictly enforced using foreign key constraints with appropriate <code>ON DELETE</code> actions (e.g., <code>CASCADE</code> for dependent data, <code>SET NULL</code> for optional relationships).</li>
<li><strong>Custom Types (ENUMs):</strong> PostgreSQL's <code>ENUM</code> types are used for fields with a fixed set of possible values (e.g., user roles, project statuses). This improves data integrity and readability.</li>
<li><strong>JSONB for Flexibility:</strong> The <code>jsonb</code> data type is used for semi-structured data like AR analysis results, addresses, or proposal details, offering a balance between structure and flexibility.</li>
</ul>
<hr>
<h4 id="2-sql-implementation-types-tables-and-relationships"><strong>2. SQL Implementation: Types, Tables, and Relationships</strong></h4>
<p>Execute the following SQL statements in your Supabase project's SQL Editor.</p>
<h5 id="21-custom-data-types-enums"><strong>2.1. Custom Data Types (ENUMs)</strong></h5>
<p>First, we define the custom types that will be used across multiple tables.</p>
<pre><code class="language-sql"><span class="hljs-comment">-- From previous step, ensure this exists</span>
<span class="hljs-comment">-- CREATE TYPE user_role AS ENUM (&#x27;homeowner&#x27;, &#x27;contractor&#x27;, &#x27;admin&#x27;);</span>

<span class="hljs-comment">-- New types for the application domain</span>
<span class="hljs-keyword">CREATE</span> TYPE project_status <span class="hljs-keyword">AS</span> ENUM (<span class="hljs-string">&#x27;draft&#x27;</span>, <span class="hljs-string">&#x27;open_for_bids&#x27;</span>, <span class="hljs-string">&#x27;in_progress&#x27;</span>, <span class="hljs-string">&#x27;completed&#x27;</span>, <span class="hljs-string">&#x27;cancelled&#x27;</span>);
<span class="hljs-keyword">CREATE</span> TYPE urgency_level <span class="hljs-keyword">AS</span> ENUM (<span class="hljs-string">&#x27;low&#x27;</span>, <span class="hljs-string">&#x27;medium&#x27;</span>, <span class="hljs-string">&#x27;high&#x27;</span>);
<span class="hljs-keyword">CREATE</span> TYPE verification_status <span class="hljs-keyword">AS</span> ENUM (<span class="hljs-string">&#x27;pending&#x27;</span>, <span class="hljs-string">&#x27;approved&#x27;</span>, <span class="hljs-string">&#x27;rejected&#x27;</span>);
<span class="hljs-keyword">CREATE</span> TYPE match_status <span class="hljs-keyword">AS</span> ENUM (<span class="hljs-string">&#x27;matched&#x27;</span>, <span class="hljs-string">&#x27;viewed&#x27;</span>, <span class="hljs-string">&#x27;declined&#x27;</span>, <span class="hljs-string">&#x27;proposal_sent&#x27;</span>, <span class="hljs-string">&#x27;proposal_accepted&#x27;</span>);
<span class="hljs-keyword">CREATE</span> TYPE payment_status <span class="hljs-keyword">AS</span> ENUM (<span class="hljs-string">&#x27;succeeded&#x27;</span>, <span class="hljs-string">&#x27;pending&#x27;</span>, <span class="hljs-string">&#x27;failed&#x27;</span>);
</code></pre>
<h5 id="22-core-user-and-profile-tables"><strong>2.2. Core User and Profile Tables</strong></h5>
<p>These tables handle user identity and role-specific data.</p>
<p><strong>Table: <code>profiles</code></strong> (Extends <code>auth.users</code>)
<em>Purpose: Stores common user data and the critical <code>role</code> field.</em></p>
<pre><code class="language-sql"><span class="hljs-comment">-- This table should exist from the foundation_auth subtask.</span>
<span class="hljs-comment">-- If not, create it as follows:</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.profiles (
  id UUID <span class="hljs-keyword">PRIMARY</span> KEY <span class="hljs-keyword">REFERENCES</span> auth.users(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  updated_at TIMESTAMPTZ,
  full_name TEXT,
  avatar_url TEXT,
  role user_role <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;homeowner&#x27;</span>
);
</code></pre>
<p><strong>Table: <code>contractor_details</code></strong>
<em>Purpose: Stores detailed information specific to contractors, including verification status and payment details.</em></p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.contractor_details (
  profile_id UUID <span class="hljs-keyword">PRIMARY</span> KEY <span class="hljs-keyword">REFERENCES</span> public.profiles(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  company_name TEXT,
  bio TEXT,
  website_url TEXT,
  phone_number TEXT,
  address JSONB, <span class="hljs-comment">-- { &quot;street&quot;: &quot;...&quot;, &quot;city&quot;: &quot;...&quot;, &quot;state&quot;: &quot;...&quot;, &quot;zip&quot;: &quot;...&quot; }</span>
  service_radius_miles <span class="hljs-type">INT</span>,
  is_caps_certified <span class="hljs-type">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">false</span>,
  license_number TEXT,
  insurance_details JSONB, <span class="hljs-comment">-- { &quot;provider&quot;: &quot;...&quot;, &quot;policy_number&quot;: &quot;...&quot;, &quot;expiry_date&quot;: &quot;...&quot; }</span>
  verification_status verification_status <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;pending&#x27;</span>,
  stripe_connect_id TEXT <span class="hljs-keyword">UNIQUE</span>, <span class="hljs-comment">-- For Stripe Connect onboarding</span>
  created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> NOW(),
  updated_at TIMESTAMPTZ
);
</code></pre>
<h5 id="23-project-and-assessment-tables"><strong>2.3. Project and Assessment Tables</strong></h5>
<p>These tables form the core of the lead generation workflow.</p>
<p><strong>Table: <code>projects</code></strong> (The &quot;Lead&quot;)
<em>Purpose: Represents a homeowner's modification project, which becomes a lead for contractors.</em></p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.projects (
  id UUID <span class="hljs-keyword">PRIMARY</span> KEY <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
  homeowner_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> public.profiles(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  selected_contractor_id UUID <span class="hljs-keyword">REFERENCES</span> public.profiles(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">SET</span> <span class="hljs-keyword">NULL</span>,
  title TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  description TEXT,
  address JSONB <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  urgency urgency_level <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  budget_range TEXT, <span class="hljs-comment">-- e.g., &quot;$5k-$10k&quot;</span>
  status project_status <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;draft&#x27;</span>,
  created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> NOW(),
  updated_at TIMESTAMPTZ
);
</code></pre>
<p><strong>Table: <code>ar_assessments</code></strong>
<em>Purpose: Stores the results from the AR scan and subsequent AI analysis.</em></p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.ar_assessments (
  id UUID <span class="hljs-keyword">PRIMARY</span> KEY <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
  project_id UUID <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> public.projects(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  room_type TEXT,
  accessibility_score <span class="hljs-type">INT</span> <span class="hljs-keyword">CHECK</span> (accessibility_score <span class="hljs-operator">&gt;=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> accessibility_score <span class="hljs-operator">&lt;=</span> <span class="hljs-number">100</span>),
  gemini_analysis_raw JSONB,
  identified_hazards JSONB, <span class="hljs-comment">-- Array of objects: [{ &quot;hazard&quot;: &quot;...&quot;, &quot;details&quot;: &quot;...&quot; }]</span>
  recommendations JSONB, <span class="hljs-comment">-- Array of objects: [{ &quot;recommendation&quot;: &quot;...&quot;, &quot;details&quot;: &quot;...&quot; }]</span>
  fal_ai_visualization_urls TEXT[], <span class="hljs-comment">-- Array of URLs</span>
  created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> NOW()
);
</code></pre>
<p><strong>Table: <code>assessment_media</code></strong>
<em>Purpose: Stores references to images/videos from an AR scan, linked to Supabase Storage.</em></p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.assessment_media (
  id UUID <span class="hljs-keyword">PRIMARY</span> KEY <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
  assessment_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> public.ar_assessments(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  storage_path TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- e.g., &#x27;assessment-media/project_id/file.jpg&#x27;</span>
  media_type TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- &#x27;image&#x27; or &#x27;video&#x27;</span>
  uploaded_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> NOW()
);
</code></pre>
<h5 id="24-interaction-and-transaction-tables"><strong>2.4. Interaction and Transaction Tables</strong></h5>
<p>These tables manage the interactions between homeowners and contractors.</p>
<p><strong>Table: <code>project_matches</code></strong>
<em>Purpose: Tracks which contractors are matched with a project and the status of their engagement.</em></p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.project_matches (
  id UUID <span class="hljs-keyword">PRIMARY</span> KEY <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
  project_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> public.projects(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  contractor_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> public.profiles(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  status match_status <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;matched&#x27;</span>,
  proposal_details JSONB, <span class="hljs-comment">-- The &quot;Dynamic Scope Builder&quot; output</span>
  proposed_cost <span class="hljs-type">NUMERIC</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>),
  created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> NOW(),
  updated_at TIMESTAMPTZ,
  <span class="hljs-keyword">UNIQUE</span>(project_id, contractor_id) <span class="hljs-comment">-- A contractor can only be matched to a project once</span>
);
</code></pre>
<p><strong>Table: <code>messages</code></strong>
<em>Purpose: A simple, real-time messaging system scoped to a specific project match.</em></p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.messages (
  id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY GENERATED ALWAYS <span class="hljs-keyword">AS</span> <span class="hljs-keyword">IDENTITY</span>,
  project_match_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> public.project_matches(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  sender_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> public.profiles(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  content TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> NOW()
);
</code></pre>
<p><strong>Table: <code>payments</code></strong>
<em>Purpose: Records all financial transactions processed via Stripe.</em></p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.payments (
  id UUID <span class="hljs-keyword">PRIMARY</span> KEY <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
  project_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> public.projects(id),
  payer_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> public.profiles(id), <span class="hljs-comment">-- Homeowner</span>
  payee_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> public.profiles(id), <span class="hljs-comment">-- Contractor</span>
  stripe_charge_id TEXT <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  amount_cents <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- Store amount in cents to avoid floating point issues</span>
  currency TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;usd&#x27;</span>,
  status payment_status <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> NOW()
);
</code></pre>
<p><strong>Table: <code>reviews</code></strong>
<em>Purpose: Allows homeowners to leave reviews for contractors upon project completion.</em></p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.reviews (
  id UUID <span class="hljs-keyword">PRIMARY</span> KEY <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
  project_id UUID <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> public.projects(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  reviewer_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> public.profiles(id), <span class="hljs-comment">-- Homeowner</span>
  reviewee_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> public.profiles(id), <span class="hljs-comment">-- Contractor</span>
  rating <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">CHECK</span> (rating <span class="hljs-operator">&gt;=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> rating <span class="hljs-operator">&lt;=</span> <span class="hljs-number">5</span>),
  comment TEXT,
  created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> NOW()
);
</code></pre>
<hr>
<h4 id="3-row-level-security-rls-policies"><strong>3. Row Level Security (RLS) Policies</strong></h4>
<p>RLS is the cornerstone of data security in this architecture. The following policies restrict data access based on the authenticated user's ID and role.</p>
<p><strong>First, enable RLS on all tables:</strong></p>
<pre><code class="language-sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> public.profiles ENABLE <span class="hljs-type">ROW</span> LEVEL SECURITY;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> public.contractor_details ENABLE <span class="hljs-type">ROW</span> LEVEL SECURITY;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> public.projects ENABLE <span class="hljs-type">ROW</span> LEVEL SECURITY;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> public.ar_assessments ENABLE <span class="hljs-type">ROW</span> LEVEL SECURITY;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> public.assessment_media ENABLE <span class="hljs-type">ROW</span> LEVEL SECURITY;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> public.project_matches ENABLE <span class="hljs-type">ROW</span> LEVEL SECURITY;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> public.messages ENABLE <span class="hljs-type">ROW</span> LEVEL SECURITY;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> public.payments ENABLE <span class="hljs-type">ROW</span> LEVEL SECURITY;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> public.reviews ENABLE <span class="hljs-type">ROW</span> LEVEL SECURITY;
</code></pre>
<p><strong>Helper Function to get user role (if not already created):</strong></p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> get_my_role()
<span class="hljs-keyword">RETURNS</span> user_role <span class="hljs-keyword">AS</span> $$
  <span class="hljs-keyword">SELECT</span> role <span class="hljs-keyword">FROM</span> public.profiles <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> auth.uid()
$$ <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">sql</span> STABLE;
</code></pre>
<h5 id="31-profiles-policies"><strong>3.1. <code>profiles</code> Policies</strong></h5>
<ul>
<li><strong>Logic:</strong> Users can see and edit their own profile. Authenticated users can see other profiles (for viewing contractor/homeowner info). Admins can do anything.</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">-- Users can view their own profile</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Users can view their own profile&quot; <span class="hljs-keyword">ON</span> public.profiles
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (auth.uid() <span class="hljs-operator">=</span> id);

<span class="hljs-comment">-- Authenticated users can view other profiles</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Authenticated users can view other profiles&quot; <span class="hljs-keyword">ON</span> public.profiles
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (auth.role() <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;authenticated&#x27;</span>);

<span class="hljs-comment">-- Users can update their own profile</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Users can update their own profile&quot; <span class="hljs-keyword">ON</span> public.profiles
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">USING</span> (auth.uid() <span class="hljs-operator">=</span> id);

<span class="hljs-comment">-- Admins have full access</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Admins have full access to profiles&quot; <span class="hljs-keyword">ON</span> public.profiles
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">USING</span> (get_my_role() <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;admin&#x27;</span>);
</code></pre>
<h5 id="32-contractor_details-policies"><strong>3.2. <code>contractor_details</code> Policies</strong></h5>
<ul>
<li><strong>Logic:</strong> Anyone can view approved contractor details. Only the contractor themselves or an admin can create/update their details.</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">-- Anyone can view approved contractor details</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Public can view approved contractor details&quot; <span class="hljs-keyword">ON</span> public.contractor_details
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (verification_status <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;approved&#x27;</span>);

<span class="hljs-comment">-- Contractor can view their own details regardless of status</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Contractors can view their own details&quot; <span class="hljs-keyword">ON</span> public.contractor_details
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (auth.uid() <span class="hljs-operator">=</span> profile_id);

<span class="hljs-comment">-- Contractor can create/update their own details</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Contractors can manage their own details&quot; <span class="hljs-keyword">ON</span> public.contractor_details
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">USING</span> (auth.uid() <span class="hljs-operator">=</span> profile_id);

<span class="hljs-comment">-- Admins have full access</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Admins have full access to contractor details&quot; <span class="hljs-keyword">ON</span> public.contractor_details
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">USING</span> (get_my_role() <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;admin&#x27;</span>);
</code></pre>
<h5 id="33-projects-and-ar_assessments-policies"><strong>3.3. <code>projects</code> and <code>ar_assessments</code> Policies</strong></h5>
<ul>
<li><strong>Logic:</strong> Homeowners can manage their own projects. Matched contractors can view project details. The selected contractor can view. Admins can view all.</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">-- For projects table</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Homeowners can manage their own projects&quot; <span class="hljs-keyword">ON</span> public.projects
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">USING</span> (auth.uid() <span class="hljs-operator">=</span> homeowner_id);

<span class="hljs-keyword">CREATE</span> POLICY &quot;Matched contractors can view projects&quot; <span class="hljs-keyword">ON</span> public.projects
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (
    <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> project_matches
      <span class="hljs-keyword">WHERE</span> project_matches.project_id <span class="hljs-operator">=</span> projects.id <span class="hljs-keyword">AND</span> project_matches.contractor_id <span class="hljs-operator">=</span> auth.uid()
    )
  );

<span class="hljs-comment">-- For ar_assessments and assessment_media (same logic, just change table name)</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Users can manage assessments for their own projects&quot; <span class="hljs-keyword">ON</span> public.ar_assessments
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">USING</span> (
    <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> projects
      <span class="hljs-keyword">WHERE</span> projects.id <span class="hljs-operator">=</span> ar_assessments.project_id <span class="hljs-keyword">AND</span> projects.homeowner_id <span class="hljs-operator">=</span> auth.uid()
    )
  );

<span class="hljs-keyword">CREATE</span> POLICY &quot;Matched contractors can view assessments&quot; <span class="hljs-keyword">ON</span> public.ar_assessments
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (
    <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> projects p
      <span class="hljs-keyword">JOIN</span> project_matches pm <span class="hljs-keyword">ON</span> p.id <span class="hljs-operator">=</span> pm.project_id
      <span class="hljs-keyword">WHERE</span> p.id <span class="hljs-operator">=</span> ar_assessments.project_id <span class="hljs-keyword">AND</span> pm.contractor_id <span class="hljs-operator">=</span> auth.uid()
    )
  );
</code></pre>
<p><em>(Note: Create similar policies for <code>assessment_media</code> referencing its <code>assessment_id</code>)</em></p>
<h5 id="34-project_matches-policies"><strong>3.4. <code>project_matches</code> Policies</strong></h5>
<ul>
<li><strong>Logic:</strong> The associated homeowner and contractor can view their match.</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> POLICY &quot;Involved parties can view project matches&quot; <span class="hljs-keyword">ON</span> public.project_matches
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (
    auth.uid() <span class="hljs-operator">=</span> contractor_id <span class="hljs-keyword">OR</span>
    <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> projects
      <span class="hljs-keyword">WHERE</span> projects.id <span class="hljs-operator">=</span> project_matches.project_id <span class="hljs-keyword">AND</span> projects.homeowner_id <span class="hljs-operator">=</span> auth.uid()
    )
  );
</code></pre>
<h5 id="35-messages-policies"><strong>3.5. <code>messages</code> Policies</strong></h5>
<ul>
<li><strong>Logic:</strong> Only the sender or receiver of a message (determined via the <code>project_match</code>) can access it.</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> POLICY &quot;Parties in a match can access their messages&quot; <span class="hljs-keyword">ON</span> public.messages
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">USING</span> (
    <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> project_matches pm
      <span class="hljs-keyword">JOIN</span> projects p <span class="hljs-keyword">ON</span> pm.project_id <span class="hljs-operator">=</span> p.id
      <span class="hljs-keyword">WHERE</span> pm.id <span class="hljs-operator">=</span> messages.project_match_id
        <span class="hljs-keyword">AND</span> (auth.uid() <span class="hljs-operator">=</span> pm.contractor_id <span class="hljs-keyword">OR</span> auth.uid() <span class="hljs-operator">=</span> p.homeowner_id)
    )
  );
</code></pre>
<h5 id="36-reviews-policies"><strong>3.6. <code>reviews</code> Policies</strong></h5>
<ul>
<li><strong>Logic:</strong> Reviews are public to read. Only the homeowner of a completed project can create a review for that project.</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">-- Reviews are public</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Reviews are public&quot; <span class="hljs-keyword">ON</span> public.reviews
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (<span class="hljs-literal">true</span>);

<span class="hljs-comment">-- Homeowner can create a review for their completed project</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Homeowners can create reviews for their projects&quot; <span class="hljs-keyword">ON</span> public.reviews
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">CHECK</span> (
    auth.uid() <span class="hljs-operator">=</span> reviewer_id <span class="hljs-keyword">AND</span>
    <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> projects
      <span class="hljs-keyword">WHERE</span> projects.id <span class="hljs-operator">=</span> reviews.project_id
        <span class="hljs-keyword">AND</span> projects.homeowner_id <span class="hljs-operator">=</span> auth.uid()
        <span class="hljs-keyword">AND</span> projects.status <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;completed&#x27;</span>
    )
  );
</code></pre>
<p>This comprehensive schema provides a secure, scalable, and relationally-sound foundation for the HOMEase application, fully replacing the original Firebase/GCP data layer with the powerful capabilities of Supabase and PostgreSQL.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;db_schema&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Supabase Database Schema Design and Implementation&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Database Architecture, Backend Development (Supabase, PostgreSQL)&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="devops-cicd-github-actions-vercel-platform-specialist">DevOps, CI/CD (GitHub Actions), Vercel Platform Specialist</h3>
<h3 id="comprehensive-technical-architecture-plan-homease--ai-2"><strong>Comprehensive Technical Architecture Plan: HOMEase | AI</strong></h3>
<h3 id="subtask-deployment-hosting-and-devops-pipeline-on-vercel"><strong>Subtask: Deployment, Hosting, and DevOps Pipeline on Vercel</strong></h3>
<p>This document outlines the hosting, deployment, and Continuous Integration/Continuous Deployment (CI/CD) strategy for the HOMEase | AI platform. We will leverage Vercel as the hosting platform due to its first-class support for Next.js and GitHub Actions for our CI pipeline. This combination provides a robust, automated workflow from development to production, ensuring code quality and rapid iteration.</p>
<hr>
<h4 id="1-hosting-strategy-vercel-for-nextjs"><strong>1. Hosting Strategy: Vercel for Next.js</strong></h4>
<p>Vercel is the creator of Next.js and is the optimal hosting platform for this project. It is designed to handle the specific needs of the Next.js App Router, including Server Components, Server Actions, and advanced caching strategies.</p>
<p><strong>Key Advantages:</strong></p>
<ul>
<li><strong>Seamless Integration:</strong> Vercel automatically detects and optimizes Next.js projects with zero configuration.</li>
<li><strong>Performance:</strong> A global Edge Network serves static assets and caches function responses close to users, ensuring low latency worldwide.</li>
<li><strong>Preview Deployments:</strong> For every Git commit and pull request, Vercel generates a unique, shareable preview URL. This is invaluable for QA, stakeholder reviews, and collaborative development, effectively serving as an on-demand staging environment.</li>
<li><strong>Scalability:</strong> The serverless architecture scales automatically with traffic, eliminating the need for manual server management.</li>
<li><strong>Integrated CI/CD:</strong> Vercel's Git integration provides a powerful, out-of-the-box deployment pipeline that we will augment with GitHub Actions for quality assurance.</li>
</ul>
<hr>
<h4 id="2-environment-strategy"><strong>2. Environment Strategy</strong></h4>
<p>To ensure stability and data integrity, we will maintain distinct environments, each with its own dedicated Supabase project. This isolates production data from development and testing activities.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Environment</th>
<th style="text-align:left">Purpose</th>
<th style="text-align:left">Supabase Project</th>
<th style="text-align:left">Git Branch (Typical)</th>
<th style="text-align:left">Deployment Trigger</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>Local</strong></td>
<td style="text-align:left">Individual developer machines for feature development and initial testing.</td>
<td style="text-align:left">Dev Supabase Project</td>
<td style="text-align:left">Feature branches</td>
<td style="text-align:left"><code>npm run dev</code></td>
</tr>
<tr>
<td style="text-align:left"><strong>Preview</strong></td>
<td style="text-align:left">Automatically generated for every Pull Request. Used for code reviews, QA, and end-to-end testing.</td>
<td style="text-align:left">Staging Supabase</td>
<td style="text-align:left">PR branches</td>
<td style="text-align:left">Push to a branch with an open Pull Request</td>
</tr>
<tr>
<td style="text-align:left"><strong>Production</strong></td>
<td style="text-align:left">The live application accessible to homeowners and contractors.</td>
<td style="text-align:left">Production Supabase</td>
<td style="text-align:left"><code>main</code></td>
<td style="text-align:left">Merge/Push to the <code>main</code> branch</td>
</tr>
</tbody>
</table>
<p><strong>Supabase Project Setup:</strong></p>
<ol>
<li><strong>Production Project:</strong> Create a Supabase project for the live application. Choose a robust password and enable Point-in-Time Recovery (PITR) for backups.</li>
<li><strong>Staging/Dev Project:</strong> Create a second Supabase project. This can be used for both local development and Vercel's Preview deployments. Its database schema should be kept in sync with production, but it will contain test data.</li>
</ol>
<hr>
<h4 id="3-vercel-project-and-environment-variable-configuration"><strong>3. Vercel Project and Environment Variable Configuration</strong></h4>
<h5 id="31-connecting-github-to-vercel"><strong>3.1. Connecting GitHub to Vercel</strong></h5>
<ol>
<li>Sign up for a Vercel account using your GitHub credentials.</li>
<li>Click &quot;Add New... &gt; Project&quot; from the Vercel dashboard.</li>
<li>Import the <code>homease-app</code> GitHub repository.</li>
<li>Vercel will automatically detect that it's a Next.js project. No changes are needed in the &quot;Build &amp; Development Settings&quot;.</li>
<li>Click &quot;Deploy&quot;. The initial deployment will fail if environment variables are not yet configured, which we will do next.</li>
</ol>
<h5 id="32-securely-managing-environment-variables"><strong>3.2. Securely Managing Environment Variables</strong></h5>
<p>Sensitive credentials like Supabase keys must never be committed to Git. Vercel provides a secure system for managing them per environment.</p>
<ol>
<li>
<p>Navigate to your new project in the Vercel dashboard.</p>
</li>
<li>
<p>Go to the <strong>Settings</strong> tab and select <strong>Environment Variables</strong>.</p>
</li>
<li>
<p>Add the following two variables:</p>
<ul>
<li><code>NEXT_PUBLIC_SUPABASE_URL</code></li>
<li><code>NEXT_PUBLIC_SUPABASE_ANON_KEY</code></li>
</ul>
</li>
<li>
<p>For each variable, add the corresponding values from your Supabase projects, making sure to assign them to the correct Vercel Environments:</p>
<ul>
<li><strong>Production:</strong> Use the keys from your <strong>Production</strong> Supabase project. Uncheck &quot;Preview&quot; and &quot;Development&quot;.</li>
<li><strong>Preview (Staging):</strong> Use the keys from your <strong>Staging/Dev</strong> Supabase project. Check only the &quot;Preview&quot; box.</li>
<li><strong>Development:</strong> Use the same keys from your <strong>Staging/Dev</strong> Supabase project. Check only the &quot;Development&quot; box. This allows you to use <code>vercel env pull</code> to get these variables into your local <code>.env.local</code> file.</li>
</ul>
</li>
</ol>
<p>The final configuration in Vercel will look like this:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Name</th>
<th style="text-align:left">Production Value</th>
<th style="text-align:left">Preview Value</th>
<th style="text-align:left">Development Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>NEXT_PUBLIC_SUPABASE_URL</code></td>
<td style="text-align:left"><code>https://&lt;prod-ref&gt;.supabase.co</code></td>
<td style="text-align:left"><code>https://&lt;staging-ref&gt;.supabase.co</code></td>
<td style="text-align:left"><code>https://&lt;staging-ref&gt;.supabase.co</code></td>
</tr>
<tr>
<td style="text-align:left"><code>NEXT_PUBLIC_SUPABASE_ANON_KEY</code></td>
<td style="text-align:left"><code>ey...&lt;prod_key&gt;</code></td>
<td style="text-align:left"><code>ey...&lt;staging_key&gt;</code></td>
<td style="text-align:left"><code>ey...&lt;staging_key&gt;</code></td>
</tr>
</tbody>
</table>
<p>This setup ensures that merging to <code>main</code> automatically connects the deployed app to the production database, while all pull requests are connected to the isolated staging database.</p>
<hr>
<h4 id="4-cicd-pipeline-with-github-actions"><strong>4. CI/CD Pipeline with GitHub Actions</strong></h4>
<p>While Vercel handles the deployment (CD), we will use GitHub Actions for Continuous Integration (CI). This pipeline will act as a quality gate, running checks on every pull request before it can be merged. This prevents bugs and ensures code consistency.</p>
<h5 id="41-github-branch-protection"><strong>4.1. GitHub Branch Protection</strong></h5>
<p>To enforce this quality gate, we will configure a branch protection rule on the <code>main</code> branch in GitHub:</p>
<ol>
<li>In your GitHub repo, go to <strong>Settings &gt; Branches</strong>.</li>
<li>Add a rule for the <code>main</code> branch.</li>
<li>Enable <strong>&quot;Require status checks to pass before merging&quot;</strong>.</li>
<li>In the search box, find and select the name of the CI job we will create (e.g., <code>lint-and-test</code>).</li>
</ol>
<p>This configuration will physically block the &quot;Merge&quot; button on a pull request until our GitHub Actions workflow has completed successfully.</p>
<h5 id="42-github-actions-workflow-file"><strong>4.2. GitHub Actions Workflow File</strong></h5>
<p>Create the following file in your repository: <code>.github/workflows/ci.yml</code></p>
<pre><code class="language-yaml"><span class="hljs-comment"># .github/workflows/ci.yml</span>

<span class="hljs-attr">name:</span> <span class="hljs-string">HOMEase</span> <span class="hljs-string">CI</span> <span class="hljs-string">Pipeline</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-comment"># Trigger the workflow on pushes to the main branch</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">main</span>
  <span class="hljs-comment"># Trigger the workflow on any pull request</span>
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">main</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">lint-and-test:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Lint</span> <span class="hljs-string">and</span> <span class="hljs-string">Test</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-comment"># 1. Check out the repository code</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>

      <span class="hljs-comment"># 2. Set up the Node.js environment</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Node.js</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">node-version:</span> <span class="hljs-string">&#x27;20&#x27;</span> <span class="hljs-comment"># Specify your project&#x27;s Node.js version</span>
          <span class="hljs-attr">cache:</span> <span class="hljs-string">&#x27;npm&#x27;</span> <span class="hljs-comment"># Enable caching for npm dependencies</span>

      <span class="hljs-comment"># 3. Install project dependencies</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span>

      <span class="hljs-comment"># 4. Run ESLint to check for code style and quality issues</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">ESLint</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">lint</span>
        
      <span class="hljs-comment"># 5. Run automated tests (e.g., Jest, Vitest, Playwright)</span>
      <span class="hljs-comment"># This step assumes you have a `test` script in your package.json</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">test</span>

      <span class="hljs-comment"># 6. Run a type check using the TypeScript compiler</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Type</span> <span class="hljs-string">check</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">build</span> <span class="hljs-comment"># The `next build` command includes a TypeScript check</span>
</code></pre>
<p><strong>Explanation of the Workflow:</strong></p>
<ul>
<li><strong><code>name</code></strong>: The display name of the workflow.</li>
<li><strong><code>on</code></strong>: Defines the triggers. This workflow runs for every push and pull request to the <code>main</code> branch.</li>
<li><strong><code>jobs</code></strong>: A workflow is made up of one or more jobs. We have a single job named <code>lint-and-test</code>.</li>
<li><strong><code>runs-on</code></strong>: Specifies the virtual machine environment to run the job on.</li>
<li><strong><code>steps</code></strong>:
<ol>
<li><strong>Checkout code</strong>: Downloads your repository code into the runner.</li>
<li><strong>Setup Node.js</strong>: Installs the specified version of Node.js and configures caching for <code>npm</code> to speed up subsequent runs.</li>
<li><strong>Install dependencies</strong>: Runs <code>npm install</code> to get all required packages.</li>
<li><strong>Run ESLint</strong>: Executes the <code>lint</code> script from <code>package.json</code> to enforce coding standards.</li>
<li><strong>Run tests</strong>: Executes the <code>test</code> script. This is where your unit and integration tests would run.</li>
<li><strong>Type check</strong>: Runs <code>npm run build</code>. The <code>next build</code> command inherently performs a TypeScript type check, which is a crucial step for catching type-related errors before deployment.</li>
</ol>
</li>
</ul>
<p>This completes the setup of a modern, secure, and automated DevOps pipeline. This process ensures that every change to the production application is automatically tested and validated, significantly improving platform stability and developer productivity.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;deployment_devops&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Deployment, Hosting, and DevOps Pipeline on Vercel&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DevOps, CI/CD (GitHub Actions), Vercel Platform&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="frontend-development-webxr-backend-development-supabase-edge-functions-ai-api-integration-specialist">Frontend Development (WebXR), Backend Development (Supabase Edge Functions), AI API Integration Specialist</h3>
<h3 id="comprehensive-technical-architecture-plan-homease--ai-3"><strong>Comprehensive Technical Architecture Plan: HOMEase | AI</strong></h3>
<h3 id="subtask-ar-assessment-flow-and-ai-service-integration"><strong>Subtask: AR Assessment Flow and AI Service Integration</strong></h3>
<p>This document details the technical implementation of the core AR assessment feature. It outlines the end-to-end workflow, from the user capturing images in the browser to the orchestration of AI services via a Supabase Edge Function and the final persistence of results in the database. This approach prioritizes broad accessibility using WebXR and ensures a scalable, secure, and non-blocking user experience.</p>
<hr>
<h4 id="1-high-level-architectural-flow"><strong>1. High-Level Architectural Flow</strong></h4>
<p>The process is designed to be asynchronous to provide a responsive user interface. The user initiates the process, and the heavy lifting (AI analysis) happens in the background. The frontend is notified of completion via Supabase's real-time capabilities.</p>
<ol>
<li><strong>Capture &amp; Upload (Frontend):</strong> The homeowner uses a WebXR-enabled component in the Next.js app to capture images of a room. These images are uploaded directly to a private Supabase Storage bucket.</li>
<li><strong>Trigger Function (Frontend -&gt; Edge Function):</strong> Upon successful upload, the frontend invokes a Supabase Edge Function (<code>process-ar-assessment</code>), passing the storage paths of the new images and the associated <code>project_id</code>.</li>
<li><strong>Acknowledge &amp; Delegate (Edge Function):</strong> The <code>process-ar-assessment</code> function validates the request, creates an initial <code>ar_assessments</code> record with a <code>processing</code> status, and immediately returns a <code>202 Accepted</code> response. It then invokes a second, long-running Edge Function (<code>generate-ai-analysis</code>) without waiting for its completion.</li>
<li><strong>Orchestrate AI (Background Function):</strong> The <code>generate-ai-analysis</code> function:
a.  Generates secure, time-limited signed URLs for the uploaded images.
b.  Calls the <strong>Google Gemini API</strong> with the image URLs and a specialized prompt to perform hazard analysis.
c.  Calls the <strong><a href="http://Fal.ai">Fal.ai</a> API</strong> with the original image URLs and Gemini's recommendations to generate &quot;after&quot; visualizations.</li>
<li><strong>Persist Results (Background Function -&gt; Database):</strong> The function gathers the results from both AI services and updates the corresponding <code>ar_assessments</code> record in the PostgreSQL database, changing its status to <code>completed</code>.</li>
<li><strong>Real-time Notification (Database -&gt; Frontend):</strong> The Next.js app, subscribed to changes on the <code>ar_assessments</code> table via Supabase Realtime, receives the updated record automatically and displays the full report to the homeowner.</li>
</ol>
<hr>
<h4 id="2-frontend-implementation-nextjs--webxr"><strong>2. Frontend Implementation (Next.js &amp; WebXR)</strong></h4>
<p>The frontend is responsible for providing an intuitive capture experience.</p>
<ul>
<li>
<p><strong>Technology:</strong></p>
<ul>
<li><strong>Framework:</strong> Next.js 15 (App Router)</li>
<li><strong>3D/AR Library:</strong> <code>@react-three/fiber</code> and <code>@react-three/xr</code> for building the WebXR experience. This provides a declarative, component-based way to manage the AR scene.</li>
<li><strong>State Management:</strong> Zustand or React Context for managing the assessment state (upload progress, processing status).</li>
<li><strong>Supabase Client:</strong> <code>@supabase/supabase-js</code> for storage uploads, function invocation, and real-time subscriptions.</li>
</ul>
</li>
<li>
<p><strong>User Flow &amp; Component Logic (<code>ARAssessment.tsx</code>):</strong></p>
<ol>
<li><strong>Initialization:</strong> The component requests camera access and initializes an AR session.</li>
<li><strong>Guidance:</strong> The UI overlays instructions, prompting the user to &quot;Take a wide shot of the room,&quot; &quot;Take a photo of the doorway,&quot; etc.</li>
<li><strong>Capture:</strong> On user tap, the component captures the current view from the camera feed and stores it as a <code>File</code> object in local state.</li>
<li><strong>Submission:</strong>
<ul>
<li>The user clicks &quot;Analyze Room.&quot;</li>
<li>The component iterates through the captured <code>File</code> objects.</li>
<li>For each file, it calls <code>supabase.storage.from('assessment-media').upload(...)</code>. Files are uploaded to a path like <code>private/{homeowner_id}/{project_id}/{random_uuid()}.jpg</code>. The <code>private</code> bucket has strict RLS policies ensuring only the owner can write.</li>
<li>After all uploads are complete, it invokes the Edge Function:<pre><code class="language-typescript"><span class="hljs-keyword">const</span> { data, error } = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">functions</span>.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">&#x27;process-ar-assessment&#x27;</span>, {
  <span class="hljs-attr">body</span>: { 
    <span class="hljs-attr">projectId</span>: <span class="hljs-string">&#x27;...&#x27;</span>, 
    <span class="hljs-attr">imagePaths</span>: [<span class="hljs-string">&#x27;private/.../1.jpg&#x27;</span>, <span class="hljs-string">&#x27;private/.../2.jpg&#x27;</span>] 
  }
});
<span class="hljs-comment">// UI now enters a &quot;processing&quot; state</span>
</code></pre>
</li>
</ul>
</li>
<li><strong>Real-time Subscription:</strong> The component uses a React hook to listen for database changes.<pre><code class="language-typescript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> channel = supabase
    .<span class="hljs-title function_">channel</span>(<span class="hljs-string">`assessment-updates-<span class="hljs-subst">${projectId}</span>`</span>)
    .<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;postgres_changes&#x27;</span>, { 
      <span class="hljs-attr">event</span>: <span class="hljs-string">&#x27;UPDATE&#x27;</span>, 
      <span class="hljs-attr">schema</span>: <span class="hljs-string">&#x27;public&#x27;</span>, 
      <span class="hljs-attr">table</span>: <span class="hljs-string">&#x27;ar_assessments&#x27;</span>, 
      <span class="hljs-attr">filter</span>: <span class="hljs-string">`project_id=eq.<span class="hljs-subst">${projectId}</span>`</span> 
    }, <span class="hljs-function">(<span class="hljs-params">payload</span>) =&gt;</span> {
      <span class="hljs-comment">// New data is in payload.new</span>
      <span class="hljs-comment">// Update UI from &quot;processing&quot; to show the results</span>
      <span class="hljs-title function_">setAssessmentResults</span>(payload.<span class="hljs-property">new</span>);
    })
    .<span class="hljs-title function_">subscribe</span>();

  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    supabase.<span class="hljs-title function_">removeChannel</span>(channel);
  };
}, [projectId]);
</code></pre>
</li>
</ol>
</li>
</ul>
<hr>
<h4 id="3-supabase-edge-function-implementation"><strong>3. Supabase Edge Function Implementation</strong></h4>
<p>We use two Edge Functions to manage the asynchronous workflow effectively.</p>
<ul>
<li><strong>Location:</strong> <code>supabase/functions/</code></li>
<li><strong>Environment Variables (Secrets):</strong>
<ul>
<li><code>GEMINI_API_KEY</code>: Your Google AI Studio API key.</li>
<li><code>FAL_API_SECRET</code>: Your <a href="http://Fal.ai">Fal.ai</a> API key/secret.</li>
<li><code>SUPABASE_SERVICE_ROLE_KEY</code>: Required for the background function to bypass RLS when updating the database.</li>
</ul>
</li>
</ul>
<h5 id="31-process-ar-assessment-the-initiator"><strong>3.1. <code>process-ar-assessment</code> (The Initiator)</strong></h5>
<p>This function is the public-facing endpoint. It's designed to be fast and responsive.</p>
<ul>
<li><strong>File:</strong> <code>supabase/functions/process-ar-assessment/index.ts</code></li>
<li><strong>Purpose:</strong> Validate the request, create a placeholder record, and trigger the background worker.</li>
</ul>
<pre><code class="language-typescript"><span class="hljs-comment">// supabase/functions/process-ar-assessment/index.ts</span>
<span class="hljs-keyword">import</span> { serve } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;https://deno.land/std@0.177.0/http/server.ts&#x27;</span>
<span class="hljs-keyword">import</span> { createClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;https://esm.sh/@supabase/supabase-js@2&#x27;</span>

<span class="hljs-title function_">serve</span>(<span class="hljs-keyword">async</span> (req) =&gt; {
  <span class="hljs-comment">// 1. Create Supabase client with user&#x27;s auth context</span>
  <span class="hljs-keyword">const</span> supabaseClient = <span class="hljs-title function_">createClient</span>(
    <span class="hljs-title class_">Deno</span>.<span class="hljs-property">env</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;SUPABASE_URL&#x27;</span>) ?? <span class="hljs-string">&#x27;&#x27;</span>,
    <span class="hljs-title class_">Deno</span>.<span class="hljs-property">env</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;SUPABASE_ANON_KEY&#x27;</span>) ?? <span class="hljs-string">&#x27;&#x27;</span>,
    { <span class="hljs-attr">global</span>: { <span class="hljs-attr">headers</span>: { <span class="hljs-title class_">Authorization</span>: req.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;Authorization&#x27;</span>)! } } }
  );

  <span class="hljs-comment">// 2. Get user and validate payload</span>
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: { user } } = <span class="hljs-keyword">await</span> supabaseClient.<span class="hljs-property">auth</span>.<span class="hljs-title function_">getUser</span>();
  <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&#x27;Unauthorized&#x27;</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">401</span> });

  <span class="hljs-keyword">const</span> { projectId, imagePaths } = <span class="hljs-keyword">await</span> req.<span class="hljs-title function_">json</span>();
  <span class="hljs-keyword">if</span> (!projectId || !imagePaths) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&#x27;Missing parameters&#x27;</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">400</span> });
  
  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Add logic to verify user owns the project</span>

  <span class="hljs-comment">// 3. Create a placeholder assessment record</span>
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: assessment, <span class="hljs-attr">error</span>: insertError } = <span class="hljs-keyword">await</span> supabaseClient
    .<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;ar_assessments&#x27;</span>)
    .<span class="hljs-title function_">insert</span>({ <span class="hljs-attr">project_id</span>: projectId, <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;processing&#x27;</span> }) <span class="hljs-comment">// Assuming a &#x27;status&#x27; column</span>
    .<span class="hljs-title function_">select</span>(<span class="hljs-string">&#x27;id&#x27;</span>)
    .<span class="hljs-title function_">single</span>();

  <span class="hljs-keyword">if</span> (insertError) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(insertError);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&#x27;Failed to create assessment job&#x27;</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">500</span> });
  }

  <span class="hljs-comment">// 4. Invoke the background worker function without waiting</span>
  <span class="hljs-keyword">await</span> supabaseClient.<span class="hljs-property">functions</span>.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">&#x27;generate-ai-analysis&#x27;</span>, {
    <span class="hljs-attr">body</span>: { <span class="hljs-attr">assessmentId</span>: assessment.<span class="hljs-property">id</span>, imagePaths },
    <span class="hljs-comment">// This is the key for async invocation</span>
    <span class="hljs-attr">invokeOptions</span>: { <span class="hljs-attr">noWait</span>: <span class="hljs-literal">true</span> } 
  });

  <span class="hljs-comment">// 5. Return immediate success response</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">assessmentId</span>: assessment.<span class="hljs-property">id</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Analysis started&#x27;</span> }), {
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span> },
    <span class="hljs-attr">status</span>: <span class="hljs-number">202</span>,
  });
})
</code></pre>
<h5 id="32-generate-ai-analysis-the-worker"><strong>3.2. <code>generate-ai-analysis</code> (The Worker)</strong></h5>
<p>This function performs the long-running AI tasks. It uses the <code>SERVICE_ROLE_KEY</code> to have administrative access to the database and storage.</p>
<ul>
<li><strong>File:</strong> <code>supabase/functions/generate-ai-analysis/index.ts</code></li>
<li><strong>Purpose:</strong> Orchestrate calls to Gemini and <a href="http://Fal.ai">Fal.ai</a>, then update the database.</li>
</ul>
<pre><code class="language-typescript"><span class="hljs-comment">// supabase/functions/generate-ai-analysis/index.ts</span>
<span class="hljs-keyword">import</span> { serve } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;https://deno.land/std@0.177.0/http/server.ts&#x27;</span>
<span class="hljs-keyword">import</span> { createClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;https://esm.sh/@supabase/supabase-js@2&#x27;</span>

<span class="hljs-comment">// Prompt Engineering for Gemini</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GEMINI_PROMPT</span> = <span class="hljs-string">`
  You are an expert Certified Aging-in-Place Specialist (CAPS). Analyze the following home images for accessibility hazards for seniors.
  Based ONLY on the visual information, identify specific issues and provide actionable recommendations.
  Your response MUST be in a valid JSON format with the following structure:
  {
    &quot;accessibility_score&quot;: &lt;An integer between 0 and 100, where 100 is perfectly accessible&gt;,
    &quot;identified_hazards&quot;: [ { &quot;hazard&quot;: &quot;Brief name of hazard&quot;, &quot;details&quot;: &quot;Description of the issue and why it&#x27;s a risk&quot;, &quot;area&quot;: &quot;e.g., Doorway, Floor, Shower&quot; } ],
    &quot;recommendations&quot;: [ { &quot;recommendation&quot;: &quot;Brief name of solution&quot;, &quot;details&quot;: &quot;Description of the modification to fix a hazard&quot; } ]
  }
`</span>;

<span class="hljs-title function_">serve</span>(<span class="hljs-keyword">async</span> (req) =&gt; {
  <span class="hljs-comment">// 1. Use the Service Role client for elevated privileges</span>
  <span class="hljs-keyword">const</span> supabaseAdmin = <span class="hljs-title function_">createClient</span>(
    <span class="hljs-title class_">Deno</span>.<span class="hljs-property">env</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;SUPABASE_URL&#x27;</span>) ?? <span class="hljs-string">&#x27;&#x27;</span>,
    <span class="hljs-title class_">Deno</span>.<span class="hljs-property">env</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;SUPABASE_SERVICE_ROLE_KEY&#x27;</span>) ?? <span class="hljs-string">&#x27;&#x27;</span>
  );

  <span class="hljs-keyword">const</span> { assessmentId, imagePaths } = <span class="hljs-keyword">await</span> req.<span class="hljs-title function_">json</span>();

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 2. Generate signed URLs for the AI services to access the images</span>
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: signedUrlData, <span class="hljs-attr">error</span>: urlError } = <span class="hljs-keyword">await</span> supabaseAdmin.<span class="hljs-property">storage</span>
      .<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;assessment-media&#x27;</span>)
      .<span class="hljs-title function_">createSignedUrls</span>(imagePaths, <span class="hljs-number">3600</span>); <span class="hljs-comment">// Expires in 1 hour</span>
    <span class="hljs-keyword">if</span> (urlError) <span class="hljs-keyword">throw</span> urlError;

    <span class="hljs-keyword">const</span> imageUrls = signedUrlData.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">signedUrl</span>);

    <span class="hljs-comment">// 3. Call Google Gemini API</span>
    <span class="hljs-keyword">const</span> geminiRes = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=<span class="hljs-subst">${Deno.env.get(<span class="hljs-string">&#x27;GEMINI_API_KEY&#x27;</span>)}</span>`</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,
      <span class="hljs-attr">headers</span>: { <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span> },
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-attr">contents</span>: [{
          <span class="hljs-attr">parts</span>: [
            { <span class="hljs-attr">text</span>: <span class="hljs-variable constant_">GEMINI_PROMPT</span> },
            ...imageUrls.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> ({ <span class="hljs-attr">inline_data</span>: { <span class="hljs-attr">mime_type</span>: <span class="hljs-string">&quot;image/jpeg&quot;</span>, <span class="hljs-attr">data</span>: <span class="hljs-title function_">btoa</span>(<span class="hljs-keyword">await</span> (<span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url)).<span class="hljs-title function_">arrayBuffer</span>()) } }))
          ]
        }]
      })
    });
    <span class="hljs-keyword">const</span> geminiJson = <span class="hljs-keyword">await</span> geminiRes.<span class="hljs-title function_">json</span>();
    <span class="hljs-keyword">const</span> geminiAnalysis = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(geminiJson.<span class="hljs-property">candidates</span>[<span class="hljs-number">0</span>].<span class="hljs-property">content</span>.<span class="hljs-property">parts</span>[<span class="hljs-number">0</span>].<span class="hljs-property">text</span>);

    <span class="hljs-comment">// 4. Call Fal.ai API for visualization (example for one recommendation)</span>
    <span class="hljs-keyword">let</span> visualizationUrls = [];
    <span class="hljs-keyword">if</span> (geminiAnalysis.<span class="hljs-property">recommendations</span> &amp;&amp; geminiAnalysis.<span class="hljs-property">recommendations</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">const</span> firstRecommendation = geminiAnalysis.<span class="hljs-property">recommendations</span>[<span class="hljs-number">0</span>].<span class="hljs-property">details</span>;
      <span class="hljs-keyword">const</span> falRes = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://fal.run/fal-ai/fast-sdxl&#x27;</span>, {
        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,
        <span class="hljs-attr">headers</span>: { 
          <span class="hljs-string">&#x27;Authorization&#x27;</span>: <span class="hljs-string">`Key <span class="hljs-subst">${Deno.env.get(<span class="hljs-string">&#x27;FAL_API_SECRET&#x27;</span>)}</span>`</span>,
          <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span> 
        },
        <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
          <span class="hljs-attr">image_url</span>: imageUrls[<span class="hljs-number">0</span>], <span class="hljs-comment">// Use the first image as base</span>
          <span class="hljs-attr">prompt</span>: <span class="hljs-string">`A photo of a bathroom with this modification: &quot;<span class="hljs-subst">${firstRecommendation}</span>&quot;`</span>,
        })
      });
      <span class="hljs-keyword">const</span> falJson = <span class="hljs-keyword">await</span> falRes.<span class="hljs-title function_">json</span>();
      <span class="hljs-keyword">if</span> (falJson.<span class="hljs-property">images</span> &amp;&amp; falJson.<span class="hljs-property">images</span>[<span class="hljs-number">0</span>]) {
        visualizationUrls.<span class="hljs-title function_">push</span>(falJson.<span class="hljs-property">images</span>[<span class="hljs-number">0</span>].<span class="hljs-property">url</span>);
      }
    }

    <span class="hljs-comment">// 5. Update the database record with the results</span>
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">error</span>: updateError } = <span class="hljs-keyword">await</span> supabaseAdmin
      .<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;ar_assessments&#x27;</span>)
      .<span class="hljs-title function_">update</span>({
        <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;completed&#x27;</span>,
        <span class="hljs-attr">accessibility_score</span>: geminiAnalysis.<span class="hljs-property">accessibility_score</span>,
        <span class="hljs-attr">identified_hazards</span>: geminiAnalysis.<span class="hljs-property">identified_hazards</span>,
        <span class="hljs-attr">recommendations</span>: geminiAnalysis.<span class="hljs-property">recommendations</span>,
        <span class="hljs-attr">gemini_analysis_raw</span>: geminiJson, <span class="hljs-comment">// Store the full raw response</span>
        <span class="hljs-attr">fal_ai_visualization_urls</span>: visualizationUrls,
      })
      .<span class="hljs-title function_">eq</span>(<span class="hljs-string">&#x27;id&#x27;</span>, assessmentId);

    <span class="hljs-keyword">if</span> (updateError) <span class="hljs-keyword">throw</span> updateError;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&#x27;OK&#x27;</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">200</span> });

  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// Error handling: Update the record to a &#x27;failed&#x27; state</span>
    <span class="hljs-keyword">await</span> supabaseAdmin.<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;ar_assessments&#x27;</span>).<span class="hljs-title function_">update</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;failed&#x27;</span>, <span class="hljs-attr">error_message</span>: error.<span class="hljs-property">message</span> }).<span class="hljs-title function_">eq</span>(<span class="hljs-string">&#x27;id&#x27;</span>, assessmentId);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;AI Analysis Failed:&#x27;</span>, error);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(error.<span class="hljs-property">message</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">500</span> });
  }
});
</code></pre>
<p>This robust, asynchronous architecture provides a seamless user experience for the technologically intensive AR assessment feature, forming the innovative core of the HOMEase | AI platform.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ar_ai_integration&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AR Assessment Flow and AI Service Integration&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Frontend Development (WebXR), Backend Development (Supabase Edge Functions), AI API Integration&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="backend-development-supabase-edge-functions-postgresql-specialist">Backend Development (Supabase Edge Functions, PostgreSQL) Specialist</h3>
<h3 id="comprehensive-technical-architecture-plan-homease--ai-4"><strong>Comprehensive Technical Architecture Plan: HOMEase | AI</strong></h3>
<h3 id="subtask-asynchronous-lead-generation-and-contractor-matching"><strong>Subtask: Asynchronous Lead Generation and Contractor Matching</strong></h3>
<p>This document outlines the architecture for converting a completed AR assessment into a live lead and asynchronously matching it with qualified contractors. This process leverages a Supabase Database Webhook (via a PostgreSQL trigger for reliability) to invoke an Edge Function, ensuring the user interface remains responsive while complex matching logic is executed in the background. The core of the matching algorithm relies on Supabase's PostGIS capabilities for efficient geospatial querying.</p>
<hr>
<h4 id="1-high-level-architectural-flow-1"><strong>1. High-Level Architectural Flow</strong></h4>
<p>The workflow begins after the homeowner has reviewed their AI-generated assessment report. The system is designed to decouple the lead submission from the computationally intensive matching process.</p>
<ol>
<li><strong>Lead Submission (Frontend):</strong> The homeowner reviews their AR assessment results, provides additional details (urgency, budget), and clicks &quot;Find Contractors.&quot; The Next.js app sends an <code>UPDATE</code> request to the <code>projects</code> table for the specific <code>project_id</code>, changing its <code>status</code> to <code>lead_submitted</code>.</li>
<li><strong>Database Trigger (PostgreSQL):</strong> A custom PostgreSQL trigger on the <code>projects</code> table detects the status change to <code>lead_submitted</code>. Instead of a simple webhook, this trigger function selectively calls <code>pg_net</code> to invoke a secure webhook URL, ensuring the matching process only runs when this specific condition is met.</li>
<li><strong>Webhook &amp; Function Invocation (Supabase):</strong> The <code>pg_net</code> request triggers the Supabase Edge Function (<code>match-contractors</code>), passing the entire updated project record as the payload.</li>
<li><strong>Asynchronous Matching (Edge Function):</strong> The <code>match-contractors</code> function executes the core matching logic:
a.  <strong>Geospatial Query:</strong> It uses PostGIS to find all <code>contractor_profiles</code> whose <code>service_area</code> (a polygon) contains the project's <code>location</code> (a point).
b.  <strong>Skills &amp; Certification Query:</strong> It further filters these contractors based on skills derived from the AR assessment recommendations and checks for <code>caps_certified</code> status.
c.  <strong>Availability Check:</strong> It ensures matched contractors are marked as <code>is_available</code> and <code>is_verified</code>.</li>
<li><strong>Persist Matches (Edge Function -&gt; Database):</strong> The function inserts a record into the <code>project_contractor_matches</code> table for each suitable contractor found.</li>
<li><strong>Real-time Notification (Database -&gt; Frontend):</strong> The homeowner's dashboard, subscribed to real-time changes on the <code>project_contractor_matches</code> table, automatically updates to display the profiles of the matched contractors as they are added, creating a seamless and dynamic user experience.</li>
</ol>
<hr>
<h4 id="2-database-schema--setup"><strong>2. Database Schema &amp; Setup</strong></h4>
<p>To support this workflow, we will extend the database schema. The use of the <code>postgis</code> extension is critical.</p>
<p><strong>Enable PostGIS Extension (Run once in Supabase SQL Editor):</strong></p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> EXTENSION IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> postgis;
</code></pre>
<p><strong>Table Definitions:</strong></p>
<pre><code class="language-sql"><span class="hljs-comment">-- Projects Table (Extended)</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> projects
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> status TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;assessment_complete&#x27;</span>,
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> urgency TEXT, <span class="hljs-comment">-- e.g., &#x27;low&#x27;, &#x27;medium&#x27;, &#x27;high&#x27;</span>
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> budget_range NUMRANGE, <span class="hljs-comment">-- e.g., &#x27;[5000, 10000)&#x27;</span>
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> location GEOMETRY(Point, <span class="hljs-number">4326</span>); <span class="hljs-comment">-- Stores project&#x27;s lat/lon</span>

<span class="hljs-comment">-- Contractor Profiles Table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> contractor_profiles (
  id UUID <span class="hljs-keyword">PRIMARY</span> KEY <span class="hljs-keyword">REFERENCES</span> auth.users(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  company_name TEXT,
  is_verified <span class="hljs-type">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,
  is_available <span class="hljs-type">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,
  caps_certified <span class="hljs-type">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,
  service_area GEOMETRY(Polygon, <span class="hljs-number">4326</span>), <span class="hljs-comment">-- Defines the contractor&#x27;s service area</span>
  created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> NOW(),
  updated_at TIMESTAMPTZ
);
<span class="hljs-comment">-- Create a geospatial index for fast location queries</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_contractor_service_area <span class="hljs-keyword">ON</span> contractor_profiles <span class="hljs-keyword">USING</span> GIST (service_area);

<span class="hljs-comment">-- Skills &amp; Join Table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> skills (
  id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
  name TEXT <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-comment">-- e.g., &#x27;Walk-in Shower Conversion&#x27;, &#x27;Ramp Installation&#x27;</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> contractor_skills (
  contractor_id UUID <span class="hljs-keyword">REFERENCES</span> contractor_profiles(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  skill_id <span class="hljs-type">INT</span> <span class="hljs-keyword">REFERENCES</span> skills(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  <span class="hljs-keyword">PRIMARY</span> KEY (contractor_id, skill_id)
);

<span class="hljs-comment">-- Project-Contractor Matches Table (The result of the process)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> project_contractor_matches (
  id UUID <span class="hljs-keyword">PRIMARY</span> KEY <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
  project_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> projects(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  contractor_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> contractor_profiles(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  status TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;matched&#x27;</span>, <span class="hljs-comment">-- &#x27;matched&#x27;, &#x27;contacted&#x27;, &#x27;hired&#x27;</span>
  matched_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> NOW(),
  <span class="hljs-keyword">UNIQUE</span>(project_id, contractor_id)
);

<span class="hljs-comment">-- Enable Realtime on the matches table</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> project_contractor_matches REPLICA <span class="hljs-keyword">IDENTITY</span> <span class="hljs-keyword">FULL</span>;
<span class="hljs-comment">-- Send realtime messages for inserts</span>
<span class="hljs-keyword">ALTER</span> PUBLICATION supabase_realtime <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">TABLE</span> project_contractor_matches;
</code></pre>
<hr>
<h4 id="3-backend-trigger-based-webhook"><strong>3. Backend: Trigger-based Webhook</strong></h4>
<p>Using a PostgreSQL trigger is more robust than a simple table webhook because it allows for conditional logic within the database.</p>
<p><strong>Step 1: Create the Trigger Function</strong>
This function checks if the project's status is being updated to <code>lead_submitted</code>.</p>
<pre><code class="language-sql"><span class="hljs-comment">-- supabase/migrations/YYYYMMDDHHMMSS_create_matching_trigger.sql</span>

<span class="hljs-comment">-- Create the function that will be called by the trigger</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> trigger_contractor_matching()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
  webhook_url TEXT :<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;https://&lt;project_ref&gt;.supabase.co/functions/v1/match-contractors&#x27;</span>;
  <span class="hljs-comment">-- Store the secret in Supabase Vault and retrieve it</span>
  secret TEXT :<span class="hljs-operator">=</span> secrets.get(<span class="hljs-string">&#x27;WEBHOOK_SECRET&#x27;</span>);
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">-- Only proceed if the status is newly set to &#x27;lead_submitted&#x27;</span>
  IF NEW.status <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;lead_submitted&#x27;</span> <span class="hljs-keyword">AND</span> OLD.status <span class="hljs-operator">!=</span> <span class="hljs-string">&#x27;lead_submitted&#x27;</span> <span class="hljs-keyword">THEN</span>
    <span class="hljs-comment">-- Perform an HTTP POST request to the Edge Function</span>
    PERFORM net.http_post(
      url :<span class="hljs-operator">=</span> webhook_url,
      headers :<span class="hljs-operator">=</span> jsonb_build_object(
        <span class="hljs-string">&#x27;Content-Type&#x27;</span>, <span class="hljs-string">&#x27;application/json&#x27;</span>,
        <span class="hljs-string">&#x27;Authorization&#x27;</span>, <span class="hljs-string">&#x27;Bearer &#x27;</span> <span class="hljs-operator">||</span> secret
      ),
      body :<span class="hljs-operator">=</span> row_to_json(<span class="hljs-keyword">NEW</span>)::jsonb
    );
  <span class="hljs-keyword">END</span> IF;
  <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">NEW</span>;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql SECURITY DEFINER;

<span class="hljs-comment">-- Create the trigger on the &#x27;projects&#x27; table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> on_project_submit_lead
AFTER <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> public.projects
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-type">ROW</span>
<span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">FUNCTION</span> trigger_contractor_matching();
</code></pre>
<p><em>Note: You must store your <code>WEBHOOK_SECRET</code> in the Supabase Vault for this to work securely.</em></p>
<hr>
<h4 id="4-backend-match-contractors-edge-function"><strong>4. Backend: <code>match-contractors</code> Edge Function</strong></h4>
<p>This function contains the core business logic for finding suitable contractors.</p>
<ul>
<li><strong>File:</strong> <code>supabase/functions/match-contractors/index.ts</code></li>
<li><strong>Environment Variables (Secrets):</strong>
<ul>
<li><code>SUPABASE_SERVICE_ROLE_KEY</code>: To allow the function to perform admin-level database operations.</li>
<li><code>WEBHOOK_SECRET</code>: The shared secret to authorize requests from the database trigger.</li>
</ul>
</li>
</ul>
<pre><code class="language-typescript"><span class="hljs-comment">// supabase/functions/match-contractors/index.ts</span>
<span class="hljs-keyword">import</span> { serve } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;https://deno.land/std@0.177.0/http/server.ts&#x27;</span>
<span class="hljs-keyword">import</span> { createClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;https://esm.sh/@supabase/supabase-js@2&#x27;</span>

<span class="hljs-comment">// Helper function to extract potential skills from AR recommendations</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">extractSkillsFromProject</span>(<span class="hljs-params">recommendations: <span class="hljs-built_in">any</span>[]</span>): <span class="hljs-built_in">string</span>[] {
  <span class="hljs-comment">// This is a simplified example. A real implementation would use NLP</span>
  <span class="hljs-comment">// or a more robust keyword mapping system.</span>
  <span class="hljs-keyword">const</span> skillKeywords = [<span class="hljs-string">&#x27;ramp&#x27;</span>, <span class="hljs-string">&#x27;grab bar&#x27;</span>, <span class="hljs-string">&#x27;walk-in shower&#x27;</span>, <span class="hljs-string">&#x27;doorway widening&#x27;</span>];
  <span class="hljs-keyword">const</span> requiredSkills = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;();
  
  recommendations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">rec</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> detail = rec.<span class="hljs-property">details</span>.<span class="hljs-title function_">toLowerCase</span>();
    skillKeywords.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">keyword</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (detail.<span class="hljs-title function_">includes</span>(keyword)) {
        <span class="hljs-comment">// Map keyword to the canonical skill name in the &#x27;skills&#x27; table</span>
        <span class="hljs-keyword">if</span> (keyword === <span class="hljs-string">&#x27;walk-in shower&#x27;</span>) requiredSkills.<span class="hljs-title function_">add</span>(<span class="hljs-string">&#x27;Walk-in Shower Conversion&#x27;</span>);
        <span class="hljs-keyword">if</span> (keyword === <span class="hljs-string">&#x27;ramp&#x27;</span>) requiredSkills.<span class="hljs-title function_">add</span>(<span class="hljs-string">&#x27;Ramp Installation&#x27;</span>);
      }
    });
  });

  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(requiredSkills);
}

<span class="hljs-title function_">serve</span>(<span class="hljs-keyword">async</span> (req) =&gt; {
  <span class="hljs-comment">// 1. Security: Verify the authorization header</span>
  <span class="hljs-keyword">const</span> authHeader = req.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;Authorization&#x27;</span>);
  <span class="hljs-keyword">const</span> webhookSecret = <span class="hljs-title class_">Deno</span>.<span class="hljs-property">env</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;WEBHOOK_SECRET&#x27;</span>);
  <span class="hljs-keyword">if</span> (!authHeader || authHeader !== <span class="hljs-string">`Bearer <span class="hljs-subst">${webhookSecret}</span>`</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&#x27;Unauthorized&#x27;</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">401</span> });
  }

  <span class="hljs-comment">// 2. Initialize Admin Client and parse payload</span>
  <span class="hljs-keyword">const</span> supabaseAdmin = <span class="hljs-title function_">createClient</span>(
    <span class="hljs-title class_">Deno</span>.<span class="hljs-property">env</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;SUPABASE_URL&#x27;</span>) ?? <span class="hljs-string">&#x27;&#x27;</span>,
    <span class="hljs-title class_">Deno</span>.<span class="hljs-property">env</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;SUPABASE_SERVICE_ROLE_KEY&#x27;</span>) ?? <span class="hljs-string">&#x27;&#x27;</span>
  );
  <span class="hljs-keyword">const</span> project = <span class="hljs-keyword">await</span> req.<span class="hljs-title function_">json</span>();

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 3. Get AR assessment details to determine required skills</span>
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: assessment, <span class="hljs-attr">error</span>: assessmentError } = <span class="hljs-keyword">await</span> supabaseAdmin
      .<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;ar_assessments&#x27;</span>)
      .<span class="hljs-title function_">select</span>(<span class="hljs-string">&#x27;recommendations&#x27;</span>)
      .<span class="hljs-title function_">eq</span>(<span class="hljs-string">&#x27;project_id&#x27;</span>, project.<span class="hljs-property">id</span>)
      .<span class="hljs-title function_">single</span>();

    <span class="hljs-keyword">if</span> (assessmentError || !assessment) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Assessment not found for project <span class="hljs-subst">${project.id}</span>`</span>);

    <span class="hljs-keyword">const</span> requiredSkills = <span class="hljs-title function_">extractSkillsFromProject</span>(assessment.<span class="hljs-property">recommendations</span>);

    <span class="hljs-comment">// 4. Find matching contractors using an RPC function for complexity</span>
    <span class="hljs-comment">// It&#x27;s best practice to define complex SQL logic in a Postgres function.</span>
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: matchedContractors, <span class="hljs-attr">error</span>: matchError } = <span class="hljs-keyword">await</span> supabaseAdmin
      .<span class="hljs-title function_">rpc</span>(<span class="hljs-string">&#x27;find_matching_contractors&#x27;</span>, {
        <span class="hljs-attr">project_location</span>: project.<span class="hljs-property">location</span>, <span class="hljs-comment">// The GEOMETRY(Point) data</span>
        <span class="hljs-attr">required_skills</span>: requiredSkills,
        <span class="hljs-attr">limit_count</span>: <span class="hljs-number">5</span> <span class="hljs-comment">// Find the top 5 matches</span>
      });

    <span class="hljs-keyword">if</span> (matchError) <span class="hljs-keyword">throw</span> matchError;

    <span class="hljs-comment">// 5. Insert the matches into the join table</span>
    <span class="hljs-keyword">if</span> (matchedContractors &amp;&amp; matchedContractors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">const</span> matchesToInsert = matchedContractors.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">contractor</span> =&gt;</span> ({
        <span class="hljs-attr">project_id</span>: project.<span class="hljs-property">id</span>,
        <span class="hljs-attr">contractor_id</span>: contractor.<span class="hljs-property">id</span>,
      }));

      <span class="hljs-keyword">const</span> { <span class="hljs-attr">error</span>: insertError } = <span class="hljs-keyword">await</span> supabaseAdmin
        .<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;project_contractor_matches&#x27;</span>)
        .<span class="hljs-title function_">insert</span>(matchesToInsert);

      <span class="hljs-keyword">if</span> (insertError) <span class="hljs-keyword">throw</span> insertError;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">`Found <span class="hljs-subst">${matchedContractors.length}</span> matches.`</span> }), {
      <span class="hljs-attr">headers</span>: { <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span> },
      <span class="hljs-attr">status</span>: <span class="hljs-number">200</span>
    });

  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Contractor Matching Failed:&#x27;</span>, error);
    <span class="hljs-comment">// Optionally, update the project status to &#x27;matching_failed&#x27;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> }), { <span class="hljs-attr">status</span>: <span class="hljs-number">500</span> });
  }
});
</code></pre>
<h4 id="5-backend-find_matching_contractors-postgresql-function"><strong>5. Backend: <code>find_matching_contractors</code> PostgreSQL Function</strong></h4>
<p>Encapsulating the complex query in a database function (RPC) is cleaner and more performant.</p>
<pre><code class="language-sql"><span class="hljs-comment">-- supabase/migrations/YYYYMMDDHHMMSS_create_rpc_find_matches.sql</span>

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> find_matching_contractors(
  project_location GEOMETRY,
  required_skills TEXT[],
  limit_count <span class="hljs-type">INT</span>
)
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TABLE</span> (id UUID, company_name TEXT, caps_certified <span class="hljs-type">BOOLEAN</span>) <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">RETURN</span> QUERY
  <span class="hljs-keyword">SELECT</span>
    cp.id,
    cp.company_name,
    cp.caps_certified
  <span class="hljs-keyword">FROM</span>
    contractor_profiles <span class="hljs-keyword">AS</span> cp
  <span class="hljs-comment">-- Join to check skills</span>
  <span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span> cs.contractor_id
    <span class="hljs-keyword">FROM</span> contractor_skills cs
    <span class="hljs-keyword">JOIN</span> skills s <span class="hljs-keyword">ON</span> cs.skill_id <span class="hljs-operator">=</span> s.id
    <span class="hljs-keyword">WHERE</span> s.name <span class="hljs-operator">=</span> <span class="hljs-keyword">ANY</span>(required_skills)
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> cs.contractor_id
    <span class="hljs-comment">-- Ensure contractor has ALL required skills</span>
    <span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> s.id) <span class="hljs-operator">=</span> array_length(required_skills, <span class="hljs-number">1</span>)
  ) <span class="hljs-keyword">AS</span> skilled_contractors <span class="hljs-keyword">ON</span> cp.id <span class="hljs-operator">=</span> skilled_contractors.contractor_id
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-comment">-- Core Geospatial Query: Check if the project point is within the contractor&#x27;s service area polygon</span>
    ST_Contains(cp.service_area, project_location)
    <span class="hljs-keyword">AND</span> cp.is_verified <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span>
    <span class="hljs-keyword">AND</span> cp.is_available <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-comment">-- Prioritize CAPS certified contractors</span>
    cp.caps_certified <span class="hljs-keyword">DESC</span>
  LIMIT limit_count;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<p>This asynchronous, database-driven architecture provides a robust and scalable foundation for the core lead-matching functionality of the HOMEase | AI platform. It efficiently handles complex geospatial and skills-based queries without compromising the frontend user experience.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lead_matching&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Asynchronous Lead Generation and Contractor Matching&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Backend Development (Supabase Edge Functions, PostgreSQL)&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="frontend-development-nextjs-uiux-design-specialist">Frontend Development (Next.js), UI/UX Design Specialist</h3>
<h3 id="comprehensive-technical-architecture-plan-homease--ai-5"><strong>Comprehensive Technical Architecture Plan: HOMEase | AI</strong></h3>
<h3 id="subtask-homeowner-and-contractor-dashboards-development"><strong>Subtask: Homeowner and Contractor Dashboards Development</strong></h3>
<p>This document details the architecture and development plan for the user-facing dashboards for both homeowners and contractors. These dashboards are the primary interfaces for users to manage their projects, leads, and communications on the HOMEase platform. The architecture leverages Next.js App Router for a modern, server-centric approach and Supabase for authentication, database, real-time capabilities, and storage.</p>
<hr>
<h4 id="1-high-level-dashboard-architecture"><strong>1. High-Level Dashboard Architecture</strong></h4>
<p>The dashboards will be built as secure, role-based sections within the Next.js application. A unified authentication flow will direct users to the appropriate dashboard based on their role, which is managed via custom claims or a separate <code>profiles</code> table in Supabase.</p>
<ul>
<li><strong>Routing:</strong> The Next.js App Router will be used to create protected route groups.
<ul>
<li><code>/dashboard/homeowner</code>: For homeowner-specific views.</li>
<li><code>/dashboard/contractor</code>: For contractor-specific views.</li>
</ul>
</li>
<li><strong>Authentication &amp; Authorization:</strong>
<ul>
<li>A top-level <code>middleware.ts</code> file will protect all <code>/dashboard/*</code> routes, redirecting unauthenticated users to the login page.</li>
<li>A shared layout (<code>/dashboard/layout.tsx</code>) will fetch the user's session and role on the server, providing this data via context to client components or directly to child server components.</li>
</ul>
</li>
<li><strong>Component Strategy:</strong>
<ul>
<li><strong>Server Components:</strong> Used for fetching initial data, rendering static layouts, and ensuring security. This is the default for displaying project lists, profile information, etc.</li>
<li><strong>Client Components (<code>'use client'</code>):</strong> Used for all interactive elements, including forms, real-time chat, the dynamic scope builder, and map interfaces.</li>
</ul>
</li>
</ul>
<hr>
<h4 id="2-database-schema-extensions"><strong>2. Database Schema Extensions</strong></h4>
<p>Building upon the schema from the <code>lead_matching</code> task, we need additional tables to manage proposals, communication, and more detailed profiles.</p>
<pre><code class="language-sql"><span class="hljs-comment">-- Profiles Table (To store role and common user info)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> profiles (
  id UUID <span class="hljs-keyword">PRIMARY</span> KEY <span class="hljs-keyword">REFERENCES</span> auth.users(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  full_name TEXT,
  avatar_url TEXT,
  <span class="hljs-comment">-- &#x27;homeowner&#x27; or &#x27;contractor&#x27;</span>
  role TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
);

<span class="hljs-comment">-- Function to create a profile for a new user</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> public.handle_new_user()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> public.profiles (id, full_name, avatar_url, role)
  <span class="hljs-keyword">VALUES</span> (
    new.id,
    new.raw_user_meta_data<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">&#x27;full_name&#x27;</span>,
    new.raw_user_meta_data<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">&#x27;avatar_url&#x27;</span>,
    new.raw_user_meta_data<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">&#x27;role&#x27;</span> <span class="hljs-comment">-- Role is passed during sign-up</span>
  );
  <span class="hljs-comment">-- If the user is a contractor, create a contractor_profile entry</span>
  IF new.raw_user_meta_data<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">&#x27;role&#x27;</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;contractor&#x27;</span> <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> public.contractor_profiles (id) <span class="hljs-keyword">VALUES</span> (new.id);
  <span class="hljs-keyword">END</span> IF;
  <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">new</span>;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql SECURITY DEFINER;

<span class="hljs-comment">-- Trigger to run the function on user creation</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> on_auth_user_created
  AFTER <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> auth.users
  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-type">ROW</span> <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> public.handle_new_user();


<span class="hljs-comment">-- Extend Projects Table for more detailed status</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> projects
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> homeowner_id UUID <span class="hljs-keyword">REFERENCES</span> auth.users(id);

<span class="hljs-comment">-- Add a more granular status enum for projects</span>
<span class="hljs-keyword">CREATE</span> TYPE project_status <span class="hljs-keyword">AS</span> ENUM (
  <span class="hljs-string">&#x27;draft&#x27;</span>,
  <span class="hljs-string">&#x27;assessment_complete&#x27;</span>,
  <span class="hljs-string">&#x27;lead_submitted&#x27;</span>,
  <span class="hljs-string">&#x27;matching_complete&#x27;</span>,
  <span class="hljs-string">&#x27;proposals_received&#x27;</span>,
  <span class="hljs-string">&#x27;proposal_accepted&#x27;</span>,
  <span class="hljs-string">&#x27;in_progress&#x27;</span>,
  <span class="hljs-string">&#x27;completed&#x27;</span>,
  <span class="hljs-string">&#x27;cancelled&#x27;</span>
);
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> projects
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">COLUMN</span> status <span class="hljs-keyword">SET</span> DATA TYPE project_status <span class="hljs-keyword">USING</span> status::project_status;


<span class="hljs-comment">-- Proposals Table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> proposals (
  id UUID <span class="hljs-keyword">PRIMARY</span> KEY <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
  project_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> projects(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  contractor_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> contractor_profiles(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  scope_details JSONB, <span class="hljs-comment">-- Stores the itemized list from the Dynamic Scope Builder</span>
  total_price <span class="hljs-type">NUMERIC</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  status TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;pending&#x27;</span>, <span class="hljs-comment">-- &#x27;pending&#x27;, &#x27;accepted&#x27;, &#x27;declined&#x27;</span>
  created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> NOW(),
  <span class="hljs-keyword">UNIQUE</span>(project_id, contractor_id)
);
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> proposals REPLICA <span class="hljs-keyword">IDENTITY</span> <span class="hljs-keyword">FULL</span>;
<span class="hljs-keyword">ALTER</span> PUBLICATION supabase_realtime <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">TABLE</span> proposals;


<span class="hljs-comment">-- Messages Table (for real-time chat)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> messages (
  id BIGSERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
  project_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> projects(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  sender_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> auth.users(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  receiver_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> auth.users(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  content TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> NOW()
);
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> messages REPLICA <span class="hljs-keyword">IDENTITY</span> <span class="hljs-keyword">FULL</span>;
<span class="hljs-keyword">ALTER</span> PUBLICATION supabase_realtime <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">TABLE</span> messages;
</code></pre>
<hr>
<h4 id="3-homeowner-dashboard-dashboardhomeowner"><strong>3. Homeowner Dashboard (<code>/dashboard/homeowner</code>)</strong></h4>
<p>This dashboard empowers homeowners to track their project from assessment to completion.</p>
<p><strong>Key Components &amp; Pages:</strong></p>
<ol>
<li>
<p><strong>Main View (<code>/dashboard/homeowner</code>)</strong>:</p>
<ul>
<li><strong>Implementation:</strong> A Server Component that fetches all projects linked to the current <code>homeowner_id</code>.</li>
<li><strong>UI:</strong> Displays a list of <code>ProjectCard</code> components. Each card shows the project name (e.g., &quot;Master Bathroom&quot;), a summary of the AR assessment score, the current <code>status</code>, and a link to the detail page.</li>
</ul>
</li>
<li>
<p><strong>Project Detail View (<code>/dashboard/homeowner/projects/[projectId]</code>)</strong>:</p>
<ul>
<li><strong>Implementation:</strong> A dynamic route page that fetches all data related to a specific project: <code>projects</code>, <code>ar_assessments</code>, <code>project_contractor_matches</code>, and <code>proposals</code>.</li>
<li><strong>Features:</strong>
<ul>
<li><strong>Status Tracker:</strong> A visual timeline component showing the current <code>project_status</code>.</li>
<li><strong>Matched Contractors:</strong> A section that displays profiles of matched contractors. This section can be a Client Component that subscribes to real-time inserts on the <code>project_contractor_matches</code> table, showing a &quot;Finding contractors...&quot; message and then populating the list as matches are found.</li>
<li><strong>Proposals Section:</strong> Lists incoming proposals. The homeowner can view details (including the itemized scope from the <code>scope_details</code> JSONB) and has &quot;Accept&quot; or &quot;Decline&quot; buttons. Accepting a proposal would trigger a Server Action to update the <code>proposals</code> and <code>projects</code> table statuses.</li>
<li><strong>Messaging Interface:</strong> Once a proposal is accepted, a chat window becomes active. This is a Client Component that:
<ul>
<li>Subscribes to the <code>messages</code> table filtered by <code>project_id</code>.</li>
<li>Displays messages in real-time.</li>
<li>Uses a Server Action to insert new messages into the database.</li>
</ul>
</li>
<li><strong>Payment Management:</strong> Integrates with Stripe. After accepting a proposal, a &quot;Proceed to Payment&quot; button appears. This button calls a Server Action that creates a Stripe Checkout session and redirects the user to Stripe's hosted payment page.</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>Code Snippet: Real-time Matched Contractors (Client Component)</strong></p>
<pre><code class="language-typescript"><span class="hljs-comment">// app/dashboard/homeowner/projects/[projectId]/components/MatchedContractors.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { createClientComponentClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@supabase/auth-helpers-nextjs&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MatchedContractors</span>(<span class="hljs-params">{ projectId, initialMatches }</span>) {
  <span class="hljs-keyword">const</span> supabase = <span class="hljs-title function_">createClientComponentClient</span>();
  <span class="hljs-keyword">const</span> [matches, setMatches] = <span class="hljs-title function_">useState</span>(initialMatches);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> channel = supabase
      .<span class="hljs-title function_">channel</span>(<span class="hljs-string">`realtime-matches:<span class="hljs-subst">${projectId}</span>`</span>)
      .<span class="hljs-title function_">on</span>(
        <span class="hljs-string">&#x27;postgres_changes&#x27;</span>,
        {
          <span class="hljs-attr">event</span>: <span class="hljs-string">&#x27;INSERT&#x27;</span>,
          <span class="hljs-attr">schema</span>: <span class="hljs-string">&#x27;public&#x27;</span>,
          <span class="hljs-attr">table</span>: <span class="hljs-string">&#x27;project_contractor_matches&#x27;</span>,
          <span class="hljs-attr">filter</span>: <span class="hljs-string">`project_id=eq.<span class="hljs-subst">${projectId}</span>`</span>,
        },
        <span class="hljs-function">(<span class="hljs-params">payload</span>) =&gt;</span> {
          <span class="hljs-comment">// Fetch the full contractor profile for the new match</span>
          <span class="hljs-comment">// and add it to the state.</span>
          <span class="hljs-keyword">const</span> newMatch = payload.<span class="hljs-property">new</span>;
          <span class="hljs-comment">// In a real app, you&#x27;d fetch contractor details here.</span>
          <span class="hljs-title function_">setMatches</span>(<span class="hljs-function">(<span class="hljs-params">currentMatches</span>) =&gt;</span> [...currentMatches, newMatch]);
        }
      )
      .<span class="hljs-title function_">subscribe</span>();

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      supabase.<span class="hljs-title function_">removeChannel</span>(channel);
    };
  }, [supabase, projectId]);

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Matched Contractors<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      {matches.length === 0 &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Searching for qualified local contractors...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
      {/* Render list of matched contractor profiles */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<hr>
<h4 id="4-contractor-dashboard-dashboardcontractor"><strong>4. Contractor Dashboard (<code>/dashboard/contractor</code>)</strong></h4>
<p>This dashboard is the contractor's mission control for managing their business on the platform.</p>
<p><strong>Key Components &amp; Pages:</strong></p>
<ol>
<li>
<p><strong>Profile Management (<code>/dashboard/contractor/profile</code>)</strong>:</p>
<ul>
<li><strong>Implementation:</strong> A page with a Client Component form that submits to a Server Action.</li>
<li><strong>UI:</strong>
<ul>
<li>Standard form fields for <code>company_name</code>, bio, etc.</li>
<li>A file upload input for a profile picture, which uploads directly to Supabase Storage.</li>
<li>Checkboxes for <code>caps_certified</code> and a multi-select for <code>skills</code>.</li>
<li><strong>Service Area Map:</strong> An interactive map (using <code>react-leaflet</code>) where the contractor can draw a polygon defining their service area. The component's state holds the polygon's coordinates, which are converted to GeoJSON and sent to the Server Action to be saved in the <code>service_area</code> PostGIS column.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Lead Management (<code>/dashboard/contractor/leads</code>)</strong>:</p>
<ul>
<li><strong>Implementation:</strong> A Server Component that fetches all records from <code>project_contractor_matches</code> where <code>contractor_id</code> matches the current user. It joins with the <code>projects</code> and <code>ar_assessments</code> tables to get lead details.</li>
<li><strong>UI:</strong> A list or board view (e.g., New, Proposed, Won) of leads. Each lead card shows the project type, location, and urgency, with a button to &quot;View Details &amp; Create Proposal.&quot;</li>
</ul>
</li>
<li>
<p><strong>Dynamic Scope Builder (<code>/dashboard/contractor/leads/[projectId]</code>)</strong>:</p>
<ul>
<li><strong>Implementation:</strong> This is the core feature for contractors. It's a Client Component that receives the AR assessment data as a prop.</li>
<li><strong>Workflow:</strong>
<ol>
<li><strong>Display Recommendations:</strong> The component parses the <code>recommendations</code> JSON from the <code>ar_assessments</code> table and displays each item (e.g., &quot;Doorway is too narrow,&quot; &quot;No grab bars in shower&quot;).</li>
<li><strong>Itemize Scope:</strong> For each recommendation, the contractor can click &quot;Add to Scope.&quot; This adds the item to a list of line items.</li>
<li><strong>Add Custom Items:</strong> An &quot;Add Custom Item&quot; button allows the contractor to add services not identified by the AI.</li>
<li><strong>Pricing:</strong> Each line item has an input field for its cost. The component calculates the subtotal, taxes, and total in real-time.</li>
<li><strong>Submission:</strong> The final scope (an array of objects with <code>description</code> and <code>price</code>) and the <code>total_price</code> are submitted via a Server Action, which creates a new record in the <code>proposals</code> table.</li>
</ol>
</li>
</ul>
</li>
</ol>
<p><strong>Code Snippet: Server Action for Proposal Submission</strong></p>
<pre><code class="language-typescript"><span class="hljs-comment">// app/dashboard/contractor/leads/[projectId]/actions.ts</span>
<span class="hljs-string">&#x27;use server&#x27;</span>;

<span class="hljs-keyword">import</span> { createServerActionClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@supabase/auth-helpers-nextjs&#x27;</span>;
<span class="hljs-keyword">import</span> { cookies } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/headers&#x27;</span>;
<span class="hljs-keyword">import</span> { revalidatePath } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/cache&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitProposal</span>(<span class="hljs-params">formData: FormData</span>) {
  <span class="hljs-keyword">const</span> supabase = <span class="hljs-title function_">createServerActionClient</span>({ cookies });
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: { user } } = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">auth</span>.<span class="hljs-title function_">getUser</span>();

  <span class="hljs-keyword">if</span> (!user) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Unauthorized&#x27;</span> };
  }

  <span class="hljs-keyword">const</span> scopeDetails = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(formData.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;scopeDetails&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>);
  <span class="hljs-keyword">const</span> totalPrice = formData.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;totalPrice&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">const</span> projectId = formData.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;projectId&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;

  <span class="hljs-keyword">const</span> { error } = <span class="hljs-keyword">await</span> supabase.<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;proposals&#x27;</span>).<span class="hljs-title function_">insert</span>({
    <span class="hljs-attr">project_id</span>: projectId,
    <span class="hljs-attr">contractor_id</span>: user.<span class="hljs-property">id</span>,
    <span class="hljs-attr">scope_details</span>: scopeDetails,
    <span class="hljs-attr">total_price</span>: <span class="hljs-built_in">parseFloat</span>(totalPrice),
    <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;pending&#x27;</span>,
  });

  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Failed to submit proposal.&#x27;</span> };
  }

  <span class="hljs-comment">// Revalidate the page to show the new proposal status</span>
  <span class="hljs-title function_">revalidatePath</span>(<span class="hljs-string">`/dashboard/contractor/leads/<span class="hljs-subst">${projectId}</span>`</span>);
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> };
}
</code></pre>
<p>This comprehensive dashboard structure provides a robust, interactive, and secure experience for both homeowners and contractors, forming the core user-facing functionality of the HOMEase | AI platform.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user_dashboards&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Homeowner and Contractor Dashboards Development&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Frontend Development (Next.js), UI/UX Design&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="frontend-development-nextjs-backend-development-supabase-realtime-specialist">Frontend Development (Next.js), Backend Development (Supabase Realtime) Specialist</h3>
<h3 id="comprehensive-technical-architecture-plan-homease--ai-6"><strong>Comprehensive Technical Architecture Plan: HOMEase | AI</strong></h3>
<h3 id="subtask-real-time-messaging-system"><strong>Subtask: Real-time Messaging System</strong></h3>
<p>This document outlines the technical architecture for implementing a secure, real-time messaging system between homeowners and contractors within the HOMEase platform. The solution is built entirely on Supabase, leveraging its Realtime, Presence, and Row Level Security (RLS) features to provide an instant and secure communication channel.</p>
<hr>
<h4 id="1-overview--core-features"><strong>1. Overview &amp; Core Features</strong></h4>
<p>The messaging system is a critical component for facilitating communication after a homeowner accepts a contractor's proposal. The primary goals are:</p>
<ul>
<li><strong>Instant Communication:</strong> Messages should appear in the UI of both participants in real-time without needing a page refresh.</li>
<li><strong>Persistence:</strong> All conversations must be securely stored in the database for historical reference.</li>
<li><strong>Security &amp; Privacy:</strong> A user must only be able to access conversations they are a part of. This will be enforced at the database level using RLS.</li>
<li><strong>User Experience:</strong> Provide modern chat features like online status indicators (&quot;Presence&quot;) and typing notifications.</li>
</ul>
<p>The system will use a dedicated communication channel for each project, ensuring conversations are properly scoped and isolated.</p>
<hr>
<h4 id="2-database-schema--security"><strong>2. Database Schema &amp; Security</strong></h4>
<p>We will use the <code>messages</code> table defined in the previous task. We will also create a helper function to simplify our security policies.</p>
<p><strong>2.1. Messages Table Schema</strong></p>
<p>This schema is designed to store all message content and metadata required for filtering and security.</p>
<pre><code class="language-sql"><span class="hljs-comment">-- From the previous &#x27;user_dashboards&#x27; task</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> messages (
  id BIGSERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
  project_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> projects(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  sender_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> auth.users(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  <span class="hljs-comment">-- receiver_id is useful but can be derived if needed. We&#x27;ll keep it for simplicity.</span>
  receiver_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> auth.users(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
  content TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">char_length</span>(content) <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>),
  created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> NOW(),
  <span class="hljs-comment">-- Optional: read_at timestamp for read receipts</span>
  read_at TIMESTAMPTZ
);

<span class="hljs-comment">-- Enable Realtime for the messages table</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> messages REPLICA <span class="hljs-keyword">IDENTITY</span> <span class="hljs-keyword">FULL</span>;
<span class="hljs-keyword">ALTER</span> PUBLICATION supabase_realtime <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">TABLE</span> messages;

<span class="hljs-comment">-- Create an index for efficient message retrieval per project</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_messages_project_id <span class="hljs-keyword">ON</span> messages(project_id, created_at <span class="hljs-keyword">DESC</span>);
</code></pre>
<p><strong>2.2. SQL Helper Function for Security</strong></p>
<p>To make RLS policies clean and maintainable, we'll create a function that checks if a given user is a valid participant (homeowner or accepted contractor) for a specific project.</p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> is_project_participant(p_project_id UUID, p_user_id UUID)
<span class="hljs-keyword">RETURNS</span> <span class="hljs-type">BOOLEAN</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
  is_participant <span class="hljs-type">BOOLEAN</span>;
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-comment">-- Check if the user is the homeowner of the project</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> projects <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> p_project_id <span class="hljs-keyword">AND</span> homeowner_id <span class="hljs-operator">=</span> p_user_id
    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
    <span class="hljs-comment">-- Check if the user is the contractor with an accepted proposal for the project</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> proposals <span class="hljs-keyword">WHERE</span> project_id <span class="hljs-operator">=</span> p_project_id <span class="hljs-keyword">AND</span> contractor_id <span class="hljs-operator">=</span> p_user_id <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;accepted&#x27;</span>
  ) <span class="hljs-keyword">INTO</span> is_participant;
  <span class="hljs-keyword">RETURN</span> is_participant;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql SECURITY DEFINER;
</code></pre>
<p><strong>2.3. Row Level Security (RLS) Policies</strong></p>
<p>RLS is the cornerstone of our security model, ensuring data access is enforced directly by the database.</p>
<pre><code class="language-sql"><span class="hljs-comment">-- 1. Enable RLS on the messages table</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> messages ENABLE <span class="hljs-type">ROW</span> LEVEL SECURITY;

<span class="hljs-comment">-- 2. POLICY: Allow participants to READ messages for their projects</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Allow participants to read messages&quot;
<span class="hljs-keyword">ON</span> messages <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span>
<span class="hljs-keyword">USING</span> ( is_project_participant(project_id, auth.uid()) );

<span class="hljs-comment">-- 3. POLICY: Allow participants to INSERT messages for their projects</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Allow participants to send messages&quot;
<span class="hljs-keyword">ON</span> messages <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">INSERT</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">CHECK</span> (
  is_project_participant(project_id, auth.uid()) <span class="hljs-keyword">AND</span>
  sender_id <span class="hljs-operator">=</span> auth.uid() <span class="hljs-comment">-- Ensure users can only send messages as themselves</span>
);

<span class="hljs-comment">-- 4. POLICY: Deny updates and deletes to maintain conversation integrity</span>
<span class="hljs-keyword">CREATE</span> POLICY &quot;Deny message updates&quot;
<span class="hljs-keyword">ON</span> messages <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>
<span class="hljs-keyword">USING</span> ( <span class="hljs-literal">false</span> ); <span class="hljs-comment">-- Disallow anyone from updating messages</span>

<span class="hljs-keyword">CREATE</span> POLICY &quot;Deny message deletes&quot;
<span class="hljs-keyword">ON</span> messages <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">DELETE</span>
<span class="hljs-keyword">USING</span> ( <span class="hljs-literal">false</span> ); <span class="hljs-comment">-- Disallow anyone from deleting messages</span>
</code></pre>
<hr>
<h4 id="3-real-time-implementation-strategy"><strong>3. Real-time Implementation Strategy</strong></h4>
<p>We will use three distinct features of Supabase Realtime, all operating on a single channel scoped to the project ID (e.g., <code>realtime:project:123-abc</code>).</p>
<ol>
<li>
<p><strong>Postgres Changes (Message Syncing):</strong> This is the primary mechanism for receiving new messages. The frontend will subscribe to <code>INSERT</code> events on the <code>messages</code> table, filtered by the current <code>project_id</code>. This is highly reliable as it's tied directly to database commits.</p>
</li>
<li>
<p><strong>Presence (Online Status):</strong> This feature tracks which users are currently subscribed to the channel. We will use it to display a &quot; Online&quot; or &quot; Offline&quot; indicator next to the user's name in the chat header. The client will call <code>channel.track()</code> upon joining to announce its presence.</p>
</li>
<li>
<p><strong>Broadcast (Typing Indicators):</strong> This is for sending ephemeral, &quot;fire-and-forget&quot; events that don't need to be stored. When a user starts typing, the client will broadcast a <code>typing</code> event. Other clients listening on the channel will receive this event and can display a &quot;User is typing...&quot; indicator for a few seconds.</p>
</li>
</ol>
<hr>
<h4 id="4-frontend-component-architecture-nextjs"><strong>4. Frontend Component Architecture (Next.js)</strong></h4>
<p>The chat interface will be a client component (<code>'use client'</code>) that encapsulates all the logic for fetching, sending, and subscribing to real-time events.</p>
<p><strong>File:</strong> <code>app/components/messaging/ChatWindow.tsx</code></p>
<pre><code class="language-typescript"><span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useEffect, useState, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { createClientComponentClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@supabase/auth-helpers-nextjs&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@supabase/supabase-js&#x27;</span>;

<span class="hljs-comment">// Define types for clarity</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Message</span> = {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">sender_id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">created_at</span>: <span class="hljs-built_in">string</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ChatWindowProps</span> = {
  <span class="hljs-attr">projectId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">currentUser</span>: <span class="hljs-title class_">User</span>;
  <span class="hljs-attr">otherParticipant</span>: { <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">fullName</span>: <span class="hljs-built_in">string</span> };
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatWindow</span>(<span class="hljs-params">{ projectId, currentUser, otherParticipant }: ChatWindowProps</span>) {
  <span class="hljs-keyword">const</span> supabase = <span class="hljs-title function_">createClientComponentClient</span>();
  <span class="hljs-keyword">const</span> [messages, setMessages] = useState&lt;<span class="hljs-title class_">Message</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> [newMessage, setNewMessage] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);
  <span class="hljs-keyword">const</span> [isTyping, setIsTyping] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isOtherUserOnline, setIsOtherUserOnline] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> channelRef = useRef&lt;<span class="hljs-built_in">any</span>&gt;(<span class="hljs-literal">null</span>); <span class="hljs-comment">// To hold the channel instance</span>

  <span class="hljs-comment">// Fetch initial messages</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchMessages</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; {
      <span class="hljs-keyword">const</span> { data, error } = <span class="hljs-keyword">await</span> supabase
        .<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;messages&#x27;</span>)
        .<span class="hljs-title function_">select</span>(<span class="hljs-string">&#x27;*&#x27;</span>)
        .<span class="hljs-title function_">eq</span>(<span class="hljs-string">&#x27;project_id&#x27;</span>, projectId)
        .<span class="hljs-title function_">order</span>(<span class="hljs-string">&#x27;created_at&#x27;</span>, { <span class="hljs-attr">ascending</span>: <span class="hljs-literal">true</span> });

      <span class="hljs-keyword">if</span> (data) {
        <span class="hljs-title function_">setMessages</span>(data);
      }
    };
    <span class="hljs-title function_">fetchMessages</span>();
  }, [projectId, supabase]);

  <span class="hljs-comment">// Setup all real-time subscriptions</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> channel = supabase.<span class="hljs-title function_">channel</span>(<span class="hljs-string">`project-chat:<span class="hljs-subst">${projectId}</span>`</span>, {
      <span class="hljs-attr">config</span>: {
        <span class="hljs-attr">presence</span>: { <span class="hljs-attr">key</span>: currentUser.<span class="hljs-property">id</span> }, <span class="hljs-comment">// Track presence using user ID</span>
      },
    });

    <span class="hljs-comment">// 1. Subscribe to new messages (Postgres Changes)</span>
    channel.<span class="hljs-title function_">on</span>(
      <span class="hljs-string">&#x27;postgres_changes&#x27;</span>,
      { <span class="hljs-attr">event</span>: <span class="hljs-string">&#x27;INSERT&#x27;</span>, <span class="hljs-attr">schema</span>: <span class="hljs-string">&#x27;public&#x27;</span>, <span class="hljs-attr">table</span>: <span class="hljs-string">&#x27;messages&#x27;</span>, <span class="hljs-attr">filter</span>: <span class="hljs-string">`project_id=eq.<span class="hljs-subst">${projectId}</span>`</span> },
      <span class="hljs-function">(<span class="hljs-params">payload</span>) =&gt;</span> {
        <span class="hljs-title function_">setMessages</span>(<span class="hljs-function">(<span class="hljs-params">currentMessages</span>) =&gt;</span> [...currentMessages, payload.<span class="hljs-property">new</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Message</span>]);
      }
    );

    <span class="hljs-comment">// 2. Subscribe to Presence events</span>
    channel.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;presence&#x27;</span>, { <span class="hljs-attr">event</span>: <span class="hljs-string">&#x27;sync&#x27;</span> }, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> presenceState = channel.<span class="hljs-title function_">presenceState</span>();
      <span class="hljs-keyword">const</span> otherUserKey = otherParticipant.<span class="hljs-property">id</span>;
      <span class="hljs-title function_">setIsOtherUserOnline</span>(!!presenceState[otherUserKey]);
    });

    <span class="hljs-comment">// 3. Subscribe to Broadcast events (Typing)</span>
    channel.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;broadcast&#x27;</span>, { <span class="hljs-attr">event</span>: <span class="hljs-string">&#x27;typing&#x27;</span> }, <span class="hljs-function">(<span class="hljs-params">payload</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (payload.<span class="hljs-property">senderId</span> !== currentUser.<span class="hljs-property">id</span>) {
        <span class="hljs-title function_">setIsTyping</span>(<span class="hljs-literal">true</span>);
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setIsTyping</span>(<span class="hljs-literal">false</span>), <span class="hljs-number">2000</span>); <span class="hljs-comment">// Hide indicator after 2s</span>
      }
    });

    channel.<span class="hljs-title function_">subscribe</span>(<span class="hljs-keyword">async</span> (status) =&gt; {
      <span class="hljs-keyword">if</span> (status === <span class="hljs-string">&#x27;SUBSCRIBED&#x27;</span>) {
        <span class="hljs-comment">// Announce presence once subscribed</span>
        <span class="hljs-keyword">await</span> channel.<span class="hljs-title function_">track</span>({ <span class="hljs-attr">online_at</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>() });
      }
    });

    channelRef.<span class="hljs-property">current</span> = channel;

    <span class="hljs-comment">// Cleanup on component unmount</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (channelRef.<span class="hljs-property">current</span>) {
        supabase.<span class="hljs-title function_">removeChannel</span>(channelRef.<span class="hljs-property">current</span>);
      }
    };
  }, [projectId, currentUser.<span class="hljs-property">id</span>, otherParticipant.<span class="hljs-property">id</span>, supabase]);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSendMessage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">e: React.FormEvent</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-keyword">if</span> (newMessage.<span class="hljs-title function_">trim</span>() === <span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">await</span> supabase.<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;messages&#x27;</span>).<span class="hljs-title function_">insert</span>({
      <span class="hljs-attr">project_id</span>: projectId,
      <span class="hljs-attr">sender_id</span>: currentUser.<span class="hljs-property">id</span>,
      <span class="hljs-attr">receiver_id</span>: otherParticipant.<span class="hljs-property">id</span>,
      <span class="hljs-attr">content</span>: newMessage.<span class="hljs-title function_">trim</span>(),
    });

    <span class="hljs-title function_">setNewMessage</span>(<span class="hljs-string">&#x27;&#x27;</span>);
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTyping</span> = (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-keyword">if</span> (channelRef.<span class="hljs-property">current</span>) {
      channelRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">send</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;broadcast&#x27;</span>,
        <span class="hljs-attr">event</span>: <span class="hljs-string">&#x27;typing&#x27;</span>,
        <span class="hljs-attr">payload</span>: { <span class="hljs-attr">senderId</span>: currentUser.<span class="hljs-property">id</span> },
      });
    }
  };

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;chat-container&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;chat-header&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>{otherParticipant.fullName}<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{isOtherUserOnline</span> ? &#x27;<span class="hljs-attr">online</span>&#x27; <span class="hljs-attr">:</span> &#x27;<span class="hljs-attr">offline</span>&#x27;}&gt;</span>
           {isOtherUserOnline ? &#x27;Online&#x27; : &#x27;Offline&#x27;}
        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;message-list&quot;</span>&gt;</span>
        {messages.map((msg) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{msg.id}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{msg.sender_id</span> === <span class="hljs-string">currentUser.id</span> ? &#x27;<span class="hljs-attr">my-message</span>&#x27; <span class="hljs-attr">:</span> &#x27;<span class="hljs-attr">other-message</span>&#x27;}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{msg.content}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
        {isTyping &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;typing-indicator&quot;</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSendMessage}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;message-input-form&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span>
          <span class="hljs-attr">value</span>=<span class="hljs-string">{newMessage}</span>
          <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
            setNewMessage(e.target.value);
            handleTyping();
          }}
          placeholder=&quot;Type a message...&quot;
        /&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span>&gt;</span>Send<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>This architecture provides a complete, secure, and feature-rich real-time messaging system using the full power of the Supabase stack, integrating seamlessly into the Next.js application.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;realtime_messaging&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Real-time Messaging System&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Frontend Development (Next.js), Backend Development (Supabase Realtime)&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="backend-development-stripe-integration-supabase-edge-functions-frontend-development-specialist">Backend Development (Stripe Integration, Supabase Edge Functions), Frontend Development Specialist</h3>
<h3 id="comprehensive-technical-architecture-plan-homease--ai-7"><strong>Comprehensive Technical Architecture Plan: HOMEase | AI</strong></h3>
<h3 id="subtask-payment-integration-and-administrative-dashboard"><strong>Subtask: Payment Integration and Administrative Dashboard</strong></h3>
<p>This document outlines the architecture for integrating a robust payment system using Stripe and developing a secure administrative dashboard for platform management. This plan replaces the original GCP/Firebase components with a Supabase-centric stack, leveraging Stripe Connect for multi-party payments and Supabase Edge Functions for reliable, real-time event handling.</p>
<hr>
<h4 id="1-high-level-architecture-for-payments--administration"><strong>1. High-Level Architecture for Payments &amp; Administration</strong></h4>
<p>The payment and admin systems are designed to be secure, scalable, and decoupled from the main user-facing application logic.</p>
<ul>
<li><strong>Payment Flow:</strong> The system uses <strong>Stripe Connect Express</strong> for contractor onboarding and payouts, and <strong>Stripe Checkout</strong> for homeowner payments. This creates a three-party transaction model: Homeowner -&gt; Stripe -&gt; (Platform Fee + Contractor Payout).</li>
<li><strong>Webhook Handling:</strong> A Supabase Edge Function provides a secure endpoint to receive Stripe webhooks. This is the source of truth for payment-related events, ensuring the HOMEase database is always synchronized with Stripe's transaction states.</li>
<li><strong>Admin Dashboard:</strong> A separate, role-protected area within the Next.js application, located at the <code>/admin</code> route. It will use Server Components for data display and Server Actions for performing administrative tasks, ensuring all sensitive operations happen on the server.</li>
</ul>
<hr>
<h4 id="2-database-schema-extensions-1"><strong>2. Database Schema Extensions</strong></h4>
<p>To support payments and administration, we will extend the existing schema.</p>
<pre><code class="language-sql"><span class="hljs-comment">-- Add Stripe Connect ID and verification status to contractor profiles</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> contractor_profiles
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> stripe_connect_id TEXT <span class="hljs-keyword">UNIQUE</span>,
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> stripe_onboarding_complete <span class="hljs-type">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>;

<span class="hljs-comment">-- Add admin role to the profiles table</span>
<span class="hljs-comment">-- We can enforce this with a check constraint</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> profiles
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> role TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;homeowner&#x27;</span> <span class="hljs-keyword">CHECK</span> (role <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;homeowner&#x27;</span>, <span class="hljs-string">&#x27;contractor&#x27;</span>, <span class="hljs-string">&#x27;admin&#x27;</span>));

<span class="hljs-comment">-- Create a new table to track all financial transactions</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> payments (
    id UUID <span class="hljs-keyword">PRIMARY</span> KEY <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
    project_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> projects(id),
    homeowner_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> auth.users(id),
    contractor_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">REFERENCES</span> auth.users(id),
    stripe_charge_id TEXT <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- From Stripe&#x27;s charge object</span>
    amount_total <span class="hljs-type">NUMERIC</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- Total amount paid by homeowner</span>
    platform_fee <span class="hljs-type">NUMERIC</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- The fee HOMEase collected</span>
    amount_paid_to_contractor <span class="hljs-type">NUMERIC</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    status TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- e.g., &#x27;succeeded&#x27;, &#x27;pending&#x27;, &#x27;failed&#x27;</span>
    created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> NOW()
);

<span class="hljs-comment">-- Update the project status enum to include payment-related states</span>
<span class="hljs-keyword">ALTER</span> TYPE project_status RENAME <span class="hljs-keyword">TO</span> project_status_old;
<span class="hljs-keyword">CREATE</span> TYPE project_status <span class="hljs-keyword">AS</span> ENUM (
  <span class="hljs-string">&#x27;draft&#x27;</span>,
  <span class="hljs-string">&#x27;assessment_complete&#x27;</span>,
  <span class="hljs-string">&#x27;lead_submitted&#x27;</span>,
  <span class="hljs-string">&#x27;matching_complete&#x27;</span>,
  <span class="hljs-string">&#x27;proposals_received&#x27;</span>,
  <span class="hljs-string">&#x27;proposal_accepted&#x27;</span>,
  <span class="hljs-string">&#x27;awaiting_payment&#x27;</span>, <span class="hljs-comment">-- New status after proposal is accepted</span>
  <span class="hljs-string">&#x27;payment_complete&#x27;</span>, <span class="hljs-comment">-- New status after successful payment</span>
  <span class="hljs-string">&#x27;in_progress&#x27;</span>,
  <span class="hljs-string">&#x27;completed&#x27;</span>,
  <span class="hljs-string">&#x27;cancelled&#x27;</span>
);
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> projects <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">COLUMN</span> status TYPE project_status <span class="hljs-keyword">USING</span> status::text::project_status;
<span class="hljs-keyword">DROP</span> TYPE project_status_old;
</code></pre>
<hr>
<h4 id="3-stripe-integration-onboarding-and-payments"><strong>3. Stripe Integration: Onboarding and Payments</strong></h4>
<h5 id="31-contractor-onboarding-stripe-connect-express"><strong>3.1. Contractor Onboarding (Stripe Connect Express)</strong></h5>
<p>This flow allows contractors to securely provide their identity and banking information to Stripe to receive payouts.</p>
<ol>
<li><strong>Initiate Onboarding:</strong> In the contractor dashboard (<code>/dashboard/contractor/profile</code>), a &quot;Setup Payouts&quot; button is displayed if <code>stripe_onboarding_complete</code> is false.</li>
<li><strong>Server Action:</strong> Clicking the button triggers a Next.js Server Action (<code>createConnectAccount</code>).
<ul>
<li>It checks if a <code>stripe_connect_id</code> already exists for the contractor.</li>
<li>If not, it calls the Stripe API (<code>stripe.accounts.create</code>) with <code>type: 'express'</code>.</li>
<li>It saves the new <code>stripe_connect_id</code> to the <code>contractor_profiles</code> table.</li>
<li>It then calls <code>stripe.accountLinks.create</code> to generate a unique, short-lived onboarding URL.</li>
<li>The Server Action returns this URL to the client.</li>
</ul>
</li>
<li><strong>Redirect to Stripe:</strong> The client-side component receives the URL and redirects the contractor to Stripe's co-branded Express onboarding flow.</li>
<li><strong>Return to Platform:</strong> After completing the flow, Stripe redirects the contractor back to a specified <code>return_url</code> (e.g., <code>/dashboard/contractor/profile?onboarding=complete</code>).</li>
<li><strong>Webhook Verification:</strong> Stripe sends an <code>account.updated</code> webhook to our Supabase Edge Function. The function inspects the <code>charges_enabled</code> and <code>payouts_enabled</code> fields on the account object. If true, it updates the <code>stripe_onboarding_complete</code> flag to <code>true</code> in the <code>contractor_profiles</code> table.</li>
</ol>
<h5 id="32-homeowner-payment-stripe-checkout"><strong>3.2. Homeowner Payment (Stripe Checkout)</strong></h5>
<p>This flow occurs after a homeowner accepts a contractor's proposal.</p>
<ol>
<li><strong>Initiate Payment:</strong> The project status moves to <code>awaiting_payment</code>. A &quot;Pay for Project&quot; button appears on the homeowner's project detail page.</li>
<li><strong>Server Action:</strong> Clicking the button calls a Server Action (<code>createCheckoutSession</code>).
<ul>
<li>The action retrieves the project total from the <code>proposals</code> table.</li>
<li>It calculates the <code>application_fee_amount</code> based on HOMEase's business logic.</li>
<li>It calls <code>stripe.checkout.sessions.create</code> with the following key parameters:
<ul>
<li><code>line_items</code>: The project total.</li>
<li><code>payment_intent_data[application_fee_amount]</code>: The calculated platform fee.</li>
<li><code>payment_intent_data[transfer_data][destination]</code>: The contractor's <code>stripe_connect_id</code>.</li>
<li><code>success_url</code> and <code>cancel_url</code>.</li>
<li><code>metadata</code>: Includes <code>project_id</code>, <code>homeowner_id</code>, and <code>contractor_id</code> for tracking.</li>
</ul>
</li>
<li>The Server Action returns the Checkout session ID.</li>
</ul>
</li>
<li><strong>Redirect to Checkout:</strong> The client uses the Stripe.js library to redirect the homeowner to the secure Stripe Checkout page using the session ID.</li>
<li><strong>Webhook Confirmation:</strong> Upon successful payment, Stripe sends a <code>checkout.session.completed</code> webhook. The Edge Function handles this event to finalize the transaction in the database (see section 4).</li>
</ol>
<hr>
<h4 id="4-webhook-handling-with-supabase-edge-functions"><strong>4. Webhook Handling with Supabase Edge Functions</strong></h4>
<p>A single, robust Edge Function will handle all incoming Stripe events.</p>
<p><strong>Location:</strong> <code>supabase/functions/stripe-webhooks/index.ts</code></p>
<p><strong>Core Logic:</strong></p>
<ol>
<li><strong>Security First:</strong> The function <strong>must</strong> verify the Stripe signature (<code>Stripe-Signature</code> header) on every incoming request to ensure it originated from Stripe. This prevents spoofing attacks. The webhook signing secret will be stored as a Supabase environment variable.</li>
<li><strong>Event Parsing:</strong> The function parses the JSON body of the request to get the Stripe event object.</li>
<li><strong>Event Routing:</strong> A <code>switch</code> statement handles different <code>event.type</code> values.</li>
<li><strong>Database Updates:</strong> The function uses the Supabase client to perform necessary database operations for each event.</li>
</ol>
<p><strong>Code Example: <code>stripe-webhooks</code> Edge Function</strong></p>
<pre><code class="language-typescript"><span class="hljs-comment">// supabase/functions/stripe-webhooks/index.ts</span>
<span class="hljs-keyword">import</span> { serve } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;https://deno.land/std@0.177.0/http/server.ts&#x27;</span>;
<span class="hljs-keyword">import</span> { createClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;https://esm.sh/@supabase/supabase-js@2&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Stripe</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;https://esm.sh/stripe@11.1.0?target=deno&#x27;</span>;

<span class="hljs-keyword">const</span> stripe = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stripe</span>(<span class="hljs-title class_">Deno</span>.<span class="hljs-property">env</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;STRIPE_API_KEY&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, {
  <span class="hljs-attr">apiVersion</span>: <span class="hljs-string">&#x27;2022-11-15&#x27;</span>,
  <span class="hljs-attr">httpClient</span>: <span class="hljs-title class_">Stripe</span>.<span class="hljs-title function_">createFetchHttpClient</span>(),
});

<span class="hljs-keyword">const</span> webhookSecret = <span class="hljs-title class_">Deno</span>.<span class="hljs-property">env</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;STRIPE_WEBHOOK_SIGNING_SECRET&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;

<span class="hljs-title function_">serve</span>(<span class="hljs-keyword">async</span> (req) =&gt; {
  <span class="hljs-keyword">const</span> signature = req.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;Stripe-Signature&#x27;</span>);
  <span class="hljs-keyword">const</span> body = <span class="hljs-keyword">await</span> req.<span class="hljs-title function_">text</span>();

  <span class="hljs-keyword">let</span> <span class="hljs-attr">event</span>: <span class="hljs-title class_">Stripe</span>.<span class="hljs-property">Event</span>;
  <span class="hljs-keyword">try</span> {
    event = <span class="hljs-keyword">await</span> stripe.<span class="hljs-property">webhooks</span>.<span class="hljs-title function_">constructEventAsync</span>(body, signature!, webhookSecret);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Webhook signature verification failed: <span class="hljs-subst">${err.message}</span>`</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(err.<span class="hljs-property">message</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">400</span> });
  }

  <span class="hljs-comment">// Create a Supabase client with the service_role key</span>
  <span class="hljs-keyword">const</span> supabaseAdmin = <span class="hljs-title function_">createClient</span>(
    <span class="hljs-title class_">Deno</span>.<span class="hljs-property">env</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;SUPABASE_URL&#x27;</span>)!,
    <span class="hljs-title class_">Deno</span>.<span class="hljs-property">env</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;SUPABASE_SERVICE_ROLE_KEY&#x27;</span>)!
  );

  <span class="hljs-comment">// Handle the event</span>
  <span class="hljs-keyword">switch</span> (event.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;account.updated&#x27;</span>: {
      <span class="hljs-keyword">const</span> account = event.<span class="hljs-property">data</span>.<span class="hljs-property">object</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Stripe</span>.<span class="hljs-property">Account</span>;
      <span class="hljs-keyword">if</span> (account.<span class="hljs-property">charges_enabled</span> &amp;&amp; account.<span class="hljs-property">payouts_enabled</span>) {
        <span class="hljs-keyword">await</span> supabaseAdmin
          .<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;contractor_profiles&#x27;</span>)
          .<span class="hljs-title function_">update</span>({ <span class="hljs-attr">stripe_onboarding_complete</span>: <span class="hljs-literal">true</span> })
          .<span class="hljs-title function_">eq</span>(<span class="hljs-string">&#x27;stripe_connect_id&#x27;</span>, account.<span class="hljs-property">id</span>);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;checkout.session.completed&#x27;</span>: {
      <span class="hljs-keyword">const</span> session = event.<span class="hljs-property">data</span>.<span class="hljs-property">object</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Stripe</span>.<span class="hljs-property">Checkout</span>.<span class="hljs-property">Session</span>;
      <span class="hljs-keyword">const</span> { project_id, homeowner_id, contractor_id } = session.<span class="hljs-property">metadata</span>!;
      
      <span class="hljs-comment">// Update project status</span>
      <span class="hljs-keyword">await</span> supabaseAdmin
        .<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;projects&#x27;</span>)
        .<span class="hljs-title function_">update</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;payment_complete&#x27;</span> })
        .<span class="hljs-title function_">eq</span>(<span class="hljs-string">&#x27;id&#x27;</span>, project_id);

      <span class="hljs-comment">// Create a record in the payments table (simplified)</span>
      <span class="hljs-keyword">const</span> charge = <span class="hljs-keyword">await</span> stripe.<span class="hljs-property">charges</span>.<span class="hljs-title function_">retrieve</span>(session.<span class="hljs-property">payment_intent</span>.<span class="hljs-property">charges</span>.<span class="hljs-property">data</span>[<span class="hljs-number">0</span>].<span class="hljs-property">id</span>);
      <span class="hljs-keyword">await</span> supabaseAdmin.<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;payments&#x27;</span>).<span class="hljs-title function_">insert</span>({
        project_id,
        homeowner_id,
        contractor_id,
        <span class="hljs-attr">stripe_charge_id</span>: charge.<span class="hljs-property">id</span>,
        <span class="hljs-attr">amount_total</span>: session.<span class="hljs-property">amount_total</span> / <span class="hljs-number">100</span>,
        <span class="hljs-attr">platform_fee</span>: charge.<span class="hljs-property">application_fee_amount</span> / <span class="hljs-number">100</span>,
        <span class="hljs-attr">amount_paid_to_contractor</span>: (session.<span class="hljs-property">amount_total</span> - charge.<span class="hljs-property">application_fee_amount</span>) / <span class="hljs-number">100</span>,
        <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;succeeded&#x27;</span>,
      });
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-comment">// Add other cases like &#x27;charge.failed&#x27;, &#x27;payout.paid&#x27;, etc.</span>
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">received</span>: <span class="hljs-literal">true</span> }), { <span class="hljs-attr">status</span>: <span class="hljs-number">200</span> });
});
</code></pre>
<hr>
<h4 id="5-administrative-dashboard-admin"><strong>5. Administrative Dashboard (<code>/admin</code>)</strong></h4>
<p>This is a secure section of the Next.js app for internal HOMEase staff.</p>
<h5 id="51-authentication-and-authorization"><strong>5.1. Authentication and Authorization</strong></h5>
<ul>
<li><strong>Role Definition:</strong> Users with <code>role = 'admin'</code> in the <code>profiles</code> table are considered administrators. This role is assigned manually in the Supabase dashboard for trusted staff.</li>
<li><strong>Middleware Protection:</strong> A <code>middleware.ts</code> file at the root of the app will protect the <code>/admin</code> route group.<pre><code class="language-typescript"><span class="hljs-comment">// middleware.ts</span>
<span class="hljs-keyword">import</span> { createMiddlewareClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@supabase/auth-helpers-nextjs&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/server&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params">req</span>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();
  <span class="hljs-keyword">const</span> supabase = <span class="hljs-title function_">createMiddlewareClient</span>({ req, res });
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: { session } } = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">auth</span>.<span class="hljs-title function_">getSession</span>();

  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;/admin&#x27;</span>)) {
    <span class="hljs-keyword">if</span> (!session) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, req.<span class="hljs-property">url</span>));
    }
    
    <span class="hljs-comment">// Fetch user profile to check role</span>
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: profile } = <span class="hljs-keyword">await</span> supabase
      .<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;profiles&#x27;</span>)
      .<span class="hljs-title function_">select</span>(<span class="hljs-string">&#x27;role&#x27;</span>)
      .<span class="hljs-title function_">eq</span>(<span class="hljs-string">&#x27;id&#x27;</span>, session.<span class="hljs-property">user</span>.<span class="hljs-property">id</span>)
      .<span class="hljs-title function_">single</span>();
    
    <span class="hljs-keyword">if</span> (profile?.<span class="hljs-property">role</span> !== <span class="hljs-string">&#x27;admin&#x27;</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">&#x27;/dashboard&#x27;</span>, req.<span class="hljs-property">url</span>)); <span class="hljs-comment">// Or show an unauthorized page</span>
    }
  }
  <span class="hljs-keyword">return</span> res;
}
</code></pre>
</li>
</ul>
<h5 id="52-admin-dashboard-features"><strong>5.2. Admin Dashboard Features</strong></h5>
<p>The admin dashboard will be built with Server Components for read operations and Server Actions for mutations.</p>
<ol>
<li>
<p><strong>Main View (<code>/admin</code>)</strong>:</p>
<ul>
<li><strong>Implementation:</strong> A Server Component that fetches aggregate data.</li>
<li><strong>UI:</strong> Displays key platform analytics widgets:
<ul>
<li>Total Users (Homeowners vs. Contractors)</li>
<li>Leads Created (This week/month)</li>
<li>Projects in Progress</li>
<li>Total Revenue (Platform Fees)</li>
<li>A chart showing revenue over time (using Chart.js in a Client Component).</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Contractor Approval Queue (<code>/admin/contractors</code>)</strong>:</p>
<ul>
<li><strong>Implementation:</strong> A Server Component that fetches all contractors where <code>verification_status</code> is 'pending_approval'.</li>
<li><strong>UI:</strong> A table listing pending contractors. Each row shows the contractor's name, company, and location, with a &quot;Review&quot; button.</li>
<li><strong>Detail View (<code>/admin/contractors/[contractorId]</code>)</strong>:
<ul>
<li>Displays the full contractor profile, including links to download their uploaded license and insurance documents from Supabase Storage.</li>
<li>Includes &quot;Approve&quot; and &quot;Reject&quot; buttons. These buttons are part of a form that triggers a Server Action (<code>updateContractorStatus</code>).</li>
<li>The Server Action updates the contractor's <code>verification_status</code> and can trigger a Supabase Edge Function to send an approval/rejection email via Resend or a similar service.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>User Management (<code>/admin/users</code>)</strong>:</p>
<ul>
<li><strong>Implementation:</strong> A Server Component with a paginated table of all users from the <code>profiles</code> table.</li>
<li><strong>UI:</strong> Provides search and filter capabilities. Each row allows an admin to view the user's profile and provides an option to deactivate their account (e.g., setting an <code>is_active</code> flag to <code>false</code>). This action is handled by a secure Server Action.</li>
</ul>
</li>
</ol>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;payments_admin&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Payment Integration and Administrative Dashboard&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Backend Development (Stripe Integration, Supabase Edge Functions), Frontend Development&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="results-integrator">Results Integrator</h3>
<p>Of course. Here is a comprehensive technical architecture plan for the HOMEase | AI platform, re-architected to use Next.js App Router and Supabase, replacing the original Google Cloud and Firebase stack.</p>
<h3 id="executive-summary-1"><strong>Executive Summary</strong></h3>
<p>This document outlines a comprehensive technical architecture for the HOMEase | AI platform, pivoting from the originally planned Google Cloud/Firebase stack to a modern, integrated solution centered on <strong>Next.js 15 (App Router)</strong> for the frontend and <strong>Supabase</strong> for all backend services. This strategic shift consolidates the technology stack, enhances developer experience, and leverages the power of PostgreSQL to build a secure, scalable, and real-time lead generation platform.</p>
<p>The architecture is built on Vercel for hosting, providing seamless deployment and performance optimization for the Next.js application. Supabase serves as a complete backend-as-a-service (BaaS), offering a relational PostgreSQL database, authentication, object storage, serverless Edge Functions, and real-time capabilities. This plan details the system's foundation, core user journeys, payment integration, administrative oversight, and a full DevOps pipeline, ensuring a robust and efficient path to market.</p>
<hr>
<h3 id="1-core-technology-stack-1"><strong>1. Core Technology Stack</strong></h3>
<p>The platform is built on a modern, serverless architecture designed for scalability and performance.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Component</th>
<th style="text-align:left">Technology</th>
<th style="text-align:left">Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>Frontend &amp; Web Server</strong></td>
<td style="text-align:left"><strong>Next.js 15 (App Router) on Vercel</strong></td>
<td style="text-align:left">Provides a powerful React framework with Server Components, Server Actions, and an optimized build process. Vercel offers best-in-class hosting, performance, and CI/CD integration.</td>
</tr>
<tr>
<td style="text-align:left"><strong>Database</strong></td>
<td style="text-align:left"><strong>Supabase (PostgreSQL)</strong></td>
<td style="text-align:left">A robust, relational SQL database offering data integrity, powerful querying with extensions like PostGIS for geospatial data, and fine-grained security via Row Level Security (RLS).</td>
</tr>
<tr>
<td style="text-align:left"><strong>Authentication</strong></td>
<td style="text-align:left"><strong>Supabase Auth</strong></td>
<td style="text-align:left">Manages user identity, social logins, and secure session handling via JWTs. Integrates seamlessly with the database and Next.js middleware for route protection.</td>
</tr>
<tr>
<td style="text-align:left"><strong>Serverless Functions</strong></td>
<td style="text-align:left"><strong>Supabase Edge Functions (Deno)</strong></td>
<td style="text-align:left">Replaces Google Cloud Functions for running backend logic, orchestrating AI services, and handling webhooks. Deployed at the edge for low latency.</td>
</tr>
<tr>
<td style="text-align:left"><strong>File Storage</strong></td>
<td style="text-align:left"><strong>Supabase Storage</strong></td>
<td style="text-align:left">Securely stores user-uploaded images from AR assessments, contractor licenses, and other documents, with access control managed by database policies.</td>
</tr>
<tr>
<td style="text-align:left"><strong>Real-time Engine</strong></td>
<td style="text-align:left"><strong>Supabase Realtime</strong></td>
<td style="text-align:left">Powers live updates for the messaging system, online presence indicators, and notifications for asynchronous jobs like AI analysis and contractor matching.</td>
</tr>
<tr>
<td style="text-align:left"><strong>AI Analysis</strong></td>
<td style="text-align:left"><strong>Google Gemini &amp; <a href="http://Fal.ai">Fal.ai</a></strong></td>
<td style="text-align:left">As per the original specification, these external APIs will be called from Supabase Edge Functions to perform hazard analysis and generate &quot;after&quot; visualizations.</td>
</tr>
<tr>
<td style="text-align:left"><strong>Payments</strong></td>
<td style="text-align:left"><strong>Stripe (Connect &amp; Checkout)</strong></td>
<td style="text-align:left">Manages contractor onboarding, verification, payouts (Connect), and secure homeowner payments (Checkout) in a multi-party transaction model.</td>
</tr>
<tr>
<td style="text-align:left"><strong>DevOps &amp; CI/CD</strong></td>
<td style="text-align:left"><strong>GitHub &amp; Vercel with GitHub Actions</strong></td>
<td style="text-align:left">Provides a complete, automated workflow from code commit to production deployment, including automated testing, preview deployments, and environment management.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="2-platform-foundation-data-model--authentication-1"><strong>2. Platform Foundation: Data Model &amp; Authentication</strong></h3>
<p>The foundation of the platform is a secure, relational database and a robust authentication system that enforces strict access control based on user roles.</p>
<h4 id="21-supabase-database-schema-1"><strong>2.1. Supabase Database Schema</strong></h4>
<p>The data model is built on a normalized PostgreSQL schema, ensuring data integrity and consistency.</p>
<ul>
<li><strong><code>profiles</code></strong>: Extends the built-in <code>auth.users</code> table, storing public data like <code>full_name</code>, <code>avatar_url</code>, and the critical <code>role</code> (<code>homeowner</code>, <code>contractor</code>, or <code>admin</code>). A database trigger automatically creates a profile for each new user.</li>
<li><strong><code>contractor_details</code></strong>: A one-to-one extension of <code>profiles</code> for contractors, containing fields for <code>company_name</code>, <code>is_caps_certified</code>, <code>verification_status</code>, and their <code>stripe_connect_id</code>. It also includes a <code>GEOMETRY</code> column for their service area, powered by the PostGIS extension.</li>
<li><strong><code>projects</code></strong>: The central table representing a homeowner's lead. It links to the <code>homeowner_id</code>, stores the project <code>status</code> (e.g., <code>draft</code>, <code>open_for_bids</code>, <code>completed</code>), and contains address/location data.</li>
<li><strong><code>ar_assessments</code></strong>: Stores the output of the AI analysis, including the <code>accessibility_score</code>, <code>identified_hazards</code> (JSONB), <code>recommendations</code> (JSONB), and <code>fal_ai_visualization_urls</code>.</li>
<li><strong><code>project_matches</code></strong>: A join table linking <code>projects</code> to matched <code>contractors</code>, tracking the status of their interaction (e.g., <code>matched</code>, <code>proposal_sent</code>).</li>
<li><strong><code>messages</code></strong>: Stores all real-time chat messages, linked to a specific project match.</li>
<li><strong><code>payments</code></strong>: Records every transaction processed through Stripe, linking the <code>project_id</code>, <code>payer_id</code>, <code>payee_id</code>, and <code>stripe_charge_id</code>.</li>
</ul>
<h4 id="22-authentication-and-authorization-1"><strong>2.2. Authentication and Authorization</strong></h4>
<p>Authentication is handled by Supabase Auth, integrated into Next.js using the <code>@supabase/ssr</code> library.</p>
<ol>
<li><strong>Session Management:</strong> A Next.js middleware file securely manages the user's session by refreshing the auth cookie on every request, making user data available to both Server and Client Components.</li>
<li><strong>Route Protection:</strong> The middleware also acts as a gatekeeper, redirecting unauthenticated users away from protected routes like <code>/dashboard</code> and <code>/admin</code>.</li>
<li><strong>Row Level Security (RLS):</strong> This is the cornerstone of the platform's security. RLS policies are PostgreSQL rules that filter data at the database level, ensuring users can only access data they are permitted to see.
<ul>
<li><strong>Example Policy 1:</strong> A user can only select or update their own row in the <code>profiles</code> table.<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> POLICY &quot;Users can manage their own profile.&quot;
<span class="hljs-keyword">ON</span> public.profiles <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">USING</span> ( auth.uid() <span class="hljs-operator">=</span> id );
</code></pre>
</li>
<li><strong>Example Policy 2:</strong> A homeowner can only view projects they have created.<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> POLICY &quot;Homeowners can view their own projects.&quot;
<span class="hljs-keyword">ON</span> public.projects <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> ( auth.uid() <span class="hljs-operator">=</span> homeowner_id );
</code></pre>
</li>
<li><strong>Example Policy 3:</strong> A contractor can only view projects they have been explicitly matched with.<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> POLICY &quot;Contractors can view matched projects.&quot;
<span class="hljs-keyword">ON</span> public.projects <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (
  <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> project_matches
    <span class="hljs-keyword">WHERE</span> project_matches.project_id <span class="hljs-operator">=</span> projects.id
    <span class="hljs-keyword">AND</span> project_matches.contractor_id <span class="hljs-operator">=</span> auth.uid()
  )
);
</code></pre>
</li>
</ul>
</li>
</ol>
<hr>
<h3 id="3-core-journey-ar-assessment-to-contractor-match-1"><strong>3. Core Journey: AR Assessment to Contractor Match</strong></h3>
<p>This two-stage, asynchronous workflow forms the innovative core of the HOMEase platform.</p>
<h4 id="stage-1-ar-assessment-and-ai-analysis-1"><strong>Stage 1: AR Assessment and AI Analysis</strong></h4>
<p>This stage is designed to be non-blocking, providing a responsive user experience while computationally intensive AI tasks run in the background.</p>
<ol>
<li><strong>Capture (Frontend):</strong> The homeowner uses a WebXR-based component (built with <code>@react-three/xr</code>) in the Next.js app to capture images of their home. These images are uploaded directly and securely to a private bucket in <strong>Supabase Storage</strong>.</li>
<li><strong>Initiate (Edge Function):</strong> The app invokes a Supabase Edge Function (<code>process-ar-assessment</code>), passing the storage paths of the uploaded images. This function immediately creates a placeholder record in the <code>ar_assessments</code> table with a <code>processing</code> status and returns a <code>202 Accepted</code> response to the user.</li>
<li><strong>Orchestrate (Background Function):</strong> The initiator function then triggers a second, long-running Edge Function (<code>generate-ai-analysis</code>) without awaiting its completion. This worker function:
<ul>
<li>Generates secure, signed URLs for the stored images.</li>
<li>Calls the <strong>Google Gemini API</strong> with the images and a specialized prompt to perform hazard analysis.</li>
<li>Calls the <strong><a href="http://Fal.ai">Fal.ai</a> API</strong> with the results to generate &quot;after&quot; visualizations.</li>
</ul>
</li>
<li><strong>Persist &amp; Notify:</strong> The worker function updates the <code>ar_assessments</code> record with the AI results and changes its status to <code>completed</code>. The homeowner's app, subscribed to database changes via <strong>Supabase Realtime</strong>, is instantly notified and displays the full report.</li>
</ol>
<h4 id="stage-2-lead-submission-and-contractor-matching-1"><strong>Stage 2: Lead Submission and Contractor Matching</strong></h4>
<p>Once the assessment is complete, the homeowner can submit it as a lead, triggering the asynchronous matching process.</p>
<ol>
<li><strong>Submit (Frontend):</strong> The homeowner reviews the report, adds budget and urgency details, and clicks &quot;Find Contractors.&quot; This action updates the corresponding <code>projects</code> table record, setting its <code>status</code> to <code>open_for_bids</code>.</li>
<li><strong>Trigger (Database):</strong> A <strong>PostgreSQL Trigger</strong> on the <code>projects</code> table detects this specific status change. It securely invokes a Supabase Edge Function (<code>match-contractors</code>) via a database webhook, passing the project data as the payload. This trigger-based approach is more robust and conditional than a simple webhook.</li>
<li><strong>Match (Edge Function):</strong> The <code>match-contractors</code> function executes the matching logic:
<ul>
<li>It queries the <code>contractor_details</code> table using a <strong>PostGIS geospatial function</strong> (<code>ST_Contains</code>) to find contractors whose service area polygon contains the project's location point.</li>
<li>It further filters these contractors by skills (derived from the AR recommendations) and CAPS certification.</li>
<li>This complex query is encapsulated in a PostgreSQL Function (RPC) for performance and maintainability.</li>
</ul>
</li>
<li><strong>Persist &amp; Notify:</strong> For each qualified contractor found, the function inserts a record into the <code>project_matches</code> table. The homeowner's dashboard, subscribed via <strong>Supabase Realtime</strong>, automatically populates with contractor profiles as they are matched.</li>
</ol>
<hr>
<h3 id="4-user-interfaces-dashboards--communication-1"><strong>4. User Interfaces: Dashboards &amp; Communication</strong></h3>
<p>The platform provides role-specific dashboards for homeowners and contractors, built as protected routes within the Next.js application.</p>
<h4 id="41-homeowner-dashboard-dashboardhomeowner-1"><strong>4.1. Homeowner Dashboard (<code>/dashboard/homeowner</code>)</strong></h4>
<ul>
<li><strong>Project Hub:</strong> View a list of all projects and their current status on a visual timeline.</li>
<li><strong>Contractor Matching:</strong> See a real-time list of matched contractors as they are found by the backend process.</li>
<li><strong>Proposal Management:</strong> Review, accept, or decline proposals submitted by contractors.</li>
<li><strong>Secure Payments:</strong> Initiate payments via Stripe Checkout after accepting a proposal.</li>
<li><strong>Real-time Chat:</strong> Communicate directly with the selected contractor.</li>
</ul>
<h4 id="42-contractor-dashboard-dashboardcontractor-1"><strong>4.2. Contractor Dashboard (<code>/dashboard/contractor</code>)</strong></h4>
<ul>
<li><strong>Profile Management:</strong> Manage company details, upload licenses/insurance, and define a service area by drawing a polygon on an interactive map.</li>
<li><strong>Lead Feed:</strong> View and manage incoming, pre-qualified leads.</li>
<li><strong>Dynamic Scope Builder:</strong> An interactive tool that uses the AR assessment data as a starting point. Contractors can convert AI recommendations into line items, add custom items, and set prices to auto-generate a detailed proposal.</li>
<li><strong>Payment Tracking:</strong> View payment history and manage payouts.</li>
</ul>
<h4 id="43-real-time-messaging-system-1"><strong>4.3. Real-time Messaging System</strong></h4>
<p>The chat feature is powered entirely by Supabase Realtime, operating on a secure, project-specific channel.</p>
<ul>
<li><strong>Message Syncing:</strong> New messages inserted into the <code>messages</code> table are broadcast to participants in real-time using <strong>Postgres Changes</strong>.</li>
<li><strong>Online Status:</strong> <strong>Supabase Presence</strong> tracks which users are currently active in the chat, allowing for &quot;Online&quot; indicators.</li>
<li><strong>Typing Indicators:</strong> Ephemeral &quot;is typing...&quot; notifications are sent using <strong>Supabase Broadcast</strong>, which avoids writing unnecessary data to the database.</li>
</ul>
<hr>
<h3 id="5-monetization--administration-1"><strong>5. Monetization &amp; Administration</strong></h3>
<p>The platform's financial operations and internal oversight are handled by Stripe integration and a secure admin dashboard.</p>
<h4 id="51-stripe-payment-integration-1"><strong>5.1. Stripe Payment Integration</strong></h4>
<ul>
<li><strong>Contractor Onboarding:</strong> Contractors are onboarded using <strong>Stripe Connect Express</strong>. A Server Action in Next.js creates a Stripe account link, redirecting the user to Stripe's secure flow. A webhook confirms when their account is verified and ready for payouts.</li>
<li><strong>Homeowner Payments:</strong> After a proposal is accepted, the homeowner pays using <strong>Stripe Checkout</strong>. The platform fee is automatically calculated and transferred to the HOMEase platform account during the transaction using Stripe's <code>application_fee_amount</code> parameter.</li>
<li><strong>Webhook Handling:</strong> A single, secure Supabase Edge Function (<code>stripe-webhooks</code>) acts as the endpoint for all Stripe events. It verifies the Stripe signature on every request and updates the <code>payments</code> and <code>projects</code> tables accordingly, ensuring a reliable record of all financial activity.</li>
</ul>
<h4 id="52-administrative-dashboard-admin-1"><strong>5.2. Administrative Dashboard (<code>/admin</code>)</strong></h4>
<p>This is a role-protected area of the app, accessible only to users with the <code>admin</code> role.</p>
<ul>
<li><strong>Security:</strong> Access is controlled by the Next.js middleware, which checks the user's role from the <code>profiles</code> table.</li>
<li><strong>Analytics:</strong> A main dashboard displays key platform metrics like user growth, lead volume, and revenue.</li>
<li><strong>Contractor Approval:</strong> An interface for reviewing pending contractor applications, viewing their uploaded documents, and approving or rejecting them.</li>
<li><strong>User Management:</strong> A tool for viewing and managing all user accounts on the platform. All administrative actions are executed via secure Next.js Server Actions.</li>
</ul>
<hr>
<h3 id="6-deployment--devops-on-vercel-1"><strong>6. Deployment &amp; DevOps on Vercel</strong></h3>
<p>A full CI/CD pipeline ensures code quality and automates deployments, enabling rapid and reliable iteration.</p>
<ol>
<li><strong>Hosting on Vercel:</strong> The Next.js application is deployed to Vercel, which provides a global Edge Network, automatic scaling, and seamless integration with GitHub.</li>
<li><strong>Environment Strategy:</strong>
<ul>
<li><strong>Production:</strong> The live application, connected to the production Supabase project and deployed from the <code>main</code> branch.</li>
<li><strong>Preview (Staging):</strong> For every pull request, Vercel creates a unique preview deployment connected to a separate staging Supabase project. This allows for thorough testing and review before merging.</li>
<li><strong>Local:</strong> Developers run the app locally, also connected to the staging Supabase project.</li>
</ul>
</li>
<li><strong>CI/CD Pipeline with GitHub Actions:</strong>
<ul>
<li><strong>Trigger:</strong> The pipeline runs automatically on every pull request to the <code>main</code> branch.</li>
<li><strong>Quality Gates:</strong> A GitHub Actions workflow runs a series of checks:
<ul>
<li><strong>Linting:</strong> Enforces code style consistency with ESLint.</li>
<li><strong>Testing:</strong> Runs automated unit and integration tests (e.g., with Vitest or Jest).</li>
<li><strong>Type Checking:</strong> The <code>next build</code> command performs a full TypeScript check.</li>
</ul>
</li>
<li><strong>Branch Protection:</strong> A GitHub branch protection rule is configured on <code>main</code> to prevent merging until all CI checks have passed.</li>
<li><strong>Deployment:</strong> Once a pull request is approved and merged, Vercel automatically builds and deploys the new version to production, using the production environment variables configured in the Vercel dashboard.</li>
</ul>
</li>
</ol>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span>
<span class="hljs-punctuation">}</span>
</code></pre>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>