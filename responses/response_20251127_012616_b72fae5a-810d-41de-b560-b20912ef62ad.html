<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Agent Response - orchestrator&lowbar;workers</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="agent-response---orchestrator_workers">Agent Response - orchestrator_workers</h1>
<p><strong>Session ID</strong>: b72fae5a-810d-41de-b560-b20912ef62ad
<strong>Processing Time</strong>: 569.81 seconds</p>
<h2 id="final-response">Final Response</h2>
<p>Of course. Let's build out the Expense Splitter App. This is an excellent project that combines user authentication, database management, file storage, and core business logic, making it a perfect showcase for Next.js and Firebase.</p>
<p>Here is a comprehensive, step-by-step guide to building the application from project initialization to final deployment.</p>
<h3 id="executive-summary"><strong>Executive Summary</strong></h3>
<p>We will construct a full-stack Expense Splitter web application using the Next.js App Router for the frontend and Firebase for the backend. The application will allow users to register, create groups, invite members, add shared expenses with optional receipt uploads, and automatically view a simplified breakdown of who owes whom. The project is broken down into four key phases:</p>
<ol>
<li><strong>Foundation &amp; Setup:</strong> Initializing the Next.js project, configuring Firebase services (Auth, Firestore, Storage), and designing the database schema.</li>
<li><strong>Core Functionality:</strong> Implementing user authentication, creating protected routes, and building the features for creating, viewing, and managing groups.</li>
<li><strong>Expense &amp; Calculation Logic:</strong> Developing the systems for adding expenses, uploading receipts, and implementing the core algorithm to calculate and display group balances.</li>
<li><strong>Polishing &amp; Deployment:</strong> Applying a professional UI/UX design, securing the backend with robust rules, and deploying the final application to the web using Vercel.</li>
</ol>
<hr>
<h3 id="phase-1-project-foundation-and-data-modeling"><strong>Phase 1: Project Foundation and Data Modeling</strong></h3>
<p>First, we'll set up our development environment and design the database structure that will power the entire application.</p>
<h4 id="1-project-initialization-nextjs"><strong>1. Project Initialization (Next.js)</strong></h4>
<p>Begin by creating a new Next.js project with the recommended modern stack.</p>
<ol>
<li><strong>Create the App:</strong> Open your terminal and run:<pre><code class="language-bash">npx create-next-app@latest expense-splitter
</code></pre>
</li>
<li><strong>Select Options:</strong> Use the following settings for a robust setup:
<ul>
<li>TypeScript: <strong>Yes</strong></li>
<li>ESLint: <strong>Yes</strong></li>
<li>Tailwind CSS: <strong>Yes</strong></li>
<li><code>src/</code> directory: <strong>Yes</strong></li>
<li>App Router: <strong>Yes</strong></li>
<li>Customize import alias: <strong>No</strong></li>
</ul>
</li>
<li><strong>Navigate and Install Firebase:</strong><pre><code class="language-bash"><span class="hljs-built_in">cd</span> expense-splitter
npm install firebase
</code></pre>
</li>
</ol>
<h4 id="2-firebase-backend-configuration"><strong>2. Firebase Backend Configuration</strong></h4>
<p>Next, set up the necessary Firebase services.</p>
<ol>
<li><strong>Create a Firebase Project:</strong> Go to the <a href="https://console.firebase.google.com/">Firebase Console</a>, click &quot;Add project,&quot; and follow the setup wizard.</li>
<li><strong>Enable Services:</strong>
<ul>
<li><strong>Firestore Database:</strong> From the &quot;Build&quot; menu, create a Firestore database. Start in <strong>Test mode</strong> for now; we will secure it later.</li>
<li><strong>Authentication:</strong> Go to the Authentication service and enable the <strong>Email/Password</strong> and <strong>Google</strong> sign-in providers.</li>
<li><strong>Storage:</strong> Go to the Storage service and create a storage bucket, also starting in <strong>Test mode</strong>.</li>
</ul>
</li>
<li><strong>Connect App to Firebase:</strong>
<ul>
<li>In your Firebase project settings, register a new <strong>Web app (<code>&lt;/&gt;</code>)</strong>.</li>
<li>Firebase will provide a <code>firebaseConfig</code> object. Copy these credentials.</li>
</ul>
</li>
<li><strong>Set Up Environment Variables:</strong>
<ul>
<li>In your project root, create a file named <code>.env.local</code>.</li>
<li>Add your Firebase credentials, prefixed with <code>NEXT_PUBLIC_</code>:<pre><code class="language-.env.local">NEXT_PUBLIC_FIREBASE_API_KEY=&quot;AIzaSy...&quot;
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=&quot;your-project-id.firebaseapp.com&quot;
NEXT_PUBLIC_FIREBASE_PROJECT_ID=&quot;your-project-id&quot;
// ...and so on for all keys.
</code></pre>
</li>
</ul>
</li>
<li><strong>Create Firebase Initializer:</strong> Centralize your Firebase configuration. Create <code>src/lib/firebase/config.ts</code>:<pre><code class="language-typescript"><span class="hljs-comment">// src/lib/firebase/config.ts</span>
<span class="hljs-keyword">import</span> { initializeApp, getApps, getApp } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/app&quot;</span>;
<span class="hljs-keyword">import</span> { getAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/auth&quot;</span>;
<span class="hljs-keyword">import</span> { getFirestore } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;
<span class="hljs-keyword">import</span> { getStorage } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/storage&quot;</span>;

<span class="hljs-keyword">const</span> firebaseConfig = {
  <span class="hljs-attr">apiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_API_KEY</span>,
  <span class="hljs-attr">authDomain</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN</span>,
  <span class="hljs-attr">projectId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_PROJECT_ID</span>,
  <span class="hljs-attr">storageBucket</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET</span>,
  <span class="hljs-attr">messagingSenderId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID</span>,
  <span class="hljs-attr">appId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_APP_ID</span>,
};

<span class="hljs-keyword">const</span> app = !<span class="hljs-title function_">getApps</span>().<span class="hljs-property">length</span> ? <span class="hljs-title function_">initializeApp</span>(firebaseConfig) : <span class="hljs-title function_">getApp</span>();
<span class="hljs-keyword">const</span> db = <span class="hljs-title function_">getFirestore</span>(app);
<span class="hljs-keyword">const</span> auth = <span class="hljs-title function_">getAuth</span>(app);
<span class="hljs-keyword">const</span> storage = <span class="hljs-title function_">getStorage</span>(app);

<span class="hljs-keyword">export</span> { app, db, auth, storage };
</code></pre>
</li>
</ol>
<h4 id="3-firestore-schema-design"><strong>3. Firestore Schema Design</strong></h4>
<p>A well-planned schema is essential for performance and scalability. We'll use three top-level collections.</p>
<ul>
<li>
<p><strong><code>users</code> Collection:</strong> Stores individual user profiles. The Document ID will be the user's UID from Firebase Auth.</p>
<ul>
<li>Path: <code>/users/{userId}</code></li>
<li>Fields: <code>uid</code>, <code>email</code>, <code>displayName</code>, <code>photoURL</code>, <code>createdAt</code>, <code>groups</code> (Array of group IDs).</li>
</ul>
</li>
<li>
<p><strong><code>groups</code> Collection:</strong> Stores information about each expense-sharing group.</p>
<ul>
<li>Path: <code>/groups/{groupId}</code></li>
<li>Fields: <code>groupName</code>, <code>createdBy</code> (user UID), <code>createdAt</code>, <code>inviteCode</code>, <code>members</code> (Array of member objects with <code>uid</code>, <code>displayName</code>, <code>photoURL</code>), and <code>memberUids</code> (a simple Array of member UIDs for efficient security rule checks).</li>
</ul>
</li>
<li>
<p><strong><code>expenses</code> Subcollection:</strong> Each group document will contain a subcollection of its expenses. This is a highly efficient way to query for all expenses related to a single group.</p>
<ul>
<li>Path: <code>/groups/{groupId}/expenses/{expenseId}</code></li>
<li>Fields: <code>description</code>, <code>amount</code> (in cents), <code>createdAt</code>, <code>paidBy</code> (user UID), <code>paidByDisplayName</code>, <code>receiptUrl</code> (optional), <code>splitMethod</code>, and <code>participants</code> (Array of objects detailing who owes what, e.g., <code>{ uid, amountOwed }</code>).</li>
</ul>
</li>
</ul>
<p><strong>Note on Balances:</strong> We will not store running balances in the database. Instead, balances will be calculated dynamically on the client side by fetching all expenses for a group. This approach is more robust and less prone to data synchronization errors.</p>
<hr>
<h3 id="phase-2-user-authentication-and-group-management"><strong>Phase 2: User Authentication and Group Management</strong></h3>
<p>With the foundation laid, we'll build the app's core interactive features.</p>
<h4 id="1-global-authentication-state"><strong>1. Global Authentication State</strong></h4>
<p>We'll use React Context to manage the user's authentication state across the entire application. This context will also handle the crucial task of creating a user document in Firestore the first time a user signs in.</p>
<ul>
<li>Create <code>src/context/AuthContext.tsx</code>. This provider will:
<ul>
<li>Use Firebase's <code>onAuthStateChanged</code> listener to track the current user.</li>
<li>When a user logs in, it will check if a corresponding document exists in <code>/users/{uid}</code>. If not, it creates one.</li>
<li>Provide the <code>user</code> object, a <code>loading</code> state, and a <code>logout</code> function to all child components.</li>
</ul>
</li>
<li>Wrap the application's root layout (<code>src/app/layout.tsx</code>) with this <code>AuthProvider</code> to make it globally accessible.</li>
</ul>
<h4 id="2-authentication-pages-and-protected-routes"><strong>2. Authentication Pages and Protected Routes</strong></h4>
<p>Users need a way to sign in, sign up, and be restricted from accessing content they aren't authorized to see.</p>
<ol>
<li><strong>Create Auth Pages:</strong> Build the UI for <code>/login</code> and <code>/signup</code> pages using simple forms. These forms will use the Firebase SDK functions (<code>signInWithEmailAndPassword</code>, <code>createUserWithEmailAndPassword</code>, <code>signInWithPopup</code> for Google) to handle authentication.</li>
<li><strong>Implement Protected Routes:</strong> Create a <code>ProtectedRoute</code> component (<code>src/components/ProtectedRoute.tsx</code>). This component will:
<ul>
<li>Use the <code>useAuth</code> hook to access the current user and loading state.</li>
<li>If <code>loading</code> is true, it can show a spinner.</li>
<li>If <code>loading</code> is false and no <code>user</code> exists, it will redirect to the <code>/login</code> page using Next.js's <code>useRouter</code>.</li>
<li>Wrap any page that requires authentication (like the dashboard) with this <code>ProtectedRoute</code> component.</li>
</ul>
</li>
</ol>
<h4 id="3-group-management-features"><strong>3. Group Management Features</strong></h4>
<p>Once authenticated, users should be able to create and view their groups.</p>
<ol>
<li><strong>Firestore Service Functions:</strong> Create a file <code>src/lib/firebase/firestore.ts</code> to house all database interactions.
<ul>
<li><code>createGroup(groupName, user)</code>: Creates a new document in the <code>groups</code> collection, populates it with the creator's info, generates a unique invite code (using a library like <code>nanoid</code>), and adds the new group's ID to the creator's document in the <code>users</code> collection.</li>
<li><code>getUserGroups(userId)</code>: Fetches the user's document, retrieves their list of group IDs, and then queries the <code>groups</code> collection to get the full details for each group.</li>
</ul>
</li>
<li><strong>UI Components:</strong>
<ul>
<li><strong>CreateGroupModal:</strong> A modal form that takes a group name and calls the <code>createGroup</code> service function on submission.</li>
<li><strong>GroupList:</strong> A component that calls <code>getUserGroups</code> and maps over the results to display a list of <code>GroupCard</code> components. Each card shows the group's name, number of members, and the invite code.</li>
</ul>
</li>
<li><strong>Dashboard Page:</strong> Update the <code>/dashboard</code> page to be the main hub. It will display a &quot;Create Group&quot; button that opens the modal and will render the <code>GroupList</code> component.</li>
</ol>
<hr>
<h3 id="phase-3-expense-tracking-and-debt-calculation"><strong>Phase 3: Expense Tracking and Debt Calculation</strong></h3>
<p>This is the core &quot;splitter&quot; functionality of the application.</p>
<h4 id="1-expense-creation-and-receipt-uploads"><strong>1. Expense Creation and Receipt Uploads</strong></h4>
<p>We'll build a dedicated page for each group where users can add and view expenses.</p>
<ol>
<li><strong>Create Dynamic Group Page:</strong> Create a dynamic route at <code>src/app/group/[groupId]/page.tsx</code>. This page will be the central view for a single group.</li>
<li><strong>Extend Firestore Service:</strong> Add functions to <code>firestore.ts</code>:
<ul>
<li><code>getGroupDetails(groupId)</code>: Fetches a single group's document.</li>
<li><code>addExpenseToGroup(expenseData)</code>: Creates a new document in the <code>/groups/{groupId}/expenses</code> subcollection.</li>
<li><code>getGroupExpenses(groupId)</code>: Fetches all documents from a group's <code>expenses</code> subcollection.</li>
</ul>
</li>
<li><strong>Implement Receipt Uploads:</strong>
<ul>
<li>Create a storage service file, <code>src/lib/firebase/storage.ts</code>.</li>
<li>Implement an <code>uploadReceipt(file, groupId)</code> function that uses Firebase Storage to upload an image to a path like <code>receipts/{groupId}/{unique_file_name}</code> and returns the public download URL. Use <code>uuid</code> to generate unique file names.</li>
</ul>
</li>
<li><strong>Build UI Components:</strong>
<ul>
<li><strong>AddExpenseModal:</strong> A comprehensive modal form with fields for description, amount, who paid (a dropdown of group members), and an optional file input for the receipt. On submit, it will first upload the receipt (if present) to get the URL, then call <code>addExpenseToGroup</code> with all the data.</li>
<li><strong>ExpenseList:</strong> A component that displays a list of expenses for the group. Each item shows the description, amount, payer, and a link to &quot;View Receipt&quot; if a <code>receiptUrl</code> exists.</li>
</ul>
</li>
</ol>
<h4 id="2-debt-calculation-logic"><strong>2. Debt Calculation Logic</strong></h4>
<p>The &quot;magic&quot; happens here. We'll write a pure function to process expenses and determine who owes whom.</p>
<ol>
<li><strong>Create Calculation Utility:</strong> Create a file <code>src/utils/debtCalculator.ts</code>.</li>
<li><strong>Implement <code>calculateBalances</code> Function:</strong> This function will accept two arguments: an array of <code>expenses</code> and an array of group <code>members</code>.
<ul>
<li><strong>Step 1: Tally Balances:</strong> It iterates through all expenses. For each expense, it credits the <code>paidBy</code> user with the full amount and debits each <code>participant</code> by their <code>amountOwed</code>. This results in a map of each user's net balance (positive means they are owed money, negative means they owe money).</li>
<li><strong>Step 2: Simplify Debts:</strong> It implements a greedy algorithm to simplify the list of debts. It separates users into debtors (negative balance) and creditors (positive balance) and creates the minimum number of transactions required to settle all balances. For example, if A owes B $10 and B owes C $10, the algorithm simplifies this to A pays C $10.</li>
</ul>
</li>
<li><strong>Create Balance Summary UI:</strong> Build a <code>BalanceSummary</code> component that takes the simplified debt list and displays it in a clear, human-readable format (e.g., &quot;Alice owes Bob $15.50&quot;).</li>
</ol>
<h4 id="3-integrate-on-group-page"><strong>3. Integrate on Group Page</strong></h4>
<p>Update the dynamic group page (<code>/group/[groupId]/page.tsx</code>) to tie everything together.</p>
<ul>
<li>On page load, it will fetch both the group details and all its expenses in parallel.</li>
<li>It will then pass this data to the <code>calculateBalances</code> function.</li>
<li>Finally, it will render the <code>BalanceSummary</code> component with the calculated debts at the top of the page, followed by the full <code>ExpenseList</code>.</li>
</ul>
<hr>
<h3 id="phase-4-uiux-security-and-deployment"><strong>Phase 4: UI/UX, Security, and Deployment</strong></h3>
<p>The final phase focuses on making the app professional, secure, and publicly accessible.</p>
<h4 id="1-uiux-design-and-styling"><strong>1. UI/UX Design and Styling</strong></h4>
<p>We'll use Tailwind CSS to create a consistent, modern, and responsive design.</p>
<ol>
<li><strong>Establish a Design System:</strong> Extend the <code>tailwind.config.ts</code> file with a custom color palette (e.g., <code>brand.primary</code>, <code>success</code>, <code>danger</code>). Refine base styles in <code>globals.css</code> for buttons, inputs, and cards.</li>
<li><strong>Create a Reusable Layout:</strong> Build a <code>MainLayout</code> component that includes a consistent header with the app logo, user information, and a logout button. Use this layout on all authenticated pages.</li>
<li><strong>Refine Components:</strong> Systematically style all components—modals, cards, forms, and lists—using the defined color palette and utility classes. Add hover effects, transitions, and icons (e.g., from <code>heroicons</code>) to improve user experience.</li>
</ol>
<h4 id="2-firebase-security-rules"><strong>2. Firebase Security Rules</strong></h4>
<p>This is a critical, non-negotiable step before deployment to protect user data.</p>
<ol>
<li><strong>Firestore Rules:</strong> In the Firebase console, go to Firestore &gt; Rules. Replace the test rules with production rules that enforce:
<ul>
<li><strong>Users:</strong> A user can only read and write their own document (<code>/users/{userId}</code>).</li>
<li><strong>Groups:</strong> A user can only read/write group data if their UID is present in the group's <code>memberUids</code> array.</li>
<li><strong>Expenses:</strong> A user can only create an expense if they are a member of the group and are listed as the payer.</li>
</ul>
</li>
<li><strong>Storage Rules:</strong> Go to Storage &gt; Rules. Implement rules that:
<ul>
<li>Allow image uploads only for authenticated users who are members of the corresponding group.</li>
<li>Validate uploads to ensure they are images and within a reasonable size limit (e.g., &lt; 5MB).</li>
<li>Allow reads (downloads) only for members of the group.</li>
</ul>
</li>
</ol>
<h4 id="3-deployment-to-vercel"><strong>3. Deployment to Vercel</strong></h4>
<p>Finally, we'll deploy the application to the web.</p>
<ol>
<li><strong>Prepare for Deployment:</strong>
<ul>
<li>Initialize a Git repository and push your project to a provider like GitHub.</li>
<li>Ensure your <code>.gitignore</code> file includes <code>.env.local</code> to prevent committing secret keys.</li>
</ul>
</li>
<li><strong>Import to Vercel:</strong>
<ul>
<li>Sign up for Vercel using your GitHub account.</li>
<li>Import your project repository from the Vercel dashboard.</li>
</ul>
</li>
<li><strong>Configure Environment Variables:</strong> In the Vercel project settings, navigate to &quot;Environment Variables.&quot; Copy every key-value pair from your local <code>.env.local</code> file into Vercel's UI. This securely provides your production deployment with the Firebase credentials.</li>
<li><strong>Deploy:</strong> Click the &quot;Deploy&quot; button. Vercel will automatically build and deploy your application, providing you with a public URL (e.g., <code>expense-splitter.vercel.app</code>).</li>
</ol>
<p>Congratulations! You have now successfully designed, built, secured, and deployed a feature-rich Expense Splitter application. With Vercel's CI/CD, every future <code>git push</code> to your main branch will automatically trigger a new deployment, keeping your live application up-to-date.</p>
<h2 id="intermediate-steps">Intermediate Steps</h2>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtasks&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Next.js, Firebase Console&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Project Setup and Firebase Configuration&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;project-setup&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Initialize a new Next.js project using the App Router. Create a corresponding Firebase project, enabling and configuring Firestore, Firebase Authentication (Email/Password and Google), and Firebase Storage. Securely set up environment variables for Firebase configuration within the Next.js application.&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Firestore, NoSQL Database Design&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;project-setup&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;schema-design&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design the NoSQL database schema for Firestore. This includes defining the collections for users, groups, and expenses. Specify the document structure for each, including fields, data types, and relationships (e.g., how users are linked to groups and expenses to users/groups).&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Firestore Database Schema Design&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Implement User Authentication&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Next.js, React, Firebase Authentication&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Create the UI and logic for user registration, login, and logout using the Firebase Authentication SDK. Implement protected routes to restrict access to the main application features to authenticated users only. Manage the global authentication state using React Context or a similar state management solution.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user-auth&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;project-setup&quot;</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Next.js, React, Firestore&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Build Group Management Features&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;user-auth&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">&quot;schema-design&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Develop the functionality for users to create new groups, view their existing groups, and invite other users (e.g., via a unique invite code). This involves creating the UI components and the Firestore queries/mutations to manage group data.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;group-management&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Implement Expense Creation and Tracking&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;expense-creation&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;group-management&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Next.js, React Forms, Firestore&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Create the form and underlying logic for adding an expense to a group. The form should capture the expense description, total amount, the user who paid, and the split method (e.g., split equally, by specific amounts). This data will be saved as a new document in the &#x27;expenses&#x27; collection in Firestore.&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;receipt-upload&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Firebase Storage, React File Handling&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Add Receipt Upload Functionality&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Integrate Firebase Storage to allow users to upload receipt images when creating an expense. The uploaded image&#x27;s URL will be stored as a field in the corresponding expense document in Firestore.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;expense-creation&quot;</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;expense-creation&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;debt-calculation&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Develop Debt Calculation and Dashboard Logic&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Develop the core algorithm to calculate the net balance for each member within a group. This logic will process all expenses to determine who owes whom. Display these balances on a clear, intuitive dashboard for each group, providing a summary of debts.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Algorithm Design, Data Processing, Next.js&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ui-styling&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design and apply a consistent and responsive UI/UX across the application using a modern CSS framework like Tailwind CSS or a component library. Ensure all components, from authentication forms to the group dashboard, are user-friendly and visually appealing.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;UI/UX Design and Styling&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;user-auth&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">&quot;group-management&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">&quot;expense-creation&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">&quot;debt-calculation&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;UI/UX Design, CSS, Tailwind CSS&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Firebase Security Rules&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Implement Firebase Security Rules&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Write and enforce security rules for Firestore and Firebase Storage to protect user data, ensuring that users can only access and modify data they are authorized to. This is a critical step before deployment.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;security-rules&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;project-setup&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">&quot;ui-styling&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">&quot;debt-calculation&quot;</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Deploy the Application to Vercel&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Deploy the completed Next.js application to a hosting platform like Vercel. Configure the production environment, including setting up the necessary environment variables and ensuring the domain is set up correctly.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Vercel, CI/CD&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;security-rules&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;deployment&quot;</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;execution_strategy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;The project will be executed in a phased, sequential manner, starting with foundational setup and progressively building features. Phase 1 focuses on setting up the Next.js project and Firebase backend, including user authentication. Phase 2 will implement the core application logic for group and expense management. Phase 3 will develop the debt calculation logic and the main user dashboard. Phase 4 will handle the UI/UX polishing and final deployment. This ensures that a solid foundation is built before adding complex features.&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;task_understanding&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;The user wants to build a personal finance application using Next.js (App Router) and Firebase. From the provided options, the &#x27;Expense Splitter App&#x27; is the most suitable project to plan. The goal is to create a web application where users can form groups, track shared expenses, upload receipts, and easily see who owes whom, with all data stored and managed in Firebase.&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="nextjs-firebase-console-specialist">Next.js, Firebase Console Specialist</h3>
<p>Excellent choice! An Expense Splitter App is a practical and feature-rich project to build. Let's get started with the foundational step: setting up our Next.js project and configuring Firebase.</p>
<h3 id="subtask-project-setup-and-firebase-configuration"><strong>Subtask: Project Setup and Firebase Configuration</strong></h3>
<p>In this phase, we will initialize a new Next.js application using the App Router, create a corresponding Firebase project, and securely connect the two using environment variables.</p>
<hr>
<h3 id="step-1-initialize-the-nextjs-project"><strong>Step 1: Initialize the Next.js Project</strong></h3>
<p>First, let's create a new Next.js project. Make sure you have Node.js (version 18.17 or later) installed.</p>
<ol>
<li>
<p><strong>Open your terminal</strong> and run the following command. We'll name our project <code>expense-splitter</code>.</p>
<pre><code class="language-bash">npx create-next-app@latest expense-splitter
</code></pre>
</li>
<li>
<p>You'll be prompted with a series of questions. For a modern and robust setup, I recommend these selections:</p>
<pre><code class="language-text">✔ Would you like to use TypeScript? … Yes
✔ Would you like to use ESLint? … Yes
✔ Would you like to use Tailwind CSS? … Yes
✔ Would you like to use `src/` directory? … Yes
✔ Would you like to use App Router? (recommended) … Yes
✔ Would you like to customize the default import alias (@/*)? … No
</code></pre>
</li>
<li>
<p>Once the installation is complete, navigate into your new project directory:</p>
<pre><code class="language-bash"><span class="hljs-built_in">cd</span> expense-splitter
</code></pre>
</li>
</ol>
<p>You now have a clean Next.js project ready to go.</p>
<h3 id="step-2-create-and-configure-the-firebase-project"><strong>Step 2: Create and Configure the Firebase Project</strong></h3>
<p>Now, let's set up the backend services on Firebase.</p>
<ol>
<li>
<p><strong>Go to the Firebase Console:</strong> <a href="https://console.firebase.google.com/">https://console.firebase.google.com/</a></p>
</li>
<li>
<p><strong>Create a New Project:</strong> Click on &quot;Add project&quot;, give it a name (e.g., &quot;Expense Splitter App&quot;), and follow the on-screen steps. You can disable Google Analytics for this project if you wish.</p>
</li>
<li>
<p>Once your project is created, you'll be taken to the project dashboard. We need to enable three core services:</p>
<p><strong>A. Enable Firestore Database:</strong></p>
<ul>
<li>In the left-hand menu under &quot;Build&quot;, click on <strong>Firestore Database</strong>.</li>
<li>Click <strong>Create database</strong>.</li>
<li>Choose to start in <strong>Test mode</strong>. This allows for easy read/write access during development.
<blockquote>
<p><strong>⚠️ Security Warning:</strong> Test mode rules expire after 30 days and leave your data open. We will write secure rules in a later step before going to production.</p>
</blockquote>
</li>
<li>Select a Cloud Firestore location (choose one close to your target users).</li>
<li>Click <strong>Enable</strong>.</li>
</ul>
<p><strong>B. Enable Firebase Authentication:</strong></p>
<ul>
<li>In the left-hand menu under &quot;Build&quot;, click on <strong>Authentication</strong>.</li>
<li>Click <strong>Get started</strong>.</li>
<li>In the &quot;Sign-in method&quot; tab, you'll see a list of providers. Enable the following two:
<ul>
<li><strong>Email/Password</strong>: Click on it, toggle the &quot;Enable&quot; switch, and click &quot;Save&quot;.</li>
<li><strong>Google</strong>: Click on it, toggle the &quot;Enable&quot; switch, provide a project support email, and click &quot;Save&quot;.</li>
</ul>
</li>
</ul>
<p><strong>C. Enable Firebase Storage:</strong></p>
<ul>
<li>In the left-hand menu under &quot;Build&quot;, click on <strong>Storage</strong>.</li>
<li>Click <strong>Get started</strong>.</li>
<li>Follow the prompts to create a storage bucket, again starting in <strong>Test mode</strong>.</li>
<li>Choose the same location you selected for Firestore.</li>
</ul>
</li>
</ol>
<p>Your Firebase backend is now configured with the necessary services.</p>
<h3 id="step-3-connect-firebase-to-your-nextjs-app"><strong>Step 3: Connect Firebase to Your Next.js App</strong></h3>
<p>Now we need to get the configuration keys from Firebase to let our Next.js app know how to connect to it.</p>
<ol>
<li>
<p>In your Firebase project dashboard, click the <strong>Gear icon</strong> (Project settings) next to &quot;Project Overview&quot;.</p>
</li>
<li>
<p>Under the &quot;General&quot; tab, scroll down to the &quot;Your apps&quot; section.</p>
</li>
<li>
<p>Click on the <strong>Web icon (<code>&lt;/&gt;</code>)</strong> to register a new web app.</p>
</li>
<li>
<p>Give your app a nickname (e.g., &quot;Expense Splitter Web&quot;) and click <strong>Register app</strong>.</p>
</li>
<li>
<p>Firebase will generate a configuration object. <strong>Copy the <code>firebaseConfig</code> object</strong>. It will look something like this:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> firebaseConfig = {
  <span class="hljs-attr">apiKey</span>: <span class="hljs-string">&quot;AIzaSy...&quot;</span>,
  <span class="hljs-attr">authDomain</span>: <span class="hljs-string">&quot;your-project-id.firebaseapp.com&quot;</span>,
  <span class="hljs-attr">projectId</span>: <span class="hljs-string">&quot;your-project-id&quot;</span>,
  <span class="hljs-attr">storageBucket</span>: <span class="hljs-string">&quot;your-project-id.appspot.com&quot;</span>,
  <span class="hljs-attr">messagingSenderId</span>: <span class="hljs-string">&quot;...&quot;</span>,
  <span class="hljs-attr">appId</span>: <span class="hljs-string">&quot;1:...&quot;</span>
};
</code></pre>
</li>
</ol>
<h3 id="step-4-securely-set-up-environment-variables"><strong>Step 4: Securely Set Up Environment Variables</strong></h3>
<p>Never hardcode your Firebase credentials directly into your application code. We'll use environment variables.</p>
<ol>
<li>
<p>In the root of your <code>expense-splitter</code> project, create a new file named <code>.env.local</code>.</p>
</li>
<li>
<p>Open <code>.env.local</code> and add the keys from the <code>firebaseConfig</code> object you copied, prefixing each with <code>NEXT_PUBLIC_</code>. This prefix is required by Next.js to expose the variable to the browser.</p>
<pre><code class="language-.env.local">NEXT_PUBLIC_FIREBASE_API_KEY=&quot;AIzaSy...&quot;
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=&quot;your-project-id.firebaseapp.com&quot;
NEXT_PUBLIC_FIREBASE_PROJECT_ID=&quot;your-project-id&quot;
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=&quot;your-project-id.appspot.com&quot;
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=&quot;...&quot;
NEXT_PUBLIC_FIREBASE_APP_ID=&quot;1:...&quot;
</code></pre>
</li>
<li>
<p><strong>Important:</strong> The <code>.gitignore</code> file that <code>create-next-app</code> generates should already include <code>.env.local</code>. Double-check to ensure it's there so you don't accidentally commit your secret keys to version control.</p>
</li>
</ol>
<h3 id="step-5-create-a-firebase-initialization-file"><strong>Step 5: Create a Firebase Initialization File</strong></h3>
<p>Let's create a centralized file to initialize Firebase and export its services for use throughout our app.</p>
<ol>
<li>
<p><strong>Install the Firebase SDK:</strong> In your terminal, run:</p>
<pre><code class="language-bash">npm install firebase
</code></pre>
</li>
<li>
<p><strong>Create the config file:</strong> Inside the <code>src</code> directory, create a new folder structure and file: <code>src/lib/firebase/config.ts</code>.</p>
</li>
<li>
<p><strong>Add the initialization code:</strong> Paste the following code into <code>src/lib/firebase/config.ts</code>. This code safely initializes Firebase on the client side.</p>
<pre><code class="language-typescript"><span class="hljs-comment">// src/lib/firebase/config.ts</span>
<span class="hljs-keyword">import</span> { initializeApp, getApps, getApp } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/app&quot;</span>;
<span class="hljs-keyword">import</span> { getAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/auth&quot;</span>;
<span class="hljs-keyword">import</span> { getFirestore } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;
<span class="hljs-keyword">import</span> { getStorage } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/storage&quot;</span>;

<span class="hljs-comment">// Your web app&#x27;s Firebase configuration</span>
<span class="hljs-keyword">const</span> firebaseConfig = {
  <span class="hljs-attr">apiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_API_KEY</span>,
  <span class="hljs-attr">authDomain</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN</span>,
  <span class="hljs-attr">projectId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_PROJECT_ID</span>,
  <span class="hljs-attr">storageBucket</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET</span>,
  <span class="hljs-attr">messagingSenderId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID</span>,
  <span class="hljs-attr">appId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_APP_ID</span>,
};

<span class="hljs-comment">// Initialize Firebase for SSR</span>
<span class="hljs-keyword">const</span> app = !<span class="hljs-title function_">getApps</span>().<span class="hljs-property">length</span> ? <span class="hljs-title function_">initializeApp</span>(firebaseConfig) : <span class="hljs-title function_">getApp</span>();

<span class="hljs-keyword">const</span> firestore = <span class="hljs-title function_">getFirestore</span>(app);
<span class="hljs-keyword">const</span> auth = <span class="hljs-title function_">getAuth</span>(app);
<span class="hljs-keyword">const</span> storage = <span class="hljs-title function_">getStorage</span>(app);

<span class="hljs-keyword">export</span> { app, firestore, auth, storage };
</code></pre>
</li>
<li>
<p><strong>Restart your development server:</strong> Since you've added environment variables, you need to stop your dev server (if it's running) with <code>Ctrl + C</code> and restart it to load them.</p>
<pre><code class="language-bash">npm run dev
</code></pre>
</li>
</ol>
<hr>
<p><strong>Congratulations!</strong> You have successfully:</p>
<ul>
<li>Initialized a new Next.js 14 project with the App Router, TypeScript, and Tailwind CSS.</li>
<li>Created a Firebase project and enabled Firestore, Authentication, and Storage.</li>
<li>Securely connected your Next.js app to Firebase using environment variables.</li>
<li>Set up a centralized Firebase initialization file.</li>
</ul>
<p>Your project's foundation is now solid and ready for the next step: building the authentication system.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;project-setup&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Project Setup and Firebase Configuration&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Next.js, Firebase Console&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="firestore-nosql-database-design-specialist">Firestore, NoSQL Database Design Specialist</h3>
<p>Excellent, the project foundation is set. Now, let's design the heart of our application: the database schema. A well-designed schema is crucial for performance, scalability, and ease of development. We will use Firestore, a NoSQL document database, which gives us flexibility.</p>
<p>Our schema will be built around three core entities: <strong>Users</strong>, <strong>Groups</strong>, and <strong>Expenses</strong>.</p>
<hr>
<h3 id="subtask-firestore-database-schema-design"><strong>Subtask: Firestore Database Schema Design</strong></h3>
<p>Here is the detailed NoSQL schema for our Expense Splitter application.</p>
<h3 id="1-users-collection">1. <code>users</code> Collection</h3>
<p>This collection stores information for each registered user. The Document ID for each user document should be their unique UID provided by Firebase Authentication. This creates a direct and secure link between the authenticated user and their data.</p>
<p><strong>Collection Path:</strong> <code>/users/{userId}</code></p>
<p><strong>Document Structure:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;uid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auth_generated_uid_123&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;jane.doe@example.com&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;displayName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Jane Doe&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;photoURL&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://example.com/path/to/photo.jpg&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;createdAt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-10-27T10:00:00Z&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Firestore Timestamp</span>
  <span class="hljs-attr">&quot;groups&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">&quot;group_id_abc&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">&quot;group_id_xyz&quot;</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Field Descriptions:</strong></p>
<ul>
<li><strong><code>uid</code> (String):</strong> The user's unique ID from Firebase Auth. Stored for convenience, but the Document ID is the primary key.</li>
<li><strong><code>email</code> (String):</strong> The user's email address, used for identification and communication.</li>
<li><strong><code>displayName</code> (String):</strong> The user's full name, which will be displayed throughout the app.</li>
<li><strong><code>photoURL</code> (String, nullable):</strong> A URL to the user's profile picture.</li>
<li><strong><code>createdAt</code> (Timestamp):</strong> The timestamp of when the user account was created.</li>
<li><strong><code>groups</code> (Array<String>):</strong> An array of <code>groupId</code>s. This is a form of <strong>denormalization</strong> that allows us to quickly fetch all groups a user belongs to without performing a complex query across the entire <code>groups</code> collection.</li>
</ul>
<hr>
<h3 id="2-groups-collection">2. <code>groups</code> Collection</h3>
<p>This collection stores all the groups created by users. Each group is a container for members and their shared expenses.</p>
<p><strong>Collection Path:</strong> <code>/groups/{groupId}</code></p>
<p><strong>Document Structure:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;groupName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Hawaii Trip 2024&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;groupImageURL&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://example.com/path/to/group_image.jpg&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;createdBy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auth_generated_uid_123&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// References users.uid</span>
  <span class="hljs-attr">&quot;createdAt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-11-15T14:30:00Z&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Firestore Timestamp</span>
  <span class="hljs-attr">&quot;defaultCurrency&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;USD&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;members&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;uid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auth_generated_uid_123&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;displayName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Jane Doe&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;photoURL&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://example.com/path/to/photo.jpg&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;jane.doe@example.com&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;joinedAt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-11-15T14:30:00Z&quot;</span> <span class="hljs-comment">// Firestore Timestamp</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;uid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auth_generated_uid_456&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;displayName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;John Smith&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;photoURL&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://example.com/path/to/johns_photo.jpg&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;john.smith@example.com&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;joinedAt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-11-16T09:00:00Z&quot;</span> <span class="hljs-comment">// Firestore Timestamp</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Field Descriptions:</strong></p>
<ul>
<li><strong><code>groupName</code> (String):</strong> The user-defined name for the group (e.g., &quot;Apartment Bills&quot;).</li>
<li><strong><code>groupImageURL</code> (String, nullable):</strong> An optional URL for a group cover photo.</li>
<li><strong><code>createdBy</code> (String):</strong> The <code>uid</code> of the user who created the group.</li>
<li><strong><code>createdAt</code> (Timestamp):</strong> The timestamp of when the group was created.</li>
<li><strong><code>defaultCurrency</code> (String):</strong> The default currency for the group (e.g., &quot;USD&quot;, &quot;EUR&quot;).</li>
<li><strong><code>members</code> (Array<Object>):</strong> An array of member objects. We <strong>denormalize</strong> user data here (like <code>displayName</code> and <code>photoURL</code>) to avoid fetching each user's profile individually every time we load a group. This significantly improves performance for the group dashboard view.</li>
</ul>
<hr>
<h3 id="3-expenses-collection">3. <code>expenses</code> Collection</h3>
<p>This collection holds every individual transaction. Each expense document is linked to a single group. This design allows us to query all expenses for a specific group efficiently.</p>
<p><strong>Collection Path:</strong> <code>/expenses/{expenseId}</code></p>
<p><strong>Document Structure:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;groupId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;group_id_abc&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Foreign key to the groups collection</span>
  <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Dinner at Luigi&#x27;s&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;totalAmount&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">150.75</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;currency&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;USD&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;date&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-11-17T20:00:00Z&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Firestore Timestamp (when the expense occurred)</span>
  <span class="hljs-attr">&quot;createdAt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-11-17T22:05:00Z&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Firestore Timestamp (when the record was created)</span>
  <span class="hljs-attr">&quot;addedBy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auth_generated_uid_456&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// References users.uid</span>
  <span class="hljs-attr">&quot;receiptURL&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://firebasestorage.googleapis.com/...&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;notes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Split the appetizer three ways, but Jane paid for the wine.&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;payment&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">&quot;paidBy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auth_generated_uid_456&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;amountPaid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">150.75</span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;splitDetails&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">&quot;splitWith&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auth_generated_uid_123&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;amountOwed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50.25</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">&quot;splitWith&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auth_generated_uid_456&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;amountOwed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50.25</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">&quot;splitWith&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auth_generated_uid_789&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;amountOwed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50.25</span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Field Descriptions:</strong></p>
<ul>
<li><strong><code>groupId</code> (String):</strong> A crucial field that links the expense to its parent group. We will create a Firestore index on this field for fast queries.</li>
<li><strong><code>description</code> (String):</strong> A brief description of the expense.</li>
<li><strong><code>totalAmount</code> (Number):</strong> The total monetary value of the transaction.</li>
<li><strong><code>currency</code> (String):</strong> The currency of the transaction.</li>
<li><strong><code>date</code> (Timestamp):</strong> The actual date and time the expense occurred.</li>
<li><strong><code>createdAt</code> (Timestamp):</strong> The timestamp of when the expense was logged in the app.</li>
<li><strong><code>addedBy</code> (String):</strong> The <code>uid</code> of the user who entered this expense record.</li>
<li><strong><code>receiptURL</code> (String, nullable):</strong> A URL pointing to the receipt image stored in Firebase Storage.</li>
<li><strong><code>notes</code> (String, nullable):</strong> Optional field for additional details.</li>
<li><strong><code>payment</code> (Array<Object>):</strong> An array defining who paid and how much. This supports simple cases (one person paid all) and complex ones (multiple people contributed to the payment).
<ul>
<li><code>paidBy</code> (String): The <code>uid</code> of the user who paid.</li>
<li><code>amountPaid</code> (Number): The amount they paid.</li>
</ul>
</li>
<li><strong><code>splitDetails</code> (Array<Object>):</strong> An array defining how the expense is allocated among members. The frontend logic will calculate these values based on the split type (e.g., equally, by amount, by percentage).
<ul>
<li><code>splitWith</code> (String): The <code>uid</code> of the user who is part of the split.</li>
<li><code>amountOwed</code> (Number): The calculated share of the total amount this user is responsible for.</li>
</ul>
</li>
</ul>
<h3 id="how-balances-are-calculated">How Balances Are Calculated</h3>
<p>With this schema, we <strong>do not</strong> store running balances (e.g., &quot;Jane owes John $20&quot;) in the database. This is difficult to maintain and prone to errors. Instead, balances are calculated dynamically on the client-side:</p>
<ol>
<li>Fetch all expenses for a given group.</li>
<li>For each user, iterate through all expenses and calculate:
<ul>
<li><strong>Total Paid:</strong> Sum of <code>amountPaid</code> where <code>paidBy</code> is their <code>uid</code>.</li>
<li><strong>Total Share:</strong> Sum of <code>amountOwed</code> where <code>splitWith</code> is their <code>uid</code>.</li>
</ul>
</li>
<li><strong>Net Balance = Total Paid - Total Share.</strong>
<ul>
<li>A positive balance means the group owes them money.</li>
<li>A negative balance means they owe the group money.</li>
</ul>
</li>
</ol>
<p>The app's UI can then run a simplification algorithm on these net balances to show the simplest set of transactions to settle up (e.g., &quot;You pay John $15.50&quot;).</p>
<p>This schema is normalized where it matters (separating users, groups, and expenses) but uses denormalization strategically to optimize for common read operations, providing a solid and performant foundation for our application.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;schema-design&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Firestore Database Schema Design&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Firestore, NoSQL Database Design&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="nextjs-react-firebase-authentication-specialist">Next.js, React, Firebase Authentication Specialist</h3>
<p>Excellent, the foundation is set. Now, let's implement the core user authentication system. This will allow users to sign up, log in, and log out, and will protect the main parts of our application from unauthorized access.</p>
<p>We will use React's Context API to manage the user's authentication state globally across the application.</p>
<hr>
<h3 id="step-1-create-the-authentication-context"><strong>Step 1: Create the Authentication Context</strong></h3>
<p>The Auth Context will be the single source of truth for the current user's status. It will provide the user object, a loading state, and authentication functions (login, logout, etc.) to any component that needs them.</p>
<ol>
<li>
<p>Create a new directory and file: <code>src/context/AuthContext.tsx</code>.</p>
</li>
<li>
<p>Paste the following code into the file. Read the comments to understand how it works.</p>
<pre><code class="language-typescript"><span class="hljs-comment">// src/context/AuthContext.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">ReactNode</span>,
  createContext,
  useContext,
  useEffect,
  useState,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">User</span>,
  onAuthStateChanged,
  signOut <span class="hljs-keyword">as</span> firebaseSignOut,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/auth&#x27;</span>;
<span class="hljs-keyword">import</span> { auth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/config&#x27;</span>; <span class="hljs-comment">// Our initialized auth instance</span>
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/navigation&#x27;</span>;

<span class="hljs-comment">// Define the shape of the context data</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthContextType</span> {
  <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> | <span class="hljs-literal">null</span>;
  <span class="hljs-attr">loading</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">logout</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;
}

<span class="hljs-comment">// Create the context with a default value</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AuthContext</span> = createContext&lt;<span class="hljs-title class_">AuthContextType</span> | <span class="hljs-literal">undefined</span>&gt;(<span class="hljs-literal">undefined</span>);

<span class="hljs-comment">// Create the provider component</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">AuthProvider</span> = (<span class="hljs-params">{ children }: { children: ReactNode }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [user, setUser] = useState&lt;<span class="hljs-title class_">User</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// Subscribe to Firebase auth state changes</span>
    <span class="hljs-keyword">const</span> unsubscribe = <span class="hljs-title function_">onAuthStateChanged</span>(auth, <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (user) {
        <span class="hljs-title function_">setUser</span>(user);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">setUser</span>(<span class="hljs-literal">null</span>);
      }
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    });

    <span class="hljs-comment">// Cleanup subscription on unmount</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">unsubscribe</span>();
  }, []);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">firebaseSignOut</span>(auth);
    router.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;/login&#x27;</span>); <span class="hljs-comment">// Redirect to login page after logout</span>
  };

  <span class="hljs-keyword">const</span> value = {
    user,
    loading,
    logout,
  };

  <span class="hljs-comment">// We don&#x27;t render anything until the initial auth check is complete</span>
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AuthContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>
      {!loading &amp;&amp; children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">AuthContext.Provider</span>&gt;</span></span>
  );
};

<span class="hljs-comment">// Create a custom hook for easy access to the context</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useAuth</span> = (<span class="hljs-params"></span>) =&gt; {
  <span class="hljs-keyword">const</span> context = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">AuthContext</span>);
  <span class="hljs-keyword">if</span> (context === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;useAuth must be used within an AuthProvider&#x27;</span>);
  }
  <span class="hljs-keyword">return</span> context;
};
</code></pre>
</li>
</ol>
<h3 id="step-2-integrate-the-auth-provider-into-the-app"><strong>Step 2: Integrate the Auth Provider into the App</strong></h3>
<p>To make the authentication context available to all pages and components, we need to wrap our root layout with the <code>AuthProvider</code>.</p>
<ol>
<li>
<p>Open <code>src/app/layout.tsx</code>.</p>
</li>
<li>
<p>Import <code>AuthProvider</code> and wrap the <code>{children}</code> with it.</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/app/layout.tsx</span>
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">Metadata</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Inter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/font/google&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./globals.css&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>; <span class="hljs-comment">// Import the provider</span>

<span class="hljs-keyword">const</span> inter = <span class="hljs-title class_">Inter</span>({ <span class="hljs-attr">subsets</span>: [<span class="hljs-string">&#x27;latin&#x27;</span>] });

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">metadata</span>: <span class="hljs-title class_">Metadata</span> = {
  <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Expense Splitter&#x27;</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">&#x27;Split bills with ease&#x27;</span>,
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params">{
  children,
}: {
  children: React.ReactNode;
}</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{inter.className}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">AuthProvider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">AuthProvider</span>&gt;</span> {/* Wrap here */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
  );
}
</code></pre>
</li>
</ol>
<h3 id="step-3-create-the-login-and-sign-up-pages"><strong>Step 3: Create the Login and Sign Up Pages</strong></h3>
<p>Now, let's build the UI for users to log in and create new accounts. We'll use a route group <code>(auth)</code> to keep these pages organized.</p>
<ol>
<li>
<p><strong>Create the file structure:</strong></p>
<ul>
<li><code>src/app/(auth)/login/page.tsx</code></li>
<li><code>src/app/(auth)/signup/page.tsx</code></li>
</ul>
</li>
<li>
<p><strong>Code for the Login Page (<code>src/app/(auth)/login/page.tsx</code>):</strong></p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/app/(auth)/login/page.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/navigation&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/link&#x27;</span>;
<span class="hljs-keyword">import</span> {
  signInWithEmailAndPassword,
  signInWithPopup,
  <span class="hljs-title class_">GoogleAuthProvider</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/auth&#x27;</span>;
<span class="hljs-keyword">import</span> { auth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/config&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">LoginPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> [email, setEmail] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);
  <span class="hljs-keyword">const</span> [password, setPassword] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;string | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">e: React.FormEvent</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">signInWithEmailAndPassword</span>(auth, email, password);
      router.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;/dashboard&#x27;</span>); <span class="hljs-comment">// Redirect to a protected route on success</span>
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">err</span>: any) {
      <span class="hljs-title function_">setError</span>(err.<span class="hljs-property">message</span>);
    }
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleGoogleSignIn</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-keyword">const</span> provider = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GoogleAuthProvider</span>();
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">signInWithPopup</span>(auth, provider);
      router.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;/dashboard&#x27;</span>);
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">err</span>: any) {
      <span class="hljs-title function_">setError</span>(err.<span class="hljs-property">message</span>);
    }
  };

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex items-center justify-center min-h-screen bg-gray-100&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-2xl font-bold text-center&quot;</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleLogin}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-6&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;label&quot;</span>&gt;</span>Email<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
              <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;email&quot;</span>
              <span class="hljs-attr">value</span>=<span class="hljs-string">{email}</span>
              <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setEmail(e.target.value)}
              required
              className=&quot;input&quot;
            /&gt;
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;label&quot;</span>&gt;</span>Password<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
              <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span>
              <span class="hljs-attr">value</span>=<span class="hljs-string">{password}</span>
              <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setPassword(e.target.value)}
              required
              className=&quot;input&quot;
            /&gt;
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          {error &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-red-500 text-sm&quot;</span>&gt;</span>{error}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button w-full&quot;</span>&gt;</span>
            Login
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;divider&quot;</span>&gt;</span>OR<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleGoogleSignIn}</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button-secondary w-full&quot;</span>
        &gt;</span>
          Sign in with Google
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-center&quot;</span>&gt;</span>
          Don&#x27;t have an account?{&#x27; &#x27;}
          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/signup&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-blue-600 hover:underline&quot;</span>&gt;</span>
            Sign Up
          <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
</li>
<li>
<p><strong>Code for the Sign Up Page (<code>src/app/(auth)/signup/page.tsx</code>):</strong></p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/app/(auth)/signup/page.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/navigation&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/link&#x27;</span>;
<span class="hljs-keyword">import</span> { createUserWithEmailAndPassword } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/auth&#x27;</span>;
<span class="hljs-keyword">import</span> { auth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/config&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">SignUpPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> [email, setEmail] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);
  <span class="hljs-keyword">const</span> [password, setPassword] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;string | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSignUp</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">e: React.FormEvent</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createUserWithEmailAndPassword</span>(auth, email, password);
      router.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;/dashboard&#x27;</span>); <span class="hljs-comment">// Redirect to a protected route on success</span>
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">err</span>: any) {
      <span class="hljs-title function_">setError</span>(err.<span class="hljs-property">message</span>);
    }
  };

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex items-center justify-center min-h-screen bg-gray-100&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-2xl font-bold text-center&quot;</span>&gt;</span>Create an Account<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSignUp}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-6&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;label&quot;</span>&gt;</span>Email<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
              <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;email&quot;</span>
              <span class="hljs-attr">value</span>=<span class="hljs-string">{email}</span>
              <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setEmail(e.target.value)}
              required
              className=&quot;input&quot;
            /&gt;
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;label&quot;</span>&gt;</span>Password<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
              <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span>
              <span class="hljs-attr">value</span>=<span class="hljs-string">{password}</span>
              <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setPassword(e.target.value)}
              required
              className=&quot;input&quot;
            /&gt;
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          {error &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-red-500 text-sm&quot;</span>&gt;</span>{error}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button w-full&quot;</span>&gt;</span>
            Sign Up
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-center&quot;</span>&gt;</span>
          Already have an account?{&#x27; &#x27;}
          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/login&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-blue-600 hover:underline&quot;</span>&gt;</span>
            Login
          <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
</li>
<li>
<p><strong>Add some basic styles</strong> to <code>src/app/globals.css</code> to make the forms look decent.</p>
<pre><code class="language-css"><span class="hljs-comment">/* src/app/globals.css */</span>
<span class="hljs-keyword">@tailwind</span> base;
<span class="hljs-keyword">@tailwind</span> components;
<span class="hljs-keyword">@tailwind</span> utilities;

<span class="hljs-keyword">@layer</span> components {
  <span class="hljs-selector-class">.input</span> {
    <span class="hljs-keyword">@apply</span> w-full px-<span class="hljs-number">3</span> py-<span class="hljs-number">2</span> border border-gray-<span class="hljs-number">300</span> rounded-md shadow-sm <span class="hljs-attribute">focus</span>:outline-none <span class="hljs-attribute">focus</span>:ring-blue-<span class="hljs-number">500</span> <span class="hljs-attribute">focus</span>:border-blue-<span class="hljs-number">500</span>;
  }
  <span class="hljs-selector-class">.label</span> {
    <span class="hljs-keyword">@apply</span> block text-sm font-medium text-gray-<span class="hljs-number">700</span> mb-<span class="hljs-number">1</span>;
  }
  <span class="hljs-selector-class">.button</span> {
    <span class="hljs-keyword">@apply</span> flex justify-center py-<span class="hljs-number">2</span> px-<span class="hljs-number">4</span> border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-<span class="hljs-number">600</span> <span class="hljs-attribute">hover</span>:bg-blue-<span class="hljs-number">700</span> <span class="hljs-attribute">focus</span>:outline-none <span class="hljs-attribute">focus</span>:ring-<span class="hljs-number">2</span> <span class="hljs-attribute">focus</span>:ring-offset-<span class="hljs-number">2</span> <span class="hljs-attribute">focus</span>:ring-blue-<span class="hljs-number">500</span>;
  }
  <span class="hljs-selector-class">.button-secondary</span> {
    <span class="hljs-keyword">@apply</span> flex justify-center py-<span class="hljs-number">2</span> px-<span class="hljs-number">4</span> border border-gray-<span class="hljs-number">300</span> rounded-md shadow-sm text-sm font-medium text-gray-<span class="hljs-number">700</span> bg-white <span class="hljs-attribute">hover</span>:bg-gray-<span class="hljs-number">50</span> <span class="hljs-attribute">focus</span>:outline-none <span class="hljs-attribute">focus</span>:ring-<span class="hljs-number">2</span> <span class="hljs-attribute">focus</span>:ring-offset-<span class="hljs-number">2</span> <span class="hljs-attribute">focus</span>:ring-blue-<span class="hljs-number">500</span>;
  }
  <span class="hljs-selector-class">.divider</span> {
    <span class="hljs-keyword">@apply</span> relative my-<span class="hljs-number">4</span>;
  }
  <span class="hljs-selector-class">.divider</span><span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-keyword">@apply</span> content-[<span class="hljs-string">&#x27;&#x27;</span>] absolute left-<span class="hljs-number">0</span> top-<span class="hljs-number">1</span>/<span class="hljs-number">2</span> w-[<span class="hljs-number">45%</span>] h-px bg-gray-<span class="hljs-number">300</span>;
  }
  <span class="hljs-selector-class">.divider</span><span class="hljs-selector-pseudo">::after</span> {
    <span class="hljs-keyword">@apply</span> content-[<span class="hljs-string">&#x27;&#x27;</span>] absolute right-<span class="hljs-number">0</span> top-<span class="hljs-number">1</span>/<span class="hljs-number">2</span> w-[<span class="hljs-number">45%</span>] h-px bg-gray-<span class="hljs-number">300</span>;
  }
}
</code></pre>
</li>
</ol>
<h3 id="step-4-create-a-protected-route-and-a-dashboard-page"><strong>Step 4: Create a Protected Route and a Dashboard Page</strong></h3>
<p>Now for the crucial part: ensuring only logged-in users can access certain pages. We'll create a simple <code>/dashboard</code> page and protect it.</p>
<ol>
<li>
<p><strong>Create a ProtectedRoute component:</strong> This component will check the auth state and redirect if the user is not logged in.</p>
<ul>
<li>Create the file: <code>src/components/ProtectedRoute.tsx</code></li>
</ul>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/ProtectedRoute.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/navigation&#x27;</span>;
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">ProtectedRoute</span> = (<span class="hljs-params">{ children }: { children: React.ReactNode }</span>) =&gt; {
  <span class="hljs-keyword">const</span> { user, loading } = <span class="hljs-title function_">useAuth</span>();
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// Wait until the loading is finished before checking the user</span>
    <span class="hljs-keyword">if</span> (!loading &amp;&amp; !user) {
      router.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;/login&#x27;</span>);
    }
  }, [user, loading, router]);

  <span class="hljs-comment">// If loading, you can show a spinner or a blank page</span>
  <span class="hljs-keyword">if</span> (loading) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>; <span class="hljs-comment">// Or a proper loading spinner component</span>
  }

  <span class="hljs-comment">// If the user is authenticated, render the children</span>
  <span class="hljs-keyword">if</span> (user) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span>{children}<span class="hljs-tag">&lt;/&gt;</span></span>;
  }

  <span class="hljs-comment">// If not authenticated and not loading, return null (or redirect)</span>
  <span class="hljs-comment">// The useEffect will handle the redirect, but this prevents flashing the content.</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">ProtectedRoute</span>;
</code></pre>
</li>
<li>
<p><strong>Create the Dashboard page:</strong> This will be our main application page for authenticated users.</p>
<ul>
<li>Create the file: <code>src/app/dashboard/page.tsx</code></li>
</ul>
<pre><code class="language-tsx"><span class="hljs-comment">// src/app/dashboard/page.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> <span class="hljs-title class_">ProtectedRoute</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/ProtectedRoute&#x27;</span>;
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dashboard</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> { user, logout } = <span class="hljs-title function_">useAuth</span>();

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-8&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;max-w-4xl mx-auto&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex justify-between items-center mb-8&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-3xl font-bold&quot;</span>&gt;</span>Dashboard<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
          {user &amp;&amp; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex items-center gap-4&quot;</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-gray-600&quot;</span>&gt;</span>{user.email}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{logout}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button&quot;</span>&gt;</span>
                Logout
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-6 bg-white rounded-lg shadow-md&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-semibold&quot;</span>&gt;</span>Welcome to your Expense Splitter!<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-2 text-gray-700&quot;</span>&gt;</span>
            This is your protected dashboard. You can start creating groups and adding expenses here.
          <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// Wrap the Dashboard component with ProtectedRoute</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DashboardPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProtectedRoute</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Dashboard</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ProtectedRoute</span>&gt;</span></span>
  );
}
</code></pre>
</li>
<li>
<p><strong>Update the Home Page:</strong> Let's make the root page (<code>/</code>) a simple landing page that directs users to login or the dashboard.</p>
<ul>
<li>Open <code>src/app/page.tsx</code> and replace its content.</li>
</ul>
<pre><code class="language-tsx"><span class="hljs-comment">// src/app/page.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/link&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">HomePage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex min-h-screen flex-col items-center justify-center p-24 bg-gray-50&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-center&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-4xl font-bold mb-4&quot;</span>&gt;</span>Welcome to Expense Splitter<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg text-gray-600 mb-8&quot;</span>&gt;</span>
          The easiest way to split bills with friends and family.
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-x-4&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/login&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button&quot;</span>&gt;</span>
            Login
          <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/dashboard&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button-secondary&quot;</span>&gt;</span>
            Go to Dashboard
          <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span></span>
  );
}
</code></pre>
</li>
</ol>
<hr>
<h3 id="summary-and-whats-next"><strong>Summary and What's Next</strong></h3>
<p>You have now successfully implemented a complete authentication flow!</p>
<ul>
<li><strong>Global State:</strong> <code>AuthContext</code> provides user status throughout the app.</li>
<li><strong>Sign Up/Login:</strong> Users can create accounts with email/password or sign in with Google.</li>
<li><strong>Protected Routes:</strong> The <code>/dashboard</code> route is now only accessible to logged-in users. Any attempt to access it while logged out will result in a redirect to the <code>/login</code> page.</li>
<li><strong>Logout:</strong> The logout button on the dashboard securely signs the user out and redirects them.</li>
</ul>
<p>You can now run your app (<code>npm run dev</code>) and test the entire flow. Try signing up, logging out, logging back in, and accessing <code>/dashboard</code> directly by typing it in the URL when you're logged out. You'll see the protection in action.</p>
<p>The next logical step is to start building the core features of the app, such as creating and managing expense groups.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user-auth&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Implement User Authentication&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Next.js, React, Firebase Authentication&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="nextjs-react-firestore-specialist">Next.js, React, Firestore Specialist</h3>
<p>With a solid authentication system and database schema in place, it's time to build the core group management functionality. Users need to be able to create groups to share expenses in, see a list of all the groups they belong to, and invite others to join.</p>
<p>We will update the dashboard to be the central hub for these actions. It will display a list of the user's groups and provide a way to create new ones.</p>
<hr>
<h3 id="step-1-create-user-document-in-firestore-on-sign-up"><strong>Step 1: Create User Document in Firestore on Sign-Up</strong></h3>
<p>Our schema relies on a <code>users</code> document for each authenticated user. However, Firebase Auth doesn't create this for us automatically. We need to ensure that whenever a user logs in for the first time, their corresponding document is created in our <code>users</code> collection. The best place to handle this is in our <code>AuthContext</code>.</p>
<ol>
<li>
<p><strong>Install Firestore:</strong> If you haven't already, add the Firestore SDK to your project.</p>
<pre><code class="language-bash">npm install firebase
</code></pre>
</li>
<li>
<p><strong>Update <code>AuthContext.tsx</code>:</strong> Modify the <code>useEffect</code> hook to check for and create the user document.</p>
<pre><code class="language-typescript"><span class="hljs-comment">// src/context/AuthContext.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">ReactNode</span>,
  createContext,
  useContext,
  useEffect,
  useState,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">User</span>,
  onAuthStateChanged,
  signOut <span class="hljs-keyword">as</span> firebaseSignOut,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/auth&#x27;</span>;
<span class="hljs-keyword">import</span> { auth, db } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/config&#x27;</span>; <span class="hljs-comment">// Import db</span>
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/navigation&#x27;</span>;
<span class="hljs-keyword">import</span> { doc, getDoc, serverTimestamp, setDoc } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/firestore&#x27;</span>; <span class="hljs-comment">// Import Firestore functions</span>

<span class="hljs-comment">// ... (interface and createContext are the same)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthContextType</span> {
  <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> | <span class="hljs-literal">null</span>;
  <span class="hljs-attr">loading</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">logout</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;
}
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AuthContext</span> = createContext&lt;<span class="hljs-title class_">AuthContextType</span> | <span class="hljs-literal">undefined</span>&gt;(<span class="hljs-literal">undefined</span>);


<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">AuthProvider</span> = (<span class="hljs-params">{ children }: { children: ReactNode }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [user, setUser] = useState&lt;<span class="hljs-title class_">User</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> unsubscribe = <span class="hljs-title function_">onAuthStateChanged</span>(auth, <span class="hljs-keyword">async</span> (user) =&gt; {
      <span class="hljs-keyword">if</span> (user) {
        <span class="hljs-comment">// User is signed in, now check for/create Firestore doc</span>
        <span class="hljs-keyword">const</span> userDocRef = <span class="hljs-title function_">doc</span>(db, <span class="hljs-string">&#x27;users&#x27;</span>, user.<span class="hljs-property">uid</span>);
        <span class="hljs-keyword">const</span> userDocSnap = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDoc</span>(userDocRef);

        <span class="hljs-keyword">if</span> (!userDocSnap.<span class="hljs-title function_">exists</span>()) {
          <span class="hljs-comment">// Create the user document if it doesn&#x27;t exist</span>
          <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(userDocRef, {
            <span class="hljs-attr">uid</span>: user.<span class="hljs-property">uid</span>,
            <span class="hljs-attr">email</span>: user.<span class="hljs-property">email</span>,
            <span class="hljs-attr">displayName</span>: user.<span class="hljs-property">displayName</span> || user.<span class="hljs-property">email</span>?.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;@&#x27;</span>)[<span class="hljs-number">0</span>], <span class="hljs-comment">// Use a part of email as default</span>
            <span class="hljs-attr">photoURL</span>: user.<span class="hljs-property">photoURL</span>,
            <span class="hljs-attr">createdAt</span>: <span class="hljs-title function_">serverTimestamp</span>(),
            <span class="hljs-attr">groups</span>: [], <span class="hljs-comment">// Initialize with an empty groups array</span>
          });
        }
        <span class="hljs-title function_">setUser</span>(user);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">setUser</span>(<span class="hljs-literal">null</span>);
      }
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    });

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">unsubscribe</span>();
  }, []);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">firebaseSignOut</span>(auth);
    router.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;/login&#x27;</span>);
  };

  <span class="hljs-keyword">const</span> value = {
    user,
    loading,
    logout,
  };

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AuthContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>
      {!loading &amp;&amp; children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">AuthContext.Provider</span>&gt;</span></span>
  );
};

<span class="hljs-comment">// ... (useAuth hook is the same)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useAuth</span> = (<span class="hljs-params"></span>) =&gt; {
  <span class="hljs-keyword">const</span> context = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">AuthContext</span>);
  <span class="hljs-keyword">if</span> (context === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;useAuth must be used within an AuthProvider&#x27;</span>);
  }
  <span class="hljs-keyword">return</span> context;
};
</code></pre>
</li>
</ol>
<h3 id="step-2-create-firestore-service-functions-for-groups"><strong>Step 2: Create Firestore Service Functions for Groups</strong></h3>
<p>To keep our component logic clean, let's create a dedicated file for all Firestore interactions related to groups.</p>
<ol>
<li>
<p><strong>Install <code>nanoid</code></strong> for generating unique, short invite codes.</p>
<pre><code class="language-bash">npm install nanoid
</code></pre>
</li>
<li>
<p>Create a new file: <code>src/lib/firebase/firestore.ts</code>.</p>
</li>
<li>
<p>Add the following functions to manage group data.</p>
<pre><code class="language-typescript"><span class="hljs-comment">// src/lib/firebase/firestore.ts</span>
<span class="hljs-keyword">import</span> {
  doc,
  addDoc,
  collection,
  serverTimestamp,
  updateDoc,
  arrayUnion,
  getDoc,
  query,
  where,
  documentId,
  getDocs,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> { db } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./config&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/auth&#x27;</span>;
<span class="hljs-keyword">import</span> { customAlphabet } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;nanoid&#x27;</span>;

<span class="hljs-comment">// Define the structure for a Group</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Group</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">groupName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">createdBy</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">createdAt</span>: <span class="hljs-built_in">any</span>; <span class="hljs-comment">// Firestore Timestamp</span>
  <span class="hljs-attr">members</span>: <span class="hljs-built_in">any</span>[]; <span class="hljs-comment">// Array of member objects</span>
  <span class="hljs-attr">inviteCode</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// Function to generate a unique 6-character invite code</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">generateInviteCode</span> = (<span class="hljs-params"></span>) =&gt; {
  <span class="hljs-keyword">const</span> nanoid = <span class="hljs-title function_">customAlphabet</span>(<span class="hljs-string">&#x27;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span>, <span class="hljs-number">6</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">nanoid</span>();
};

<span class="hljs-comment">/**
 * Creates a new group in Firestore.
 * <span class="hljs-doctag">@param</span> groupName The name of the new group.
 * <span class="hljs-doctag">@param</span> user The user object of the creator.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createGroup</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">groupName: <span class="hljs-built_in">string</span>, user: User</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!groupName || !user) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Group name and user are required.&#x27;</span>);
  }

  <span class="hljs-comment">// 1. Fetch the user&#x27;s profile from Firestore to get displayName, etc.</span>
  <span class="hljs-keyword">const</span> userDocRef = <span class="hljs-title function_">doc</span>(db, <span class="hljs-string">&#x27;users&#x27;</span>, user.<span class="hljs-property">uid</span>);
  <span class="hljs-keyword">const</span> userDocSnap = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDoc</span>(userDocRef);

  <span class="hljs-keyword">if</span> (!userDocSnap.<span class="hljs-title function_">exists</span>()) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;User profile not found in Firestore.&#x27;</span>);
  }
  <span class="hljs-keyword">const</span> userData = userDocSnap.<span class="hljs-title function_">data</span>();

  <span class="hljs-comment">// 2. Create the new group document</span>
  <span class="hljs-keyword">const</span> groupDocRef = <span class="hljs-keyword">await</span> <span class="hljs-title function_">addDoc</span>(<span class="hljs-title function_">collection</span>(db, <span class="hljs-string">&#x27;groups&#x27;</span>), {
    groupName,
    <span class="hljs-attr">createdBy</span>: user.<span class="hljs-property">uid</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-title function_">serverTimestamp</span>(),
    <span class="hljs-attr">inviteCode</span>: <span class="hljs-title function_">generateInviteCode</span>(),
    <span class="hljs-attr">members</span>: [
      {
        <span class="hljs-attr">uid</span>: user.<span class="hljs-property">uid</span>,
        <span class="hljs-attr">email</span>: userData.<span class="hljs-property">email</span>,
        <span class="hljs-attr">displayName</span>: userData.<span class="hljs-property">displayName</span>,
        <span class="hljs-attr">photoURL</span>: userData.<span class="hljs-property">photoURL</span>,
        <span class="hljs-attr">joinedAt</span>: <span class="hljs-title function_">serverTimestamp</span>(),
      },
    ],
  });

  <span class="hljs-comment">// 3. Add the new group&#x27;s ID to the user&#x27;s `groups` array</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">updateDoc</span>(userDocRef, {
    <span class="hljs-attr">groups</span>: <span class="hljs-title function_">arrayUnion</span>(groupDocRef.<span class="hljs-property">id</span>),
  });

  <span class="hljs-keyword">return</span> groupDocRef.<span class="hljs-property">id</span>;
};

<span class="hljs-comment">/**
 * Fetches all groups a user belongs to.
 * <span class="hljs-doctag">@param</span> userId The UID of the user.
 * <span class="hljs-doctag">@returns</span> A promise that resolves to an array of group objects.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getUserGroups = <span class="hljs-keyword">async</span> (<span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Group</span>[]&gt; =&gt; {
  <span class="hljs-keyword">if</span> (!userId) <span class="hljs-keyword">return</span> [];

  <span class="hljs-comment">// 1. Get the user&#x27;s document to find their group IDs</span>
  <span class="hljs-keyword">const</span> userDocRef = <span class="hljs-title function_">doc</span>(db, <span class="hljs-string">&#x27;users&#x27;</span>, userId);
  <span class="hljs-keyword">const</span> userDocSnap = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDoc</span>(userDocRef);

  <span class="hljs-keyword">if</span> (!userDocSnap.<span class="hljs-title function_">exists</span>() || !userDocSnap.<span class="hljs-title function_">data</span>().<span class="hljs-property">groups</span>?.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">return</span> []; <span class="hljs-comment">// User has no groups</span>
  }

  <span class="hljs-keyword">const</span> groupIds = userDocSnap.<span class="hljs-title function_">data</span>().<span class="hljs-property">groups</span>;

  <span class="hljs-comment">// 2. Query the &#x27;groups&#x27; collection for documents with those IDs</span>
  <span class="hljs-keyword">const</span> groupsQuery = <span class="hljs-title function_">query</span>(
    <span class="hljs-title function_">collection</span>(db, <span class="hljs-string">&#x27;groups&#x27;</span>),
    <span class="hljs-title function_">where</span>(<span class="hljs-title function_">documentId</span>(), <span class="hljs-string">&#x27;in&#x27;</span>, groupIds)
  );
  <span class="hljs-keyword">const</span> querySnapshot = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDocs</span>(groupsQuery);

  <span class="hljs-keyword">const</span> groups = querySnapshot.<span class="hljs-property">docs</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">doc</span>) =&gt;</span> ({
    <span class="hljs-attr">id</span>: doc.<span class="hljs-property">id</span>,
    ...doc.<span class="hljs-title function_">data</span>(),
  })) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Group</span>[];

  <span class="hljs-keyword">return</span> groups;
};
</code></pre>
</li>
</ol>
<h3 id="step-3-build-the-group-management-ui-components"><strong>Step 3: Build the Group Management UI Components</strong></h3>
<p>Let's create the components for displaying the group list and the modal for creating a new group.</p>
<ol>
<li>
<p><strong>Create the <code>CreateGroupModal</code> component:</strong></p>
<ul>
<li>File: <code>src/components/groups/CreateGroupModal.tsx</code></li>
</ul>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/groups/CreateGroupModal.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;
<span class="hljs-keyword">import</span> { createGroup } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;

interface <span class="hljs-title class_">CreateGroupModalProps</span> {
  <span class="hljs-attr">isOpen</span>: boolean;
  <span class="hljs-attr">onClose</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span>;
  <span class="hljs-attr">onGroupCreated</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span>; <span class="hljs-comment">// Callback to refresh group list</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">CreateGroupModal</span>(<span class="hljs-params">{
  isOpen,
  onClose,
  onGroupCreated,
}: CreateGroupModalProps</span>) {
  <span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">useAuth</span>();
  <span class="hljs-keyword">const</span> [groupName, setGroupName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);
  <span class="hljs-keyword">const</span> [isLoading, setIsLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;string | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">e: React.FormEvent</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-keyword">if</span> (!user || !groupName.<span class="hljs-title function_">trim</span>()) <span class="hljs-keyword">return</span>;

    <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createGroup</span>(groupName, user);
      <span class="hljs-title function_">setGroupName</span>(<span class="hljs-string">&#x27;&#x27;</span>);
      <span class="hljs-title function_">onGroupCreated</span>(); <span class="hljs-comment">// Trigger refresh</span>
      <span class="hljs-title function_">onClose</span>(); <span class="hljs-comment">// Close modal</span>
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">err</span>: any) {
      <span class="hljs-title function_">setError</span>(err.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
    }
  };

  <span class="hljs-keyword">if</span> (!isOpen) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white p-6 rounded-lg shadow-xl w-full max-w-md&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-2xl font-bold mb-4&quot;</span>&gt;</span>Create New Group<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mb-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">&quot;groupName&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;label&quot;</span>&gt;</span>
              Group Name
            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
              <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;groupName&quot;</span>
              <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span>
              <span class="hljs-attr">value</span>=<span class="hljs-string">{groupName}</span>
              <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setGroupName(e.target.value)}
              placeholder=&quot;e.g., Apartment Bills&quot;
              required
              className=&quot;input&quot;
            /&gt;
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          {error &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-red-500 text-sm mb-4&quot;</span>&gt;</span>{error}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex justify-end gap-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
              <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span>
              <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClose}</span>
              <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button-secondary&quot;</span>
              <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isLoading}</span>
            &gt;</span>
              Cancel
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isLoading}</span>&gt;</span>
              {isLoading ? &#x27;Creating...&#x27; : &#x27;Create Group&#x27;}
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
</li>
<li>
<p><strong>Create the <code>GroupList</code> component:</strong></p>
<ul>
<li>File: <code>src/components/groups/GroupList.tsx</code></li>
</ul>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/groups/GroupList.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Group</span>, getUserGroups } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;

<span class="hljs-comment">// A simple card component to display group info</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">GroupCard</span>(<span class="hljs-params">{ group }: { group: Group }</span>) {
    <span class="hljs-keyword">const</span> [showCode, setShowCode] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">copyToClipboard</span> = (<span class="hljs-params"></span>) =&gt; {
        navigator.<span class="hljs-property">clipboard</span>.<span class="hljs-title function_">writeText</span>(group.<span class="hljs-property">inviteCode</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;Invite code copied to clipboard!&#x27;</span>);
        });
    };

    <span class="hljs-keyword">return</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white p-4 rounded-lg shadow-md border border-gray-200&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-semibold text-gray-800&quot;</span>&gt;</span>{group.groupName}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-500 mt-1&quot;</span>&gt;</span>
                {group.members.length} member{group.members.length !== 1 ? &#x27;s&#x27; : &#x27;&#x27;}
            <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-4&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setShowCode(!showCode)} className=&quot;text-sm text-blue-600 hover:underline&quot;&gt;
                    {showCode ? &#x27;Hide&#x27; : &#x27;Show&#x27;} Invite Code
                <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                {showCode &amp;&amp; (
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-2 p-2 bg-gray-100 rounded-md flex items-center justify-between&quot;</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-mono text-lg tracking-widest&quot;</span>&gt;</span>{group.inviteCode}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{copyToClipboard}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm button-secondary py-1 px-2&quot;</span>&gt;</span>Copy<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                )}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GroupList</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">useAuth</span>();
  <span class="hljs-keyword">const</span> [groups, setGroups] = useState&lt;<span class="hljs-title class_">Group</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> [isLoading, setIsLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;string | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchGroups</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span>;
    <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> userGroups = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserGroups</span>(user.<span class="hljs-property">uid</span>);
      <span class="hljs-title function_">setGroups</span>(userGroups);
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">err</span>: any) {
      <span class="hljs-title function_">setError</span>(<span class="hljs-string">&#x27;Failed to fetch groups.&#x27;</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
    }
  };

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetchGroups</span>();
  }, [user]); <span class="hljs-comment">// Refetch when user changes</span>

  <span class="hljs-keyword">if</span> (isLoading) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Loading groups...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;
  }

  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-red-500&quot;</span>&gt;</span>{error}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;
  }

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {groups.length &gt; 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6&quot;</span>&gt;</span>
          {groups.map((group) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">GroupCard</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{group.id}</span> <span class="hljs-attr">group</span>=<span class="hljs-string">{group}</span> /&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-center py-10 px-6 bg-gray-50 rounded-lg&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-medium text-gray-800&quot;</span>&gt;</span>No groups yet!<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-gray-600 mt-1&quot;</span>&gt;</span>
            Create a new group to start splitting expenses.
          <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
</li>
</ol>
<h3 id="step-4-integrate-into-the-dashboard-page"><strong>Step 4: Integrate into the Dashboard Page</strong></h3>
<p>Finally, let's update the main dashboard page to use our new components.</p>
<ul>
<li>
<p>Open <code>src/app/dashboard/page.tsx</code> and replace its content:</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/app/dashboard/page.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ProtectedRoute</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/ProtectedRoute&#x27;</span>;
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CreateGroupModal</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/groups/CreateGroupModal&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">GroupList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/groups/GroupList&#x27;</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dashboard</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> { user, logout } = <span class="hljs-title function_">useAuth</span>();
  <span class="hljs-keyword">const</span> [isModalOpen, setIsModalOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-comment">// This function will be passed to the modal to refresh the list</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleGroupCreated</span> = (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-comment">// A simple way to refresh is to re-mount the GroupList component.</span>
    <span class="hljs-comment">// We can force this by changing a key, but for now, we&#x27;ll rely</span>
    <span class="hljs-comment">// on the user seeing the new group after a manual refresh or navigation.</span>
    <span class="hljs-comment">// A more advanced solution would use a state management library or context.</span>
    <span class="hljs-comment">// For now, we just close the modal. The GroupList will be stale until refresh.</span>
    <span class="hljs-comment">// To fix this, we&#x27;ll pass the fetch function down.</span>
    <span class="hljs-comment">// Let&#x27;s refactor GroupList to accept a trigger. This is getting complex.</span>
    <span class="hljs-comment">// A simpler approach: let&#x27;s just re-render the whole page.</span>
    <span class="hljs-comment">// window.location.reload(); // This is a bit heavy-handed.</span>
    <span class="hljs-comment">// Let&#x27;s modify GroupList to expose its fetch function.</span>
    <span class="hljs-comment">// A better approach: Let&#x27;s just create a key for the GroupList.</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;min-h-screen bg-gray-50&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white shadow-sm&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-2xl font-bold text-gray-900&quot;</span>&gt;</span>Dashboard<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
          {user &amp;&amp; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex items-center gap-4&quot;</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-gray-600 hidden sm:block&quot;</span>&gt;</span>{user.email}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{logout}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button-secondary&quot;</span>&gt;</span>
                Logout
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;py-8&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;max-w-7xl mx-auto sm:px-6 lg:px-8&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;px-4 sm:px-0 mb-6 flex justify-between items-center&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-semibold text-gray-800&quot;</span>&gt;</span>Your Groups<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(true)} className=&quot;button&quot;&gt;
              + Create Group
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;px-4 sm:px-0&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">GroupList</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">CreateGroupModal</span>
        <span class="hljs-attr">isOpen</span>=<span class="hljs-string">{isModalOpen}</span>
        <span class="hljs-attr">onClose</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(false)}
        onGroupCreated={() =&gt; {
          // The simplest way to refresh the list is to reload the page.
          // For a better UX, you&#x27;d use a state management tool or context.
          window.location.reload();
        }}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// Wrap the Dashboard component with ProtectedRoute</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DashboardPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProtectedRoute</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Dashboard</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ProtectedRoute</span>&gt;</span></span>
  );
}
</code></pre>
<p><em>Note: The <code>window.location.reload()</code> is a simple but effective way to ensure the group list is up-to-date after creation. In a larger application, you might use a state management library like Zustand or React Query to manage data fetching and re-validation more elegantly.</em></p>
</li>
</ul>
<hr>
<h3 id="summary-and-whats-next-1"><strong>Summary and What's Next</strong></h3>
<p>You have now successfully implemented the core group management features:</p>
<ul>
<li><strong>User Onboarding:</strong> New users automatically get a corresponding document in the <code>users</code> collection in Firestore.</li>
<li><strong>Group Creation:</strong> Logged-in users can open a modal and create a new group. The data is saved correctly in both the <code>groups</code> and <code>users</code> collections.</li>
<li><strong>Group Viewing:</strong> The dashboard now fetches and displays a list of all groups the current user is a member of.</li>
<li><strong>Invite System:</strong> Each group has a unique invite code that can be shown and copied, laying the groundwork for adding new members.</li>
</ul>
<p>The next logical step is to make these group cards clickable, leading to a dedicated page for each group where users can view and add expenses.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;group-management&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Build Group Management Features&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Next.js, React, Firestore&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="nextjs-react-forms-firestore-specialist">Next.js, React Forms, Firestore Specialist</h3>
<p>With group management in place, the next critical step is allowing users to add and track expenses within those groups. We will create a dedicated page for each group where members can see a list of expenses and add new ones.</p>
<p>This involves:</p>
<ol>
<li>Creating a dynamic route and page for individual groups (<code>/group/[groupId]</code>).</li>
<li>Updating our Firestore service functions to handle expense creation and retrieval.</li>
<li>Building UI components for adding a new expense (a modal form) and listing existing expenses.</li>
<li>Making the group cards on the dashboard link to their respective detail pages.</li>
</ol>
<hr>
<h3 id="step-1-update-firestore-service-functions-for-expenses"><strong>Step 1: Update Firestore Service Functions for Expenses</strong></h3>
<p>First, let's extend our <code>firestore.ts</code> file with functions to manage expenses. We'll add an <code>Expense</code> interface and functions to add and get expenses for a specific group. We will store expenses in a subcollection within each group document for better data organization and querying performance.</p>
<ol>
<li>
<p><strong>Define the <code>Expense</code> interface and update <code>Group</code> interface:</strong>
In <code>src/lib/firebase/firestore.ts</code>, add the <code>Expense</code> interface. Also, add the <code>members</code> type definition for clarity.</p>
<pre><code class="language-typescript"><span class="hljs-comment">// src/lib/firebase/firestore.ts</span>

<span class="hljs-comment">// ... (imports)</span>

<span class="hljs-comment">// Add Member type definition</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Member</span> {
    <span class="hljs-attr">uid</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">displayName</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">photoURL</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">joinedAt</span>: <span class="hljs-built_in">any</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Group</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">groupName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">createdBy</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">createdAt</span>: <span class="hljs-built_in">any</span>;
  <span class="hljs-attr">members</span>: <span class="hljs-title class_">Member</span>[]; <span class="hljs-comment">// Use the Member type</span>
  <span class="hljs-attr">inviteCode</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// Define the structure for an Expense</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Expense</span> {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">amount</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// Stored in cents</span>
    <span class="hljs-attr">paidBy</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// UID of the user who paid</span>
    <span class="hljs-attr">paidByDisplayName</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// Denormalized for easy display</span>
    <span class="hljs-attr">groupId</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">createdAt</span>: <span class="hljs-built_in">any</span>; <span class="hljs-comment">// Firestore Timestamp</span>
    <span class="hljs-attr">splitMethod</span>: <span class="hljs-string">&#x27;equally&#x27;</span>; <span class="hljs-comment">// For now, we only support &#x27;equally&#x27;</span>
    <span class="hljs-attr">participants</span>: {
        <span class="hljs-attr">uid</span>: <span class="hljs-built_in">string</span>;
        <span class="hljs-attr">amountOwed</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// Stored in cents</span>
    }[];
}

<span class="hljs-comment">// ... (existing createGroup and getUserGroups functions)</span>
</code></pre>
</li>
<li>
<p><strong>Create <code>addExpenseToGroup</code> and <code>getGroupExpenses</code> functions:</strong>
Add these new functions to <code>src/lib/firebase/firestore.ts</code>.</p>
<pre><code class="language-typescript"><span class="hljs-comment">// src/lib/firebase/firestore.ts</span>
<span class="hljs-keyword">import</span> {
  <span class="hljs-comment">// ... existing imports</span>
  getDoc,
  query,
  where,
  documentId,
  getDocs,
  orderBy, <span class="hljs-comment">// Add orderBy</span>
  <span class="hljs-title class_">Timestamp</span>, <span class="hljs-comment">// Add Timestamp</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/firestore&#x27;</span>;
<span class="hljs-comment">// ...</span>

<span class="hljs-comment">/**
 * Fetches details for a single group.
 * <span class="hljs-doctag">@param</span> groupId The ID of the group.
 * <span class="hljs-doctag">@returns</span> A promise that resolves to the group object or null if not found.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getGroupDetails = <span class="hljs-keyword">async</span> (<span class="hljs-attr">groupId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Group</span> | <span class="hljs-literal">null</span>&gt; =&gt; {
    <span class="hljs-keyword">if</span> (!groupId) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">const</span> groupDocRef = <span class="hljs-title function_">doc</span>(db, <span class="hljs-string">&#x27;groups&#x27;</span>, groupId);
    <span class="hljs-keyword">const</span> groupDocSnap = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDoc</span>(groupDocRef);

    <span class="hljs-keyword">if</span> (groupDocSnap.<span class="hljs-title function_">exists</span>()) {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: groupDocSnap.<span class="hljs-property">id</span>, ...groupDocSnap.<span class="hljs-title function_">data</span>() } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Group</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
};


<span class="hljs-comment">/**
 * Adds a new expense to a group&#x27;s &#x27;expenses&#x27; subcollection.
 * <span class="hljs-doctag">@param</span> expenseData The data for the new expense.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">addExpenseToGroup</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">expenseData: {
  description: <span class="hljs-built_in">string</span>;
  amount: <span class="hljs-built_in">number</span>; // Should be <span class="hljs-keyword">in</span> dollars <span class="hljs-keyword">from</span> the form
  paidBy: <span class="hljs-built_in">string</span>;
  groupId: <span class="hljs-built_in">string</span>;
  participantsUids: <span class="hljs-built_in">string</span>[];
}</span>) =&gt; {
  <span class="hljs-keyword">const</span> { description, amount, paidBy, groupId, participantsUids } = expenseData;

  <span class="hljs-keyword">if</span> (!description || amount &lt;= <span class="hljs-number">0</span> || !paidBy || !groupId || participantsUids.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Missing required expense data.&#x27;</span>);
  }

  <span class="hljs-comment">// 1. Fetch the payer&#x27;s display name</span>
  <span class="hljs-keyword">const</span> userDocRef = <span class="hljs-title function_">doc</span>(db, <span class="hljs-string">&#x27;users&#x27;</span>, paidBy);
  <span class="hljs-keyword">const</span> userDocSnap = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDoc</span>(userDocRef);
  <span class="hljs-keyword">if</span> (!userDocSnap.<span class="hljs-title function_">exists</span>()) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Payer user not found.&#x27;</span>);
  }
  <span class="hljs-keyword">const</span> paidByDisplayName = userDocSnap.<span class="hljs-title function_">data</span>().<span class="hljs-property">displayName</span>;

  <span class="hljs-comment">// 2. Calculate the split</span>
  <span class="hljs-keyword">const</span> amountInCents = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(amount * <span class="hljs-number">100</span>);
  <span class="hljs-keyword">const</span> splitAmount = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(amountInCents / participantsUids.<span class="hljs-property">length</span>);
  <span class="hljs-keyword">const</span> participants = participantsUids.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">uid</span> =&gt;</span> ({
      uid,
      <span class="hljs-attr">amountOwed</span>: splitAmount,
  }));

  <span class="hljs-comment">// 3. Create the expense document in the subcollection</span>
  <span class="hljs-keyword">const</span> groupExpensesColRef = <span class="hljs-title function_">collection</span>(db, <span class="hljs-string">&#x27;groups&#x27;</span>, groupId, <span class="hljs-string">&#x27;expenses&#x27;</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">addDoc</span>(groupExpensesColRef, {
    description,
    <span class="hljs-attr">amount</span>: amountInCents,
    paidBy,
    paidByDisplayName,
    groupId,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-title function_">serverTimestamp</span>(),
    <span class="hljs-attr">splitMethod</span>: <span class="hljs-string">&#x27;equally&#x27;</span>,
    participants,
  });
};

<span class="hljs-comment">/**
 * Fetches all expenses for a given group, ordered by creation date.
 * <span class="hljs-doctag">@param</span> groupId The ID of the group.
 * <span class="hljs-doctag">@returns</span> A promise that resolves to an array of expense objects.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getGroupExpenses = <span class="hljs-keyword">async</span> (<span class="hljs-attr">groupId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Expense</span>[]&gt; =&gt; {
    <span class="hljs-keyword">if</span> (!groupId) <span class="hljs-keyword">return</span> [];

    <span class="hljs-keyword">const</span> expensesQuery = <span class="hljs-title function_">query</span>(
        <span class="hljs-title function_">collection</span>(db, <span class="hljs-string">&#x27;groups&#x27;</span>, groupId, <span class="hljs-string">&#x27;expenses&#x27;</span>),
        <span class="hljs-title function_">orderBy</span>(<span class="hljs-string">&#x27;createdAt&#x27;</span>, <span class="hljs-string">&#x27;desc&#x27;</span>)
    );

    <span class="hljs-keyword">const</span> querySnapshot = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDocs</span>(expensesQuery);

    <span class="hljs-keyword">const</span> expenses = querySnapshot.<span class="hljs-property">docs</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">doc</span> =&gt;</span> ({
        <span class="hljs-attr">id</span>: doc.<span class="hljs-property">id</span>,
        ...doc.<span class="hljs-title function_">data</span>(),
    })) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Expense</span>[];

    <span class="hljs-keyword">return</span> expenses;
};
</code></pre>
</li>
</ol>
<h3 id="step-2-update-group-cards-to-be-clickable-links"><strong>Step 2: Update Group Cards to be Clickable Links</strong></h3>
<p>Modify the <code>GroupCard</code> component in <code>src/components/groups/GroupList.tsx</code> to link to the new group detail page.</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/groups/GroupList.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Group</span>, getUserGroups } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/link&#x27;</span>; <span class="hljs-comment">// Import Link</span>
<span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;

<span class="hljs-comment">// A simple card component to display group info</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">GroupCard</span>(<span class="hljs-params">{ group }: { group: Group }</span>) {
  <span class="hljs-keyword">const</span> [showCode, setShowCode] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">copyToClipboard</span> = (<span class="hljs-params"></span>) =&gt; {
    navigator.<span class="hljs-property">clipboard</span>.<span class="hljs-title function_">writeText</span>(group.<span class="hljs-property">inviteCode</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;Invite code copied to clipboard!&#x27;</span>);
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// Wrap the entire card content in a Link component</span>
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">{</span>`/<span class="hljs-attr">group</span>/${<span class="hljs-attr">group.id</span>}`} <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;block hover:shadow-lg transition-shadow duration-200&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white p-4 rounded-lg shadow-md border border-gray-200 h-full flex flex-col justify-between&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-semibold text-gray-800&quot;</span>&gt;</span>{group.groupName}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-500 mt-1&quot;</span>&gt;</span>
            {group.members.length} member{group.members.length !== 1 ? &#x27;s&#x27; : &#x27;&#x27;}
          <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-4&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
              e.preventDefault(); // Prevent link navigation
              setShowCode(!showCode);
            }}
            className=&quot;text-sm text-blue-600 hover:underline&quot;
          &gt;
            {showCode ? &#x27;Hide&#x27; : &#x27;Show&#x27;} Invite Code
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          {showCode &amp;&amp; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-2 p-2 bg-gray-100 rounded-md flex items-center justify-between&quot;</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-mono text-lg tracking-widest&quot;</span>&gt;</span>{group.inviteCode}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
                  e.preventDefault(); // Prevent link navigation
                  copyToClipboard();
                }}
                className=&quot;text-sm button-secondary py-1 px-2&quot;
              &gt;
                Copy
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// ... (rest of GroupList component is the same)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GroupList</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 id="step-3-build-the-ui-components-for-expenses"><strong>Step 3: Build the UI Components for Expenses</strong></h3>
<p>We need a modal for adding expenses and a component to list them.</p>
<ol>
<li>
<p><strong>Create <code>AddExpenseModal.tsx</code>:</strong></p>
<ul>
<li>File: <code>src/components/expenses/AddExpenseModal.tsx</code></li>
</ul>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/expenses/AddExpenseModal.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;
<span class="hljs-keyword">import</span> { addExpenseToGroup } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Member</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;

interface <span class="hljs-title class_">AddExpenseModalProps</span> {
  <span class="hljs-attr">isOpen</span>: boolean;
  <span class="hljs-attr">onClose</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span>;
  <span class="hljs-attr">onExpenseAdded</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span>;
  <span class="hljs-attr">groupId</span>: string;
  <span class="hljs-attr">members</span>: <span class="hljs-title class_">Member</span>[];
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AddExpenseModal</span>(<span class="hljs-params">{
  isOpen,
  onClose,
  onExpenseAdded,
  groupId,
  members,
}: AddExpenseModalProps</span>) {
  <span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">useAuth</span>();
  <span class="hljs-keyword">const</span> [description, setDescription] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);
  <span class="hljs-keyword">const</span> [amount, setAmount] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);
  <span class="hljs-keyword">const</span> [paidBy, setPaidBy] = <span class="hljs-title function_">useState</span>(user?.<span class="hljs-property">uid</span> || <span class="hljs-string">&#x27;&#x27;</span>);
  <span class="hljs-keyword">const</span> [isLoading, setIsLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;string | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// For this simple version, we assume the expense is split among all members</span>
  <span class="hljs-keyword">const</span> participantsUids = members.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">uid</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">e: React.FormEvent</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-keyword">if</span> (!user || !description.<span class="hljs-title function_">trim</span>() || !amount || !paidBy) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> numericAmount = <span class="hljs-built_in">parseFloat</span>(amount);
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(numericAmount) || numericAmount &lt;= <span class="hljs-number">0</span>) {
      <span class="hljs-title function_">setError</span>(<span class="hljs-string">&#x27;Please enter a valid amount.&#x27;</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">addExpenseToGroup</span>({
        description,
        <span class="hljs-attr">amount</span>: numericAmount,
        paidBy,
        groupId,
        participantsUids,
      });
      <span class="hljs-title function_">setDescription</span>(<span class="hljs-string">&#x27;&#x27;</span>);
      <span class="hljs-title function_">setAmount</span>(<span class="hljs-string">&#x27;&#x27;</span>);
      <span class="hljs-title function_">onExpenseAdded</span>();
      <span class="hljs-title function_">onClose</span>();
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">err</span>: any) {
      <span class="hljs-title function_">setError</span>(err.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
    }
  };

  <span class="hljs-keyword">if</span> (!isOpen) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white p-6 rounded-lg shadow-xl w-full max-w-md&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-2xl font-bold mb-4&quot;</span>&gt;</span>Add New Expense<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mb-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">&quot;description&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;label&quot;</span>&gt;</span>Description<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
              <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;description&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{description}</span>
              <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setDescription(e.target.value)}
              placeholder=&quot;e.g., Groceries&quot; required className=&quot;input&quot;
            /&gt;
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mb-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">&quot;amount&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;label&quot;</span>&gt;</span>Amount ($)<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
              <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;amount&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{amount}</span>
              <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setAmount(e.target.value)}
              placeholder=&quot;0.00&quot; required className=&quot;input&quot;
              step=&quot;0.01&quot; min=&quot;0.01&quot;
            /&gt;
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mb-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">&quot;paidBy&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;label&quot;</span>&gt;</span>Paid by<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;paidBy&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{paidBy}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setPaidBy(e.target.value)} className=&quot;input&quot;&gt;
              {members.map((member) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{member.uid}</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{member.uid}</span>&gt;</span>
                  {member.displayName}
                <span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
              ))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-500 mb-4&quot;</span>&gt;</span>
            This will be split equally among all {members.length} members.
          <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          {error &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-red-500 text-sm mb-4&quot;</span>&gt;</span>{error}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex justify-end gap-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClose}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button-secondary&quot;</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isLoading}</span>&gt;</span>
              Cancel
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isLoading}</span>&gt;</span>
              {isLoading ? &#x27;Adding...&#x27; : &#x27;Add Expense&#x27;}
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
</li>
<li>
<p><strong>Create <code>ExpenseList.tsx</code>:</strong></p>
<ul>
<li>File: <code>src/components/expenses/ExpenseList.tsx</code></li>
</ul>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/expenses/ExpenseList.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Expense</span>, getGroupExpenses } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Timestamp</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/firestore&#x27;</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpenseCard</span>(<span class="hljs-params">{ expense }: { expense: Expense }</span>) {
    <span class="hljs-comment">// Function to format Firestore Timestamp to a readable date</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">formatDate</span> = (<span class="hljs-params">timestamp: Timestamp</span>) =&gt; {
        <span class="hljs-keyword">if</span> (!timestamp) <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Date not available&#x27;</span>;
        <span class="hljs-keyword">return</span> timestamp.<span class="hljs-title function_">toDate</span>().<span class="hljs-title function_">toLocaleDateString</span>(<span class="hljs-string">&#x27;en-US&#x27;</span>, {
            <span class="hljs-attr">month</span>: <span class="hljs-string">&#x27;short&#x27;</span>,
            <span class="hljs-attr">day</span>: <span class="hljs-string">&#x27;numeric&#x27;</span>,
        });
    };

    <span class="hljs-keyword">return</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex items-center justify-between&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xs text-gray-500&quot;</span>&gt;</span>{formatDate(expense.createdAt)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-medium text-gray-800&quot;</span>&gt;</span>{expense.description}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-600&quot;</span>&gt;</span>
                    Paid by {expense.paidByDisplayName}
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-right&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-semibold text-gray-900&quot;</span>&gt;</span>
                    ${(expense.amount / 100).toFixed(2)}
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xs text-gray-500&quot;</span>&gt;</span>
                    Split among {expense.participants.length} people
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}


<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpenseList</span>(<span class="hljs-params">{ groupId, refreshTrigger }: { groupId: string, refreshTrigger: number }</span>) {
  <span class="hljs-keyword">const</span> [expenses, setExpenses] = useState&lt;<span class="hljs-title class_">Expense</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> [isLoading, setIsLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;string | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchExpenses</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; {
      <span class="hljs-keyword">if</span> (!groupId) <span class="hljs-keyword">return</span>;
      <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);
      <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> groupExpenses = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getGroupExpenses</span>(groupId);
        <span class="hljs-title function_">setExpenses</span>(groupExpenses);
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-title function_">setError</span>(<span class="hljs-string">&#x27;Failed to fetch expenses.&#x27;</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
      }
    };

    <span class="hljs-title function_">fetchExpenses</span>();
  }, [groupId, refreshTrigger]); <span class="hljs-comment">// Refetch when groupId or the trigger changes</span>

  <span class="hljs-keyword">if</span> (isLoading) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Loading expenses...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;
  }

  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-red-500&quot;</span>&gt;</span>{error}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;
  }

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {expenses.length &gt; 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4&quot;</span>&gt;</span>
          {expenses.map((expense) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">ExpenseCard</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{expense.id}</span> <span class="hljs-attr">expense</span>=<span class="hljs-string">{expense}</span> /&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-center py-10 px-6 bg-gray-50 rounded-lg&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-medium text-gray-800&quot;</span>&gt;</span>No expenses yet!<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-gray-600 mt-1&quot;</span>&gt;</span>
            Add an expense to get started.
          <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
</li>
</ol>
<h3 id="step-4-create-the-group-detail-page"><strong>Step 4: Create the Group Detail Page</strong></h3>
<p>Finally, create the dynamic page that brings everything together.</p>
<ul>
<li>
<p>Create the file <code>src/app/group/[groupId]/page.tsx</code>:</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/app/group/[groupId]/page.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { useParams, useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/navigation&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ProtectedRoute</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/ProtectedRoute&#x27;</span>;
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Group</span>, getGroupDetails } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AddExpenseModal</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/expenses/AddExpenseModal&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ExpenseList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/expenses/ExpenseList&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/link&#x27;</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">GroupDetailPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">useAuth</span>();
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
  <span class="hljs-keyword">const</span> params = <span class="hljs-title function_">useParams</span>();
  <span class="hljs-keyword">const</span> groupId = params.<span class="hljs-property">groupId</span> <span class="hljs-keyword">as</span> string;

  <span class="hljs-keyword">const</span> [group, setGroup] = useState&lt;<span class="hljs-title class_">Group</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isLoading, setIsLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;string | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isModalOpen, setIsModalOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [refreshTrigger, setRefreshTrigger] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!groupId || !user) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchGroupData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; {
      <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);
      <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> groupDetails = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getGroupDetails</span>(groupId);
        <span class="hljs-keyword">if</span> (!groupDetails) {
          <span class="hljs-title function_">setError</span>(<span class="hljs-string">&#x27;Group not found.&#x27;</span>);
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// Security check: ensure the current user is a member of this group</span>
        <span class="hljs-keyword">const</span> isMember = groupDetails.<span class="hljs-property">members</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">member</span> =&gt;</span> member.<span class="hljs-property">uid</span> === user.<span class="hljs-property">uid</span>);
        <span class="hljs-keyword">if</span> (!isMember) {
          <span class="hljs-title function_">setError</span>(<span class="hljs-string">&#x27;You are not a member of this group.&#x27;</span>);
          <span class="hljs-comment">// Optional: redirect them</span>
          <span class="hljs-comment">// router.push(&#x27;/dashboard&#x27;);</span>
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-title function_">setGroup</span>(groupDetails);
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-title function_">setError</span>(<span class="hljs-string">&#x27;Failed to load group details.&#x27;</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
      }
    };

    <span class="hljs-title function_">fetchGroupData</span>();
  }, [groupId, user, router]);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleExpenseAdded</span> = (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-comment">// Increment the trigger to force ExpenseList to refetch data</span>
    <span class="hljs-title function_">setRefreshTrigger</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
  };

  <span class="hljs-keyword">if</span> (isLoading) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-8&quot;</span>&gt;</span>Loading group...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-8 text-red-500&quot;</span>&gt;</span>{error}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
  <span class="hljs-keyword">if</span> (!group) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-8&quot;</span>&gt;</span>Group not found.<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;min-h-screen bg-gray-50&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white shadow-sm&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;max-w-4xl mx-auto py-4 px-4 sm:px-6 lg:px-8&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex items-center gap-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/dashboard&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-blue-600 hover:underline&quot;</span>&gt;</span>
                <span class="hljs-symbol">&amp;larr;</span> Back to Dashboard
            <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-3xl font-bold text-gray-900 mt-2&quot;</span>&gt;</span>{group.groupName}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;py-8&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;max-w-4xl mx-auto sm:px-6 lg:px-8&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;px-4 sm:px-0 mb-6 flex justify-between items-center&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-semibold text-gray-800&quot;</span>&gt;</span>Expenses<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(true)} className=&quot;button&quot;&gt;
              + Add Expense
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;px-4 sm:px-0&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ExpenseList</span> <span class="hljs-attr">groupId</span>=<span class="hljs-string">{group.id}</span> <span class="hljs-attr">refreshTrigger</span>=<span class="hljs-string">{refreshTrigger}</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>

      {isModalOpen &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">AddExpenseModal</span>
          <span class="hljs-attr">isOpen</span>=<span class="hljs-string">{isModalOpen}</span>
          <span class="hljs-attr">onClose</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(false)}
          onExpenseAdded={handleExpenseAdded}
          groupId={group.id}
          members={group.members}
        /&gt;
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GroupPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProtectedRoute</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">GroupDetailPage</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ProtectedRoute</span>&gt;</span></span>
  );
}
</code></pre>
</li>
</ul>
<hr>
<h3 id="summary"><strong>Summary</strong></h3>
<p>You have now implemented the complete flow for creating and viewing expenses within a group.</p>
<ul>
<li><strong>Data Structure:</strong> Expenses are stored in a subcollection under each group for efficient querying.</li>
<li><strong>Navigation:</strong> Users can click on a group from their dashboard to navigate to a dedicated page for that group.</li>
<li><strong>Expense Creation:</strong> A modal form allows users to add a new expense, specifying the description, amount, and who paid. For now, the cost is split equally among all members.</li>
<li><strong>Expense Tracking:</strong> The group page displays a list of all expenses, showing key details like the description, amount, and payer. The list automatically refreshes when a new expense is added.</li>
<li><strong>Security:</strong> A basic check is in place to ensure only group members can view the group's details.</li>
</ul>
<p>The next step is to calculate and display the balances, showing who owes whom within the group.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;expense-creation&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Implement Expense Creation and Tracking&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Next.js, React Forms, Firestore&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="firebase-storage-react-file-handling-specialist">Firebase Storage, React File Handling Specialist</h3>
<p>Excellent, with expense creation and tracking in place, let's enhance it by adding the ability to upload and attach receipts. This is a perfect use case for Firebase Storage.</p>
<p>We will integrate Firebase Storage to handle image uploads. When a user adds an expense, they'll have an option to attach a receipt image. This image will be uploaded to a secure folder in your Storage bucket, and its public URL will be saved with the expense data in Firestore.</p>
<hr>
<h3 id="step-1-enable-and-configure-firebase-storage"><strong>Step 1: Enable and Configure Firebase Storage</strong></h3>
<p>Before writing any code, you need to enable Firebase Storage in your project.</p>
<ol>
<li>Go to your <a href="https://console.firebase.google.com/">Firebase Console</a>.</li>
<li>Select your project.</li>
<li>In the left-hand navigation pane, go to <strong>Storage</strong>.</li>
<li>Click <strong>&quot;Get started&quot;</strong>.</li>
<li>Follow the prompts to set up your storage bucket. When asked about Security Rules, choose <strong>&quot;Start in production mode&quot;</strong>. We will update the rules shortly.</li>
<li>Select a location for your bucket (choose one close to your users).</li>
</ol>
<h4 id="update-storage-security-rules"><strong>Update Storage Security Rules</strong></h4>
<p>For security, we need to define rules for who can read and write files. Go to the <strong>Rules</strong> tab in the Firebase Storage section. Replace the default rules with the following:</p>
<pre><code class="language-javascript"><span class="hljs-comment">// Firebase Storage Security Rules</span>
rules_version = <span class="hljs-string">&#x27;2&#x27;</span>;

service firebase.<span class="hljs-property">storage</span> {
  match /b/{bucket}/o {
    <span class="hljs-comment">// Match any file path for receipts</span>
    <span class="hljs-comment">// receipts/{groupId}/{fileName}</span>
    match /receipts/{groupId}/{fileName} {
      <span class="hljs-comment">// Allow read access to anyone with the URL (standard for displaying images)</span>
      allow read;
      
      <span class="hljs-comment">// Allow write (create, update) access only if the user is authenticated</span>
      <span class="hljs-comment">// A more robust rule would check if the user is a member of {groupId}</span>
      <span class="hljs-comment">// but for now, we&#x27;ll keep it simple.</span>
      allow <span class="hljs-attr">write</span>: <span class="hljs-keyword">if</span> request.<span class="hljs-property">auth</span> != <span class="hljs-literal">null</span>;
    }
  }
}
</code></pre>
<p>Click <strong>Publish</strong> to save your new rules. These rules allow any authenticated user to upload receipts and allow anyone with the link to view them.</p>
<hr>
<h3 id="step-2-create-a-firebase-storage-service"><strong>Step 2: Create a Firebase Storage Service</strong></h3>
<p>Let's create a dedicated file for our storage-related functions to keep our code organized.</p>
<ol>
<li>
<p><strong>Install <code>uuid</code> for generating unique file names:</strong>
This prevents users from overwriting each other's files if they happen to upload a file with the same name (e.g., <code>receipt.jpg</code>).</p>
<pre><code class="language-bash">npm install uuid
npm install @types/uuid --save-dev
</code></pre>
</li>
<li>
<p><strong>Create the storage service file:</strong></p>
<ul>
<li>File: <code>src/lib/firebase/storage.ts</code></li>
</ul>
<pre><code class="language-typescript"><span class="hljs-comment">// src/lib/firebase/storage.ts</span>
<span class="hljs-keyword">import</span> { getStorage, ref, uploadBytes, getDownloadURL } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/storage&#x27;</span>;
<span class="hljs-keyword">import</span> { v4 <span class="hljs-keyword">as</span> uuidv4 } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;uuid&#x27;</span>;
<span class="hljs-keyword">import</span> { app } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./firebase&#x27;</span>; <span class="hljs-comment">// Your initialized Firebase app</span>

<span class="hljs-keyword">const</span> storage = <span class="hljs-title function_">getStorage</span>(app);

<span class="hljs-comment">/**
 * Uploads a receipt image to Firebase Storage.
 * <span class="hljs-doctag">@param</span> file The image file to upload.
 * <span class="hljs-doctag">@param</span> groupId The ID of the group this receipt belongs to.
 * <span class="hljs-doctag">@returns</span> A promise that resolves with the public download URL of the uploaded file.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> uploadReceipt = <span class="hljs-keyword">async</span> (<span class="hljs-attr">file</span>: <span class="hljs-title class_">File</span>, <span class="hljs-attr">groupId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; =&gt; {
    <span class="hljs-keyword">if</span> (!file) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;No file provided for upload.&quot;</span>);
    }
    <span class="hljs-keyword">if</span> (!groupId) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Group ID is required for upload.&quot;</span>);
    }

    <span class="hljs-comment">// Create a unique file name to avoid collisions</span>
    <span class="hljs-keyword">const</span> fileExtension = file.<span class="hljs-property">name</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;.&#x27;</span>).<span class="hljs-title function_">pop</span>();
    <span class="hljs-keyword">const</span> uniqueFileName = <span class="hljs-string">`<span class="hljs-subst">${uuidv4()}</span>.<span class="hljs-subst">${fileExtension}</span>`</span>;

    <span class="hljs-comment">// Create a reference to the file path in Storage</span>
    <span class="hljs-keyword">const</span> storageRef = <span class="hljs-title function_">ref</span>(storage, <span class="hljs-string">`receipts/<span class="hljs-subst">${groupId}</span>/<span class="hljs-subst">${uniqueFileName}</span>`</span>);

    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// Upload the file</span>
        <span class="hljs-keyword">const</span> snapshot = <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadBytes</span>(storageRef, file);

        <span class="hljs-comment">// Get the public download URL</span>
        <span class="hljs-keyword">const</span> downloadURL = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDownloadURL</span>(snapshot.<span class="hljs-property">ref</span>);

        <span class="hljs-keyword">return</span> downloadURL;
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;Error uploading file:&quot;</span>, error);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Failed to upload receipt. Please try again.&quot;</span>);
    }
};
</code></pre>
</li>
</ol>
<hr>
<h3 id="step-3-update-firestore-interface-and-function"><strong>Step 3: Update Firestore Interface and Function</strong></h3>
<p>Now, we'll modify our Firestore logic to accommodate the new <code>receiptUrl</code> field.</p>
<ol>
<li>
<p><strong>Update the <code>Expense</code> interface:</strong>
In <code>src/lib/firebase/firestore.ts</code>, add the optional <code>receiptUrl</code> field.</p>
<pre><code class="language-typescript"><span class="hljs-comment">// src/lib/firebase/firestore.ts</span>

<span class="hljs-comment">// ... (imports and other interfaces)</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Expense</span> {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">amount</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// Stored in cents</span>
    <span class="hljs-attr">paidBy</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// UID of the user who paid</span>
    <span class="hljs-attr">paidByDisplayName</span>:<span class="hljs-built_in">string</span>;
    <span class="hljs-attr">groupId</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">createdAt</span>: <span class="hljs-built_in">any</span>; <span class="hljs-comment">// Firestore Timestamp</span>
    <span class="hljs-attr">splitMethod</span>: <span class="hljs-string">&#x27;equally&#x27;</span>;
    receiptUrl?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// &lt;-- Add this optional field</span>
    <span class="hljs-attr">participants</span>: {
        <span class="hljs-attr">uid</span>: <span class="hljs-built_in">string</span>;
        <span class="hljs-attr">amountOwed</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// Stored in cents</span>
    }[];
}
</code></pre>
</li>
<li>
<p><strong>Update the <code>addExpenseToGroup</code> function:</strong>
Modify the function to accept the <code>receiptUrl</code> and save it to the document.</p>
<pre><code class="language-typescript"><span class="hljs-comment">// src/lib/firebase/firestore.ts</span>

<span class="hljs-comment">// ... (imports)</span>

<span class="hljs-comment">/**
 * Adds a new expense to a group&#x27;s &#x27;expenses&#x27; subcollection.
 * <span class="hljs-doctag">@param</span> expenseData The data for the new expense.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">addExpenseToGroup</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">expenseData: {
  description: <span class="hljs-built_in">string</span>;
  amount: <span class="hljs-built_in">number</span>; // Should be <span class="hljs-keyword">in</span> dollars <span class="hljs-keyword">from</span> the form
  paidBy: <span class="hljs-built_in">string</span>;
  groupId: <span class="hljs-built_in">string</span>;
  participantsUids: <span class="hljs-built_in">string</span>[];
  receiptUrl?: <span class="hljs-built_in">string</span>; // &lt;-- Add optional parameter
}</span>) =&gt; {
  <span class="hljs-comment">// Destructure the new receiptUrl property</span>
  <span class="hljs-keyword">const</span> { description, amount, paidBy, groupId, participantsUids, receiptUrl } = expenseData;

  <span class="hljs-keyword">if</span> (!description || amount &lt;= <span class="hljs-number">0</span> || !paidBy || !groupId || participantsUids.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Missing required expense data.&#x27;</span>);
  }

  <span class="hljs-comment">// ... (user lookup and split calculation logic remains the same)</span>
  <span class="hljs-keyword">const</span> userDocRef = <span class="hljs-title function_">doc</span>(db, <span class="hljs-string">&#x27;users&#x27;</span>, paidBy);
  <span class="hljs-keyword">const</span> userDocSnap = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDoc</span>(userDocRef);
  <span class="hljs-keyword">if</span> (!userDocSnap.<span class="hljs-title function_">exists</span>()) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Payer user not found.&#x27;</span>);
  }
  <span class="hljs-keyword">const</span> paidByDisplayName = userDocSnap.<span class="hljs-title function_">data</span>().<span class="hljs-property">displayName</span>;

  <span class="hljs-keyword">const</span> amountInCents = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(amount * <span class="hljs-number">100</span>);
  <span class="hljs-keyword">const</span> splitAmount = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(amountInCents / participantsUids.<span class="hljs-property">length</span>);
  <span class="hljs-keyword">const</span> participants = participantsUids.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">uid</span> =&gt;</span> ({
      uid,
      <span class="hljs-attr">amountOwed</span>: splitAmount,
  }));

  <span class="hljs-comment">// Create the expense document in the subcollection</span>
  <span class="hljs-keyword">const</span> groupExpensesColRef = <span class="hljs-title function_">collection</span>(db, <span class="hljs-string">&#x27;groups&#x27;</span>, groupId, <span class="hljs-string">&#x27;expenses&#x27;</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">addDoc</span>(groupExpensesColRef, {
    description,
    <span class="hljs-attr">amount</span>: amountInCents,
    paidBy,
    paidByDisplayName,
    groupId,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-title function_">serverTimestamp</span>(),
    <span class="hljs-attr">splitMethod</span>: <span class="hljs-string">&#x27;equally&#x27;</span>,
    participants,
    <span class="hljs-attr">receiptUrl</span>: receiptUrl || <span class="hljs-literal">null</span>, <span class="hljs-comment">// &lt;-- Add the URL to the document</span>
  });
};

<span class="hljs-comment">// ... (rest of the file)</span>
</code></pre>
</li>
</ol>
<hr>
<h3 id="step-4-update-the-ui-components"><strong>Step 4: Update the UI Components</strong></h3>
<p>Let's modify the modal to include a file input and the expense card to display a link to the receipt.</p>
<ol>
<li>
<p><strong>Modify <code>AddExpenseModal.tsx</code>:</strong>
We'll add state to hold the selected file, a file input field, and update the <code>handleSubmit</code> logic to perform the upload before creating the expense document.</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/expenses/AddExpenseModal.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;
<span class="hljs-keyword">import</span> { addExpenseToGroup, <span class="hljs-title class_">Member</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> { uploadReceipt } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/storage&#x27;</span>; <span class="hljs-comment">// &lt;-- Import upload function</span>

interface <span class="hljs-title class_">AddExpenseModalProps</span> {
  <span class="hljs-comment">// ... (props are the same)</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AddExpenseModal</span>(<span class="hljs-params">{
  isOpen,
  onClose,
  onExpenseAdded,
  groupId,
  members,
}: AddExpenseModalProps</span>) {
  <span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">useAuth</span>();
  <span class="hljs-keyword">const</span> [description, setDescription] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);
  <span class="hljs-keyword">const</span> [amount, setAmount] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);
  <span class="hljs-keyword">const</span> [paidBy, setPaidBy] = <span class="hljs-title function_">useState</span>(user?.<span class="hljs-property">uid</span> || <span class="hljs-string">&#x27;&#x27;</span>);
  <span class="hljs-keyword">const</span> [receiptFile, setReceiptFile] = useState&lt;<span class="hljs-title class_">File</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>); <span class="hljs-comment">// &lt;-- State for file</span>
  <span class="hljs-keyword">const</span> [isLoading, setIsLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;string | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> participantsUids = members.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">uid</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFileChange</span> = (<span class="hljs-params">e: React.ChangeEvent&lt;HTMLInputElement&gt;</span>) =&gt; {
    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span>.<span class="hljs-property">files</span> &amp;&amp; e.<span class="hljs-property">target</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>]) {
      <span class="hljs-title function_">setReceiptFile</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>]);
    }
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">e: React.FormEvent</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-comment">// ... (validation is the same)</span>
    <span class="hljs-keyword">if</span> (!user || !description.<span class="hljs-title function_">trim</span>() || !amount || !paidBy) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> numericAmount = <span class="hljs-built_in">parseFloat</span>(amount);
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(numericAmount) || numericAmount &lt;= <span class="hljs-number">0</span>) {
      <span class="hljs-title function_">setError</span>(<span class="hljs-string">&#x27;Please enter a valid amount.&#x27;</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">let</span> receiptUrl = <span class="hljs-string">&#x27;&#x27;</span>;
      <span class="hljs-comment">// 1. If a file is selected, upload it first</span>
      <span class="hljs-keyword">if</span> (receiptFile) {
        receiptUrl = <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadReceipt</span>(receiptFile, groupId);
      }

      <span class="hljs-comment">// 2. Add expense data (including the URL) to Firestore</span>
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">addExpenseToGroup</span>({
        description,
        <span class="hljs-attr">amount</span>: numericAmount,
        paidBy,
        groupId,
        participantsUids,
        receiptUrl, <span class="hljs-comment">// Pass the URL</span>
      });

      <span class="hljs-comment">// Reset form and close modal</span>
      <span class="hljs-title function_">setDescription</span>(<span class="hljs-string">&#x27;&#x27;</span>);
      <span class="hljs-title function_">setAmount</span>(<span class="hljs-string">&#x27;&#x27;</span>);
      <span class="hljs-title function_">setReceiptFile</span>(<span class="hljs-literal">null</span>);
      <span class="hljs-title function_">onExpenseAdded</span>();
      <span class="hljs-title function_">onClose</span>();
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">err</span>: any) {
      <span class="hljs-title function_">setError</span>(err.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
    }
  };

  <span class="hljs-keyword">if</span> (!isOpen) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white p-6 rounded-lg shadow-xl w-full max-w-md&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-2xl font-bold mb-4&quot;</span>&gt;</span>Add New Expense<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
          {/* Description, Amount, Paid By fields are the same */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mb-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">&quot;description&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;label&quot;</span>&gt;</span>Description<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;description&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{description}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setDescription(e.target.value)} placeholder=&quot;e.g., Groceries&quot; required className=&quot;input&quot; /&gt;
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mb-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">&quot;amount&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;label&quot;</span>&gt;</span>Amount ($)<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;amount&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{amount}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setAmount(e.target.value)} placeholder=&quot;0.00&quot; required className=&quot;input&quot; step=&quot;0.01&quot; min=&quot;0.01&quot; /&gt;
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mb-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">&quot;paidBy&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;label&quot;</span>&gt;</span>Paid by<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;paidBy&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{paidBy}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setPaidBy(e.target.value)} className=&quot;input&quot;&gt;
              {members.map((member) =&gt; ( <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{member.uid}</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{member.uid}</span>&gt;</span>{member.displayName}<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

          {/* New File Input Field */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mb-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">&quot;receipt&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;label&quot;</span>&gt;</span>Receipt (Optional)<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
              <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;receipt&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleFileChange}</span>
              <span class="hljs-attr">accept</span>=<span class="hljs-string">&quot;image/png, image/jpeg, image/webp&quot;</span>
              <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;input file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100&quot;</span>
            /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-500 mb-4&quot;</span>&gt;</span>
            This will be split equally among all {members.length} members.
          <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          {error &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-red-500 text-sm mb-4&quot;</span>&gt;</span>{error}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex justify-end gap-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClose}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button-secondary&quot;</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isLoading}</span>&gt;</span>
              Cancel
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isLoading}</span>&gt;</span>
              {isLoading ? &#x27;Saving...&#x27; : &#x27;Add Expense&#x27;}
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
</li>
<li>
<p><strong>Modify <code>ExpenseList.tsx</code>:</strong>
Update the <code>ExpenseCard</code> to conditionally render a &quot;View Receipt&quot; link.</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/expenses/ExpenseList.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Expense</span>, getGroupExpenses } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Timestamp</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/firestore&#x27;</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpenseCard</span>(<span class="hljs-params">{ expense }: { expense: Expense }</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">formatDate</span> = (<span class="hljs-params">timestamp: Timestamp</span>) =&gt; {
        <span class="hljs-comment">// ... (function is the same)</span>
        <span class="hljs-keyword">if</span> (!timestamp) <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Date not available&#x27;</span>;
        <span class="hljs-keyword">return</span> timestamp.<span class="hljs-title function_">toDate</span>().<span class="hljs-title function_">toLocaleDateString</span>(<span class="hljs-string">&#x27;en-US&#x27;</span>, {
            <span class="hljs-attr">month</span>: <span class="hljs-string">&#x27;short&#x27;</span>,
            <span class="hljs-attr">day</span>: <span class="hljs-string">&#x27;numeric&#x27;</span>,
        });
    };

    <span class="hljs-keyword">return</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex items-center justify-between&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xs text-gray-500&quot;</span>&gt;</span>{formatDate(expense.createdAt)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-medium text-gray-800&quot;</span>&gt;</span>{expense.description}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-600&quot;</span>&gt;</span>
                    Paid by {expense.paidByDisplayName}
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                {/* Conditionally render the receipt link */}
                {expense.receiptUrl &amp;&amp; (
                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span>
                        <span class="hljs-attr">href</span>=<span class="hljs-string">{expense.receiptUrl}</span>
                        <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span>
                        <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;noopener noreferrer&quot;</span>
                        <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-blue-600 hover:underline mt-1 inline-block font-medium&quot;</span>
                    &gt;</span>
                        View Receipt
                    <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                )}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-right&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-semibold text-gray-900&quot;</span>&gt;</span>
                    ${(expense.amount / 100).toFixed(2)}
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xs text-gray-500&quot;</span>&gt;</span>
                    Split among {expense.participants.length} people
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}

<span class="hljs-comment">// The rest of the ExpenseList component remains the same</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpenseList</span>(<span class="hljs-params">{ groupId, refreshTrigger }: { groupId: string, refreshTrigger: number }</span>) {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
</li>
</ol>
<hr>
<h3 id="summary-1"><strong>Summary</strong></h3>
<p>You have now successfully integrated Firebase Storage into the application.</p>
<ul>
<li><strong>Firebase Storage:</strong> You configured a Storage bucket and set up security rules to allow authenticated users to upload files.</li>
<li><strong>Upload Logic:</strong> A dedicated <code>storage.ts</code> service now handles the logic for uploading files and generating a unique, secure URL.</li>
<li><strong>Data Model:</strong> The <code>Expense</code> data structure in Firestore was updated to include an optional <code>receiptUrl</code>.</li>
<li><strong>User Interface:</strong> The &quot;Add Expense&quot; modal now has a file input, and the expense list will display a link to view the receipt if one was attached.</li>
</ul>
<p>This feature adds significant value, allowing users to keep a visual record of their shared expenses. The next logical step would be to calculate and display the balances to clearly show who owes money to whom.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;receipt-upload&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Add Receipt Upload Functionality&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Firebase Storage, React File Handling&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="algorithm-design-data-processing-nextjs-specialist">Algorithm Design, Data Processing, Next.js Specialist</h3>
<p>Here is the detailed implementation for developing the debt calculation and dashboard logic.</p>
<h3 id="approach"><strong>Approach</strong></h3>
<p>To calculate and display who owes whom, we will:</p>
<ol>
<li><strong>Create a Calculation Utility:</strong> A dedicated TypeScript module will contain the core logic for processing expenses and calculating balances. This keeps our business logic separate from our UI components.</li>
<li><strong>Develop a Dashboard Component:</strong> A new React component, <code>GroupDashboard</code>, will be created to visually represent the calculated balances and the simplified &quot;settle up&quot; plan.</li>
<li><strong>Refactor the Group Detail Page:</strong> The main page (<code>/group/[groupId]/page.tsx</code>) will be updated to fetch all necessary data (group details and expenses), run the calculation logic, and pass the results to the new dashboard component and the existing expense list.</li>
</ol>
<hr>
<h3 id="step-1-create-the-debt-calculation-utility"><strong>Step 1: Create the Debt Calculation Utility</strong></h3>
<p>This utility function will be the brain of our expense splitting logic. It will take the list of group members and all their expenses and return a clean summary of balances and debts.</p>
<ol>
<li>
<p>Create a new folder <code>src/utils</code>.</p>
</li>
<li>
<p>Create a new file <code>src/utils/debtCalculator.ts</code>:</p>
<pre><code class="language-typescript"><span class="hljs-comment">// src/utils/debtCalculator.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Member</span>, <span class="hljs-title class_">Expense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;

<span class="hljs-comment">// The structure for a member&#x27;s final balance</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Balance</span> {
  <span class="hljs-attr">uid</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">displayName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">netBalance</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// in cents. Positive means they are owed, negative means they owe.</span>
}

<span class="hljs-comment">// The structure for a simplified transaction to settle debts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SimplifiedDebt</span> {
  <span class="hljs-attr">from</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// UID of the person who owes</span>
  <span class="hljs-attr">fromName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">to</span>: <span class="hljs-built_in">string</span>;   <span class="hljs-comment">// UID of the person to be paid</span>
  <span class="hljs-attr">toName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">amount</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// in cents</span>
}

<span class="hljs-comment">/**
 * Calculates the net balance for each member and a simplified list of transactions to settle up.
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">members</span> - Array of group members.
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">expenses</span> - Array of all expenses in the group.
 * <span class="hljs-doctag">@returns</span> An object containing member balances and simplified debts.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateBalances</span>(<span class="hljs-params">members: Member[], expenses: Expense[]</span>): { <span class="hljs-attr">balances</span>: <span class="hljs-title class_">Balance</span>[], <span class="hljs-attr">simplifiedDebts</span>: <span class="hljs-title class_">SimplifiedDebt</span>[] } {
  <span class="hljs-keyword">const</span> balancesMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;();
  members.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">member</span> =&gt;</span> balancesMap.<span class="hljs-title function_">set</span>(member.<span class="hljs-property">uid</span>, <span class="hljs-number">0</span>));

  <span class="hljs-comment">// 1. Tally up total paid vs. total owed for each member</span>
  expenses.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">expense</span> =&gt;</span> {
    <span class="hljs-comment">// The person who paid gets credited the full amount</span>
    <span class="hljs-keyword">const</span> payerBalance = balancesMap.<span class="hljs-title function_">get</span>(expense.<span class="hljs-property">paidBy</span>) || <span class="hljs-number">0</span>;
    balancesMap.<span class="hljs-title function_">set</span>(expense.<span class="hljs-property">paidBy</span>, payerBalance + expense.<span class="hljs-property">amount</span>);

    <span class="hljs-comment">// Each participant gets debited their share of the cost</span>
    expense.<span class="hljs-property">participants</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">participant</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> participantBalance = balancesMap.<span class="hljs-title function_">get</span>(participant.<span class="hljs-property">uid</span>) || <span class="hljs-number">0</span>;
      balancesMap.<span class="hljs-title function_">set</span>(participant.<span class="hljs-property">uid</span>, participantBalance - participant.<span class="hljs-property">amountOwed</span>);
    });
  });

  <span class="hljs-comment">// 2. Convert the map into a more usable array of Balance objects</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">finalBalances</span>: <span class="hljs-title class_">Balance</span>[] = members.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">member</span> =&gt;</span> ({
    <span class="hljs-attr">uid</span>: member.<span class="hljs-property">uid</span>,
    <span class="hljs-attr">displayName</span>: member.<span class="hljs-property">displayName</span>,
    <span class="hljs-attr">netBalance</span>: balancesMap.<span class="hljs-title function_">get</span>(member.<span class="hljs-property">uid</span>) || <span class="hljs-number">0</span>,
  }));

  <span class="hljs-comment">// 3. Calculate the simplified list of who-owes-whom</span>
  <span class="hljs-keyword">const</span> simplifiedDebts = <span class="hljs-title function_">simplifyDebts</span>(finalBalances);

  <span class="hljs-keyword">return</span> { <span class="hljs-attr">balances</span>: finalBalances, simplifiedDebts };
}

<span class="hljs-comment">/**
 * Takes a list of balances and computes the minimum number of transactions to settle all debts.
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">balances</span> - The array of final balances for each member.
 * <span class="hljs-doctag">@returns</span> An array of simplified debt transactions.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">simplifyDebts</span>(<span class="hljs-params">balances: Balance[]</span>): <span class="hljs-title class_">SimplifiedDebt</span>[] {
  <span class="hljs-comment">// Separate members into those who are owed money (creditors) and those who owe (debtors)</span>
  <span class="hljs-keyword">const</span> debtors = balances
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">b</span> =&gt;</span> b.<span class="hljs-property">netBalance</span> &lt; <span class="hljs-number">0</span>)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">b</span> =&gt;</span> ({ ...b, <span class="hljs-attr">netBalance</span>: -b.<span class="hljs-property">netBalance</span> })); <span class="hljs-comment">// Make balances positive for easier math</span>

  <span class="hljs-keyword">const</span> creditors = balances.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">b</span> =&gt;</span> b.<span class="hljs-property">netBalance</span> &gt; <span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-attr">transactions</span>: <span class="hljs-title class_">SimplifiedDebt</span>[] = [];

  <span class="hljs-keyword">let</span> debtorIndex = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> creditorIndex = <span class="hljs-number">0</span>;

  <span class="hljs-comment">// Loop until all debts or credits are cleared</span>
  <span class="hljs-keyword">while</span> (debtorIndex &lt; debtors.<span class="hljs-property">length</span> &amp;&amp; creditorIndex &lt; creditors.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">const</span> debtor = debtors[debtorIndex];
    <span class="hljs-keyword">const</span> creditor = creditors[creditorIndex];
    <span class="hljs-keyword">const</span> amountToTransfer = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(debtor.<span class="hljs-property">netBalance</span>, creditor.<span class="hljs-property">netBalance</span>);

    <span class="hljs-comment">// Create a transaction if the amount is non-trivial</span>
    <span class="hljs-keyword">if</span> (amountToTransfer &gt; <span class="hljs-number">0.5</span>) { <span class="hljs-comment">// Use a small threshold to avoid floating point dust</span>
        transactions.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">from</span>: debtor.<span class="hljs-property">uid</span>,
          <span class="hljs-attr">fromName</span>: debtor.<span class="hljs-property">displayName</span>,
          <span class="hljs-attr">to</span>: creditor.<span class="hljs-property">uid</span>,
          <span class="hljs-attr">toName</span>: creditor.<span class="hljs-property">displayName</span>,
          <span class="hljs-attr">amount</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(amountToTransfer),
        });
    }

    <span class="hljs-comment">// Subtract the transferred amount from both parties</span>
    debtor.<span class="hljs-property">netBalance</span> -= amountToTransfer;
    creditor.<span class="hljs-property">netBalance</span> -= amountToTransfer;

    <span class="hljs-comment">// If a debtor has paid off their full amount, move to the next debtor</span>
    <span class="hljs-keyword">if</span> (debtor.<span class="hljs-property">netBalance</span> &lt; <span class="hljs-number">0.5</span>) {
      debtorIndex++;
    }
    <span class="hljs-comment">// If a creditor has been fully paid, move to the next creditor</span>
    <span class="hljs-keyword">if</span> (creditor.<span class="hljs-property">netBalance</span> &lt; <span class="hljs-number">0.5</span>) {
      creditorIndex++;
    }
  }

  <span class="hljs-keyword">return</span> transactions;
}
</code></pre>
</li>
</ol>
<h3 id="step-2-create-the-group-dashboard-ui-component"><strong>Step 2: Create the Group Dashboard UI Component</strong></h3>
<p>This component will display the summary of balances and the settlement plan.</p>
<ol>
<li>
<p>Create a new folder <code>src/components/dashboard</code>.</p>
</li>
<li>
<p>Create a new file <code>src/components/dashboard/GroupDashboard.tsx</code>:</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/dashboard/GroupDashboard.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Balance</span>, <span class="hljs-title class_">SimplifiedDebt</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/debtCalculator&#x27;</span>;

interface <span class="hljs-title class_">GroupDashboardProps</span> {
  <span class="hljs-attr">balances</span>: <span class="hljs-title class_">Balance</span>[];
  <span class="hljs-attr">debts</span>: <span class="hljs-title class_">SimplifiedDebt</span>[];
}

<span class="hljs-comment">// Helper to format cents into a currency string (e.g., 1234 -&gt; &quot;$12.34&quot;)</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">formatCurrency</span> = (<span class="hljs-params">amountInCents: number</span>) =&gt; {
  <span class="hljs-keyword">const</span> dollars = amountInCents / <span class="hljs-number">100</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">&#x27;en-US&#x27;</span>, {
    <span class="hljs-attr">style</span>: <span class="hljs-string">&#x27;currency&#x27;</span>,
    <span class="hljs-attr">currency</span>: <span class="hljs-string">&#x27;USD&#x27;</span>,
  }).<span class="hljs-title function_">format</span>(dollars);
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GroupDashboard</span>(<span class="hljs-params">{ balances, debts }: GroupDashboardProps</span>) {
  <span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">useAuth</span>();

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-8&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-2xl font-bold text-gray-800 mb-4&quot;</span>&gt;</span>Group Summary<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;grid grid-cols-1 md:grid-cols-2 gap-8&quot;</span>&gt;</span>
        {/* Column 1: Member Balances */}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-semibold mb-3&quot;</span>&gt;</span>Balances<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-2&quot;</span>&gt;</span>
            {balances.map(balance =&gt; {
              const isCurrentUser = balance.uid === user?.uid;
              const isOwed = balance.netBalance &gt; 0;
              const isOwing = balance.netBalance &lt; 0;

              let text = &#x27;is settled up&#x27;;
              let textColor = &#x27;text-gray-500&#x27;;
              if (isOwed) {
                text = `is owed ${formatCurrency(balance.netBalance)}`;
                textColor = &#x27;text-green-600&#x27;;
              } else if (isOwing) {
                text = `owes ${formatCurrency(Math.abs(balance.netBalance))}`;
                textColor = &#x27;text-red-600&#x27;;
              }

              return (
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{balance.uid}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">flex</span> <span class="hljs-attr">justify-between</span> <span class="hljs-attr">items-center</span> <span class="hljs-attr">p-2</span> <span class="hljs-attr">rounded</span> ${<span class="hljs-attr">isCurrentUser</span> ? &#x27;<span class="hljs-attr">bg-blue-50</span>&#x27; <span class="hljs-attr">:</span> &#x27;&#x27;}`}&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">font-medium</span> ${<span class="hljs-attr">isCurrentUser</span> ? &#x27;<span class="hljs-attr">text-blue-800</span>&#x27; <span class="hljs-attr">:</span> &#x27;<span class="hljs-attr">text-gray-700</span>&#x27;}`}&gt;</span>
                    {isCurrentUser ? &#x27;You&#x27; : balance.displayName}
                  <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">font-semibold</span> ${<span class="hljs-attr">textColor</span>}`}&gt;</span>
                    {text}
                  <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
              );
            })}
          <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        {/* Column 2: Settlement Plan */}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-semibold mb-3&quot;</span>&gt;</span>How to Settle Up<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
          {debts.length &gt; 0 ? (
            <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-3&quot;</span>&gt;</span>
              {debts.map((debt, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex items-center gap-3 text-gray-800&quot;</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-medium&quot;</span>&gt;</span>{debt.fromName}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;h-5 w-5 text-gray-400&quot;</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">&quot;none&quot;</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">&quot;0 0 24 24&quot;</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">&quot;currentColor&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">strokeLinecap</span>=<span class="hljs-string">&quot;round&quot;</span> <span class="hljs-attr">strokeLinejoin</span>=<span class="hljs-string">&quot;round&quot;</span> <span class="hljs-attr">strokeWidth</span>=<span class="hljs-string">{2}</span> <span class="hljs-attr">d</span>=<span class="hljs-string">&quot;M17 8l4 4m0 0l-4 4m4-4H3&quot;</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-medium&quot;</span>&gt;</span>{debt.toName}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;ml-auto font-bold text-blue-700&quot;</span>&gt;</span>
                    {formatCurrency(debt.amount)}
                  <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
              ))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
          ) : (
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-gray-600 italic&quot;</span>&gt;</span>Everyone is settled up!<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
</li>
</ol>
<h3 id="step-3-refactor-the-group-detail-page-and-expense-list"><strong>Step 3: Refactor the Group Detail Page and Expense List</strong></h3>
<p>Now, we'll modify the group detail page to orchestrate the data fetching and calculation. The <code>ExpenseList</code> component will also be simplified to just display data it receives via props.</p>
<ol>
<li>
<p><strong>Update <code>ExpenseList.tsx</code> to be a &quot;dumb&quot; component:</strong>
Modify <code>src/components/expenses/ExpenseList.tsx</code> to remove its data-fetching logic.</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/expenses/ExpenseList.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Expense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Timestamp</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/firestore&#x27;</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpenseCard</span>(<span class="hljs-params">{ expense }: { expense: Expense }</span>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">formatDate</span> = (<span class="hljs-params">timestamp: Timestamp</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!timestamp) <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Date not available&#x27;</span>;
    <span class="hljs-keyword">return</span> timestamp.<span class="hljs-title function_">toDate</span>().<span class="hljs-title function_">toLocaleDateString</span>(<span class="hljs-string">&#x27;en-US&#x27;</span>, {
      <span class="hljs-attr">month</span>: <span class="hljs-string">&#x27;short&#x27;</span>,
      <span class="hljs-attr">day</span>: <span class="hljs-string">&#x27;numeric&#x27;</span>,
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex items-center justify-between&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xs text-gray-500&quot;</span>&gt;</span>{formatDate(expense.createdAt)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-medium text-gray-800&quot;</span>&gt;</span>{expense.description}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-600&quot;</span>&gt;</span>
          Paid by {expense.paidByDisplayName}
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-right&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-semibold text-gray-900&quot;</span>&gt;</span>
          ${(expense.amount / 100).toFixed(2)}
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xs text-gray-500&quot;</span>&gt;</span>
          Split among {expense.participants.length} people
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// This component now just receives the expenses array as a prop</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpenseList</span>(<span class="hljs-params">{ expenses }: { expenses: Expense[] }</span>) {
  <span class="hljs-keyword">if</span> (expenses.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> (
      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-center py-10 px-6 bg-gray-50 rounded-lg&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-medium text-gray-800&quot;</span>&gt;</span>No expenses yet!<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-gray-600 mt-1&quot;</span>&gt;</span>
          Add an expense to get started.
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
  }

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4&quot;</span>&gt;</span>
      {expenses.map((expense) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">ExpenseCard</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{expense.id}</span> <span class="hljs-attr">expense</span>=<span class="hljs-string">{expense}</span> /&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
</li>
<li>
<p><strong>Update the Group Detail Page (<code>/group/[groupId]/page.tsx</code>)</strong>
This page will now fetch both group details and expenses, perform the balance calculation, and pass the data down to the <code>GroupDashboard</code> and <code>ExpenseList</code> components.</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/app/group/[groupId]/page.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { useParams, useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/navigation&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/link&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ProtectedRoute</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/ProtectedRoute&#x27;</span>;
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Group</span>, <span class="hljs-title class_">Expense</span>, getGroupDetails, getGroupExpenses } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AddExpenseModal</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/expenses/AddExpenseModal&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ExpenseList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/expenses/ExpenseList&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">GroupDashboard</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/dashboard/GroupDashboard&#x27;</span>;
<span class="hljs-keyword">import</span> { calculateBalances, <span class="hljs-title class_">Balance</span>, <span class="hljs-title class_">SimplifiedDebt</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/debtCalculator&#x27;</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">GroupDetailPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">useAuth</span>();
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
  <span class="hljs-keyword">const</span> params = <span class="hljs-title function_">useParams</span>();
  <span class="hljs-keyword">const</span> groupId = params.<span class="hljs-property">groupId</span> <span class="hljs-keyword">as</span> string;

  <span class="hljs-keyword">const</span> [group, setGroup] = useState&lt;<span class="hljs-title class_">Group</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [expenses, setExpenses] = useState&lt;<span class="hljs-title class_">Expense</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> [balances, setBalances] = useState&lt;<span class="hljs-title class_">Balance</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> [debts, setDebts] = useState&lt;<span class="hljs-title class_">SimplifiedDebt</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> [isLoading, setIsLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;string | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isModalOpen, setIsModalOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [refreshTrigger, setRefreshTrigger] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!groupId || !user) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchGroupData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; {
      <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);
      <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// Fetch group details and expenses in parallel for efficiency</span>
        <span class="hljs-keyword">const</span> [groupDetails, groupExpenses] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
          <span class="hljs-title function_">getGroupDetails</span>(groupId),
          <span class="hljs-title function_">getGroupExpenses</span>(groupId),
        ]);

        <span class="hljs-keyword">if</span> (!groupDetails) {
          <span class="hljs-title function_">setError</span>(<span class="hljs-string">&#x27;Group not found.&#x27;</span>);
          <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">const</span> isMember = groupDetails.<span class="hljs-property">members</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">member</span> =&gt;</span> member.<span class="hljs-property">uid</span> === user.<span class="hljs-property">uid</span>);
        <span class="hljs-keyword">if</span> (!isMember) {
          <span class="hljs-title function_">setError</span>(<span class="hljs-string">&#x27;You are not a member of this group.&#x27;</span>);
          <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-title function_">setGroup</span>(groupDetails);
        <span class="hljs-title function_">setExpenses</span>(groupExpenses);

        <span class="hljs-comment">// Calculate balances once all data is fetched</span>
        <span class="hljs-keyword">const</span> { balances, simplifiedDebts } = <span class="hljs-title function_">calculateBalances</span>(groupExpenses,
          groupDetails.<span class="hljs-property">members</span>
        );
        <span class="hljs-title function_">setBalances</span>(balances);
        <span class="hljs-title function_">setSimplifiedDebts</span>(simplifiedDebts);

      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-title function_">setError</span>(<span class="hljs-string">&#x27;Failed to load group data.&#x27;</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
      }
    };

    <span class="hljs-title function_">fetchGroupData</span>();
  }, [groupId, user, router, refreshTrigger]); <span class="hljs-comment">// Add refreshTrigger to re-run on changes</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleExpenseAdded</span> = (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-comment">// Increment the trigger to force a full refetch of data and recalculation</span>
    <span class="hljs-title function_">setRefreshTrigger</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
  };

  <span class="hljs-keyword">if</span> (isLoading) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-8 text-center&quot;</span>&gt;</span>Loading group details and expenses...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-8 text-red-500 text-center&quot;</span>&gt;</span>{error}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
  <span class="hljs-keyword">if</span> (!group) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-8 text-center&quot;</span>&gt;</span>Group not found.<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;min-h-screen bg-gray-50&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white shadow-sm&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;max-w-4xl mx-auto py-4 px-4 sm:px-6 lg:px-8&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex items-center gap-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/dashboard&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-blue-600 hover:underline&quot;</span>&gt;</span>
                <span class="hljs-symbol">&amp;larr;</span> Back to Dashboard
            <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-3xl font-bold text-gray-900 mt-2&quot;</span>&gt;</span>{group.groupName}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;py-8&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;max-w-4xl mx-auto sm:px-6 lg:px-8 space-y-8&quot;</span>&gt;</span>
          {/* Balance Summary Section */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;px-4 sm:px-0&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">BalanceSummary</span> <span class="hljs-attr">debts</span>=<span class="hljs-string">{simplifiedDebts}</span> <span class="hljs-attr">members</span>=<span class="hljs-string">{group.members}</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

          {/* Expenses Section */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;px-4 sm:px-0 mb-6 flex justify-between items-center&quot;</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-semibold text-gray-800&quot;</span>&gt;</span>Expenses<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(true)} className=&quot;button&quot;&gt;
                + Add Expense
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;px-4 sm:px-0&quot;</span>&gt;</span>
              {/* Pass expenses directly to avoid re-fetching */}
              <span class="hljs-tag">&lt;<span class="hljs-name">ExpenseList</span> <span class="hljs-attr">expenses</span>=<span class="hljs-string">{expenses}</span> <span class="hljs-attr">isLoading</span>=<span class="hljs-string">{isLoading}</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>

      {isModalOpen &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">AddExpenseModal</span>
          <span class="hljs-attr">isOpen</span>=<span class="hljs-string">{isModalOpen}</span>
          <span class="hljs-attr">onClose</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(false)}
          onExpenseAdded={handleExpenseAdded}
          groupId={group.id}
          members={group.members}
        /&gt;
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GroupPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProtectedRoute</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">GroupDetailPage</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ProtectedRoute</span>&gt;</span></span>
  );
}
</code></pre>
</li>
</ol>
<h3 id="step-2-create-the-debt-calculation-logic"><strong>Step 2: Create the Debt Calculation Logic</strong></h3>
<p>This is the core of this task. We'll create a new utility file to house the algorithm that calculates balances and simplifies debts.</p>
<ul>
<li>
<p>Create a new file: <code>src/lib/debt-calculator.ts</code></p>
<pre><code class="language-typescript"><span class="hljs-comment">// src/lib/debt-calculator.ts</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Expense</span>, <span class="hljs-title class_">Member</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./firebase/firestore&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Balance</span> {
  <span class="hljs-attr">uid</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">displayName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">netBalance</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// in cents. &gt; 0 means they are owed money, &lt; 0 means they owe money</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SimplifiedDebt</span> {
  <span class="hljs-attr">from</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// UID of the person who owes</span>
  <span class="hljs-attr">to</span>: <span class="hljs-built_in">string</span>;   <span class="hljs-comment">// UID of the person who is owed</span>
  <span class="hljs-attr">amount</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// in cents</span>
}

<span class="hljs-comment">/**
 * Calculates net balances and simplifies debts for a group.
 * <span class="hljs-doctag">@param</span> expenses An array of all expense objects for the group.
 * <span class="hljs-doctag">@param</span> members An array of all member objects in the group.
 * <span class="hljs-doctag">@returns</span> An object containing final balances and a list of simplified debt transactions.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> calculateBalances = (
  <span class="hljs-attr">expenses</span>: <span class="hljs-title class_">Expense</span>[],
  <span class="hljs-attr">members</span>: <span class="hljs-title class_">Member</span>[]
): { <span class="hljs-attr">balances</span>: <span class="hljs-title class_">Balance</span>[]; <span class="hljs-attr">simplifiedDebts</span>: <span class="hljs-title class_">SimplifiedDebt</span>[] } =&gt; {
  <span class="hljs-keyword">if</span> (!members || members.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">balances</span>: [], <span class="hljs-attr">simplifiedDebts</span>: [] };
  }

  <span class="hljs-comment">// Step 1: Calculate the net balance for each member</span>
  <span class="hljs-keyword">const</span> balanceMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;();
  members.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">member</span> =&gt;</span> balanceMap.<span class="hljs-title function_">set</span>(member.<span class="hljs-property">uid</span>, <span class="hljs-number">0</span>));

  expenses.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">expense</span> =&gt;</span> {
    <span class="hljs-comment">// Credit the payer by the full amount of the expense</span>
    <span class="hljs-keyword">const</span> payerBalance = balanceMap.<span class="hljs-title function_">get</span>(expense.<span class="hljs-property">paidBy</span>) || <span class="hljs-number">0</span>;
    balanceMap.<span class="hljs-title function_">set</span>(expense.<span class="hljs-property">paidBy</span>, payerBalance + expense.<span class="hljs-property">amount</span>);

    <span class="hljs-comment">// Debit each participant by their share of the expense</span>
    expense.<span class="hljs-property">participants</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">participant</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> participantBalance = balanceMap.<span class="hljs-title function_">get</span>(participant.<span class="hljs-property">uid</span>) || <span class="hljs-number">0</span>;
      balanceMap.<span class="hljs-title function_">set</span>(participant.<span class="hljs-property">uid</span>, participantBalance - participant.<span class="hljs-property">amountOwed</span>);
    });
  });

  <span class="hljs-comment">// Convert map to an array of Balance objects for easier processing</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">finalBalances</span>: <span class="hljs-title class_">Balance</span>[] = members.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">member</span> =&gt;</span> ({
    <span class="hljs-attr">uid</span>: member.<span class="hljs-property">uid</span>,
    <span class="hljs-attr">displayName</span>: member.<span class="hljs-property">displayName</span>,
    <span class="hljs-attr">netBalance</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(balanceMap.<span class="hljs-title function_">get</span>(member.<span class="hljs-property">uid</span>) || <span class="hljs-number">0</span>), <span class="hljs-comment">// Round to avoid floating point issues</span>
  }));

  <span class="hljs-comment">// Step 2: Simplify the debts using a greedy algorithm</span>
  <span class="hljs-keyword">const</span> simplifiedDebts = <span class="hljs-title function_">simplifyDebts</span>(finalBalances);

  <span class="hljs-keyword">return</span> { <span class="hljs-attr">balances</span>: finalBalances, simplifiedDebts };
};


<span class="hljs-comment">/**
 * Simplifies a list of balances into the minimum number of transactions.
 * <span class="hljs-doctag">@param</span> balances An array of balance objects.
 * <span class="hljs-doctag">@returns</span> An array of simplified debt objects.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">simplifyDebts</span>(<span class="hljs-params">balances: Balance[]</span>): <span class="hljs-title class_">SimplifiedDebt</span>[] {
  <span class="hljs-comment">// Create copies to avoid mutating the original array</span>
  <span class="hljs-keyword">const</span> debtors = balances.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">b</span> =&gt;</span> b.<span class="hljs-property">netBalance</span> &lt; <span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">b</span> =&gt;</span> ({ ...b }));
  <span class="hljs-keyword">const</span> creditors = balances.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">b</span> =&gt;</span> b.<span class="hljs-property">netBalance</span> &gt; <span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">b</span> =&gt;</span> ({ ...b }));
  
  <span class="hljs-keyword">const</span> <span class="hljs-attr">transactions</span>: <span class="hljs-title class_">SimplifiedDebt</span>[] = [];

  <span class="hljs-comment">// Loop until all debts are settled</span>
  <span class="hljs-keyword">while</span> (debtors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; creditors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> debtor = debtors[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">const</span> creditor = creditors[<span class="hljs-number">0</span>];

    <span class="hljs-keyword">const</span> amountToSettle = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(debtor.<span class="hljs-property">netBalance</span>), creditor.<span class="hljs-property">netBalance</span>);

    <span class="hljs-comment">// Create a transaction record</span>
    transactions.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">from</span>: debtor.<span class="hljs-property">uid</span>,
      <span class="hljs-attr">to</span>: creditor.<span class="hljs-property">uid</span>,
      <span class="hljs-attr">amount</span>: amountToSettle,
    });

    <span class="hljs-comment">// Update balances</span>
    debtor.<span class="hljs-property">netBalance</span> += amountToSettle;
    creditor.<span class="hljs-property">netBalance</span> -= amountToSettle;

    <span class="hljs-comment">// If a member&#x27;s balance is settled (or very close to 0), remove them from their respective list</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(debtor.<span class="hljs-property">netBalance</span>) &lt; <span class="hljs-number">1</span>) { <span class="hljs-comment">// Use a small threshold for cents</span>
      debtors.<span class="hljs-title function_">shift</span>();
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(creditor.<span class="hljs-property">netBalance</span>) &lt; <span class="hljs-number">1</span>) {
      creditors.<span class="hljs-title function_">shift</span>();
    }
  }

  <span class="hljs-keyword">return</span> transactions;
};
</code></pre>
</li>
</ul>
<h3 id="step-3-create-the-balance-summary-ui-component"><strong>Step 3: Create the Balance Summary UI Component</strong></h3>
<p>This component will receive the calculated debts and display them in a user-friendly format.</p>
<ul>
<li>
<p>Create a new file: <code>src/components/expenses/BalanceSummary.tsx</code></p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/expenses/BalanceSummary.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Member</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SimplifiedDebt</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/debt-calculator&#x27;</span>;

interface <span class="hljs-title class_">BalanceSummaryProps</span> {
  <span class="hljs-attr">debts</span>: <span class="hljs-title class_">SimplifiedDebt</span>[];
  <span class="hljs-attr">members</span>: <span class="hljs-title class_">Member</span>[];
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">BalanceSummary</span>(<span class="hljs-params">{ debts, members }: BalanceSummaryProps</span>) {
  <span class="hljs-comment">// Create a map for quick lookup of member names by UID</span>
  <span class="hljs-keyword">const</span> memberMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(members.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> [m.<span class="hljs-property">uid</span>, m.<span class="hljs-property">displayName</span>]));

  <span class="hljs-keyword">if</span> (debts.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> (
      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md&quot;</span> <span class="hljs-attr">role</span>=<span class="hljs-string">&quot;alert&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-bold&quot;</span>&gt;</span>All Settled Up!<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>There are no outstanding debts in the group.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
  }

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white p-6 rounded-lg shadow-md border border-gray-200&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-semibold text-gray-800 mb-4&quot;</span>&gt;</span>Who Owes Who<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-3&quot;</span>&gt;</span>
        {debts.map((debt, index) =&gt; {
          const fromName = memberMap.get(debt.from) || &#x27;Unknown User&#x27;;
          const toName = memberMap.get(debt.to) || &#x27;Unknown User&#x27;;
          const amount = (debt.amount / 100).toFixed(2);

          return (
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex items-center justify-between p-3 bg-gray-50 rounded-md&quot;</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-gray-700&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-semibold text-red-600&quot;</span>&gt;</span>{fromName}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> owes{&#x27; &#x27;}
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-semibold text-green-600&quot;</span>&gt;</span>{toName}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-bold text-lg text-gray-900&quot;</span>&gt;</span>
                ${amount}
              <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          );
        })}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
</li>
</ul>
<h3 id="step-4-refactor-expenselist-to-be-a-presentational-component"><strong>Step 4: Refactor <code>ExpenseList</code> to be a Presentational Component</strong></h3>
<p>To improve performance and simplify logic, we'll modify <code>ExpenseList</code> to no longer fetch its own data. Instead, it will receive the list of expenses as a prop from its parent, <code>GroupDetailPage</code>.</p>
<ul>
<li>
<p>Update the file: <code>src/components/expenses/ExpenseList.tsx</code></p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/expenses/ExpenseList.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Expense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Timestamp</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/firestore&#x27;</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpenseCard</span>(<span class="hljs-params">{ expense }: { expense: Expense }</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">formatDate</span> = (<span class="hljs-params">timestamp: Timestamp</span>) =&gt; {
        <span class="hljs-keyword">if</span> (!timestamp) <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Date not available&#x27;</span>;
        <span class="hljs-keyword">return</span> timestamp.<span class="hljs-title function_">toDate</span>().<span class="hljs-title function_">toLocaleDateString</span>(<span class="hljs-string">&#x27;en-US&#x27;</span>, {
            <span class="hljs-attr">month</span>: <span class="hljs-string">&#x27;short&#x27;</span>,
            <span class="hljs-attr">day</span>: <span class="hljs-string">&#x27;numeric&#x27;</span>,
        });
    };

    <span class="hljs-keyword">return</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex items-center justify-between&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xs text-gray-500&quot;</span>&gt;</span>{formatDate(expense.createdAt)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-medium text-gray-800&quot;</span>&gt;</span>{expense.description}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-600&quot;</span>&gt;</span>
                    Paid by {expense.paidByDisplayName}
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-right&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-semibold text-gray-900&quot;</span>&gt;</span>
                    ${(expense.amount / 100).toFixed(2)}
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xs text-gray-500&quot;</span>&gt;</span>
                    Split among {expense.participants.length} people
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}

<span class="hljs-comment">// Refactored to accept expenses and loading state as props</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpenseList</span>(<span class="hljs-params">{ expenses, isLoading }: { expenses: Expense[], isLoading: boolean }</span>) {
  <span class="hljs-keyword">if</span> (isLoading) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Loading expenses...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;
  }

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {expenses.length &gt; 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4&quot;</span>&gt;</span>
          {expenses.map((expense) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">ExpenseCard</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{expense.id}</span> <span class="hljs-attr">expense</span>=<span class="hljs-string">{expense}</span> /&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-center py-10 px-6 bg-gray-50 rounded-lg&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-medium text-gray-800&quot;</span>&gt;</span>No expenses yet!<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-gray-600 mt-1&quot;</span>&gt;</span>
            Add an expense to get started.
          <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
</li>
</ul>
<hr>
<h3 id="summary-2"><strong>Summary</strong></h3>
<p>You have successfully implemented the debt calculation and dashboard logic.</p>
<ul>
<li><strong>Core Algorithm:</strong> A robust <code>calculateBalances</code> function in <code>src/lib/debt-calculator.ts</code> now processes all expenses to determine each member's net balance.</li>
<li><strong>Debt Simplification:</strong> The algorithm includes a greedy approach to simplify debts, minimizing the number of transactions required to settle up (e.g., instead of A owes B $10 and B owes C $10, it calculates that A owes C $10).</li>
<li><strong>Integrated Dashboard:</strong> The group detail page (<code>/group/[groupId]</code>) now fetches all necessary data, performs the calculations, and displays a clear &quot;Who Owes Who&quot; summary at the top using the new <code>BalanceSummary</code> component.</li>
<li><strong>Efficiency:</strong> The <code>ExpenseList</code> component has been refactored to be a presentational component, preventing redundant data fetching and ensuring the entire page updates atomically when a new expense is added.</li>
</ul>
<p>The application now provides the core value of an expense splitter: clarity on who owes whom. The next steps could involve adding features like settling debts, viewing personal balance summaries, or handling more complex split methods.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;debt-calculation&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Develop Debt Calculation and Dashboard Logic&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Algorithm Design, Data Processing, Next.js&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="uiux-design-css-tailwind-css-specialist">UI/UX Design, CSS, Tailwind CSS Specialist</h3>
<p>Excellent. The application is fully functional, but its appearance is basic. A polished, intuitive user interface is crucial for a finance app to feel trustworthy and be pleasant to use.</p>
<p>In this step, we will overhaul the UI/UX using <strong>Tailwind CSS</strong>. We'll establish a consistent design system with a defined color palette, component styles, and responsive layouts to create a professional and modern look and feel.</p>
<hr>
<h3 id="step-1-enhance-tailwind-configuration-and-base-styles"><strong>Step 1: Enhance Tailwind Configuration and Base Styles</strong></h3>
<p>First, let's define our color palette and refine the base styles for the entire application.</p>
<ol>
<li>
<p><strong>Install Heroicons:</strong> We'll use this popular icon library to add visual cues to our UI.</p>
<pre><code class="language-bash">npm install @heroicons/react
</code></pre>
</li>
<li>
<p><strong>Update <code>tailwind.config.ts</code>:</strong> We'll extend the default theme with our custom color scheme.</p>
<pre><code class="language-ts"><span class="hljs-comment">// tailwind.config.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Config</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;tailwindcss&#x27;</span>

<span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Config</span> = {
  <span class="hljs-attr">content</span>: [
    <span class="hljs-string">&#x27;./src/pages/**/*.{js,ts,jsx,tsx,mdx}&#x27;</span>,
    <span class="hljs-string">&#x27;./src/components/**/*.{js,ts,jsx,tsx,mdx}&#x27;</span>,
    <span class="hljs-string">&#x27;./src/app/**/*.{js,ts,jsx,tsx,mdx}&#x27;</span>,
  ],
  <span class="hljs-attr">theme</span>: {
    <span class="hljs-attr">extend</span>: {
      <span class="hljs-attr">colors</span>: {
        <span class="hljs-attr">brand</span>: {
          <span class="hljs-attr">primary</span>: <span class="hljs-string">&#x27;#4f46e5&#x27;</span>, <span class="hljs-comment">// Indigo 600</span>
          <span class="hljs-attr">secondary</span>: <span class="hljs-string">&#x27;#6366f1&#x27;</span>, <span class="hljs-comment">// Indigo 500</span>
          <span class="hljs-attr">light</span>: <span class="hljs-string">&#x27;#e0e7ff&#x27;</span>, <span class="hljs-comment">// Indigo 100</span>
        },
        <span class="hljs-attr">success</span>: <span class="hljs-string">&#x27;#16a34a&#x27;</span>, <span class="hljs-comment">// Green 600</span>
        <span class="hljs-attr">danger</span>: <span class="hljs-string">&#x27;#dc2626&#x27;</span>, <span class="hljs-comment">// Red 600</span>
        <span class="hljs-attr">light</span>: <span class="hljs-string">&#x27;#f8fafc&#x27;</span>, <span class="hljs-comment">// Slate 50</span>
      },
    },
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@tailwindcss/forms&#x27;</span>), <span class="hljs-comment">// A plugin for better default form styles</span>
  ],
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> config
</code></pre>
<p><em>Note: You might need to install <code>@tailwindcss/forms</code>: <code>npm install -D @tailwindcss/forms</code></em></p>
</li>
<li>
<p><strong>Refine <code>globals.css</code>:</strong> Let's clean up the global stylesheet. We'll set a background color for the app and refine our component layer for better consistency.</p>
<pre><code class="language-css"><span class="hljs-comment">/* src/app/globals.css */</span>
<span class="hljs-keyword">@tailwind</span> base;
<span class="hljs-keyword">@tailwind</span> components;
<span class="hljs-keyword">@tailwind</span> utilities;

<span class="hljs-comment">/* Apply a default background color and font smoothing */</span>
<span class="hljs-selector-tag">body</span> {
  <span class="hljs-keyword">@apply</span> bg-light antialiased;
}

<span class="hljs-keyword">@layer</span> components {
  <span class="hljs-comment">/* We will apply styles more directly in components, but keep some core ones here */</span>
  <span class="hljs-selector-class">.button</span> {
    <span class="hljs-keyword">@apply</span> inline-flex items-center justify-center rounded-md bg-brand-primary px-<span class="hljs-number">4</span> py-<span class="hljs-number">2</span> text-sm font-semibold text-white shadow-sm transition-colors <span class="hljs-attribute">hover</span>:bg-brand-secondary <span class="hljs-attribute">focus-visible</span>:outline <span class="hljs-attribute">focus-visible</span>:outline-<span class="hljs-number">2</span> <span class="hljs-attribute">focus-visible</span>:outline-offset-<span class="hljs-number">2</span> <span class="hljs-attribute">focus-visible</span>:outline-brand-primary <span class="hljs-attribute">disabled</span>:opacity-<span class="hljs-number">50</span> <span class="hljs-attribute">disabled</span>:cursor-not-allowed;
  }
  <span class="hljs-selector-class">.button-secondary</span> {
    <span class="hljs-keyword">@apply</span> inline-flex items-center justify-center rounded-md bg-white px-<span class="hljs-number">4</span> py-<span class="hljs-number">2</span> text-sm font-semibold text-gray-<span class="hljs-number">900</span> shadow-sm ring-<span class="hljs-number">1</span> ring-inset ring-gray-<span class="hljs-number">300</span> transition-colors <span class="hljs-attribute">hover</span>:bg-gray-<span class="hljs-number">50</span> <span class="hljs-attribute">disabled</span>:opacity-<span class="hljs-number">50</span> <span class="hljs-attribute">disabled</span>:cursor-not-allowed;
  }
  <span class="hljs-selector-class">.input</span> {
    <span class="hljs-keyword">@apply</span> block w-full rounded-md border-<span class="hljs-number">0</span> py-<span class="hljs-number">1.5</span> text-gray-<span class="hljs-number">900</span> shadow-sm ring-<span class="hljs-number">1</span> ring-inset ring-gray-<span class="hljs-number">300</span> <span class="hljs-attribute">placeholder</span>:text-gray-<span class="hljs-number">400</span> <span class="hljs-attribute">focus</span>:ring-<span class="hljs-number">2</span> <span class="hljs-attribute">focus</span>:ring-inset <span class="hljs-attribute">focus</span>:ring-brand-primary <span class="hljs-attribute">sm</span>:text-sm <span class="hljs-attribute">sm</span>:leading-<span class="hljs-number">6</span>;
  }
  <span class="hljs-selector-class">.label</span> {
    <span class="hljs-keyword">@apply</span> block text-sm font-medium leading-<span class="hljs-number">6</span> text-gray-<span class="hljs-number">900</span>;
  }
  <span class="hljs-selector-class">.card</span> {
    <span class="hljs-keyword">@apply</span> bg-white rounded-lg shadow-md border border-gray-<span class="hljs-number">200</span>;
  }
}
</code></pre>
</li>
</ol>
<hr>
<h3 id="step-2-create-a-reusable-layout-component"><strong>Step 2: Create a Reusable Layout Component</strong></h3>
<p>To ensure a consistent header and page structure for logged-in users, we'll create a <code>MainLayout</code> component.</p>
<ul>
<li>
<p>Create a new file: <code>src/components/layout/MainLayout.tsx</code></p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/layout/MainLayout.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/link&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArrowRightOnRectangleIcon</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@heroicons/react/24/outline&#x27;</span>;

interface <span class="hljs-title class_">MainLayoutProps</span> {
  <span class="hljs-attr">children</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;
  <span class="hljs-attr">pageTitle</span>: string;
  backButtonHref?: string;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MainLayout</span>(<span class="hljs-params">{ children, pageTitle, backButtonHref }: MainLayoutProps</span>) {
  <span class="hljs-keyword">const</span> { user, logout } = <span class="hljs-title function_">useAuth</span>();

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;min-h-screen bg-light&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white shadow-sm sticky top-0 z-40&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mx-auto max-w-7xl px-4 sm:px-6 lg:px-8&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex h-16 justify-between&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/dashboard&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex-shrink-0 text-2xl font-bold text-brand-primary&quot;</span>&gt;</span>
                SplitEase
              <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex items-center gap-4&quot;</span>&gt;</span>
              {user &amp;&amp; (
                <span class="hljs-tag">&lt;&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-600 hidden sm:block&quot;</span>&gt;</span>
                    {user.email}
                  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
                    <span class="hljs-attr">onClick</span>=<span class="hljs-string">{logout}</span>
                    <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button-secondary p-2&quot;</span>
                    <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;Logout&quot;</span>
                  &gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">ArrowRightOnRectangleIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;h-5 w-5&quot;</span> /&gt;</span>
                  <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                <span class="hljs-tag">&lt;/&gt;</span>
              )}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span></span>

      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;py-8&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mx-auto max-w-7xl sm:px-6 lg:px-8&quot;</span>&gt;</span>
          {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span></span>
    &lt;/div&gt;
  );
}
</code></pre>
</li>
</ul>
<hr>
<h3 id="step-3-update-and-style-the-dashboard-page"><strong>Step 3: Update and Style the Dashboard Page</strong></h3>
<p>Let's apply our new layout and styles to the main dashboard.</p>
<ol>
<li>
<p><strong>Restyle <code>GroupCard</code> in <code>GroupList.tsx</code>:</strong> Make the cards cleaner and more interactive.</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/groups/GroupList.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Group</span>, getUserGroups } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/link&#x27;</span>;
<span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UsersIcon</span>, <span class="hljs-title class_">ClipboardDocumentIcon</span>, <span class="hljs-title class_">CheckIcon</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@heroicons/react/24/outline&#x27;</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">GroupCard</span>(<span class="hljs-params">{ group }: { group: Group }</span>) {
  <span class="hljs-keyword">const</span> [copied, setCopied] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">copyToClipboard</span> = (<span class="hljs-params">e: React.MouseEvent</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>(); <span class="hljs-comment">// Prevent link navigation</span>
    navigator.<span class="hljs-property">clipboard</span>.<span class="hljs-title function_">writeText</span>(group.<span class="hljs-property">inviteCode</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setCopied</span>(<span class="hljs-literal">true</span>);
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setCopied</span>(<span class="hljs-literal">false</span>), <span class="hljs-number">2000</span>); <span class="hljs-comment">// Reset after 2 seconds</span>
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">{</span>`/<span class="hljs-attr">group</span>/${<span class="hljs-attr">group.id</span>}`} <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;group block&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;card h-full p-6 transition-all group-hover:shadow-xl group-hover:-translate-y-1&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-bold text-gray-800&quot;</span>&gt;</span>{group.groupName}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-2 flex items-center text-sm text-gray-500&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">UsersIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;h-4 w-4 mr-2&quot;</span> /&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{group.members.length} member{group.members.length !== 1 ? &#x27;s&#x27; : &#x27;&#x27;}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-4 pt-4 border-t border-gray-100&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xs font-semibold text-gray-500 uppercase&quot;</span>&gt;</span>Invite Code<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-1 flex items-center justify-between gap-2 p-2 bg-gray-50 rounded-md&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-mono text-lg tracking-widest text-gray-700&quot;</span>&gt;</span>{group.inviteCode}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{copyToClipboard}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button-secondary p-2&quot;</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;Copy code&quot;</span>&gt;</span>
              {copied ? <span class="hljs-tag">&lt;<span class="hljs-name">CheckIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;h-5 w-5 text-success&quot;</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">ClipboardDocumentIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;h-5 w-5&quot;</span> /&gt;</span>}
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// ... (rest of GroupList component is the same, just remove the old GroupCard)</span>
</code></pre>
</li>
<li>
<p><strong>Update <code>dashboard/page.tsx</code>:</strong> Use the <code>MainLayout</code> and add a proper header.</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/app/dashboard/page.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ProtectedRoute</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/ProtectedRoute&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CreateGroupModal</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/groups/CreateGroupModal&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">GroupList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/groups/GroupList&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MainLayout</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/layout/MainLayout&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PlusIcon</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@heroicons/react/20/solid&#x27;</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dashboard</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> [isModalOpen, setIsModalOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">MainLayout</span> <span class="hljs-attr">pageTitle</span>=<span class="hljs-string">&quot;Dashboard&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;px-4 sm:px-0 mb-6 flex justify-between items-center&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-3xl font-bold tracking-tight text-gray-900&quot;</span>&gt;</span>Your Groups<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(true)} className=&quot;button&quot;&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">PlusIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;h-5 w-5 mr-1&quot;</span> /&gt;</span>
          Create Group
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;px-4 sm:px-0&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">GroupList</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">CreateGroupModal</span>
        <span class="hljs-attr">isOpen</span>=<span class="hljs-string">{isModalOpen}</span>
        <span class="hljs-attr">onClose</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(false)}
        onGroupCreated={() =&gt; {
          window.location.reload();
        }}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">MainLayout</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DashboardPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProtectedRoute</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Dashboard</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ProtectedRoute</span>&gt;</span></span>
  );
}
</code></pre>
</li>
</ol>
<hr>
<h3 id="step-4-update-and-style-the-group-detail-page"><strong>Step 4: Update and Style the Group Detail Page</strong></h3>
<p>This page has the most components and will benefit greatly from a cleaner design.</p>
<ol>
<li>
<p><strong>Restyle <code>BalanceSummary.tsx</code>:</strong> Make the &quot;who owes who&quot; section visually clear.</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/expenses/BalanceSummary.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Member</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SimplifiedDebt</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/debt-calculator&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArrowLongRightIcon</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@heroicons/react/24/solid&#x27;</span>;

interface <span class="hljs-title class_">BalanceSummaryProps</span> {
  <span class="hljs-attr">debts</span>: <span class="hljs-title class_">SimplifiedDebt</span>[];
  <span class="hljs-attr">members</span>: <span class="hljs-title class_">Member</span>[];
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">BalanceSummary</span>(<span class="hljs-params">{ debts, members }: BalanceSummaryProps</span>) {
  <span class="hljs-keyword">const</span> memberMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(members.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> [m.<span class="hljs-property">uid</span>, m.<span class="hljs-property">displayName</span>]));

  <span class="hljs-keyword">if</span> (debts.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> (
      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;card p-6 bg-green-50 border-green-200&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-bold text-green-800&quot;</span>&gt;</span>All Settled Up!<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-1 text-green-700&quot;</span>&gt;</span>There are no outstanding debts in this group.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
  }

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;card p-6&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-bold text-gray-800 mb-4&quot;</span>&gt;</span>How to Settle Up<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4&quot;</span>&gt;</span>
        {debts.map((debt, index) =&gt; {
          const fromName = memberMap.get(debt.from) || &#x27;Unknown User&#x27;;
          const toName = memberMap.get(debt.to) || &#x27;Unknown User&#x27;;
          const amount = (debt.amount / 100).toFixed(2);

          return (
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex flex-col sm:flex-row items-center justify-between p-4 bg-gray-50 rounded-lg&quot;</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex items-center gap-3 text-lg&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-semibold text-danger&quot;</span>&gt;</span>{fromName}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ArrowLongRightIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;h-6 w-6 text-gray-400&quot;</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-semibold text-success&quot;</span>&gt;</span>{toName}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-2 sm:mt-0 font-bold text-2xl text-brand-primary&quot;</span>&gt;</span>
                ${amount}
              <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          );
        })}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
</li>
<li>
<p><strong>Restyle <code>ExpenseList.tsx</code>:</strong> Improve the layout of individual expense items.</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/expenses/ExpenseList.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Expense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Timestamp</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/firestore&#x27;</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpenseCard</span>(<span class="hljs-params">{ expense }: { expense: Expense }</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">formatDate</span> = (<span class="hljs-params">timestamp: Timestamp</span>) =&gt; {
        <span class="hljs-keyword">if</span> (!timestamp) <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Date not available&#x27;</span>;
        <span class="hljs-keyword">return</span> timestamp.<span class="hljs-title function_">toDate</span>().<span class="hljs-title function_">toLocaleDateString</span>(<span class="hljs-string">&#x27;en-US&#x27;</span>, {
            <span class="hljs-attr">year</span>: <span class="hljs-string">&#x27;numeric&#x27;</span>, <span class="hljs-attr">month</span>: <span class="hljs-string">&#x27;short&#x27;</span>, <span class="hljs-attr">day</span>: <span class="hljs-string">&#x27;numeric&#x27;</span>,
        });
    };

    <span class="hljs-keyword">return</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;card p-4 flex items-center justify-between gap-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex-1&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-bold text-lg text-gray-800&quot;</span>&gt;</span>{expense.description}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-500 mt-1&quot;</span>&gt;</span>
                    Paid by <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-medium text-gray-700&quot;</span>&gt;</span>{expense.paidByDisplayName}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> on {formatDate(expense.createdAt)}
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-right&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-2xl font-semibold text-gray-900&quot;</span>&gt;</span>
                    ${(expense.amount / 100).toFixed(2)}
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xs text-gray-500&quot;</span>&gt;</span>
                    Split among {expense.participants.length}
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}

<span class="hljs-comment">// ... (rest of ExpenseList component is the same)</span>
</code></pre>
</li>
<li>
<p><strong>Update <code>group/[groupId]/page.tsx</code>:</strong> Integrate the layout and clean up the structure.</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/app/group/[groupId]/page.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { useParams, useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/navigation&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/link&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ProtectedRoute</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/ProtectedRoute&#x27;</span>;
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Group</span>, <span class="hljs-title class_">Expense</span>, getGroupDetails, getGroupExpenses } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> { calculateBalances, <span class="hljs-title class_">SimplifiedDebt</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/debt-calculator&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MainLayout</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/layout/MainLayout&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">BalanceSummary</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/expenses/BalanceSummary&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ExpenseList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/expenses/ExpenseList&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AddExpenseModal</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/expenses/AddExpenseModal&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PlusIcon</span>, <span class="hljs-title class_">ArrowLeftIcon</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@heroicons/react/20/solid&#x27;</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">GroupDetailPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// ... (all state and useEffect hooks remain the same)</span>
  <span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">useAuth</span>();
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
  <span class="hljs-keyword">const</span> params = <span class="hljs-title function_">useParams</span>();
  <span class="hljs-keyword">const</span> groupId = params.<span class="hljs-property">groupId</span> <span class="hljs-keyword">as</span> string;

  <span class="hljs-keyword">const</span> [group, setGroup] = useState&lt;<span class="hljs-title class_">Group</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [expenses, setExpenses] = useState&lt;<span class="hljs-title class_">Expense</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> [debts, setDebts] = useState&lt;<span class="hljs-title class_">SimplifiedDebt</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> [isLoading, setIsLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;string | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isModalOpen, setIsModalOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [refreshTrigger, setRefreshTrigger] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!groupId || !user) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchGroupData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; {
      <span class="hljs-comment">// ... (fetch logic remains identical)</span>
    };
    <span class="hljs-title function_">fetchGroupData</span>();
  }, [groupId, user, router, refreshTrigger]);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleExpenseAdded</span> = (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-title function_">setRefreshTrigger</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
  };

  <span class="hljs-keyword">if</span> (isLoading) { <span class="hljs-comment">/* ... */</span> }
  <span class="hljs-keyword">if</span> (error) { <span class="hljs-comment">/* ... */</span> }
  <span class="hljs-keyword">if</span> (!group) { <span class="hljs-comment">/* ... */</span> }

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">MainLayout</span> <span class="hljs-attr">pageTitle</span>=<span class="hljs-string">{group.groupName}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-8&quot;</span>&gt;</span>
        {/* Page Header */}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;px-4 sm:px-0&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/dashboard&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;inline-flex items-center gap-2 text-sm font-medium text-gray-600 hover:text-brand-primary mb-4&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ArrowLeftIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;h-4 w-4&quot;</span> /&gt;</span>
                Back to All Groups
            <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-3xl font-bold tracking-tight text-gray-900&quot;</span>&gt;</span>{group.groupName}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        {/* Balance Summary */}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;px-4 sm:px-0&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">BalanceSummary</span> <span class="hljs-attr">debts</span>=<span class="hljs-string">{debts}</span> <span class="hljs-attr">members</span>=<span class="hljs-string">{group.members}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        {/* Expenses Section */}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;px-4 sm:px-0 mb-6 flex justify-between items-center&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-2xl font-bold text-gray-900&quot;</span>&gt;</span>Expenses<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(true)} className=&quot;button&quot;&gt;
              <span class="hljs-tag">&lt;<span class="hljs-name">PlusIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;h-5 w-5 mr-1&quot;</span> /&gt;</span>
              Add Expense
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;px-4 sm:px-0&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ExpenseList</span> <span class="hljs-attr">expenses</span>=<span class="hljs-string">{expenses}</span> <span class="hljs-attr">isLoading</span>=<span class="hljs-string">{isLoading}</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {isModalOpen &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">AddExpenseModal</span>
          <span class="hljs-attr">isOpen</span>=<span class="hljs-string">{isModalOpen}</span>
          <span class="hljs-attr">onClose</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(false)}
          onExpenseAdded={handleExpenseAdded}
          groupId={group.id}
          members={group.members}
        /&gt;
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">MainLayout</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// ... (default export remains the same)</span>
</code></pre>
</li>
</ol>
<hr>
<h3 id="step-5-style-the-modals"><strong>Step 5: Style the Modals</strong></h3>
<p>Finally, let's give our modals a professional look.</p>
<ul>
<li>
<p><strong>Update <code>CreateGroupModal.tsx</code> and <code>AddExpenseModal.tsx</code>:</strong> The styling is nearly identical for both. Here is the updated JSX for <code>CreateGroupModal</code>. Apply similar changes to <code>AddExpenseModal</code>.</p>
<pre><code class="language-tsx"><span class="hljs-comment">// src/components/groups/CreateGroupModal.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/context/AuthContext&#x27;</span>;
<span class="hljs-keyword">import</span> { createGroup } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">XMarkIcon</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@heroicons/react/24/outline&#x27;</span>;

<span class="hljs-comment">// ... (interface and function signature)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">CreateGroupModal</span>(<span class="hljs-params">{ isOpen, onClose, onGroupCreated }: CreateGroupModalProps</span>) {
    <span class="hljs-comment">// ... (state hooks and handleSubmit logic remain the same)</span>

    <span class="hljs-keyword">if</span> (!isOpen) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">return</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;relative z-50&quot;</span> <span class="hljs-attr">aria-labelledby</span>=<span class="hljs-string">&quot;modal-title&quot;</span> <span class="hljs-attr">role</span>=<span class="hljs-string">&quot;dialog&quot;</span> <span class="hljs-attr">aria-modal</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span>
            {/* Backdrop */}
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;fixed inset-0 z-10 w-screen overflow-y-auto&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex min-h-full items-center justify-center p-4 text-center sm:items-center sm:p-0&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg&quot;</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4&quot;</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;sm:flex sm:items-start&quot;</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;w-full mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left&quot;</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex justify-between items-center&quot;</span>&gt;</span>
                                        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-semibold leading-6 text-gray-900&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;modal-title&quot;</span>&gt;</span>
                                            Create a New Group
                                        <span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                                        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClose}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-1 rounded-full hover:bg-gray-100&quot;</span>&gt;</span>
                                            <span class="hljs-tag">&lt;<span class="hljs-name">XMarkIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;h-6 w-6 text-gray-500&quot;</span> /&gt;</span>
                                        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-4&quot;</span>&gt;</span>
                                        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mb-4&quot;</span>&gt;</span>
                                                <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">&quot;groupName&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;label&quot;</span>&gt;</span>Group Name<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
                                                <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
                                                    <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;groupName&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{groupName}</span>
                                                    <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setGroupName(e.target.value)}
                                                    placeholder=&quot;e.g., Apartment Roommates&quot; required className=&quot;input mt-1&quot;
                                                /&gt;
                                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                            {error &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-red-500 text-sm mb-4&quot;</span>&gt;</span>{error}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-6 flex justify-end gap-4&quot;</span>&gt;</span>
                                                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClose}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button-secondary&quot;</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isLoading}</span>&gt;</span>
                                                    Cancel
                                                <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                                                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isLoading}</span>&gt;</span>
                                                    {isLoading ? &#x27;Creating...&#x27; : &#x27;Create Group&#x27;}
                                                <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
</li>
</ul>
<h3 id="summary-3"><strong>Summary</strong></h3>
<p>By systematically applying a design system through Tailwind CSS, you have transformed the application from a functional prototype into a polished, professional-looking product.</p>
<ul>
<li><strong>Consistent Design:</strong> A defined color palette and component styles (<code>button</code>, <code>card</code>, <code>input</code>) create a cohesive user experience.</li>
<li><strong>Reusable Layout:</strong> The <code>MainLayout</code> component reduces code duplication and ensures every authenticated page has a consistent header and structure.</li>
<li><strong>Improved UX:</strong> The UI is now more intuitive, with clear visual hierarchies, interactive hover states, and helpful icons.</li>
<li><strong>Responsive:</strong> All updated components and layouts are designed to work seamlessly across device sizes, from mobile phones to desktops.</li>
</ul>
<p>The application is now not only fully functional but also visually appealing and user-friendly, providing a solid foundation for any future features.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ui-styling&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;UI/UX Design and Styling&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;UI/UX Design, CSS, Tailwind CSS&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="firebase-security-rules-specialist">Firebase Security Rules Specialist</h3>
<p>Excellent. With the application's core logic and UI in place, it's absolutely critical to secure our backend before considering deployment. Firebase Security Rules are the server-side gatekeepers that protect your data from unauthorized access, ensuring users can only read and write data they are permitted to.</p>
<p>We will write and deploy rules for both Firestore and Firebase Storage.</p>
<hr>
<h3 id="a-quick-note-on-data-modeling-for-security"><strong>A Quick Note on Data Modeling for Security</strong></h3>
<p>For our security rules to work efficiently, we need to make a small but important adjustment to our Firestore data model. When checking if a user is a member of a group, it's much more efficient to check against a simple list of UIDs rather than an array of objects.</p>
<p><strong>Action Required:</strong> Ensure that whenever you create or update a group's members, you also maintain a simple array of UIDs.</p>
<p>Your <code>Group</code> document in Firestore should look like this:</p>
<pre><code class="language-json"><span class="hljs-comment">// /groups/{groupId}</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;groupName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Apartment Roommates&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;ownerId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user_uid_of_creator&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;inviteCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ABC123&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;members&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">&quot;uid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user_uid_of_creator&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;displayName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Alice&quot;</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">&quot;uid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;another_user_uid&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;displayName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Bob&quot;</span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;memberUids&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;user_uid_of_creator&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;another_user_uid&quot;</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// &lt;-- ADD THIS FIELD</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>You'll need to update your <code>createGroup</code> and any &quot;join group&quot; functions to maintain this <code>memberUids</code> array. This is essential for the following rules to work.</p>
<hr>
<h3 id="step-1-write-firestore-security-rules"><strong>Step 1: Write Firestore Security Rules</strong></h3>
<p>These rules define who can read, write, update, and delete documents in your Firestore database.</p>
<ol>
<li>Go to your <strong>Firebase Console</strong>.</li>
<li>In the &quot;Build&quot; menu, click on <strong>Firestore Database</strong>.</li>
<li>Select the <strong>Rules</strong> tab.</li>
<li>Replace the existing content (which is likely in test mode) with the following rules:</li>
</ol>
<pre><code class="language-javascript"><span class="hljs-comment">// firestore.rules</span>

rules_version = <span class="hljs-string">&#x27;2&#x27;</span>;

service cloud.<span class="hljs-property">firestore</span> {
  match /databases/{database}/documents {

    <span class="hljs-comment">// Helper function to check if a user is authenticated</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">isAuthenticated</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">return</span> request.<span class="hljs-property">auth</span> != <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">// Helper function to check if the requesting user&#x27;s UID is in the group&#x27;s `memberUids` array.</span>
    <span class="hljs-comment">// This is why the `memberUids` array in our data model is crucial.</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">isGroupMember</span>(<span class="hljs-params">groupId</span>) {
      <span class="hljs-keyword">return</span> request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> <span class="hljs-keyword">in</span> <span class="hljs-title function_">get</span>(<span class="hljs-regexp">/databases/</span>$(database)/documents/groups/$(groupId)).<span class="hljs-property">data</span>.<span class="hljs-property">memberUids</span>;
    }

    <span class="hljs-comment">// Rules for the &#x27;users&#x27; collection</span>
    match /users/{userId} {
      <span class="hljs-comment">// A user can read, create, and update their own profile document. No one else can.</span>
      allow read, create, <span class="hljs-attr">update</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isAuthenticated</span>() &amp;&amp; request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> == userId;
      <span class="hljs-comment">// Disallow client-side deletion of user profiles for data integrity.</span>
      allow <span class="hljs-attr">delete</span>: <span class="hljs-keyword">if</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// Rules for the &#x27;groups&#x27; collection</span>
    match /groups/{groupId} {
      <span class="hljs-comment">// READ: Allow if the user is a member of the group.</span>
      allow <span class="hljs-attr">read</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isAuthenticated</span>() &amp;&amp; <span class="hljs-title function_">isGroupMember</span>(groupId);

      <span class="hljs-comment">// CREATE: Allow if the user is authenticated, they are the owner, and they are in the member list.</span>
      allow <span class="hljs-attr">create</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isAuthenticated</span>()
                    &amp;&amp; request.<span class="hljs-property">resource</span>.<span class="hljs-property">data</span>.<span class="hljs-property">ownerId</span> == request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span>
                    &amp;&amp; request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> <span class="hljs-keyword">in</span> request.<span class="hljs-property">resource</span>.<span class="hljs-property">data</span>.<span class="hljs-property">memberUids</span>;

      <span class="hljs-comment">// UPDATE: Allow if the user is a member. The app&#x27;s client-side logic will handle</span>
      <span class="hljs-comment">// specific actions like joining with an invite code or changing the group name.</span>
      allow <span class="hljs-attr">update</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isAuthenticated</span>() &amp;&amp; <span class="hljs-title function_">isGroupMember</span>(groupId);

      <span class="hljs-comment">// DELETE: Only the group owner can delete the group.</span>
      allow <span class="hljs-attr">delete</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isAuthenticated</span>() &amp;&amp; resource.<span class="hljs-property">data</span>.<span class="hljs-property">ownerId</span> == request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span>;

      <span class="hljs-comment">// Rules for the &#x27;expenses&#x27; subcollection</span>
      match /expenses/{expenseId} {
        <span class="hljs-comment">// LIST/READ: Allow if the user is a member of the parent group.</span>
        allow list, <span class="hljs-attr">read</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isAuthenticated</span>() &amp;&amp; <span class="hljs-title function_">isGroupMember</span>(groupId);

        <span class="hljs-comment">// CREATE: Allow if the user is a group member and they are the one marked as &#x27;paidBy&#x27;.</span>
        allow <span class="hljs-attr">create</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isAuthenticated</span>()
                      &amp;&amp; <span class="hljs-title function_">isGroupMember</span>(groupId)
                      &amp;&amp; request.<span class="hljs-property">resource</span>.<span class="hljs-property">data</span>.<span class="hljs-property">paidBy</span> == request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span>;

        <span class="hljs-comment">// UPDATE: Allow only if the user is the one who originally paid for the expense.</span>
        allow <span class="hljs-attr">update</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isAuthenticated</span>()
                      &amp;&amp; <span class="hljs-title function_">isGroupMember</span>(groupId)
                      &amp;&amp; resource.<span class="hljs-property">data</span>.<span class="hljs-property">paidBy</span> == request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span>;

        <span class="hljs-comment">// DELETE: Allow if the user paid for the expense OR is the group owner.</span>
        allow <span class="hljs-attr">delete</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isAuthenticated</span>()
                      &amp;&amp; <span class="hljs-title function_">isGroupMember</span>(groupId)
                      &amp;&amp; (resource.<span class="hljs-property">data</span>.<span class="hljs-property">paidBy</span> == request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> || <span class="hljs-title function_">get</span>(<span class="hljs-regexp">/databases/</span>$(database)/documents/groups/$(groupId)).<span class="hljs-property">data</span>.<span class="hljs-property">ownerId</span> == request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span>);
      }
    }
  }
}
</code></pre>
<ol start="5">
<li>Click <strong>Publish</strong>.</li>
</ol>
<h4 id="explanation-of-firestore-rules"><strong>Explanation of Firestore Rules:</strong></h4>
<ul>
<li><strong><code>users</code> collection:</strong> Ensures a user can only ever access and modify their own user document.</li>
<li><strong><code>groups</code> collection:</strong>
<ul>
<li><code>read</code>: You can only get details of a group if you are a member. This prevents users from snooping on groups they don't belong to.</li>
<li><code>create</code>: Enforces that the person creating the group is correctly listed as the owner and a member.</li>
<li><code>delete</code>: Restricts deletion to the group's original creator (<code>ownerId</code>).</li>
</ul>
</li>
<li><strong><code>expenses</code> subcollection:</strong>
<ul>
<li><code>list</code>, <code>read</code>: Leverages the <code>isGroupMember</code> function to ensure only group members can see the expenses within that group.</li>
<li><code>create</code>: A user can only add an expense where they are listed as the payer (<code>paidBy</code>). This prevents a user from creating an expense and saying someone else paid for it.</li>
<li><code>delete</code>: Allows either the person who paid or the group owner to delete an expense, providing flexibility.</li>
</ul>
</li>
</ul>
<hr>
<h3 id="step-2-write-firebase-storage-security-rules"><strong>Step 2: Write Firebase Storage Security Rules</strong></h3>
<p>These rules protect the receipt images that users upload, ensuring they are only accessible to the correct group members.</p>
<ol>
<li>Go to your <strong>Firebase Console</strong>.</li>
<li>In the &quot;Build&quot; menu, click on <strong>Storage</strong>.</li>
<li>Select the <strong>Rules</strong> tab.</li>
<li>Replace the existing content with the following rules. We will enforce a file path structure of <code>receipts/{groupId}/{expenseId}/{fileName}</code>.</li>
</ol>
<pre><code class="language-javascript"><span class="hljs-comment">// storage.rules</span>

rules_version = <span class="hljs-string">&#x27;2&#x27;</span>;

service firebase.<span class="hljs-property">storage</span> {
  match /b/{bucket}/o {

    <span class="hljs-comment">// Helper function to check group membership by reading from Firestore.</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">isGroupMember</span>(<span class="hljs-params">groupId</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">exists</span>(<span class="hljs-regexp">/databases/</span>(<span class="hljs-keyword">default</span>)/documents/groups/$(groupId)) &amp;&amp;
             request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> <span class="hljs-keyword">in</span> <span class="hljs-title function_">get</span>(<span class="hljs-regexp">/databases/</span>(<span class="hljs-keyword">default</span>)/documents/groups/$(groupId)).<span class="hljs-property">data</span>.<span class="hljs-property">memberUids</span>;
    }

    <span class="hljs-comment">// Helper function to check if the user is the owner of the expense or the group.</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">canModifyExpenseAsset</span>(<span class="hljs-params">groupId, expenseId</span>) {
      <span class="hljs-keyword">let</span> expense = <span class="hljs-title function_">get</span>(<span class="hljs-regexp">/databases/</span>(<span class="hljs-keyword">default</span>)/documents/groups/$(groupId)/expenses/$(expenseId)).<span class="hljs-property">data</span>;
      <span class="hljs-keyword">let</span> group = <span class="hljs-title function_">get</span>(<span class="hljs-regexp">/databases/</span>(<span class="hljs-keyword">default</span>)/documents/groups/$(groupId)).<span class="hljs-property">data</span>;
      <span class="hljs-keyword">return</span> request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> == expense.<span class="hljs-property">paidBy</span> || request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> == group.<span class="hljs-property">ownerId</span>;
    }

    <span class="hljs-comment">// Rules for receipt images. Path structure: /receipts/{groupId}/{expenseId}/{anyFileName}</span>
    match /receipts/{groupId}/{expenseId}/{fileName} {

      <span class="hljs-comment">// READ (Download): Allow if the user is authenticated and a member of the group.</span>
      allow <span class="hljs-attr">read</span>: <span class="hljs-keyword">if</span> request.<span class="hljs-property">auth</span> != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-title function_">isGroupMember</span>(groupId);

      <span class="hljs-comment">// CREATE (Upload): Allow if the user is a member and the file is a reasonably sized image.</span>
      allow <span class="hljs-attr">create</span>: <span class="hljs-keyword">if</span> request.<span class="hljs-property">auth</span> != <span class="hljs-literal">null</span>
                     &amp;&amp; <span class="hljs-title function_">isGroupMember</span>(groupId)
                     &amp;&amp; request.<span class="hljs-property">resource</span>.<span class="hljs-property">size</span> &lt; <span class="hljs-number">5</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> <span class="hljs-comment">// Max 5MB</span>
                     &amp;&amp; request.<span class="hljs-property">resource</span>.<span class="hljs-property">contentType</span>.<span class="hljs-title function_">matches</span>(<span class="hljs-string">&#x27;image/.*&#x27;</span>); <span class="hljs-comment">// Only allow images</span>

      <span class="hljs-comment">// UPDATE: Disallow overwriting files for simplicity and security.</span>
      allow <span class="hljs-attr">update</span>: <span class="hljs-keyword">if</span> <span class="hljs-literal">false</span>;

      <span class="hljs-comment">// DELETE: Only allow deletion by the person who paid for the expense or the group owner.</span>
      allow <span class="hljs-attr">delete</span>: <span class="hljs-keyword">if</span> request.<span class="hljs-property">auth</span> != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-title function_">canModifyExpenseAsset</span>(groupId, expenseId);
    }
  }
}
</code></pre>
<ol start="5">
<li>Click <strong>Publish</strong>.</li>
</ol>
<h4 id="explanation-of-storage-rules"><strong>Explanation of Storage Rules:</strong></h4>
<ul>
<li><strong>Cross-Service Communication:</strong> These rules demonstrate a powerful feature of Firebase: they can read your Firestore database (<code>get()</code> and <code>exists()</code>) to make authorization decisions for Storage.</li>
<li><strong>Path-Based Security:</strong> The rules are tied to the file path. By enforcing a structure like <code>/receipts/{groupId}/{expenseId}/...</code>, we can extract the <code>groupId</code> and <code>expenseId</code> to check permissions.</li>
<li><strong>Upload Validation:</strong> We add important server-side checks to ensure users can only upload images (<code>image/.*</code>) and that those images aren't excessively large (max 5MB), protecting your storage costs and server resources.</li>
<li><strong>Scoped Deletion:</strong> The <code>delete</code> rule is very specific. It reads the corresponding expense document in Firestore to ensure only the person who paid (or the group owner) can delete the associated receipt.</li>
</ul>
<hr>
<h3 id="summary-4"><strong>Summary</strong></h3>
<p>You have now implemented a robust security layer for your application. These rules run on the Firebase servers and cannot be bypassed by client-side code, providing a strong guarantee that:</p>
<ul>
<li>User data is private and accessible only by the owner.</li>
<li>Group data (details, expenses, receipts) is confined to its members.</li>
<li>Specific actions like creating or deleting expenses are restricted to authorized users (the payer or group owner).</li>
<li>File uploads are validated for type and size.</li>
</ul>
<p>Your application is now significantly more secure and ready for real-world use.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;security-rules&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Implement Firebase Security Rules&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Firebase Security Rules&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="vercel-cicd-specialist">Vercel, CI/CD Specialist</h3>
<p>With our application's logic complete and its backend secured with robust Firebase rules, the final step is to deploy it to the web for everyone to use. We will use <strong>Vercel</strong>, the platform created by the makers of Next.js, which offers a seamless and powerful deployment experience.</p>
<h3 id="why-vercel"><strong>Why Vercel?</strong></h3>
<ul>
<li><strong>Optimized for Next.js:</strong> Vercel is designed to host Next.js apps, providing the best performance, including serverless functions, edge caching, and automatic code splitting.</li>
<li><strong>Continuous Deployment (CI/CD):</strong> Once set up, every <code>git push</code> to your main branch will automatically trigger a new deployment, keeping your live app in sync with your code.</li>
<li><strong>Free Tier:</strong> Vercel offers a generous free &quot;Hobby&quot; plan that is perfect for personal projects and MVPs.</li>
<li><strong>Global CDN:</strong> Your application is automatically distributed across a global network, ensuring fast load times for users anywhere in the world.</li>
</ul>
<hr>
<h3 id="step-1-prepare-your-project-for-deployment"><strong>Step 1: Prepare Your Project for Deployment</strong></h3>
<p>Before deploying, we need to ensure our project is set up correctly.</p>
<h4 id="11-create-a-git-repository"><strong>1.1. Create a Git Repository</strong></h4>
<p>Vercel deploys directly from a Git repository. If your code isn't already in one, now is the time.</p>
<ol>
<li>
<p><strong>Initialize Git:</strong> If you haven't already, run this in your project's root directory:</p>
<pre><code class="language-bash">git init
</code></pre>
</li>
<li>
<p><strong>Create a <code>.gitignore</code> file:</strong> This file tells Git which files to ignore. It's crucial for security and efficiency. Create a file named <code>.gitignore</code> in your project root and add the following:</p>
<pre><code># Dependencies
/node_modules

# Local Environment Variables
.env.local

# Next.js build output
/.next/
/out/

# Production log
/npm-debug.log*
/yarn-debug.log*
/yarn-error.log*

# Editor directories and files
.vscode
.idea
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</code></pre>
<p><strong>Crucially, ensure <code>.env.local</code> is in this file. You must never commit your secret keys to a public repository.</strong></p>
</li>
<li>
<p><strong>Push to GitHub/GitLab/Bitbucket:</strong></p>
<ul>
<li>Create a new repository on your preferred platform (e.g., GitHub).</li>
<li>Follow the instructions provided by the platform to connect your local repository and push your code. The commands will look something like this:<pre><code class="language-bash">git add .
git commit -m <span class="hljs-string">&quot;Initial commit for deployment&quot;</span>
git branch -M main
git remote add origin &lt;your-repository-url.git&gt;
git push -u origin main
</code></pre>
</li>
</ul>
</li>
</ol>
<h4 id="12-verify-environment-variables"><strong>1.2. Verify Environment Variables</strong></h4>
<p>Your application relies on environment variables to connect to Firebase. Locally, you have them in <code>.env.local</code>. For production on Vercel, we will configure them in the Vercel dashboard.</p>
<p>Make sure you have all the necessary keys from your Firebase project settings ready:</p>
<ul>
<li><code>NEXT_PUBLIC_FIREBASE_API_KEY</code></li>
<li><code>NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN</code></li>
<li><code>NEXT_PUBLIC_FIREBASE_PROJECT_ID</code></li>
<li><code>NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET</code></li>
<li><code>NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID</code></li>
<li><code>NEXT_PUBLIC_FIREBASE_APP_ID</code></li>
</ul>
<hr>
<h3 id="step-2-deploying-with-vercel"><strong>Step 2: Deploying with Vercel</strong></h3>
<p>Now for the exciting part!</p>
<ol>
<li>
<p><strong>Sign Up for Vercel:</strong> Go to <a href="https://vercel.com/">vercel.com</a> and sign up. The easiest way is to <strong>Continue with GitHub</strong> (or your chosen Git provider). This grants Vercel access to your repositories.</p>
</li>
<li>
<p><strong>Import Your Project:</strong></p>
<ul>
<li>From your Vercel dashboard, click <strong>&quot;Add New...&quot;</strong> and select <strong>&quot;Project&quot;</strong>.</li>
<li>Vercel will display a list of your Git repositories. Find your expense-splitter app repository and click the <strong>&quot;Import&quot;</strong> button next to it.</li>
</ul>
</li>
<li>
<p><strong>Configure Your Project:</strong></p>
<ul>
<li>Vercel will automatically detect that you're using Next.js and pre-fill the <strong>Framework Preset</strong> and <strong>Build and Output Settings</strong>. You do not need to change these.</li>
<li>Expand the <strong>Environment Variables</strong> section. This is the most important step.</li>
<li>Carefully copy each key-value pair from your local <code>.env.local</code> file into the Vercel UI. For each variable:
<ul>
<li>Enter the name (e.g., <code>NEXT_PUBLIC_FIREBASE_API_KEY</code>).</li>
<li>Enter the value (e.g., <code>AIzaSy...</code>).</li>
<li>Click <strong>&quot;Add&quot;</strong>.</li>
</ul>
</li>
<li>Repeat this for all your Firebase environment variables. The <code>NEXT_PUBLIC_</code> prefix is essential for Next.js to expose these variables to the browser.</li>
</ul>
</li>
<li>
<p><strong>Deploy!</strong></p>
<ul>
<li>Once all variables are added, click the <strong>&quot;Deploy&quot;</strong> button.</li>
<li>Vercel will now begin the deployment process. It will:
<ol>
<li>Clone your repository.</li>
<li>Install all dependencies (<code>npm install</code>).</li>
<li>Run the build command (<code>next build</code>).</li>
<li>Deploy the static assets, serverless functions, and edge configuration.</li>
</ol>
</li>
<li>You can watch the build logs in real-time.</li>
</ul>
</li>
</ol>
<hr>
<h3 id="step-3-celebrate-and-verify"><strong>Step 3: Celebrate and Verify</strong></h3>
<p>If all goes well, you'll be greeted with a &quot;Congratulations!&quot; screen and some celebratory confetti!</p>
<ul>
<li><strong>Visit Your Live App:</strong> Vercel provides you with a public URL (e.g., <code>your-project-name.vercel.app</code>). Click the screenshot or the &quot;Visit&quot; button to see your application live on the internet.</li>
<li><strong>Thoroughly Test:</strong> Perform all the key user actions to ensure everything works in the production environment:
<ul>
<li>Sign up for a new account.</li>
<li>Log out and log back in.</li>
<li>Create a new group.</li>
<li>Invite another user (you can use a different browser or incognito mode to test this).</li>
<li>Add an expense with a receipt upload.</li>
<li>Verify that the receipt image loads correctly.</li>
<li>Check the &quot;Who Owes Who&quot; calculations.</li>
</ul>
</li>
</ul>
<h3 id="automatic-deployments-and-custom-domains"><strong>Automatic Deployments and Custom Domains</strong></h3>
<p>You are now set up with a professional-grade deployment workflow.</p>
<ul>
<li><strong>Automatic Deployments:</strong> From now on, every time you <code>git push</code> to your <code>main</code> branch, Vercel will automatically build and deploy the changes, updating your live application. No manual steps are needed!</li>
<li><strong>Preview Deployments:</strong> If you create a new branch and open a Pull Request on GitHub, Vercel will automatically create a unique &quot;preview&quot; deployment for that PR. This allows you to test changes in a production-like environment before merging them into the main branch.</li>
<li><strong>(Optional) Custom Domain:</strong> To make your app look more professional, you can add a custom domain. In your Vercel project's <strong>Settings</strong> tab, go to <strong>Domains</strong>. Enter the domain you own, and Vercel will provide you with the DNS records you need to configure with your domain registrar (e.g., GoDaddy, Namecheap). Vercel will also automatically provision and renew a free SSL certificate for your domain.</li>
</ul>
<p>Congratulations! You have successfully built and deployed a full-stack, secure, and scalable personal finance application using Next.js, Firebase, and Vercel.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;deployment&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Deploy the Application to Vercel&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Vercel, CI/CD&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="results-integrator">Results Integrator</h3>
<p>Of course. Let's build out the Expense Splitter App. This is an excellent project that combines user authentication, database management, file storage, and core business logic, making it a perfect showcase for Next.js and Firebase.</p>
<p>Here is a comprehensive, step-by-step guide to building the application from project initialization to final deployment.</p>
<h3 id="executive-summary-1"><strong>Executive Summary</strong></h3>
<p>We will construct a full-stack Expense Splitter web application using the Next.js App Router for the frontend and Firebase for the backend. The application will allow users to register, create groups, invite members, add shared expenses with optional receipt uploads, and automatically view a simplified breakdown of who owes whom. The project is broken down into four key phases:</p>
<ol>
<li><strong>Foundation &amp; Setup:</strong> Initializing the Next.js project, configuring Firebase services (Auth, Firestore, Storage), and designing the database schema.</li>
<li><strong>Core Functionality:</strong> Implementing user authentication, creating protected routes, and building the features for creating, viewing, and managing groups.</li>
<li><strong>Expense &amp; Calculation Logic:</strong> Developing the systems for adding expenses, uploading receipts, and implementing the core algorithm to calculate and display group balances.</li>
<li><strong>Polishing &amp; Deployment:</strong> Applying a professional UI/UX design, securing the backend with robust rules, and deploying the final application to the web using Vercel.</li>
</ol>
<hr>
<h3 id="phase-1-project-foundation-and-data-modeling-1"><strong>Phase 1: Project Foundation and Data Modeling</strong></h3>
<p>First, we'll set up our development environment and design the database structure that will power the entire application.</p>
<h4 id="1-project-initialization-nextjs-1"><strong>1. Project Initialization (Next.js)</strong></h4>
<p>Begin by creating a new Next.js project with the recommended modern stack.</p>
<ol>
<li><strong>Create the App:</strong> Open your terminal and run:<pre><code class="language-bash">npx create-next-app@latest expense-splitter
</code></pre>
</li>
<li><strong>Select Options:</strong> Use the following settings for a robust setup:
<ul>
<li>TypeScript: <strong>Yes</strong></li>
<li>ESLint: <strong>Yes</strong></li>
<li>Tailwind CSS: <strong>Yes</strong></li>
<li><code>src/</code> directory: <strong>Yes</strong></li>
<li>App Router: <strong>Yes</strong></li>
<li>Customize import alias: <strong>No</strong></li>
</ul>
</li>
<li><strong>Navigate and Install Firebase:</strong><pre><code class="language-bash"><span class="hljs-built_in">cd</span> expense-splitter
npm install firebase
</code></pre>
</li>
</ol>
<h4 id="2-firebase-backend-configuration-1"><strong>2. Firebase Backend Configuration</strong></h4>
<p>Next, set up the necessary Firebase services.</p>
<ol>
<li><strong>Create a Firebase Project:</strong> Go to the <a href="https://console.firebase.google.com/">Firebase Console</a>, click &quot;Add project,&quot; and follow the setup wizard.</li>
<li><strong>Enable Services:</strong>
<ul>
<li><strong>Firestore Database:</strong> From the &quot;Build&quot; menu, create a Firestore database. Start in <strong>Test mode</strong> for now; we will secure it later.</li>
<li><strong>Authentication:</strong> Go to the Authentication service and enable the <strong>Email/Password</strong> and <strong>Google</strong> sign-in providers.</li>
<li><strong>Storage:</strong> Go to the Storage service and create a storage bucket, also starting in <strong>Test mode</strong>.</li>
</ul>
</li>
<li><strong>Connect App to Firebase:</strong>
<ul>
<li>In your Firebase project settings, register a new <strong>Web app (<code>&lt;/&gt;</code>)</strong>.</li>
<li>Firebase will provide a <code>firebaseConfig</code> object. Copy these credentials.</li>
</ul>
</li>
<li><strong>Set Up Environment Variables:</strong>
<ul>
<li>In your project root, create a file named <code>.env.local</code>.</li>
<li>Add your Firebase credentials, prefixed with <code>NEXT_PUBLIC_</code>:<pre><code class="language-.env.local">NEXT_PUBLIC_FIREBASE_API_KEY=&quot;AIzaSy...&quot;
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=&quot;your-project-id.firebaseapp.com&quot;
NEXT_PUBLIC_FIREBASE_PROJECT_ID=&quot;your-project-id&quot;
// ...and so on for all keys.
</code></pre>
</li>
</ul>
</li>
<li><strong>Create Firebase Initializer:</strong> Centralize your Firebase configuration. Create <code>src/lib/firebase/config.ts</code>:<pre><code class="language-typescript"><span class="hljs-comment">// src/lib/firebase/config.ts</span>
<span class="hljs-keyword">import</span> { initializeApp, getApps, getApp } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/app&quot;</span>;
<span class="hljs-keyword">import</span> { getAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/auth&quot;</span>;
<span class="hljs-keyword">import</span> { getFirestore } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;
<span class="hljs-keyword">import</span> { getStorage } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/storage&quot;</span>;

<span class="hljs-keyword">const</span> firebaseConfig = {
  <span class="hljs-attr">apiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_API_KEY</span>,
  <span class="hljs-attr">authDomain</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN</span>,
  <span class="hljs-attr">projectId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_PROJECT_ID</span>,
  <span class="hljs-attr">storageBucket</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET</span>,
  <span class="hljs-attr">messagingSenderId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID</span>,
  <span class="hljs-attr">appId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_FIREBASE_APP_ID</span>,
};

<span class="hljs-keyword">const</span> app = !<span class="hljs-title function_">getApps</span>().<span class="hljs-property">length</span> ? <span class="hljs-title function_">initializeApp</span>(firebaseConfig) : <span class="hljs-title function_">getApp</span>();
<span class="hljs-keyword">const</span> db = <span class="hljs-title function_">getFirestore</span>(app);
<span class="hljs-keyword">const</span> auth = <span class="hljs-title function_">getAuth</span>(app);
<span class="hljs-keyword">const</span> storage = <span class="hljs-title function_">getStorage</span>(app);

<span class="hljs-keyword">export</span> { app, db, auth, storage };
</code></pre>
</li>
</ol>
<h4 id="3-firestore-schema-design-1"><strong>3. Firestore Schema Design</strong></h4>
<p>A well-planned schema is essential for performance and scalability. We'll use three top-level collections.</p>
<ul>
<li>
<p><strong><code>users</code> Collection:</strong> Stores individual user profiles. The Document ID will be the user's UID from Firebase Auth.</p>
<ul>
<li>Path: <code>/users/{userId}</code></li>
<li>Fields: <code>uid</code>, <code>email</code>, <code>displayName</code>, <code>photoURL</code>, <code>createdAt</code>, <code>groups</code> (Array of group IDs).</li>
</ul>
</li>
<li>
<p><strong><code>groups</code> Collection:</strong> Stores information about each expense-sharing group.</p>
<ul>
<li>Path: <code>/groups/{groupId}</code></li>
<li>Fields: <code>groupName</code>, <code>createdBy</code> (user UID), <code>createdAt</code>, <code>inviteCode</code>, <code>members</code> (Array of member objects with <code>uid</code>, <code>displayName</code>, <code>photoURL</code>), and <code>memberUids</code> (a simple Array of member UIDs for efficient security rule checks).</li>
</ul>
</li>
<li>
<p><strong><code>expenses</code> Subcollection:</strong> Each group document will contain a subcollection of its expenses. This is a highly efficient way to query for all expenses related to a single group.</p>
<ul>
<li>Path: <code>/groups/{groupId}/expenses/{expenseId}</code></li>
<li>Fields: <code>description</code>, <code>amount</code> (in cents), <code>createdAt</code>, <code>paidBy</code> (user UID), <code>paidByDisplayName</code>, <code>receiptUrl</code> (optional), <code>splitMethod</code>, and <code>participants</code> (Array of objects detailing who owes what, e.g., <code>{ uid, amountOwed }</code>).</li>
</ul>
</li>
</ul>
<p><strong>Note on Balances:</strong> We will not store running balances in the database. Instead, balances will be calculated dynamically on the client side by fetching all expenses for a group. This approach is more robust and less prone to data synchronization errors.</p>
<hr>
<h3 id="phase-2-user-authentication-and-group-management-1"><strong>Phase 2: User Authentication and Group Management</strong></h3>
<p>With the foundation laid, we'll build the app's core interactive features.</p>
<h4 id="1-global-authentication-state-1"><strong>1. Global Authentication State</strong></h4>
<p>We'll use React Context to manage the user's authentication state across the entire application. This context will also handle the crucial task of creating a user document in Firestore the first time a user signs in.</p>
<ul>
<li>Create <code>src/context/AuthContext.tsx</code>. This provider will:
<ul>
<li>Use Firebase's <code>onAuthStateChanged</code> listener to track the current user.</li>
<li>When a user logs in, it will check if a corresponding document exists in <code>/users/{uid}</code>. If not, it creates one.</li>
<li>Provide the <code>user</code> object, a <code>loading</code> state, and a <code>logout</code> function to all child components.</li>
</ul>
</li>
<li>Wrap the application's root layout (<code>src/app/layout.tsx</code>) with this <code>AuthProvider</code> to make it globally accessible.</li>
</ul>
<h4 id="2-authentication-pages-and-protected-routes-1"><strong>2. Authentication Pages and Protected Routes</strong></h4>
<p>Users need a way to sign in, sign up, and be restricted from accessing content they aren't authorized to see.</p>
<ol>
<li><strong>Create Auth Pages:</strong> Build the UI for <code>/login</code> and <code>/signup</code> pages using simple forms. These forms will use the Firebase SDK functions (<code>signInWithEmailAndPassword</code>, <code>createUserWithEmailAndPassword</code>, <code>signInWithPopup</code> for Google) to handle authentication.</li>
<li><strong>Implement Protected Routes:</strong> Create a <code>ProtectedRoute</code> component (<code>src/components/ProtectedRoute.tsx</code>). This component will:
<ul>
<li>Use the <code>useAuth</code> hook to access the current user and loading state.</li>
<li>If <code>loading</code> is true, it can show a spinner.</li>
<li>If <code>loading</code> is false and no <code>user</code> exists, it will redirect to the <code>/login</code> page using Next.js's <code>useRouter</code>.</li>
<li>Wrap any page that requires authentication (like the dashboard) with this <code>ProtectedRoute</code> component.</li>
</ul>
</li>
</ol>
<h4 id="3-group-management-features-1"><strong>3. Group Management Features</strong></h4>
<p>Once authenticated, users should be able to create and view their groups.</p>
<ol>
<li><strong>Firestore Service Functions:</strong> Create a file <code>src/lib/firebase/firestore.ts</code> to house all database interactions.
<ul>
<li><code>createGroup(groupName, user)</code>: Creates a new document in the <code>groups</code> collection, populates it with the creator's info, generates a unique invite code (using a library like <code>nanoid</code>), and adds the new group's ID to the creator's document in the <code>users</code> collection.</li>
<li><code>getUserGroups(userId)</code>: Fetches the user's document, retrieves their list of group IDs, and then queries the <code>groups</code> collection to get the full details for each group.</li>
</ul>
</li>
<li><strong>UI Components:</strong>
<ul>
<li><strong>CreateGroupModal:</strong> A modal form that takes a group name and calls the <code>createGroup</code> service function on submission.</li>
<li><strong>GroupList:</strong> A component that calls <code>getUserGroups</code> and maps over the results to display a list of <code>GroupCard</code> components. Each card shows the group's name, number of members, and the invite code.</li>
</ul>
</li>
<li><strong>Dashboard Page:</strong> Update the <code>/dashboard</code> page to be the main hub. It will display a &quot;Create Group&quot; button that opens the modal and will render the <code>GroupList</code> component.</li>
</ol>
<hr>
<h3 id="phase-3-expense-tracking-and-debt-calculation-1"><strong>Phase 3: Expense Tracking and Debt Calculation</strong></h3>
<p>This is the core &quot;splitter&quot; functionality of the application.</p>
<h4 id="1-expense-creation-and-receipt-uploads-1"><strong>1. Expense Creation and Receipt Uploads</strong></h4>
<p>We'll build a dedicated page for each group where users can add and view expenses.</p>
<ol>
<li><strong>Create Dynamic Group Page:</strong> Create a dynamic route at <code>src/app/group/[groupId]/page.tsx</code>. This page will be the central view for a single group.</li>
<li><strong>Extend Firestore Service:</strong> Add functions to <code>firestore.ts</code>:
<ul>
<li><code>getGroupDetails(groupId)</code>: Fetches a single group's document.</li>
<li><code>addExpenseToGroup(expenseData)</code>: Creates a new document in the <code>/groups/{groupId}/expenses</code> subcollection.</li>
<li><code>getGroupExpenses(groupId)</code>: Fetches all documents from a group's <code>expenses</code> subcollection.</li>
</ul>
</li>
<li><strong>Implement Receipt Uploads:</strong>
<ul>
<li>Create a storage service file, <code>src/lib/firebase/storage.ts</code>.</li>
<li>Implement an <code>uploadReceipt(file, groupId)</code> function that uses Firebase Storage to upload an image to a path like <code>receipts/{groupId}/{unique_file_name}</code> and returns the public download URL. Use <code>uuid</code> to generate unique file names.</li>
</ul>
</li>
<li><strong>Build UI Components:</strong>
<ul>
<li><strong>AddExpenseModal:</strong> A comprehensive modal form with fields for description, amount, who paid (a dropdown of group members), and an optional file input for the receipt. On submit, it will first upload the receipt (if present) to get the URL, then call <code>addExpenseToGroup</code> with all the data.</li>
<li><strong>ExpenseList:</strong> A component that displays a list of expenses for the group. Each item shows the description, amount, payer, and a link to &quot;View Receipt&quot; if a <code>receiptUrl</code> exists.</li>
</ul>
</li>
</ol>
<h4 id="2-debt-calculation-logic-1"><strong>2. Debt Calculation Logic</strong></h4>
<p>The &quot;magic&quot; happens here. We'll write a pure function to process expenses and determine who owes whom.</p>
<ol>
<li><strong>Create Calculation Utility:</strong> Create a file <code>src/utils/debtCalculator.ts</code>.</li>
<li><strong>Implement <code>calculateBalances</code> Function:</strong> This function will accept two arguments: an array of <code>expenses</code> and an array of group <code>members</code>.
<ul>
<li><strong>Step 1: Tally Balances:</strong> It iterates through all expenses. For each expense, it credits the <code>paidBy</code> user with the full amount and debits each <code>participant</code> by their <code>amountOwed</code>. This results in a map of each user's net balance (positive means they are owed money, negative means they owe money).</li>
<li><strong>Step 2: Simplify Debts:</strong> It implements a greedy algorithm to simplify the list of debts. It separates users into debtors (negative balance) and creditors (positive balance) and creates the minimum number of transactions required to settle all balances. For example, if A owes B $10 and B owes C $10, the algorithm simplifies this to A pays C $10.</li>
</ul>
</li>
<li><strong>Create Balance Summary UI:</strong> Build a <code>BalanceSummary</code> component that takes the simplified debt list and displays it in a clear, human-readable format (e.g., &quot;Alice owes Bob $15.50&quot;).</li>
</ol>
<h4 id="3-integrate-on-group-page-1"><strong>3. Integrate on Group Page</strong></h4>
<p>Update the dynamic group page (<code>/group/[groupId]/page.tsx</code>) to tie everything together.</p>
<ul>
<li>On page load, it will fetch both the group details and all its expenses in parallel.</li>
<li>It will then pass this data to the <code>calculateBalances</code> function.</li>
<li>Finally, it will render the <code>BalanceSummary</code> component with the calculated debts at the top of the page, followed by the full <code>ExpenseList</code>.</li>
</ul>
<hr>
<h3 id="phase-4-uiux-security-and-deployment-1"><strong>Phase 4: UI/UX, Security, and Deployment</strong></h3>
<p>The final phase focuses on making the app professional, secure, and publicly accessible.</p>
<h4 id="1-uiux-design-and-styling-1"><strong>1. UI/UX Design and Styling</strong></h4>
<p>We'll use Tailwind CSS to create a consistent, modern, and responsive design.</p>
<ol>
<li><strong>Establish a Design System:</strong> Extend the <code>tailwind.config.ts</code> file with a custom color palette (e.g., <code>brand.primary</code>, <code>success</code>, <code>danger</code>). Refine base styles in <code>globals.css</code> for buttons, inputs, and cards.</li>
<li><strong>Create a Reusable Layout:</strong> Build a <code>MainLayout</code> component that includes a consistent header with the app logo, user information, and a logout button. Use this layout on all authenticated pages.</li>
<li><strong>Refine Components:</strong> Systematically style all components—modals, cards, forms, and lists—using the defined color palette and utility classes. Add hover effects, transitions, and icons (e.g., from <code>heroicons</code>) to improve user experience.</li>
</ol>
<h4 id="2-firebase-security-rules-1"><strong>2. Firebase Security Rules</strong></h4>
<p>This is a critical, non-negotiable step before deployment to protect user data.</p>
<ol>
<li><strong>Firestore Rules:</strong> In the Firebase console, go to Firestore &gt; Rules. Replace the test rules with production rules that enforce:
<ul>
<li><strong>Users:</strong> A user can only read and write their own document (<code>/users/{userId}</code>).</li>
<li><strong>Groups:</strong> A user can only read/write group data if their UID is present in the group's <code>memberUids</code> array.</li>
<li><strong>Expenses:</strong> A user can only create an expense if they are a member of the group and are listed as the payer.</li>
</ul>
</li>
<li><strong>Storage Rules:</strong> Go to Storage &gt; Rules. Implement rules that:
<ul>
<li>Allow image uploads only for authenticated users who are members of the corresponding group.</li>
<li>Validate uploads to ensure they are images and within a reasonable size limit (e.g., &lt; 5MB).</li>
<li>Allow reads (downloads) only for members of the group.</li>
</ul>
</li>
</ol>
<h4 id="3-deployment-to-vercel-1"><strong>3. Deployment to Vercel</strong></h4>
<p>Finally, we'll deploy the application to the web.</p>
<ol>
<li><strong>Prepare for Deployment:</strong>
<ul>
<li>Initialize a Git repository and push your project to a provider like GitHub.</li>
<li>Ensure your <code>.gitignore</code> file includes <code>.env.local</code> to prevent committing secret keys.</li>
</ul>
</li>
<li><strong>Import to Vercel:</strong>
<ul>
<li>Sign up for Vercel using your GitHub account.</li>
<li>Import your project repository from the Vercel dashboard.</li>
</ul>
</li>
<li><strong>Configure Environment Variables:</strong> In the Vercel project settings, navigate to &quot;Environment Variables.&quot; Copy every key-value pair from your local <code>.env.local</code> file into Vercel's UI. This securely provides your production deployment with the Firebase credentials.</li>
<li><strong>Deploy:</strong> Click the &quot;Deploy&quot; button. Vercel will automatically build and deploy your application, providing you with a public URL (e.g., <code>expense-splitter.vercel.app</code>).</li>
</ol>
<p>Congratulations! You have now successfully designed, built, secured, and deployed a feature-rich Expense Splitter application. With Vercel's CI/CD, every future <code>git push</code> to your main branch will automatically trigger a new deployment, keeping your live application up-to-date.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span>
<span class="hljs-punctuation">}</span>
</code></pre>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>