# Agent Response - orchestrator_workers

**Session ID**: 3975daa0-c467-41f6-8666-a8c3b3770c59
**Processing Time**: 91.25 seconds

## Final Response

This is an excellent and well-structured business plan for HOMEase | AI, with a clear strategic pivot to a lead-generation-focused model. Leveraging AR for high-quality, pre-validated leads in the aging-in-place sector is a compelling differentiator.

Below is a comprehensive technical plan for your Python FastAPI backend and Next.js App Router frontend, designed to support the phased growth outlined in your business plan and prioritize the "Immediate Go-to-Market Improvement" features.

---

## HOMEase | AI: Technical Architecture Plan (FastAPI & Next.js App Router)

### **I. Core Principles & Architecture Goals**

Our technical architecture is designed to be robust, scalable, secure, and user-centric, aligning directly with the HOMEase | AI business objectives:

1.  **API-First Approach:** The FastAPI backend will operate as a completely decoupled API layer, serving data to various clients (Next.js web app, potential future native mobile app).
2.  **Scalability:** The system will be built to handle a rapidly increasing number of users, AR assessments, and leads, anticipating the aggressive growth projections.
3.  **Security & Compliance:** Robust authentication, authorization, data encryption, and adherence to privacy regulations (CCPA, HIPAA-lite principles for sensitive health-related data) are paramount.
4.  **User Experience (UX) Focus:** The frontend will be meticulously designed for intuitive use, especially for older adults and their caregivers, addressing the stated challenge that "technology is not designed with their age group in mind."
5.  **Modularity:** Breaking down the application into manageable services and modules will facilitate easier development, testing, and future feature expansion.
6.  **Observability:** Comprehensive logging, monitoring, and tracing will be implemented for effective troubleshooting, performance analysis, and proactive issue detection.

### **II. Technology Stack Overview**

*   **Backend (FastAPI):**
    *   **Language:** Python 3.10+
    *   **Framework:** FastAPI (for high performance, async support, and automatic OpenAPI documentation)
    *   **Database:** PostgreSQL (Robust, ACID-compliant, excellent for relational data and JSONB for flexible schema needs)
    *   **ORM:** SQLAlchemy 2.0 (with async support for database interactions)
    *   **Asynchronous Tasks:** Celery with Redis (for background processing, e.g., complex AR data analysis, lead matching, notifications, email sending)
    *   **Authentication:** JWT (JSON Web Tokens) for secure API access.
    *   **Validation:** Pydantic (natively integrated with FastAPI for data validation and serialization)
    *   **Dependency Management:** Poetry or PDM (for consistent project environments)
    *   **Containerization:** Docker (for consistent development and deployment environments)
    *   **ASGI Server:** Uvicorn (for serving the FastAPI application in production)
*   **Frontend (Next.js App Router):**
    *   **Framework:** Next.js (utilizing the App Router for modern React features, server components, and optimized routing)
    *   **Language:** TypeScript (for type safety and improved developer experience)
    *   **Styling:** Tailwind CSS (for rapid, utility-first styling and responsive design)
    *   **Data Fetching:** React Query (TanStack Query) or SWR (for efficient data fetching, caching, and revalidation, enhancing perceived performance)
    *   **State Management:** React Context API + `useState`/`useReducer` (for local component state); potentially Zustand or Jotai for more global, lightweight needs.
    *   **AR Implementation:**
        *   **Primary (Recommended for optimal performance & LiDAR):** A dedicated native mobile application (e.g., built with React Native/Expo, leveraging ARKit for iOS and ARCore for Android). This separate app would handle the detailed LiDAR scanning, 3D reconstruction, and initial feature detection, sending processed data to the FastAPI backend.
        *   **Fallback/Web-based AR (for basic visualization):** WebXR API with libraries like `three.js` or `A-Frame` for basic augmented reality experiences directly in the browser. *Note: Direct LiDAR access for precise measurements is limited or unavailable via WebXR, making a native app superior for the core AR assessment.*
    *   **Real-time Communication:** Socket.IO client (connecting to FastAPI backend using `python-socketio`) for in-app messaging and notifications.
*   **Deployment & Infrastructure:**
    *   **Backend:** AWS ECS/EC2, Google Cloud Run/App Engine, or Render (container-based deployments for scalability and ease of management).
    *   **Frontend:** Vercel (highly optimized for Next.js deployments, providing global CDN and serverless functions).
    *   **Database:** AWS RDS (PostgreSQL), Google Cloud SQL (PostgreSQL), or DigitalOcean Managed Databases (for managed, scalable database solutions).
    *   **CI/CD:** GitHub Actions or GitLab CI/CD (for automated testing, building, and deployment pipelines).

### **III. Detailed Backend (FastAPI) Plan**

The backend will be designed with modularity, using FastAPI's APIRouter for logical separation of concerns.

**1. API Endpoints (by Module):**

*   **`auth` Module:**
    *   `POST /register/homeowner`: User registration for homeowners.
    *   `POST /register/contractor`: Initial registration for contractors.
    *   `POST /login`: User authentication, returning JWT access and refresh tokens.
    *   `POST /token/refresh`: Endpoint to refresh expired JWTs.
    *   `POST /forgot-password`, `POST /reset-password`: Standard password recovery flows.
*   **`users` Module (Shared User Management):**
    *   `GET /users/me`: Retrieve current authenticated user's profile.
    *   `PUT /users/me`: Update current user's profile.
    *   `PUT /users/me/password`: Change user's password.
*   **`homeowners` Module:**
    *   `GET /homeowners/{id}`: Retrieve a specific homeowner's profile (admin/self access).
    *   `PUT /homeowners/{id}`: Update homeowner profile (admin/self access).
*   **`contractors` Module:**
    *   `GET /contractors/{id}`: Retrieve contractor profile (public/admin/self access).
    *   `PUT /contractors/{id}`: Update contractor profile (self access).
    *   `POST /contractors/{id}/apply`: Submit detailed contractor application (licenses, insurance, etc.).
    *   `GET /contractors/pending`: Admin endpoint to list pending contractor applications.
    *   `PUT /contractors/{id}/approve`: Admin endpoint to approve/decline contractors.
    *   `GET /contractors/search`: Internal endpoint for lead matching service to search/filter approved contractors.
*   **`ar_assessments` Module (Core for Lead Generation):**
    *   `POST /ar-assessments`: Submit new AR assessment data.
        *   **Input:** JSON payload including `homeowner_id`, `raw_ar_data` (e.g., structured point cloud data, semantic segmentation results, identified objects like doors, windows, counters), `measurements` (detected dimensions like doorway width, ramp slope), `identified_issues` (e.g., "narrow doorway", "no grab bars"), `suggested_modifications` (initial AI/AR-driven recommendations).
        *   **Output:** `ar_assessment_id`, confirmation.
    *   `GET /ar-assessments/{id}`: Retrieve a specific AR assessment.
    *   `GET /homeowners/{homeowner_id}/ar-assessments`: Get all assessments for a given homeowner.
*   **`leads` Module:**
    *   `POST /leads`: Create a new lead based on an AR assessment.
        *   **Input:** `ar_assessment_id`, `homeowner_id`, `urgency`, `budget_range`, `additional_notes`.
        *   **Action:** Triggers an asynchronous lead matching process (Celery task).
    *   `GET /leads/{id}`: Retrieve lead details (homeowner/matched contractor/admin access).
    *   `GET /leads/homeowner/{homeowner_id}`: Get leads initiated by a specific homeowner.
    *   `GET /leads/contractor/{contractor_id}/available`: Get available leads for a contractor (based on matching results).
    *   `POST /leads/{id}/accept`: Contractor accepts a lead (marks it as taken, initiates payment process).
    *   `POST /leads/{id}/decline`: Contractor declines a lead (triggers re-matching if necessary).
    *   `GET /leads/contractor/{contractor_id}/accepted`: Get leads previously accepted by a contractor.
    *   `PUT /leads/{id}/status`: Update lead status (e.g., "in progress", "completed").
*   **`messaging` Module:**
    *   `GET /messages/{lead_id}`: Retrieve message history for a specific lead.
    *   `POST /messages/{lead_id}`: Send a new message.
    *   Dedicated WebSocket endpoint for real-time chat.
*   **`reviews` Module:**
    *   `POST /reviews`: Submit a review for a contractor after project completion.
    *   `GET /contractors/{id}/reviews`: Retrieve reviews for a specific contractor.
*   **`payments` Module:**
    *   `POST /payments/webhook`: Endpoint for receiving payment gateway notifications (e.g., Stripe webhooks).
    *   `GET /contractors/{id}/billing`: Retrieve contractor's billing history.
*   **`admin` Module (Internal API):**
    *   `GET /admin/analytics/leads`: Lead generation performance analytics.
    *   `GET /admin/analytics/contractors`: Contractor performance analytics.
    *   `PUT /admin/users/{id}/role`: Manage user roles.

**2. Database Schema (PostgreSQL):**

*   **`users`:** `id` (PK), `email` (unique), `password_hash`, `role` (enum: 'homeowner', 'contractor', 'admin'), `created_at`, `updated_at`.
*   **`homeowners`:** `id` (PK), `user_id` (FK to users), `first_name`, `last_name`, `phone`, `address`, `city`, `state`, `zip_code`, `preferences` (JSONB for flexible storage).
*   **`contractors`:** `id` (PK), `user_id` (FK to users), `company_name`, `contact_person`, `phone`, `email`, `website`, `service_areas` (ARRAY of strings or JSONB), `specializations` (ARRAY of strings), `licenses` (JSONB), `insurance_info` (JSONB), `background_check_status` (enum), `caps_certified` (boolean), `approval_status` (enum: 'pending', 'approved', 'rejected'), `average_rating`, `total_reviews`, `created_at`, `updated_at`.
*   **`ar_assessments`:** `id` (PK), `homeowner_id` (FK to homeowners), `raw_ar_data` (JSONB for metadata, or S3/Cloud Storage path for large files), `measurements` (JSONB), `identified_issues` (JSONB), `suggested_modifications` (JSONB), `created_at`.
*   **`leads`:** `id` (PK), `homeowner_id` (FK to homeowners), `ar_assessment_id` (FK to ar_assessments), `status` (enum: 'new', 'matched', 'accepted', 'in_progress', 'completed', 'declined'), `urgency` (enum: 'low', 'medium', 'high'), `budget_range` (string or enum), `additional_notes`, `created_at`, `updated_at`.
*   **`lead_assignments`:** `lead_id` (PK, FK to leads), `contractor_id` (PK, FK to contractors), `status` (enum: 'assigned', 'accepted', 'declined'), `assigned_at`, `accepted_at`, `declined_at`. (Composite PK: `(lead_id, contractor_id)`)
*   **`messages`:** `id` (PK), `lead_id` (FK to leads), `sender_id` (FK to users), `receiver_id` (FK to users), `content` (text), `timestamp`.
*   **`reviews`:** `id` (PK), `lead_id` (FK to leads), `homeowner_id` (FK to homeowners), `contractor_id` (FK to contractors), `rating` (integer 1-5), `comment` (text), `created_at`.
*   **`payments`:** `id` (PK), `contractor_id` (FK to contractors), `lead_id` (FK to leads), `amount`, `currency`, `status` (enum: 'pending', 'paid', 'failed'), `transaction_id` (from payment gateway), `created_at`.
*   **`admin_logs`:** `id` (PK), `admin_user_id` (FK to users), `action` (text), `details` (JSONB), `timestamp`.

**3. Key Backend Logic & Services:**

*   **AR Data Processing Service:** Receives and processes raw AR data from the client. This service will extract structured measurements, identify architectural features, and potentially apply machine learning models for semantic segmentation or issue detection. This processing could be a Celery task if it's computationally intensive.
*   **Lead Matching Service (Celery Task):** Triggered upon new lead creation. This service will:
    1.  Filter eligible contractors based on `service_areas`, `specializations`, and `approval_status`.
    2.  Score contractors based on `average_rating`, `lead_conversion_rate`, `CAPS_certified` status, and current availability.
    3.  Select the top `N` contractors for the lead.
    4.  Create `lead_assignments` entries and notify matched contractors.
    5.  Implement logic for re-matching if initial assignments are declined or expire.
*   **Payment Integration Service:** Manages secure communication with a payment gateway (e.g., Stripe API). Handles charging contractors for accepted leads and processing payment webhooks for transaction status updates.
*   **Contractor Vetting Service:** Manages the contractor application workflow, including integration with third-party APIs for license verification, insurance checks, and background checks. Provides an admin interface for manual review and approval.
*   **Real-time Communication Service:** Utilizes `python-socketio` within FastAPI to enable WebSocket connections for instant messaging between homeowners and contractors, and for real-time notifications (e.g., new lead alerts for contractors).

### **IV. Detailed Frontend (Next.js App Router) Plan**

The Next.js application will leverage the App Router for robust routing, data fetching, and performance optimizations.

**1. Project Structure (App Router):**

```
/app
  / (root layout, homepage)
  /auth
    /login/page.tsx
    /register/page.tsx
    /forgot-password/page.tsx
  /homeowner
    /layout.tsx (Homeowner Dashboard Layout)
    /dashboard/page.tsx
    /ar-scan/page.tsx (Client Component for AR)
    /my-requests
      /[leadId]/page.tsx
    /messages/page.tsx
    /profile/page.tsx
  /contractor
    /layout.tsx (Contractor Dashboard Layout)
    /dashboard/page.tsx
    /leads/page.tsx (Available Leads)
      /[leadId]/page.tsx (Lead Details)
    /my-projects/page.tsx
    /profile/page.tsx
    /analytics/page.tsx
    /billing/page.tsx
  /admin (Potentially a separate Next.js app or a dedicated React Admin panel for internal use)
    /layout.tsx
    /users/page.tsx
    /contractors/pending/page.tsx
    /leads/page.tsx
    /analytics/page.tsx
  /components (Reusable UI components: buttons, cards, forms, navigation)
  /lib (Utility functions, API client, authentication helpers)
  /styles (Tailwind CSS configuration, global styles)
  /public (Static assets)
```

**2. Key Pages & Components:**

*   **Public Pages:**
    *   **Homepage (`/`):** Engaging marketing content, clear Call-to-Action (CTAs) for "Homeowners" and "Contractors," showcasing the value proposition of HOMEase | AI.
    *   **How It Works (`/how-it-works`):** Detailed explanation of the AR assessment process, lead validation, and contractor matching. Visuals and simple language are key.
    *   **Pricing (`/pricing`):** Transparent pricing tiers for contractors, emphasizing the value of high-quality leads.
*   **Homeowner Flow:**
    *   **Registration (`/auth/register`):** Simple, multi-step form for email/password and basic demographic information.
    *   **Dashboard (`/homeowner/dashboard`):** Personalized overview with quick access to "Start AR Scan," "My Requests," and "Messages."
    *   **AR Scan (`/homeowner/ar-scan`):**
        *   **Client Component (`use client`):** This page will host the AR experience.
        *   **AR Integration:**
            *   **If Native App:** This page will guide the user to download the native app or deep-link into it if already installed. The native app handles the actual LiDAR scanning and data collection, then sends processed data back to the FastAPI backend.
            *   **If Web-based AR (Fallback):** Utilizes WebXR to access the device camera. Provides UI overlays to guide users through "scanning" rooms. Manual input fields or very basic object detection (if feasible with WebXR) would collect data. *Crucially, emphasize the limitations of WebXR for precise measurements compared to native LiDAR.*
        *   **Guided Workflow:** Step-by-step instructions with clear visual cues and large buttons.
        *   **Input Forms:** After AR scan, intuitive forms to specify urgency, budget range, and additional notes.
        *   **Review/Confirm:** A clear summary of the AR assessment and lead details before final submission.
    *   **My Requests (`/homeowner/my-requests`):** A list of all submitted leads, showing their current status (e.g., "pending match," "matched," "in progress," "completed").
    *   **Lead Detail (`/homeowner/my-requests/[leadId]`):** Detailed view of a specific lead, including the AR assessment summary, profiles of matched contractors, and access to the messaging interface.
    *   **Messaging (`/homeowner/messages`):** Real-time chat interface for communication with matched contractors.
    *   **Profile (`/homeowner/profile`):** User settings, contact information, and preferences.
*   **Contractor Flow:**
    *   **Registration (`/auth/register`):** A comprehensive multi-step form for company details, specializations (e.g., Certified Aging-in-Place Specialist - CAPS), service areas, license/insurance uploads, and background check consent.
    *   **Dashboard (`/contractor/dashboard`):** Overview of new available leads, accepted leads, conversion rates, and earnings.
    *   **Lead Inbox (`/contractor/leads`):** A list of new, available leads. Each lead card provides key information like modification type, urgency, location, and a summary from the AR assessment.
    *   **Lead Detail (`/contractor/leads/[leadId]`):**
        *   Detailed view of the AR assessment data (measurements, identified issues, homeowner notes, suggested modifications).
        *   Clear options to "Accept Lead" or "Decline Lead."
        *   **Dynamic Scope Builder UI:** A crucial feature for contractors. This tool will auto-generate an initial scope-of-work proposal based on the AR scan data and AI output, allowing contractors to refine, add pricing, and generate a branded, professional proposal.
    *   **My Projects (`/contractor/my-projects`):** List of accepted leads/projects, with status updates and communication links.
    *   **Messaging (`/contractor/messages`):** Real-time chat with homeowners.
    *   **Profile Management (`/contractor/profile`):** Update company information, specializations, upload portfolio images, and manage availability.
    *   **Performance Analytics (`/contractor/analytics`):** Charts and graphs displaying lead conversion rates, customer satisfaction scores, and ROI on leads.
    *   **Billing & Payments (`/contractor/billing`):** View lead charges, payment history, and manage payment methods (using Stripe Elements for secure card input).

**3. Key Frontend Logic & Integrations:**

*   **Authentication:** Leverage Next.js Server Components for secure session management (e.g., using `next-auth` or a custom JWT handling strategy with HTTP-only cookies). Client components will use tokens for authenticated API calls.
*   **API Client:** A custom client (e.g., using `fetch` or `axios`) to interact with the FastAPI backend, handling authentication headers and error responses.
*   **AR Integration (Crucial Decision):** As noted, a native mobile app for homeowners for optimal LiDAR scanning is recommended. The Next.js web app would then serve as the primary interface for contractors and for homeowners to manage their requests post-scan. If a web-only AR solution is pursued initially, `three.js` or `A-Frame` would be used, with clear disclaimers about precision.
*   **Real-time Messaging:** Integrate `socket.io-client` in a client component to establish and manage WebSocket connections with the FastAPI backend for instant messaging between users.
*   **Payment UI:** Integrate Stripe Elements (or similar) for secure and compliant credit card input and management on the contractor billing pages.
*   **Accessibility (for Seniors):** This is paramount.
    *   **Design System:** Implement a comprehensive design system focused on senior-friendly UX principles:
        *   **Large Font Sizes:** Default large text, with options for even larger.
        *   **High Contrast:** Strong color contrast between text and background.
        *   **Clear Iconography:** Simple, unambiguous icons with accompanying text labels.
        *   **Ample Whitespace:** Reduces visual clutter.
        *   **Simple Navigation:** Intuitive, consistent navigation menus.
        *   **Minimal Technical Jargon:** Use straightforward, plain language.
        *   **Tapping over Complex Gestures:** Prioritize simple tap interactions.
        *   **Voice Command Integration (Future):** Explore integration with platform-native voice assistants (Alexa/Siri) for basic commands to enhance accessibility.
    *   **User Testing:** Continuous user testing with diverse groups of older adults to identify and address usability issues iteratively.
    *   **Feedback Mechanisms:** Easy-to-find channels for users to provide feedback on the app's usability.

### **V. Addressing "Immediate Go-to-Market Improvement" Features**

Let's map your prioritized features to the technical plan:

1.  **User-Friendly, AR-Based Initial Home Assessment Tool:**
    *   **Technical Implementation:** The core of the `ar_assessments` module in FastAPI for data ingestion and the `/homeowner/ar-scan` page in Next.js (or a linked native app) for the client-side AR experience. Significant UX/UI design effort will be focused here.
    *   **Go-to-Market Impact:** This is the primary differentiator and will be heavily featured in marketing. Its intuitiveness is critical for homeowner adoption.

2.  **Immediate Provision of Validated, High-Quality Leads:**
    *   **Technical Implementation:** The FastAPI `leads` module will handle the creation and management of leads. The `ar_assessments` data is directly integrated into the lead payload, ensuring "confirmed homeowner intent," "clearly identified modification requirements via AR," "budget range indication," and "urgency indication."
    *   **Go-to-Market Impact:** This is the core value proposition for contractors, justifying premium pricing and driving contractor acquisition.

3.  **Automated, Intelligent Contractor Matching & Verified Contractor Tiering System:**
    *   **Technical Implementation:** The Lead Matching Service (a Celery task in FastAPI) will implement the matching algorithm. The `contractors` table will store vetting status and performance metrics (`average_rating`, `lead_conversion_rate`) to support tiering.
    *   **Go-to-Market Impact:** Ensures rapid, relevant matches for homeowners and fair lead distribution for contractors, fostering trust and efficiency on both sides.

4.  **Integrated Communication Tool:**
    *   **Technical Implementation:** The `messaging` module in FastAPI with WebSocket support via `python-socketio`, and the `/homeowner/messages` and `/contractor/messages` pages in Next.js.
    *   **Go-to-Market Impact:** Streamlines communication post-match, reducing friction and improving conversion rates by enabling quick, direct interaction.

5.  **Contractor Onboarding and Vetting Process:**
    *   **Technical Implementation:** The `contractors` module in FastAPI handles application submissions and admin approvals. The Contractor Vetting Service integrates with third-party APIs for verification. The `/auth/register` and `/contractor/profile` pages in Next.js provide the UI.
    *   **Go-to-Market Impact:** Essential for building a reputable network, which is key for homeowner trust and attracting quality contractors.

6.  **Targeted Digital Marketing Campaigns:**
    *   **Technical Implementation:** While primarily a marketing function, the backend will provide analytics endpoints (`/admin/analytics/leads`, `/admin/analytics/contractors`) to track campaign effectiveness. The frontend will be built with SEO best practices (server-side rendering, semantic HTML).
    *   **Go-to-Market Impact:** Drives initial traffic and user acquisition for both homeowners and contractors.

7.  **Dynamic Scope Builder (for Contractors):**
    *   **Technical Implementation:** This will be a key feature within the `/contractor/leads/[leadId]` page in Next.js, leveraging the detailed AR assessment data from the FastAPI `ar_assessments` endpoint to pre-populate proposal templates.
    *   **Go-to-Market Impact:** A significant value-add for contractors, making their quoting process faster and more professional, directly impacting their lead conversion rates and satisfaction with the platform.

### **VI. Conclusion**

This technical plan provides a robust blueprint for HOMEase | AI, leveraging the strengths of FastAPI and Next.js App Router to build a highly scalable, secure, and user-friendly platform. By prioritizing the core AR-driven lead generation and contractor value propositions from the outset, the proposed architecture directly supports your "Immediate Go-to-Market Improvement" goals.

The choice to potentially develop a native mobile app for the core AR scanning functionality, while maintaining a powerful Next.js web application for overall platform management, addresses the nuanced technical requirements of precise AR measurements and the critical need for an accessible user experience for your target demographic. This layered approach ensures that HOMEase | AI can deliver on its promise of revolutionizing aging-in-place modifications through innovative technology and a highly efficient marketplace.

## Intermediate Steps

### Task Coordinator

Task Understanding:
Error occurred during planning: 429 RESOURCE_EXHAUSTED. {'error': {'code': 429, 'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, head to: https://ai.google.dev/gemini-api/docs/rate-limits.', 'status': 'RESOURCE_EXHAUSTED', 'details': [{'@type': 'type.googleapis.com/google.rpc.QuotaFailure', 'violations': [{'quotaMetric': 'generativelanguage.googleapis.com/generate_content_free_tier_input_token_count', 'quotaId': 'GenerateContentInputTokensPerModelPerMinute-FreeTier', 'quotaDimensions': {'location': 'global', 'model': 'gemini-2.5-flash'}, 'quotaValue': '250000'}]}, {'@type': 'type.googleapis.com/google.rpc.Help', 'links': [{'description': 'Learn more about Gemini API quotas', 'url': 'https://ai.google.dev/gemini-api/docs/rate-limits'}]}, {'@type': 'type.googleapis.com/google.rpc.RetryInfo', 'retryDelay': '49s'}]}}

Execution Strategy:
Execute the general processing subtask as a fallback

Subtasks:
1. General Processing (Priority: 1, Expertise: General Knowledge)
   Description: Process the user query in a general way
   Dependencies: None

**Metadata:**
```json
{
  "task_understanding": "Error occurred during planning: 429 RESOURCE_EXHAUSTED. {'error': {'code': 429, 'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, head to: https://ai.google.dev/gemini-api/docs/rate-limits.', 'status': 'RESOURCE_EXHAUSTED', 'details': [{'@type': 'type.googleapis.com/google.rpc.QuotaFailure', 'violations': [{'quotaMetric': 'generativelanguage.googleapis.com/generate_content_free_tier_input_token_count', 'quotaId': 'GenerateContentInputTokensPerModelPerMinute-FreeTier', 'quotaDimensions': {'location': 'global', 'model': 'gemini-2.5-flash'}, 'quotaValue': '250000'}]}, {'@type': 'type.googleapis.com/google.rpc.Help', 'links': [{'description': 'Learn more about Gemini API quotas', 'url': 'https://ai.google.dev/gemini-api/docs/rate-limits'}]}, {'@type': 'type.googleapis.com/google.rpc.RetryInfo', 'retryDelay': '49s'}]}}",
  "subtasks": [
    {
      "id": "subtask1",
      "title": "General Processing",
      "description": "Process the user query in a general way",
      "required_expertise": "General Knowledge",
      "priority": 1,
      "dependencies": []
    }
  ],
  "execution_strategy": "Execute the general processing subtask as a fallback"
}
```

### General Knowledge Specialist

This is an exciting and well-researched business plan for HOMEase | AI! The strategic pivot to a lead-generation-focused model, leveraging AR for high-quality leads in the aging-in-place sector, makes perfect sense for rapid market entry and scalability.

Let's break down the technical planning for your Python FastAPI backend and Next.js App Router frontend, keeping in mind the phased growth and the "Immediate Go-to-Market Improvement" features you've prioritized.

---

## HOMEase | AI: Technical Architecture Plan (FastAPI & Next.js App Router)

### **I. Core Principles & Architecture Goals**

1.  **API-First Approach:** FastAPI will serve as a robust, well-documented API layer, completely decoupled from the frontend.
2.  **Scalability:** Design for high concurrency and data volume from the outset, especially for lead processing and user interactions.
3.  **Security:** Implement strong authentication, authorization, and data encryption (especially for sensitive AR and personal data). Adherence to HIPAA-lite principles and CCPA/state privacy laws will be paramount.
4.  **User Experience (UX) Focus:** The frontend must be highly intuitive, especially for older adults and their caregivers.
5.  **Modularity:** Break down the application into manageable services/modules for easier development, testing, and future expansion.
6.  **Observability:** Implement logging, monitoring, and tracing for effective troubleshooting and performance analysis.

### **II. Technology Stack Overview**

*   **Backend:**
    *   **Language:** Python 3.10+
    *   **Framework:** FastAPI
    *   **Database:** PostgreSQL (Robust, scalable, good for relational data)
    *   **ORM:** SQLAlchemy 2.0 (with async support)
    *   **Asynchronous Tasks:** Celery with Redis (for background processing like complex AR data analysis, lead matching, notifications)
    *   **Authentication:** JWT (JSON Web Tokens)
    *   **Validation:** Pydantic (built-in with FastAPI)
    *   **Dependency Management:** Poetry or PDM
    *   **Containerization:** Docker
    *   **ASGI Server:** Uvicorn (for production deployment)
*   **Frontend:**
    *   **Framework:** Next.js (App Router)
    *   **Language:** TypeScript
    *   **Styling:** Tailwind CSS (for rapid, utility-first styling)
    *   **Data Fetching:** React Query (TanStack Query) or SWR (for efficient data fetching, caching, and revalidation)
    *   **State Management:** React Context API + `useState`/`useReducer` (for local component state); potentially Zustand or Jotai for more global, lightweight needs.
    *   **AR Implementation:**
        *   **Primary:** Native mobile app (React Native/Expo with ARKit/ARCore modules) for best LiDAR integration and performance, especially for detailed measurements.
        *   **Fallback/Web:** WebXR (three.js/A-Frame) for basic AR visualization on web, but note LiDAR limitations.
    *   **Real-time Communication:** Socket.IO client (connecting to FastAPI backend with `python-socketio`) for messaging/notifications.
*   **Deployment & Infrastructure:**
    *   **Backend:** AWS ECS/EC2, Google Cloud Run/App Engine, or Render (container-based deployment)
    *   **Frontend:** Vercel (optimized for Next.js)
    *   **Database:** AWS RDS (PostgreSQL), Google Cloud SQL (PostgreSQL), or DigitalOcean Managed Databases
    *   **CI/CD:** GitHub Actions or GitLab CI/CD

### **III. Detailed Backend (FastAPI) Plan**

**1. API Endpoints (Modular Design)**

Group endpoints logically into routers (e.g., `auth`, `users`, `homeowners`, `contractors`, `leads`, `ar_assessments`, `messaging`, `payments`, `admin`).

*   **`auth` Module:**
    *   `POST /register/homeowner`: Register a new homeowner.
    *   `POST /register/contractor`: Register a new contractor (initial details).
    *   `POST /login`: User login (returns JWT access and refresh tokens).
    *   `POST /token/refresh`: Refresh expired access token.
    *   `POST /forgot-password`, `POST /reset-password`.
*   **`users` Module (Shared User Management):**
    *   `GET /users/me`: Get current user profile.
    *   `PUT /users/me`: Update current user profile.
    *   `PUT /users/me/password`: Change password.
*   **`homeowners` Module:**
    *   `GET /homeowners/{id}`: Get homeowner profile (admin/self).
    *   `PUT /homeowners/{id}`: Update homeowner profile (admin/self).
*   **`contractors` Module:**
    *   `GET /contractors/{id}`: Get contractor profile (public/admin/self).
    *   `PUT /contractors/{id}`: Update contractor profile (self).
    *   `POST /contractors/{id}/apply`: Submit full contractor application (licenses, insurance, etc.).
    *   `GET /contractors/pending`: Get list of pending contractors (admin).
    *   `PUT /contractors/{id}/approve`: Approve/Decline contractor (admin).
    *   `GET /contractors/search`: Search/filter approved contractors (for internal use, not directly exposed to homeowners for matching).
*   **`ar_assessments` Module (Critical for Lead Generation):**
    *   `POST /ar-assessments`: Submit new AR assessment data.
        *   **Input:** JSON payload containing:
            *   `homeowner_id`
            *   `raw_ar_data`: Base64 encoded images/video, or structured data (e.g., point cloud data, semantic segmentation results, identified objects like doors, windows, counters). *This will be the most complex part.*
            *   `measurements`: Detected dimensions (e.g., doorway width, ramp slope, grab bar height suggestions).
            *   `identified_issues`: e.g., "narrow doorway", "no grab bars", "high counter".
            *   `suggested_modifications`: Initial AI/AR-driven recommendations.
        *   **Output:** `ar_assessment_id`, confirmation.
    *   `GET /ar-assessments/{id}`: Retrieve a specific AR assessment.
    *   `GET /homeowners/{homeowner_id}/ar-assessments`: Get all assessments for a homeowner.
*   **`leads` Module:**
    *   `POST /leads`: Create a new lead from an AR assessment.
        *   **Input:** `ar_assessment_id`, `homeowner_id`, `urgency`, `budget_range`, `additional_notes`.
        *   **Action:** Trigger asynchronous lead matching process (Celery task).
    *   `GET /leads/{id}`: Get lead details (homeowner/matched contractor/admin).
    *   `GET /leads/homeowner/{homeowner_id}`: Get leads initiated by a homeowner.
    *   `GET /leads/contractor/{contractor_id}/available`: Get available leads for a contractor (based on matching).
    *   `POST /leads/{id}/accept`: Contractor accepts a lead (marks it as taken, charges contractor).
    *   `POST /leads/{id}/decline`: Contractor declines a lead (re-matches if necessary).
    *   `GET /leads/contractor/{contractor_id}/accepted`: Get leads accepted by a contractor.
    *   `PUT /leads/{id}/status`: Update lead status (e.g., "in progress", "completed").
*   **`messaging` Module:**
    *   `GET /messages/{lead_id}`: Get message history for a specific lead.
    *   `POST /messages/{lead_id}`: Send a new message.
    *   WebSocket endpoint for real-time chat.
*   **`reviews` Module:**
    *   `POST /reviews`: Submit a review for a contractor.
    *   `GET /contractors/{id}/reviews`: Get reviews for a contractor.
*   **`payments` Module:**
    *   `POST /payments/webhook`: Webhook endpoint for payment gateway (e.g., Stripe).
    *   `GET /contractors/{id}/billing`: Get contractor's billing history.
*   **`admin` Module:**
    *   `GET /admin/analytics/leads`: Lead generation analytics.
    *   `GET /admin/analytics/contractors`: Contractor performance analytics.
    *   `PUT /admin/users/{id}/role`: Change user role.

**2. Database Schema (PostgreSQL)**

*   **`users`:** `id` (PK), `email` (unique), `password_hash`, `role` (enum: 'homeowner', 'contractor', 'admin'), `created_at`, `updated_at`.
*   **`homeowners`:** `id` (PK), `user_id` (FK to users), `first_name`, `last_name`, `phone`, `address`, `city`, `state`, `zip_code`, `preferences` (JSONB).
*   **`contractors`:** `id` (PK), `user_id` (FK to users), `company_name`, `contact_person`, `phone`, `email`, `website`, `service_areas` (ARRAY of strings or JSONB), `specializations` (ARRAY of strings), `licenses` (JSONB: {type: num, state, expiration}), `insurance_info` (JSONB), `background_check_status` (enum), `caps_certified` (boolean), `approval_status` (enum: 'pending', 'approved', 'rejected'), `average_rating`, `total_reviews`, `created_at`, `updated_at`.
*   **`ar_assessments`:** `id` (PK), `homeowner_id` (FK to homeowners), `raw_ar_data` (JSONB or dedicated storage path for larger files), `measurements` (JSONB), `identified_issues` (JSONB), `suggested_modifications` (JSONB), `created_at`.
*   **`leads`:** `id` (PK), `homeowner_id` (FK to homeowners), `ar_assessment_id` (FK to ar_assessments), `status` (enum: 'new', 'matched', 'accepted', 'in_progress', 'completed', 'declined'), `urgency` (enum: 'low', 'medium', 'high'), `budget_range` (string or enum), `additional_notes`, `created_at`, `updated_at`.
*   **`lead_assignments`:** `lead_id` (PK, FK to leads), `contractor_id` (PK, FK to contractors), `status` (enum: 'assigned', 'accepted', 'declined'), `assigned_at`, `accepted_at`, `declined_at`. (Composite PK: `(lead_id, contractor_id)`)
*   **`messages`:** `id` (PK), `lead_id` (FK to leads), `sender_id` (FK to users), `receiver_id` (FK to users), `content` (text), `timestamp`.
*   **`reviews`:** `id` (PK), `lead_id` (FK to leads), `homeowner_id` (FK to homeowners), `contractor_id` (FK to contractors), `rating` (integer 1-5), `comment` (text), `created_at`.
*   **`payments`:** `id` (PK), `contractor_id` (FK to contractors), `lead_id` (FK to leads), `amount`, `currency`, `status` (enum: 'pending', 'paid', 'failed'), `transaction_id` (from payment gateway), `created_at`.
*   **`admin_logs`:** `id` (PK), `admin_user_id` (FK to users), `action` (text), `details` (JSONB), `timestamp`.

**3. Key Backend Logic & Services:**

*   **AR Data Processing Service:**
    *   Receives raw AR data.
    *   Processes it to extract structured measurements and identify features.
    *   Potentially uses a dedicated machine learning model (Python libraries like OpenCV, Scikit-image, or specialized AR SDKs with Python bindings) for advanced analysis if not done client-side.
    *   Stores processed data efficiently.
*   **Lead Matching Service (Celery Task):**
    *   Triggered when a new lead is created.
    *   Filters contractors by `service_areas`, `specializations`.
    *   Scores contractors based on `average_rating`, `lead_conversion_rate`, `availability`, `CAPS_certified` status.
    *   Selects top N contractors.
    *   Creates `lead_assignments` entries.
    *   Sends notifications to matched contractors.
    *   Handles re-matching if initial contractors decline.
*   **Payment Integration Service:**
    *   Handles secure communication with Stripe/PayPal API.
    *   Manages charging contractors for accepted leads.
    *   Processes payment webhooks for status updates.
*   **Vetting Service:**
    *   Manages contractor application workflow.
    *   Integrates with third-party APIs for license verification, background checks (e.g., Checkr, Certn).
    *   Admin interface for manual review and approval.
*   **Real-time Communication Service:**
    *   Uses `python-socketio` with FastAPI to enable WebSocket connections for instant messaging and notifications.

### **IV. Detailed Frontend (Next.js App Router) Plan**

**1. Project Structure (App Router)**

```
/app
  / (root layout, homepage)
  /auth
    /login
    /register
    /forgot-password
  /homeowner
    /layout.tsx (homeowner dashboard layout)
    /dashboard
    /ar-scan (client component for AR)
    /my-requests
      /[leadId]
    /messages
    /profile
  /contractor
    /layout.tsx (contractor dashboard layout)
    /dashboard
    /leads (available leads)
      /[leadId] (lead details)
    /my-projects
    /profile
    /analytics
    /billing
  /admin (internal, potentially separate Next.js app or a dedicated React Admin panel)
    /layout.tsx
    /users
    /contractors/pending
    /leads
    /analytics
  /components (reusable UI components)
  /lib (utility functions, API client, auth helpers)
  /styles
  /public
```

**2. Key Pages & Components:**

*   **Public Pages:**
    *   **Homepage (`/`):** Marketing content, clear CTAs for "Homeowners" and "Contractors."
    *   **How It Works (`/how-it-works`):** Explains the AR process, lead validation, and matching.
    *   **Pricing (`/pricing`):** Transparent pricing tiers for contractors.
*   **Homeowner Flow:**
    *   **Registration (`/auth/register`):** Simple form for email/password.
    *   **Dashboard (`/homeowner/dashboard`):** Quick access to "Start AR Scan," "My Requests," "Messages."
    *   **AR Scan (`/homeowner/ar-scan`):**
        *   **Client Component:** This will be a client component using `use client`.
        *   **AR Integration:**
            *   **Native App (Recommended):** If using React Native/Expo, this page would trigger the native AR module. The native app would handle LiDAR scanning, 3D reconstruction, and feature detection, then send the processed data (measurements, identified objects, suggested modifications) to the FastAPI backend.
            *   **WebXR (Fallback/Alternative):** Use `three.js` or `A-Frame` for basic AR. Users would grant camera access. UI overlays would guide them to "scan" areas. Manual input for measurements or very basic object detection could be simulated. *LiDAR access is not directly available via WebXR, limiting accuracy for detailed measurements.*
        *   **Guided Workflow:** Step-by-step instructions for scanning.
        *   **Input Forms:** After AR scan, forms to specify urgency, budget, additional notes.
        *   **Review/Confirm:** Display a summary of the AR assessment and lead details before submission.
    *   **My Requests (`/homeowner/my-requests`):** List of submitted leads, showing status (e.g., "pending match," "matched," "in progress").
    *   **Lead Detail (`/homeowner/my-requests/[leadId]`):** Detailed view of the specific lead, including AR assessment summary, matched contractor profiles, and access to messaging.
    *   **Messaging (`/homeowner/messages`):** Real-time chat interface with matched contractors.
    *   **Profile (`/homeowner/profile`):** User settings, contact info.
*   **Contractor Flow:**
    *   **Registration (`/auth/register`):** Multi-step form for company details, licenses, insurance, specializations, service areas, CAPS certification upload.
    *   **Dashboard (`/contractor/dashboard`):** Overview of new leads, accepted leads, conversion rates, and earnings.
    *   **Lead Inbox (`/contractor/leads`):** List of new, available leads. Each lead card shows key info (type of modification, urgency, location).
    *   **Lead Detail (`/contractor/leads/[leadId]`):**
        *   Detailed view of the AR assessment data (measurements, identified issues, homeowner notes).
        *   Option to "Accept Lead" or "Decline Lead."
        *   "Dynamic Scope Builder" UI: Pre-populates a proposal template based on AR data, allowing contractors to refine and generate a branded proposal.
    *   **My Projects (`/contractor/my-projects`):** List of accepted leads/projects, with status updates.
    *   **Messaging (`/contractor/messages`):** Real-time chat with homeowners.
    *   **Profile Management (`/contractor/profile`):** Update company info, specializations, upload portfolio images, manage availability.
    *   **Performance Analytics (`/contractor/analytics`):** Charts/graphs showing lead conversion rates, customer satisfaction scores, ROI.
    *   **Billing & Payments (`/contractor/billing`):** View lead charges, payment history, manage payment methods (Stripe Elements integration).

**3. Key Frontend Logic & Integrations:**

*   **Authentication:** Use Next.js Server Components for secure session management (e.g., with `next-auth` or custom JWT handling with cookies). Client components will use tokens for API calls.
*   **API Client:** A wrapper around `fetch` or `axios` to interact with the FastAPI backend, handling authentication headers.
*   **AR Integration (Crucial Decision):**
    *   **If Native (React Native/Expo):** The Next.js web app would largely handle marketing, account management, and contractor dashboards. The homeowner AR scanning would be within a separate, dedicated native mobile app that communicates with the same FastAPI backend. This offers the best AR performance and LiDAR access.
    *   **If Web-based AR:** Research WebXR capabilities for depth estimation. Libraries like `three.js` or `A-Frame` can render 3D overlays. This would require significant client-side computation and might compromise accuracy compared to native LiDAR.
*   **Real-time Messaging:** Use `socket.io-client` in a client component to connect to the FastAPI WebSocket endpoint.
*   **Payment UI:** Integrate Stripe Elements or similar UI components for secure credit card input on the contractor billing page.
*   **Accessibility (for Seniors):**
    *   **Design System:** Implement a design system with large font sizes, high contrast, clear iconography, ample whitespace, and simple navigation.
    *

**Metadata:**
```json
{
  "subtask_id": "subtask1",
  "title": "General Processing",
  "expertise": "General Knowledge"
}
```

### Results Integrator

This is an excellent and well-structured business plan for HOMEase | AI, with a clear strategic pivot to a lead-generation-focused model. Leveraging AR for high-quality, pre-validated leads in the aging-in-place sector is a compelling differentiator.

Below is a comprehensive technical plan for your Python FastAPI backend and Next.js App Router frontend, designed to support the phased growth outlined in your business plan and prioritize the "Immediate Go-to-Market Improvement" features.

---

## HOMEase | AI: Technical Architecture Plan (FastAPI & Next.js App Router)

### **I. Core Principles & Architecture Goals**

Our technical architecture is designed to be robust, scalable, secure, and user-centric, aligning directly with the HOMEase | AI business objectives:

1.  **API-First Approach:** The FastAPI backend will operate as a completely decoupled API layer, serving data to various clients (Next.js web app, potential future native mobile app).
2.  **Scalability:** The system will be built to handle a rapidly increasing number of users, AR assessments, and leads, anticipating the aggressive growth projections.
3.  **Security & Compliance:** Robust authentication, authorization, data encryption, and adherence to privacy regulations (CCPA, HIPAA-lite principles for sensitive health-related data) are paramount.
4.  **User Experience (UX) Focus:** The frontend will be meticulously designed for intuitive use, especially for older adults and their caregivers, addressing the stated challenge that "technology is not designed with their age group in mind."
5.  **Modularity:** Breaking down the application into manageable services and modules will facilitate easier development, testing, and future feature expansion.
6.  **Observability:** Comprehensive logging, monitoring, and tracing will be implemented for effective troubleshooting, performance analysis, and proactive issue detection.

### **II. Technology Stack Overview**

*   **Backend (FastAPI):**
    *   **Language:** Python 3.10+
    *   **Framework:** FastAPI (for high performance, async support, and automatic OpenAPI documentation)
    *   **Database:** PostgreSQL (Robust, ACID-compliant, excellent for relational data and JSONB for flexible schema needs)
    *   **ORM:** SQLAlchemy 2.0 (with async support for database interactions)
    *   **Asynchronous Tasks:** Celery with Redis (for background processing, e.g., complex AR data analysis, lead matching, notifications, email sending)
    *   **Authentication:** JWT (JSON Web Tokens) for secure API access.
    *   **Validation:** Pydantic (natively integrated with FastAPI for data validation and serialization)
    *   **Dependency Management:** Poetry or PDM (for consistent project environments)
    *   **Containerization:** Docker (for consistent development and deployment environments)
    *   **ASGI Server:** Uvicorn (for serving the FastAPI application in production)
*   **Frontend (Next.js App Router):**
    *   **Framework:** Next.js (utilizing the App Router for modern React features, server components, and optimized routing)
    *   **Language:** TypeScript (for type safety and improved developer experience)
    *   **Styling:** Tailwind CSS (for rapid, utility-first styling and responsive design)
    *   **Data Fetching:** React Query (TanStack Query) or SWR (for efficient data fetching, caching, and revalidation, enhancing perceived performance)
    *   **State Management:** React Context API + `useState`/`useReducer` (for local component state); potentially Zustand or Jotai for more global, lightweight needs.
    *   **AR Implementation:**
        *   **Primary (Recommended for optimal performance & LiDAR):** A dedicated native mobile application (e.g., built with React Native/Expo, leveraging ARKit for iOS and ARCore for Android). This separate app would handle the detailed LiDAR scanning, 3D reconstruction, and initial feature detection, sending processed data to the FastAPI backend.
        *   **Fallback/Web-based AR (for basic visualization):** WebXR API with libraries like `three.js` or `A-Frame` for basic augmented reality experiences directly in the browser. *Note: Direct LiDAR access for precise measurements is limited or unavailable via WebXR, making a native app superior for the core AR assessment.*
    *   **Real-time Communication:** Socket.IO client (connecting to FastAPI backend using `python-socketio`) for in-app messaging and notifications.
*   **Deployment & Infrastructure:**
    *   **Backend:** AWS ECS/EC2, Google Cloud Run/App Engine, or Render (container-based deployments for scalability and ease of management).
    *   **Frontend:** Vercel (highly optimized for Next.js deployments, providing global CDN and serverless functions).
    *   **Database:** AWS RDS (PostgreSQL), Google Cloud SQL (PostgreSQL), or DigitalOcean Managed Databases (for managed, scalable database solutions).
    *   **CI/CD:** GitHub Actions or GitLab CI/CD (for automated testing, building, and deployment pipelines).

### **III. Detailed Backend (FastAPI) Plan**

The backend will be designed with modularity, using FastAPI's APIRouter for logical separation of concerns.

**1. API Endpoints (by Module):**

*   **`auth` Module:**
    *   `POST /register/homeowner`: User registration for homeowners.
    *   `POST /register/contractor`: Initial registration for contractors.
    *   `POST /login`: User authentication, returning JWT access and refresh tokens.
    *   `POST /token/refresh`: Endpoint to refresh expired JWTs.
    *   `POST /forgot-password`, `POST /reset-password`: Standard password recovery flows.
*   **`users` Module (Shared User Management):**
    *   `GET /users/me`: Retrieve current authenticated user's profile.
    *   `PUT /users/me`: Update current user's profile.
    *   `PUT /users/me/password`: Change user's password.
*   **`homeowners` Module:**
    *   `GET /homeowners/{id}`: Retrieve a specific homeowner's profile (admin/self access).
    *   `PUT /homeowners/{id}`: Update homeowner profile (admin/self access).
*   **`contractors` Module:**
    *   `GET /contractors/{id}`: Retrieve contractor profile (public/admin/self access).
    *   `PUT /contractors/{id}`: Update contractor profile (self access).
    *   `POST /contractors/{id}/apply`: Submit detailed contractor application (licenses, insurance, etc.).
    *   `GET /contractors/pending`: Admin endpoint to list pending contractor applications.
    *   `PUT /contractors/{id}/approve`: Admin endpoint to approve/decline contractors.
    *   `GET /contractors/search`: Internal endpoint for lead matching service to search/filter approved contractors.
*   **`ar_assessments` Module (Core for Lead Generation):**
    *   `POST /ar-assessments`: Submit new AR assessment data.
        *   **Input:** JSON payload including `homeowner_id`, `raw_ar_data` (e.g., structured point cloud data, semantic segmentation results, identified objects like doors, windows, counters), `measurements` (detected dimensions like doorway width, ramp slope), `identified_issues` (e.g., "narrow doorway", "no grab bars"), `suggested_modifications` (initial AI/AR-driven recommendations).
        *   **Output:** `ar_assessment_id`, confirmation.
    *   `GET /ar-assessments/{id}`: Retrieve a specific AR assessment.
    *   `GET /homeowners/{homeowner_id}/ar-assessments`: Get all assessments for a given homeowner.
*   **`leads` Module:**
    *   `POST /leads`: Create a new lead based on an AR assessment.
        *   **Input:** `ar_assessment_id`, `homeowner_id`, `urgency`, `budget_range`, `additional_notes`.
        *   **Action:** Triggers an asynchronous lead matching process (Celery task).
    *   `GET /leads/{id}`: Retrieve lead details (homeowner/matched contractor/admin access).
    *   `GET /leads/homeowner/{homeowner_id}`: Get leads initiated by a specific homeowner.
    *   `GET /leads/contractor/{contractor_id}/available`: Get available leads for a contractor (based on matching results).
    *   `POST /leads/{id}/accept`: Contractor accepts a lead (marks it as taken, initiates payment process).
    *   `POST /leads/{id}/decline`: Contractor declines a lead (triggers re-matching if necessary).
    *   `GET /leads/contractor/{contractor_id}/accepted`: Get leads previously accepted by a contractor.
    *   `PUT /leads/{id}/status`: Update lead status (e.g., "in progress", "completed").
*   **`messaging` Module:**
    *   `GET /messages/{lead_id}`: Retrieve message history for a specific lead.
    *   `POST /messages/{lead_id}`: Send a new message.
    *   Dedicated WebSocket endpoint for real-time chat.
*   **`reviews` Module:**
    *   `POST /reviews`: Submit a review for a contractor after project completion.
    *   `GET /contractors/{id}/reviews`: Retrieve reviews for a specific contractor.
*   **`payments` Module:**
    *   `POST /payments/webhook`: Endpoint for receiving payment gateway notifications (e.g., Stripe webhooks).
    *   `GET /contractors/{id}/billing`: Retrieve contractor's billing history.
*   **`admin` Module (Internal API):**
    *   `GET /admin/analytics/leads`: Lead generation performance analytics.
    *   `GET /admin/analytics/contractors`: Contractor performance analytics.
    *   `PUT /admin/users/{id}/role`: Manage user roles.

**2. Database Schema (PostgreSQL):**

*   **`users`:** `id` (PK), `email` (unique), `password_hash`, `role` (enum: 'homeowner', 'contractor', 'admin'), `created_at`, `updated_at`.
*   **`homeowners`:** `id` (PK), `user_id` (FK to users), `first_name`, `last_name`, `phone`, `address`, `city`, `state`, `zip_code`, `preferences` (JSONB for flexible storage).
*   **`contractors`:** `id` (PK), `user_id` (FK to users), `company_name`, `contact_person`, `phone`, `email`, `website`, `service_areas` (ARRAY of strings or JSONB), `specializations` (ARRAY of strings), `licenses` (JSONB), `insurance_info` (JSONB), `background_check_status` (enum), `caps_certified` (boolean), `approval_status` (enum: 'pending', 'approved', 'rejected'), `average_rating`, `total_reviews`, `created_at`, `updated_at`.
*   **`ar_assessments`:** `id` (PK), `homeowner_id` (FK to homeowners), `raw_ar_data` (JSONB for metadata, or S3/Cloud Storage path for large files), `measurements` (JSONB), `identified_issues` (JSONB), `suggested_modifications` (JSONB), `created_at`.
*   **`leads`:** `id` (PK), `homeowner_id` (FK to homeowners), `ar_assessment_id` (FK to ar_assessments), `status` (enum: 'new', 'matched', 'accepted', 'in_progress', 'completed', 'declined'), `urgency` (enum: 'low', 'medium', 'high'), `budget_range` (string or enum), `additional_notes`, `created_at`, `updated_at`.
*   **`lead_assignments`:** `lead_id` (PK, FK to leads), `contractor_id` (PK, FK to contractors), `status` (enum: 'assigned', 'accepted', 'declined'), `assigned_at`, `accepted_at`, `declined_at`. (Composite PK: `(lead_id, contractor_id)`)
*   **`messages`:** `id` (PK), `lead_id` (FK to leads), `sender_id` (FK to users), `receiver_id` (FK to users), `content` (text), `timestamp`.
*   **`reviews`:** `id` (PK), `lead_id` (FK to leads), `homeowner_id` (FK to homeowners), `contractor_id` (FK to contractors), `rating` (integer 1-5), `comment` (text), `created_at`.
*   **`payments`:** `id` (PK), `contractor_id` (FK to contractors), `lead_id` (FK to leads), `amount`, `currency`, `status` (enum: 'pending', 'paid', 'failed'), `transaction_id` (from payment gateway), `created_at`.
*   **`admin_logs`:** `id` (PK), `admin_user_id` (FK to users), `action` (text), `details` (JSONB), `timestamp`.

**3. Key Backend Logic & Services:**

*   **AR Data Processing Service:** Receives and processes raw AR data from the client. This service will extract structured measurements, identify architectural features, and potentially apply machine learning models for semantic segmentation or issue detection. This processing could be a Celery task if it's computationally intensive.
*   **Lead Matching Service (Celery Task):** Triggered upon new lead creation. This service will:
    1.  Filter eligible contractors based on `service_areas`, `specializations`, and `approval_status`.
    2.  Score contractors based on `average_rating`, `lead_conversion_rate`, `CAPS_certified` status, and current availability.
    3.  Select the top `N` contractors for the lead.
    4.  Create `lead_assignments` entries and notify matched contractors.
    5.  Implement logic for re-matching if initial assignments are declined or expire.
*   **Payment Integration Service:** Manages secure communication with a payment gateway (e.g., Stripe API). Handles charging contractors for accepted leads and processing payment webhooks for transaction status updates.
*   **Contractor Vetting Service:** Manages the contractor application workflow, including integration with third-party APIs for license verification, insurance checks, and background checks. Provides an admin interface for manual review and approval.
*   **Real-time Communication Service:** Utilizes `python-socketio` within FastAPI to enable WebSocket connections for instant messaging between homeowners and contractors, and for real-time notifications (e.g., new lead alerts for contractors).

### **IV. Detailed Frontend (Next.js App Router) Plan**

The Next.js application will leverage the App Router for robust routing, data fetching, and performance optimizations.

**1. Project Structure (App Router):**

```
/app
  / (root layout, homepage)
  /auth
    /login/page.tsx
    /register/page.tsx
    /forgot-password/page.tsx
  /homeowner
    /layout.tsx (Homeowner Dashboard Layout)
    /dashboard/page.tsx
    /ar-scan/page.tsx (Client Component for AR)
    /my-requests
      /[leadId]/page.tsx
    /messages/page.tsx
    /profile/page.tsx
  /contractor
    /layout.tsx (Contractor Dashboard Layout)
    /dashboard/page.tsx
    /leads/page.tsx (Available Leads)
      /[leadId]/page.tsx (Lead Details)
    /my-projects/page.tsx
    /profile/page.tsx
    /analytics/page.tsx
    /billing/page.tsx
  /admin (Potentially a separate Next.js app or a dedicated React Admin panel for internal use)
    /layout.tsx
    /users/page.tsx
    /contractors/pending/page.tsx
    /leads/page.tsx
    /analytics/page.tsx
  /components (Reusable UI components: buttons, cards, forms, navigation)
  /lib (Utility functions, API client, authentication helpers)
  /styles (Tailwind CSS configuration, global styles)
  /public (Static assets)
```

**2. Key Pages & Components:**

*   **Public Pages:**
    *   **Homepage (`/`):** Engaging marketing content, clear Call-to-Action (CTAs) for "Homeowners" and "Contractors," showcasing the value proposition of HOMEase | AI.
    *   **How It Works (`/how-it-works`):** Detailed explanation of the AR assessment process, lead validation, and contractor matching. Visuals and simple language are key.
    *   **Pricing (`/pricing`):** Transparent pricing tiers for contractors, emphasizing the value of high-quality leads.
*   **Homeowner Flow:**
    *   **Registration (`/auth/register`):** Simple, multi-step form for email/password and basic demographic information.
    *   **Dashboard (`/homeowner/dashboard`):** Personalized overview with quick access to "Start AR Scan," "My Requests," and "Messages."
    *   **AR Scan (`/homeowner/ar-scan`):**
        *   **Client Component (`use client`):** This page will host the AR experience.
        *   **AR Integration:**
            *   **If Native App:** This page will guide the user to download the native app or deep-link into it if already installed. The native app handles the actual LiDAR scanning and data collection, then sends processed data back to the FastAPI backend.
            *   **If Web-based AR (Fallback):** Utilizes WebXR to access the device camera. Provides UI overlays to guide users through "scanning" rooms. Manual input fields or very basic object detection (if feasible with WebXR) would collect data. *Crucially, emphasize the limitations of WebXR for precise measurements compared to native LiDAR.*
        *   **Guided Workflow:** Step-by-step instructions with clear visual cues and large buttons.
        *   **Input Forms:** After AR scan, intuitive forms to specify urgency, budget range, and additional notes.
        *   **Review/Confirm:** A clear summary of the AR assessment and lead details before final submission.
    *   **My Requests (`/homeowner/my-requests`):** A list of all submitted leads, showing their current status (e.g., "pending match," "matched," "in progress," "completed").
    *   **Lead Detail (`/homeowner/my-requests/[leadId]`):** Detailed view of a specific lead, including the AR assessment summary, profiles of matched contractors, and access to the messaging interface.
    *   **Messaging (`/homeowner/messages`):** Real-time chat interface for communication with matched contractors.
    *   **Profile (`/homeowner/profile`):** User settings, contact information, and preferences.
*   **Contractor Flow:**
    *   **Registration (`/auth/register`):** A comprehensive multi-step form for company details, specializations (e.g., Certified Aging-in-Place Specialist - CAPS), service areas, license/insurance uploads, and background check consent.
    *   **Dashboard (`/contractor/dashboard`):** Overview of new available leads, accepted leads, conversion rates, and earnings.
    *   **Lead Inbox (`/contractor/leads`):** A list of new, available leads. Each lead card provides key information like modification type, urgency, location, and a summary from the AR assessment.
    *   **Lead Detail (`/contractor/leads/[leadId]`):**
        *   Detailed view of the AR assessment data (measurements, identified issues, homeowner notes, suggested modifications).
        *   Clear options to "Accept Lead" or "Decline Lead."
        *   **Dynamic Scope Builder UI:** A crucial feature for contractors. This tool will auto-generate an initial scope-of-work proposal based on the AR scan data and AI output, allowing contractors to refine, add pricing, and generate a branded, professional proposal.
    *   **My Projects (`/contractor/my-projects`):** List of accepted leads/projects, with status updates and communication links.
    *   **Messaging (`/contractor/messages`):** Real-time chat with homeowners.
    *   **Profile Management (`/contractor/profile`):** Update company information, specializations, upload portfolio images, and manage availability.
    *   **Performance Analytics (`/contractor/analytics`):** Charts and graphs displaying lead conversion rates, customer satisfaction scores, and ROI on leads.
    *   **Billing & Payments (`/contractor/billing`):** View lead charges, payment history, and manage payment methods (using Stripe Elements for secure card input).

**3. Key Frontend Logic & Integrations:**

*   **Authentication:** Leverage Next.js Server Components for secure session management (e.g., using `next-auth` or a custom JWT handling strategy with HTTP-only cookies). Client components will use tokens for authenticated API calls.
*   **API Client:** A custom client (e.g., using `fetch` or `axios`) to interact with the FastAPI backend, handling authentication headers and error responses.
*   **AR Integration (Crucial Decision):** As noted, a native mobile app for homeowners for optimal LiDAR scanning is recommended. The Next.js web app would then serve as the primary interface for contractors and for homeowners to manage their requests post-scan. If a web-only AR solution is pursued initially, `three.js` or `A-Frame` would be used, with clear disclaimers about precision.
*   **Real-time Messaging:** Integrate `socket.io-client` in a client component to establish and manage WebSocket connections with the FastAPI backend for instant messaging between users.
*   **Payment UI:** Integrate Stripe Elements (or similar) for secure and compliant credit card input and management on the contractor billing pages.
*   **Accessibility (for Seniors):** This is paramount.
    *   **Design System:** Implement a comprehensive design system focused on senior-friendly UX principles:
        *   **Large Font Sizes:** Default large text, with options for even larger.
        *   **High Contrast:** Strong color contrast between text and background.
        *   **Clear Iconography:** Simple, unambiguous icons with accompanying text labels.
        *   **Ample Whitespace:** Reduces visual clutter.
        *   **Simple Navigation:** Intuitive, consistent navigation menus.
        *   **Minimal Technical Jargon:** Use straightforward, plain language.
        *   **Tapping over Complex Gestures:** Prioritize simple tap interactions.
        *   **Voice Command Integration (Future):** Explore integration with platform-native voice assistants (Alexa/Siri) for basic commands to enhance accessibility.
    *   **User Testing:** Continuous user testing with diverse groups of older adults to identify and address usability issues iteratively.
    *   **Feedback Mechanisms:** Easy-to-find channels for users to provide feedback on the app's usability.

### **V. Addressing "Immediate Go-to-Market Improvement" Features**

Let's map your prioritized features to the technical plan:

1.  **User-Friendly, AR-Based Initial Home Assessment Tool:**
    *   **Technical Implementation:** The core of the `ar_assessments` module in FastAPI for data ingestion and the `/homeowner/ar-scan` page in Next.js (or a linked native app) for the client-side AR experience. Significant UX/UI design effort will be focused here.
    *   **Go-to-Market Impact:** This is the primary differentiator and will be heavily featured in marketing. Its intuitiveness is critical for homeowner adoption.

2.  **Immediate Provision of Validated, High-Quality Leads:**
    *   **Technical Implementation:** The FastAPI `leads` module will handle the creation and management of leads. The `ar_assessments` data is directly integrated into the lead payload, ensuring "confirmed homeowner intent," "clearly identified modification requirements via AR," "budget range indication," and "urgency indication."
    *   **Go-to-Market Impact:** This is the core value proposition for contractors, justifying premium pricing and driving contractor acquisition.

3.  **Automated, Intelligent Contractor Matching & Verified Contractor Tiering System:**
    *   **Technical Implementation:** The Lead Matching Service (a Celery task in FastAPI) will implement the matching algorithm. The `contractors` table will store vetting status and performance metrics (`average_rating`, `lead_conversion_rate`) to support tiering.
    *   **Go-to-Market Impact:** Ensures rapid, relevant matches for homeowners and fair lead distribution for contractors, fostering trust and efficiency on both sides.

4.  **Integrated Communication Tool:**
    *   **Technical Implementation:** The `messaging` module in FastAPI with WebSocket support via `python-socketio`, and the `/homeowner/messages` and `/contractor/messages` pages in Next.js.
    *   **Go-to-Market Impact:** Streamlines communication post-match, reducing friction and improving conversion rates by enabling quick, direct interaction.

5.  **Contractor Onboarding and Vetting Process:**
    *   **Technical Implementation:** The `contractors` module in FastAPI handles application submissions and admin approvals. The Contractor Vetting Service integrates with third-party APIs for verification. The `/auth/register` and `/contractor/profile` pages in Next.js provide the UI.
    *   **Go-to-Market Impact:** Essential for building a reputable network, which is key for homeowner trust and attracting quality contractors.

6.  **Targeted Digital Marketing Campaigns:**
    *   **Technical Implementation:** While primarily a marketing function, the backend will provide analytics endpoints (`/admin/analytics/leads`, `/admin/analytics/contractors`) to track campaign effectiveness. The frontend will be built with SEO best practices (server-side rendering, semantic HTML).
    *   **Go-to-Market Impact:** Drives initial traffic and user acquisition for both homeowners and contractors.

7.  **Dynamic Scope Builder (for Contractors):**
    *   **Technical Implementation:** This will be a key feature within the `/contractor/leads/[leadId]` page in Next.js, leveraging the detailed AR assessment data from the FastAPI `ar_assessments` endpoint to pre-populate proposal templates.
    *   **Go-to-Market Impact:** A significant value-add for contractors, making their quoting process faster and more professional, directly impacting their lead conversion rates and satisfaction with the platform.

### **VI. Conclusion**

This technical plan provides a robust blueprint for HOMEase | AI, leveraging the strengths of FastAPI and Next.js App Router to build a highly scalable, secure, and user-friendly platform. By prioritizing the core AR-driven lead generation and contractor value propositions from the outset, the proposed architecture directly supports your "Immediate Go-to-Market Improvement" goals.

The choice to potentially develop a native mobile app for the core AR scanning functionality, while maintaining a powerful Next.js web application for overall platform management, addresses the nuanced technical requirements of precise AR measurements and the critical need for an accessible user experience for your target demographic. This layered approach ensures that HOMEase | AI can deliver on its promise of revolutionizing aging-in-place modifications through innovative technology and a highly efficient marketplace.

**Metadata:**
```json
{
  "subtask_count": 1
}
```
